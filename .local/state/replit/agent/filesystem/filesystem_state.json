{"file_contents":{"README.md":{"content":"# LangSense Telegram Bot\n\nA comprehensive Telegram bot for financial services with multi-language support, admin panel, broadcasting, and transaction management built with Python and Aiogram v3.\n\n## Features\n\n### ğŸŒ Multi-Language Support\n- Arabic (RTL) and English interfaces\n- Dynamic language switching\n- Localized content and keyboards\n- Country-specific settings\n\n### ğŸ‘¥ User Management\n- Phone number verification\n- Automatic customer code generation\n- User profiles and preferences\n- Activity tracking\n\n### ğŸ’° Financial Services\n- Deposit requests with receipt uploads\n- Withdrawal processing\n- Complaint handling system\n- Transaction workflow management\n\n### ğŸ› ï¸ Admin Panel\n- User management and statistics\n- Language and country administration\n- Broadcasting system with targeting\n- Request inbox and approval workflow\n\n### ğŸ“¢ Broadcasting & Announcements\n- Mass messaging with rate limiting\n- Target filtering by language/country\n- Scheduled announcements\n- Delivery tracking and retry logic\n\n### ğŸ”’ Security & Authentication\n- Admin-only access controls\n- Secure database operations\n- Input validation and sanitization\n- Error handling and logging\n\n## Technology Stack\n\n- **Framework**: Aiogram v3 (Telegram Bot API)\n- **Database**: SQLAlchemy with async support\n- **Storage**: SQLite (dev) / PostgreSQL (prod)\n- **Internationalization**: JSON-based translations\n- **Task Scheduling**: APScheduler\n- **Image Processing**: Pillow\n- **Environment**: python-dotenv\n\n## Quick Start\n\n### Prerequisites\n- Python 3.8 or higher\n- Telegram Bot Token from [@BotFather](https://t.me/BotFather)\n- Your Telegram User ID\n\n### Windows Setup\n1. Download/clone this repository\n2. Double-click `run_windows.bat`\n3. Follow the setup instructions\n4. Create `.env` file with your bot token and admin ID\n5. The bot will start automatically\n\n### Linux/macOS Setup\n```bash\n# Make the script executable\nchmod +x run_linux.sh\n\n# Run the setup script\n./run_linux.sh\n","size_bytes":1965},"advanced_bot.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nLangSense Bot - Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù…ØªÙ‚Ø¯Ù…\nØ¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\n\"\"\"\n\nimport os\nimport json\nimport time\nimport logging\nimport csv\nfrom datetime import datetime\nimport urllib.request\nimport urllib.parse\nimport urllib.error\n\n# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„\nlogging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')\nlogger = logging.getLogger(__name__)\n\nclass AdvancedLangSenseBot:\n    def __init__(self, token):\n        self.token = token\n        self.api_url = f\"https://api.telegram.org/bot{token}\"\n        self.offset = 0\n        self.user_states = {}  # Ù„Ø­ÙØ¸ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        self.init_files()\n        self.admin_ids = self.get_admin_ids()  # Ø¬Ù„Ø¨ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†\n        \n    def init_files(self):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        # Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        if not os.path.exists('users.csv'):\n            with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date', 'is_banned', 'ban_reason'])\n        \n        # Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…\n        if not os.path.exists('transactions.csv'):\n            with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'customer_id', 'telegram_id', 'name', 'type', 'amount', 'status', 'date', 'admin_note', 'payment_method', 'receipt_info', 'processed_by'])\n        \n        # Ù…Ù„Ù ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\n        if not os.path.exists('payment_methods.csv'):\n            with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'name', 'type', 'details', 'is_active', 'created_date'])\n                # ÙˆØ³Ø§Ø¦Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©\n                default_methods = [\n                    ['1', 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ', 'deposit', 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 1234567890\\nØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯: Ø´Ø±ÙƒØ© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ', 'active'],\n                    ['2', 'Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', 'deposit', 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 0987654321\\nØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯: Ø´Ø±ÙƒØ© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ', 'active'],  \n                    ['3', 'STC Pay', 'withdraw', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: 0501234567', 'active'],\n                    ['4', 'Ù…Ø¯Ù‰ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ', 'withdraw', 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 1111222233334444', 'active']\n                ]\n                for method in default_methods:\n                    writer.writerow(method + [datetime.now().strftime('%Y-%m-%d')])\n        \n        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰\n        if not os.path.exists('complaints.csv'):\n            with open('complaints.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'customer_id', 'message', 'status', 'date'])\n        \n        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\n        if not os.path.exists('system_settings.csv'):\n            with open('system_settings.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['setting_key', 'setting_value', 'description'])\n                # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©\n                default_settings = [\n                    ['support_phone', '+966501234567', 'Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ'],\n                    ['support_email', 'support@langsense.com', 'Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'], \n                    ['company_name', 'Ø´Ø±ÙƒØ© LangSense Ø§Ù„Ù…Ø§Ù„ÙŠØ©', 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©'],\n                    ['min_deposit', '50', 'Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø³Ù…ÙˆØ­'],\n                    ['min_withdrawal', '100', 'Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ø³Ø­Ø¨ Ù…Ø³Ù…ÙˆØ­'],\n                    ['max_daily_withdrawal', '10000', 'Ø£Ù‚ØµÙ‰ Ù…Ø¨Ù„Øº Ø³Ø­Ø¨ ÙŠÙˆÙ…ÙŠ'],\n                    ['support_hours', '24/7', 'Ø³Ø§Ø¹Ø§Øª Ø¹Ù…Ù„ Ø§Ù„Ø¯Ø¹Ù…'],\n                    ['welcome_message', 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… LangSense Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…', 'Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨']\n                ]\n                for setting in default_settings:\n                    writer.writerow(setting)\n        \n        logger.info(\"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­\")\n        \n    def api_call(self, method, data=None):\n        \"\"\"Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù…ÙØ­Ø³Ù†\"\"\"\n        url = f\"{self.api_url}/{method}\"\n        try:\n            if data:\n                json_data = json.dumps(data).encode('utf-8')\n                req = urllib.request.Request(url, data=json_data)\n                req.add_header('Content-Type', 'application/json')\n            else:\n                req = urllib.request.Request(url)\n            \n            with urllib.request.urlopen(req, timeout=10) as response:\n                return json.loads(response.read().decode('utf-8'))\n                \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ API: {e}\")\n            return None\n    \n    def send_message(self, chat_id, text, keyboard=None):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©\"\"\"\n        data = {'chat_id': chat_id, 'text': text, 'parse_mode': 'HTML'}\n        if keyboard:\n            data['reply_markup'] = keyboard\n        return self.api_call('sendMessage', data)\n    \n    def get_updates(self):\n        \"\"\"Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª\"\"\"\n        url = f\"{self.api_url}/getUpdates?offset={self.offset + 1}&timeout=10\"\n        try:\n            with urllib.request.urlopen(url, timeout=15) as response:\n                return json.loads(response.read().decode('utf-8'))\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª: {e}\")\n            return None\n    \n    def get_admin_ids(self):\n        \"\"\"Ø¬Ù„Ø¨ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        admin_ids = os.getenv('ADMIN_USER_IDS', '').split(',')\n        return [admin_id.strip() for admin_id in admin_ids if admin_id.strip()]\n    \n    def is_admin(self, telegram_id):\n        \"\"\"ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        return str(telegram_id) in self.admin_ids\n    \n    def notify_admins(self, message):\n        \"\"\"Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        for admin_id in self.admin_ids:\n            try:\n                self.send_message(admin_id, message)\n            except:\n                pass\n    \n    def is_user_banned(self, telegram_id):\n        \"\"\"ÙØ­Øµ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        user = self.find_user(telegram_id)\n        return user and user.get('is_banned', 'no') == 'yes'\n    \n    def find_user(self, telegram_id):\n        \"\"\"Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['telegram_id'] == str(telegram_id):\n                        return row\n        except:\n            pass\n        return None\n    \n    def search_users(self, query):\n        \"\"\"Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\"\"\"\n        results = []\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if (query.lower() in row['name'].lower() or \n                        query in row['customer_id'] or \n                        query in row['phone']):\n                        results.append(row)\n        except:\n            pass\n        return results\n    \n    def get_payment_methods(self, method_type=None):\n        \"\"\"Ø¬Ù„Ø¨ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\"\"\"\n        methods = []\n        try:\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if method_type is None or row['type'] == method_type:\n                        if row['is_active'] == 'active':\n                            methods.append(row)\n        except:\n            pass\n        return methods\n    \n    def get_pending_transactions(self):\n        \"\"\"Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©\"\"\"\n        pending = []\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['status'] == 'pending':\n                        pending.append(row)\n        except:\n            pass\n        return pending\n    \n    def update_transaction_status(self, trans_id, new_status, admin_note='', admin_id=''):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        transactions = []\n        try:\n            # Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == trans_id:\n                        row['status'] = new_status\n                        if admin_note:\n                            row['admin_note'] = admin_note\n                        row['processed_by'] = admin_id\n                    transactions.append(row)\n            \n            # Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù\n            with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                fieldnames = ['id', 'customer_id', 'telegram_id', 'name', 'type', 'amount', 'status', 'date', 'admin_note', 'payment_method', 'receipt_info', 'processed_by']\n                writer = csv.DictWriter(f, fieldnames=fieldnames)\n                writer.writeheader()\n                writer.writerows(transactions)\n            return True\n        except:\n            return False\n    \n    def ban_user(self, customer_id, reason, admin_id):\n        \"\"\"Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        users = []\n        success = False\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == customer_id:\n                        row['is_banned'] = 'yes'\n                        row['ban_reason'] = reason\n                        success = True\n                    users.append(row)\n            \n            if success:\n                with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date', 'is_banned', 'ban_reason']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(users)\n        except:\n            pass\n        return success\n    \n    def main_keyboard(self, lang='ar'):\n        \"\"\"Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\"\"\"\n        if lang == 'ar':\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨'}],\n                    [{'text': 'ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ'}, {'text': 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ'}],\n                    [{'text': 'ğŸ“¨ Ø´ÙƒÙˆÙ‰'}, {'text': 'ğŸ†˜ Ø¯Ø¹Ù…'}],\n                    [{'text': 'ğŸ‡ºğŸ‡¸ English'}, {'text': '/admin'}]\n                ],\n                'resize_keyboard': True\n            }\n        else:\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Deposit Request'}, {'text': 'ğŸ’¸ Withdrawal Request'}],\n                    [{'text': 'ğŸ“‹ My Requests'}, {'text': 'ğŸ‘¤ Profile'}],\n                    [{'text': 'ğŸ“¨ Complaint'}, {'text': 'ğŸ†˜ Support'}],\n                    [{'text': 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'}, {'text': '/admin'}]\n                ],\n                'resize_keyboard': True\n            }\n    \n    def create_deposit_request(self, message):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ù…ØªÙ‚Ø¯Ù…\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        # Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…ØªØ§Ø­Ø©\n        deposit_methods = self.get_payment_methods('deposit')\n        if not deposit_methods:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¥ÙŠØ¯Ø§Ø¹ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹\")\n            return\n        \n        methods_text = \"ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯\\n\\nÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…ØªØ§Ø­Ø©:\\n\\n\"\n        keyboard_buttons = []\n        \n        for method in deposit_methods:\n            methods_text += f\"ğŸ¦ {method['name']}\\n{method['details']}\\n\\n\"\n            keyboard_buttons.append([{'text': f\"ğŸ’³ {method['name']}\"}])\n        \n        keyboard_buttons.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}])\n        \n        methods_text += \"Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©:\"\n        \n        self.send_message(message['chat']['id'], methods_text, {\n            'keyboard': keyboard_buttons,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        })\n        \n        # Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n        self.user_states[message['from']['id']] = 'selecting_deposit_method'\n    \n    def process_deposit_method_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\"\"\"\n        user = self.find_user(message['from']['id'])\n        selected_method = message['text'].replace('ğŸ’³ ', '')\n        \n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n        deposit_methods = self.get_payment_methods('deposit')\n        selected_method_info = None\n        for method in deposit_methods:\n            if method['name'] == selected_method:\n                selected_method_info = method\n                break\n        \n        if not selected_method_info:\n            self.send_message(message['chat']['id'], \"âŒ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ ØºÙŠØ± ØµØ­ÙŠØ­Ø©\")\n            return\n        \n        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n        trans_id = f\"DEP{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n        \n        response = f\"\"\"âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©: {selected_method}\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ“± Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {selected_method}\nğŸ’³ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {selected_method_info['details']}\n\nØ§Ù„Ø¢Ù†ØŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ/Ù…Ø­ÙØ¸ØªÙƒ ÙÙŠ {selected_method}:\n\nğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„:\n{selected_method_info['details']}\n\nğŸ“ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„:\n1ï¸âƒ£ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ÙŠØ¯Ø§Ø¹Ù‡ (Ø±Ù‚Ù… ÙÙ‚Ø·)\n2ï¸âƒ£ ØµÙˆØ±Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„\n\nÙ…Ø«Ø§Ù„: 1000\"\"\"\n        \n        # Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n        with open('transactions.csv', 'a', newline='', encoding='utf-8-sig') as f:\n            writer = csv.writer(f)\n            writer.writerow([\n                trans_id, user['customer_id'], user['telegram_id'], user['name'], \n                'deposit', '0', 'pending', datetime.now().strftime('%Y-%m-%d %H:%M'), \n                '', selected_method, 'awaiting_details', ''\n            ])\n        \n        # Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ø´Ø§Ù…Ù„ Ù„Ù„Ø£Ø¯Ù…Ù†\n        admin_notification = f\"\"\"ğŸš¨ Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯ - Ù…Ø±Ø­Ù„Ø© 1\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ“± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…: @{message['from'].get('username', 'ØºÙŠØ± Ù…ØªÙˆÙØ±')} ({user['telegram_id']})\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: {user['phone']}\nğŸ¦ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: {selected_method}\nğŸ“… Ø§Ù„ÙˆÙ‚Øª: {datetime.now().strftime('%Y-%m-%d %H:%M')}\nğŸ”¢ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº\n\nğŸ“‹ ØªÙØ§ØµÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹:\n{selected_method_info['details']}\n\nâ³ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¢Ù† ÙŠØ¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨...\"\"\"\n        \n        self.notify_admins(admin_notification)\n        \n        self.send_message(message['chat']['id'], response)\n        self.user_states[message['from']['id']] = f'deposit_wallet_{trans_id}_{selected_method}'\n    \n    def process_deposit_wallet(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©/Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹\"\"\"\n        state_parts = self.user_states[message['from']['id']].split('_')\n        trans_id = state_parts[2]\n        selected_method = '_'.join(state_parts[3:])\n        \n        wallet_number = message['text'].strip()\n        \n        if not wallet_number or len(wallet_number) < 5:\n            self.send_message(message['chat']['id'], \n                \"âŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©/Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­:\")\n            return\n        \n        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©\n        transactions = []\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == trans_id:\n                        row['receipt_info'] = f\"Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\"\n                        row['status'] = 'amount_pending'\n                    transactions.append(row)\n            \n            with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                fieldnames = ['id', 'customer_id', 'telegram_id', 'name', 'type', 'amount', 'status', 'date', 'admin_note', 'payment_method', 'receipt_info', 'processed_by']\n                writer = csv.DictWriter(f, fieldnames=fieldnames)\n                writer.writeheader()\n                writer.writerows(transactions)\n        except:\n            pass\n        \n        response = f\"\"\"âœ… ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {selected_method}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\n\nØ§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥ÙŠØ¯Ø§Ø¹Ù‡ (Ø¨Ø§Ù„Ø±ÙŠØ§Ù„ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ):\"\"\"\n        \n        self.send_message(message['chat']['id'], response)\n        \n        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº\n        self.user_states[message['from']['id']] = f'deposit_amount_{trans_id}'\n        \n        # Ø¥Ø´Ø¹Ø§Ø± Ù…Ø­Ø¯Ø« Ù„Ù„Ø£Ø¯Ù…Ù†\n        user = self.find_user(message['from']['id'])\n        admin_msg = f\"\"\"ğŸ”” ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ - Ù…Ø±Ø­Ù„Ø© 2\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {selected_method}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nâ° Ø§Ù„ÙˆÙ‚Øª: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\nâ³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº...\"\"\"\n        \n        self.notify_admins(admin_msg)\n    \n    def handle_admin_search(self, message):\n        \"\"\"Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n        \n        parts = message['text'].split(' ', 1)\n        if len(parts) < 2:\n            self.send_message(message['chat']['id'], \"Ø§Ø³ØªØ®Ø¯Ù…: /search Ø§Ø³Ù…_Ø£Ùˆ_Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„\")\n            return\n        \n        query = parts[1]\n        results = self.search_users(query)\n        \n        if not results:\n            self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«: {query}\")\n            return\n        \n        response = f\"ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: {query}\\n\\n\"\n        for user in results:\n            ban_status = \"ğŸš« Ù…Ø­Ø¸ÙˆØ±\" if user.get('is_banned') == 'yes' else \"âœ… Ù†Ø´Ø·\"\n            response += f\"ğŸ‘¤ {user['name']}\\nğŸ†” {user['customer_id']}\\nğŸ“± {user['phone']}\\nğŸ”¸ {ban_status}\\n\\n\"\n        \n        self.send_message(message['chat']['id'], response)\n    \n    def handle_admin_ban(self, message):\n        \"\"\"Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n        \n        parts = message['text'].split(' ', 2)\n        if len(parts) < 3:\n            self.send_message(message['chat']['id'], \"Ø§Ø³ØªØ®Ø¯Ù…: /ban Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø³Ø¨Ø¨_Ø§Ù„Ø­Ø¸Ø±\")\n            return\n        \n        customer_id = parts[1]\n        reason = parts[2]\n        \n        if self.ban_user(customer_id, reason, str(message['from']['id'])):\n            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø­Ø¸Ø±\n            user = None\n            try:\n                with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                    reader = csv.DictReader(f)\n                    for row in reader:\n                        if row['customer_id'] == customer_id:\n                            user = row\n                            break\n            except:\n                pass\n            \n            if user:\n                self.send_message(user['telegram_id'], f\"ğŸš« ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ\\n\\nØ§Ù„Ø³Ø¨Ø¨: {reason}\\n\\nÙ„Ù„Ø§Ø³ØªÙØ³Ø§Ø± ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\")\n            \n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id} Ø¨Ù†Ø¬Ø§Ø­\")\n        else:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø¸Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id}\")\n    \n    def handle_admin_pending(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n        \n        pending = self.get_pending_transactions()\n        if not pending:\n            self.send_message(message['chat']['id'], \"âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©\")\n            return\n        \n        response = f\"â³ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ({len(pending)}):\\n\\n\"\n        for trans in pending:\n            response += f\"ğŸ†” {trans['id']}\\nğŸ‘¤ {trans['name']} ({trans['customer_id']})\\nğŸ’° {trans['type']}: {trans['amount']} Ø±ÙŠØ§Ù„\\nğŸ“… {trans['date']}\\n\\n\"\n        \n        response += \"\\nğŸ’¡ Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©: /approve Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\\nğŸ’¡ Ù„Ù„Ø±ÙØ¶: /reject Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø³Ø¨Ø¨\"\n        \n        self.send_message(message['chat']['id'], response)\n    \n    def handle_text(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\"\"\"\n        if self.is_user_banned(message['from']['id']):\n            self.send_message(message['chat']['id'], \"ğŸš« Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø±.\")\n            return\n        \n        text = message['text']\n        chat_id = message['chat']['id']\n        user_id = message['from']['id']\n        \n        # ÙØ­Øµ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©\n        if self.is_admin(user_id):\n            if text.startswith('/search '):\n                self.handle_admin_search(message)\n                return\n            elif text.startswith('/ban '):\n                self.handle_admin_ban(message)\n                return\n            elif text == '/pending':\n                self.handle_admin_pending(message)\n                return\n            elif text.startswith('/approve '):\n                self.handle_admin_approve(message)\n                return\n            elif text.startswith('/reject '):\n                self.handle_admin_reject(message)\n                return\n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\n            elif text == 'ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©':\n                self.handle_admin_pending(message)\n                return\n            elif text == 'âœ… Ø·Ù„Ø¨Ø§Øª Ù…ÙÙˆØ§ÙÙ‚Ø©':\n                self.show_approved_transactions(message)\n                return\n            elif text == 'ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†':\n                self.show_users_management(message)\n                return\n            elif text == 'ğŸ” Ø§Ù„Ø¨Ø­Ø«':\n                self.prompt_admin_search(message)\n                return\n            elif text == 'ğŸ’³ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹':\n                self.show_payment_methods_admin(message)\n                return\n            elif text == 'ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª':\n                self.show_detailed_stats(message)\n                return\n            elif text == 'ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ':\n                self.prompt_broadcast(message)\n                return\n            elif text == 'ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…':\n                self.prompt_ban_user(message)\n                return\n            elif text == 'âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±':\n                self.prompt_unban_user(message)\n                return\n            elif text == 'ğŸ“ Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹':\n                self.prompt_add_payment_method(message)\n                return\n            elif text == 'âš™ï¸ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹':\n                self.show_edit_payment_methods(message)\n                return\n            elif text == 'âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…':\n                self.show_system_settings(message)\n                return\n            elif text.startswith('/editsetting '):\n                self.handle_edit_setting(message)\n                return\n            elif text.startswith('/editcompany '):\n                self.handle_edit_company(message)\n                return\n            elif text.startswith('/addcompany '):\n                self.handle_add_company(message)\n                return\n            elif text.startswith('/deletecompany '):\n                self.handle_delete_company(message)\n                return\n            elif text == 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©':\n                user = self.find_user(user_id)\n                lang = user.get('language', 'ar') if user else 'ar'\n                welcome_text = f\"Ù…Ø±Ø­Ø¨Ø§Ù‹! ğŸ‘‹\\nØªÙ… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\"\n                self.send_message(chat_id, welcome_text, self.main_keyboard(lang))\n                return\n        \n        # ÙØ­Øµ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n        if user_id in self.user_states:\n            state = self.user_states[user_id]\n            if state == 'selecting_deposit_method':\n                self.process_deposit_method_selection(message)\n                return\n            elif state.startswith('deposit_wallet_'):\n                self.process_deposit_wallet(message)\n                return\n            elif state.startswith('deposit_amount_'):\n                self.process_deposit_amount(message)\n                return\n            elif state == 'admin_searching':\n                self.process_admin_search(message)\n                return\n            elif state == 'admin_broadcasting':\n                self.process_admin_broadcast(message)\n                return\n            elif state == 'admin_banning':\n                self.process_admin_ban(message)\n                return\n            elif state == 'admin_unbanning':\n                self.process_admin_unban(message)\n                return\n            elif state == 'selecting_withdraw_method':\n                self.process_withdrawal_method_selection(message)\n                return\n            elif state.startswith('withdraw_wallet_'):\n                self.process_withdrawal_wallet(message)\n                return\n            elif state.startswith('withdraw_amount_'):\n                self.process_withdrawal_amount(message)\n                return\n            elif state == 'admin_adding_payment':\n                self.process_admin_add_payment(message)\n                return\n            elif state == 'admin_editing_payment':\n                self.process_admin_edit_payment(message)\n                return\n        \n        user = self.find_user(user_id)\n        if not user:\n            self.handle_start(message)\n            return\n        \n        lang = user.get('language', 'ar')\n        \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…\n        if text in ['ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹', 'ğŸ’° Deposit Request']:\n            self.create_deposit_request(message)\n        elif text in ['ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨', 'ğŸ’¸ Withdrawal Request']:\n            self.create_withdrawal_request(message)\n        elif text in ['ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ', 'ğŸ“‹ My Requests']:\n            self.show_user_transactions(message)\n        elif text == '/admin' and self.is_admin(user_id):\n            self.handle_admin_panel(message)\n        else:\n            self.send_message(chat_id, \"Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:\", self.main_keyboard(lang))\n    \n    def show_user_transactions(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        transactions = []\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == user['customer_id']:\n                        transactions.append(row)\n        except:\n            pass\n        \n        if not transactions:\n            self.send_message(message['chat']['id'], \"ğŸ“‹ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©\")\n            return\n        \n        response = f\"ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙƒ ({len(transactions)}):\\n\\n\"\n        for trans in transactions[-10:]:  # Ø¢Ø®Ø± 10 Ø·Ù„Ø¨Ø§Øª\n            status_emoji = {\"pending\": \"â³\", \"approved\": \"âœ…\", \"rejected\": \"âŒ\"}.get(trans['status'], \"â“\")\n            response += f\"{status_emoji} {trans['id']}\\nğŸ’° {trans['type']}: {trans['amount']} Ø±ÙŠØ§Ù„\\nğŸ“… {trans['date']}\\n\"\n            if trans.get('admin_note'):\n                response += f\"ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: {trans['admin_note']}\\n\"\n            response += \"\\n\"\n        \n        self.send_message(message['chat']['id'], response)\n    \n    def get_transaction_info(self, trans_id):\n        \"\"\"Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == trans_id:\n                        return row\n        except:\n            pass\n        return None\n    \n    def handle_admin_approve(self, message):\n        \"\"\"Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø£Ø¯Ù…Ù† Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ù…Ø¹ Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n        \n        parts = message['text'].split(' ', 1)\n        if len(parts) < 2:\n            return\n        \n        trans_id = parts[1]\n        admin_name = message['from'].get('first_name', 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©')\n        \n        if self.update_transaction_status(trans_id, 'approved', f'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ù…Ù† {admin_name}', str(message['from']['id'])):\n            # Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø©\n            trans_info = self.get_transaction_info(trans_id)\n            if trans_info:\n                user_notification = f\"\"\"ğŸ‰ ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ!\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ’° Ø§Ù„Ù†ÙˆØ¹: {trans_info['type']}\nğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº: {trans_info['amount']} Ø±ÙŠØ§Ù„\nâ° ÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: {datetime.now().strftime('%Y-%m-%d %H:%M')}\nğŸ‘¤ Ù…Ø¹Ø§Ù„Ø¬ Ø¨ÙˆØ§Ø³Ø·Ø©: {admin_name}\n\nâœ… ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­\nØ´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø§ØªÙ†Ø§\"\"\"\n                \n                try:\n                    self.send_message(trans_info['telegram_id'], user_notification)\n                except:\n                    pass\n            \n            admin_response = f\"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ {trans_id}\\nğŸ“± ØªÙ… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙˆØ±Ø§Ù‹\"\n            self.send_message(message['chat']['id'], admin_response, self.admin_keyboard())\n        else:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ {trans_id}\", self.admin_keyboard())\n    \n    def handle_admin_reject(self, message):\n        \"\"\"Ø±ÙØ¶ Ø·Ù„Ø¨ Ù…Ø¹ Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù…Ø­Ø³Ù†\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n        \n        parts = message['text'].split(' ', 2)\n        if len(parts) < 3:\n            self.send_message(message['chat']['id'], \"Ø§Ø³ØªØ®Ø¯Ù…: /reject Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø³Ø¨Ø¨\", self.admin_keyboard())\n            return\n        \n        trans_id = parts[1]\n        reason = parts[2]\n        admin_name = message['from'].get('first_name', 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©')\n        \n        if self.update_transaction_status(trans_id, 'rejected', f'Ù…Ø±ÙÙˆØ¶: {reason}', str(message['from']['id'])):\n            trans_info = self.get_transaction_info(trans_id)\n            if trans_info:\n                user_notification = f\"\"\"âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ’° Ø§Ù„Ù†ÙˆØ¹: {trans_info['type']}\nğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº: {trans_info['amount']} Ø±ÙŠØ§Ù„\nâ° ÙˆÙ‚Øª Ø§Ù„Ø±ÙØ¶: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nğŸ“ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶: {reason}\n\nğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª\nÙ„Ù„Ø§Ø³ØªÙØ³Ø§Ø± ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\"\"\"\n                \n                try:\n                    self.send_message(trans_info['telegram_id'], user_notification)\n                except:\n                    pass\n            \n            admin_response = f\"âœ… ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ {trans_id}\\nğŸ“± ØªÙ… Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø³Ø¨Ø¨ ÙÙˆØ±Ø§Ù‹\"\n            self.send_message(message['chat']['id'], admin_response, self.admin_keyboard())\n        else:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ {trans_id}\", self.admin_keyboard())\n    \n    def admin_keyboard(self):\n        \"\"\"Ù„ÙˆØ­Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø´Ø§Ù…Ù„Ø©\"\"\"\n        return {\n            'keyboard': [\n                [{'text': 'ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©'}, {'text': 'âœ… Ø·Ù„Ø¨Ø§Øª Ù…ÙÙˆØ§ÙÙ‚Ø©'}],\n                [{'text': 'ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'}, {'text': 'ğŸ” Ø§Ù„Ø¨Ø­Ø«'}],\n                [{'text': 'ğŸ’³ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹'}, {'text': 'ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª'}],\n                [{'text': 'ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ'}, {'text': 'ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'}],\n                [{'text': 'ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…'}, {'text': 'âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±'}],\n                [{'text': 'ğŸ“ Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹'}, {'text': 'âš™ï¸ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹'}],\n                [{'text': 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}]\n            ],\n            'resize_keyboard': True\n        }\n    \n    def handle_admin_panel(self, message):\n        \"\"\"Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø±\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n        \n        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø´Ø§Ù…Ù„Ø©\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                users = list(csv.DictReader(f))\n                total_users = len(users)\n                banned_users = len([u for u in users if u.get('is_banned') == 'yes'])\n                active_users = total_users - banned_users\n        except:\n            total_users = banned_users = active_users = 0\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                transactions = list(csv.DictReader(f))\n                total_trans = len(transactions)\n                pending_trans = len([t for t in transactions if t['status'] == 'pending'])\n                approved_trans = len([t for t in transactions if t['status'] == 'approved'])\n                rejected_trans = len([t for t in transactions if t['status'] == 'rejected'])\n                \n                # Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº\n                total_amount = sum(float(t.get('amount', 0)) for t in transactions if t['status'] == 'approved')\n        except:\n            total_trans = pending_trans = approved_trans = rejected_trans = 0\n            total_amount = 0\n        \n        admin_text = f\"\"\"ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø©\n\nğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ©:\nğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {total_users}\n   âœ… Ù†Ø´Ø·ÙŠÙ†: {active_users}\n   ğŸš« Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†: {banned_users}\n\nğŸ’° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: {total_trans}\n   â³ Ù…Ø¹Ù„Ù‚Ø©: {pending_trans}\n   âœ… Ù…ÙÙˆØ§ÙÙ‚Ø©: {approved_trans}\n   âŒ Ù…Ø±ÙÙˆØ¶Ø©: {rejected_trans}\n   ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº: {total_amount:,.0f} Ø±ÙŠØ§Ù„\n\nØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„:\"\"\"\n        \n        self.send_message(message['chat']['id'], admin_text, self.admin_keyboard())\n    \n    def show_approved_transactions(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙÙˆØ§ÙÙ‚Ø©\"\"\"\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                transactions = [t for t in csv.DictReader(f) if t['status'] == 'approved']\n        except:\n            transactions = []\n        \n        if not transactions:\n            self.send_message(message['chat']['id'], \"âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…ÙÙˆØ§ÙÙ‚Ø©\", self.admin_keyboard())\n            return\n        \n        response = f\"âœ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙÙˆØ§ÙÙ‚Ø© ({len(transactions)}):\\n\\n\"\n        for trans in transactions[-10:]:\n            response += f\"ğŸ†” {trans['id']}\\nğŸ‘¤ {trans['name']}\\nğŸ’° {trans['type']}: {trans['amount']} Ø±ÙŠØ§Ù„\\nğŸ“… {trans['date']}\\n\\n\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n    \n    def show_users_management(self, message):\n        \"\"\"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\"\"\"\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                users = list(csv.DictReader(f))\n        except:\n            users = []\n        \n        if not users:\n            self.send_message(message['chat']['id'], \"ğŸ‘¥ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\", self.admin_keyboard())\n            return\n        \n        active = [u for u in users if u.get('is_banned', 'no') == 'no']\n        banned = [u for u in users if u.get('is_banned', 'no') == 'yes']\n        \n        response = f\"\"\"ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n\nğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\nâœ… Ù†Ø´Ø·ÙŠÙ†: {len(active)}\nğŸš« Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†: {len(banned)}\nğŸ“‹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {len(users)}\n\nØ¢Ø®Ø± 5 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\n\"\"\"\n        for user in users[-5:]:\n            status = \"ğŸš«\" if user.get('is_banned') == 'yes' else \"âœ…\"\n            response += f\"{status} {user['name']} ({user['customer_id']})\\n\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n    \n    def prompt_admin_search(self, message):\n        \"\"\"Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        response = \"ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\\n\\nØ£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¨Ø­Ø«:\"\n        self.send_message(message['chat']['id'], response)\n        self.user_states[message['from']['id']] = 'admin_searching'\n    \n    def show_payment_methods_admin(self, message):\n        \"\"\"Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        deposit_methods = self.get_payment_methods('deposit')\n        withdraw_methods = self.get_payment_methods('withdraw')\n        \n        response = \"ğŸ’³ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©\\n\\n\"\n        \n        response += \"ğŸ’° ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:\\n\"\n        for method in deposit_methods:\n            response += f\"ğŸ¦ {method['name']}\\n\"\n        \n        response += f\"\\nğŸ’¸ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø­Ø¨:\\n\"\n        for method in withdraw_methods:\n            response += f\"ğŸ’³ {method['name']}\\n\"\n        \n        response += f\"\\nğŸ“ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {len(deposit_methods + withdraw_methods)}\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n    \n    def show_detailed_stats(self, message):\n        \"\"\"Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªÙØµÙŠÙ„ÙŠØ©\"\"\"\n        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                users = list(csv.DictReader(f))\n                total_users = len(users)\n                banned_users = len([u for u in users if u.get('is_banned') == 'yes'])\n                today_users = len([u for u in users if u['date'].startswith(datetime.now().strftime('%Y-%m-%d'))])\n        except:\n            total_users = banned_users = today_users = 0\n        \n        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                transactions = list(csv.DictReader(f))\n                total_trans = len(transactions)\n                pending_trans = len([t for t in transactions if t['status'] == 'pending'])\n                approved_trans = len([t for t in transactions if t['status'] == 'approved'])\n                rejected_trans = len([t for t in transactions if t['status'] == 'rejected'])\n                \n                # Ø§Ù„Ù…Ø¨Ø§Ù„Øº\n                total_amount = sum(float(t.get('amount', 0)) for t in transactions if t['status'] == 'approved')\n                pending_amount = sum(float(t.get('amount', 0)) for t in transactions if t['status'] == 'pending')\n                \n                # Ø§Ù„ÙŠÙˆÙ…\n                today = datetime.now().strftime('%Y-%m-%d')\n                today_trans = [t for t in transactions if t['date'].startswith(today)]\n                today_count = len(today_trans)\n                today_amount = sum(float(t.get('amount', 0)) for t in today_trans if t['status'] == 'approved')\n        except:\n            total_trans = pending_trans = approved_trans = rejected_trans = 0\n            total_amount = pending_amount = today_count = today_amount = 0\n        \n        response = f\"\"\"ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©\n\nğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\nğŸ“‹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {total_users}\nâœ… Ù†Ø´Ø·ÙŠÙ†: {total_users - banned_users}\nğŸš« Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†: {banned_users}\nğŸ†• Ø§Ù„ÙŠÙˆÙ…: {today_users}\n\nğŸ’° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª:\nğŸ“‹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: {total_trans}\nâ³ Ù…Ø¹Ù„Ù‚Ø©: {pending_trans}\nâœ… Ù…ÙÙˆØ§ÙÙ‚Ø©: {approved_trans}\nâŒ Ù…Ø±ÙÙˆØ¶Ø©: {rejected_trans}\n\nğŸ’µ Ø§Ù„Ù…Ø¨Ø§Ù„Øº:\nâœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ÙÙˆØ§ÙÙ‚: {total_amount:,.0f} Ø±ÙŠØ§Ù„\nâ³ Ù…Ø¹Ù„Ù‚: {pending_amount:,.0f} Ø±ÙŠØ§Ù„\n\nğŸ“ˆ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…:\nğŸ“‹ Ù…Ø¹Ø§Ù…Ù„Ø§Øª: {today_count}\nğŸ’µ Ù…Ø¨Ø§Ù„Øº: {today_amount:,.0f} Ø±ÙŠØ§Ù„\n\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\"\"\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n    \n    def prompt_broadcast(self, message):\n        \"\"\"Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ\"\"\"\n        response = \"ğŸ“¢ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ\\n\\nØ£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\"\n        self.send_message(message['chat']['id'], response)\n        self.user_states[message['from']['id']] = 'admin_broadcasting'\n    \n    def prompt_ban_user(self, message):\n        \"\"\"Ø·Ù„Ø¨ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        response = \"ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\\n\\nØ£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø³Ø¨Ø¨:\\nÙ…Ø«Ø§Ù„: C000001 Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø´Ø±ÙˆØ·\"\n        self.send_message(message['chat']['id'], response)\n        self.user_states[message['from']['id']] = 'admin_banning'\n    \n    def prompt_unban_user(self, message):\n        \"\"\"Ø·Ù„Ø¨ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        response = \"âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\\n\\nØ£Ø±Ø³Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:\\nÙ…Ø«Ø§Ù„: C000001\"\n        self.send_message(message['chat']['id'], response)\n        self.user_states[message['from']['id']] = 'admin_unbanning'\n    \n    def create_withdrawal_request(self, message):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ù…ØªÙ‚Ø¯Ù… Ù…Ø¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        # Ø¹Ø±Ø¶ Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…ØªØ§Ø­Ø©\n        withdraw_methods = self.get_payment_methods('withdraw')\n        if not withdraw_methods:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ø³Ø­Ø¨ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹\")\n            return\n        \n        methods_text = \"ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯\\n\\nØ§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø³Ø­Ø¨:\\n\\n\"\n        keyboard_buttons = []\n        \n        for method in withdraw_methods:\n            methods_text += f\"ğŸ’³ {method['name']}\\nğŸ“ {method['details']}\\n\\n\"\n            keyboard_buttons.append([{'text': f\"ğŸ’¸ {method['name']}\"}])\n        \n        keyboard_buttons.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}])\n        \n        methods_text += \"Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø³Ø­Ø¨:\"\n        \n        self.send_message(message['chat']['id'], methods_text, {\n            'keyboard': keyboard_buttons,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        })\n        \n        self.user_states[message['from']['id']] = 'selecting_withdraw_method'\n    \n    def process_withdrawal_method_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø­Ø¨\"\"\"\n        user = self.find_user(message['from']['id'])\n        selected_method = message['text'].replace('ğŸ’¸ ', '')\n        \n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n        withdraw_methods = self.get_payment_methods('withdraw')\n        selected_method_info = None\n        for method in withdraw_methods:\n            if method['name'] == selected_method:\n                selected_method_info = method\n                break\n        \n        if not selected_method_info:\n            self.send_message(message['chat']['id'], \"âŒ Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø­Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©\")\n            return\n        \n        response = f\"\"\"ğŸ’¸ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø­Ø¨: {selected_method}\n\nğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ©:\n{selected_method_info['details']}\n\nğŸ’¡ Ø§Ù„Ø¢Ù† ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù…Ø­ÙØ¸ØªÙƒ Ø£Ùˆ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ {selected_method}:\n\nÙ…Ø«Ø§Ù„: 0501234567\"\"\"\n        \n        self.send_message(message['chat']['id'], response)\n        self.user_states[message['from']['id']] = f'withdraw_wallet_{selected_method}'\n    \n    def process_withdrawal_wallet(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©\"\"\"\n        user = self.find_user(message['from']['id'])\n        wallet_number = message['text'].strip()\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id, '')\n        \n        if not state.startswith('withdraw_wallet_'):\n            return\n        \n        selected_method = state.replace('withdraw_wallet_', '')\n        \n        response = f\"\"\"âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ¦ Ø§Ù„Ø´Ø±ÙƒØ©: {selected_method}\n\nğŸ’° Ø§Ù„Ø¢Ù† ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø­Ø¨Ù‡:\n\nÙ…Ø«Ø§Ù„: 500\"\"\"\n        \n        self.send_message(message['chat']['id'], response)\n        self.user_states[user_id] = f'withdraw_amount_{selected_method}_{wallet_number}'\n    \n    def process_withdrawal_amount(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨\"\"\"\n        if not message['text'].isdigit():\n            self.send_message(message['chat']['id'], \"âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)\")\n            return\n        \n        amount = message['text']\n        user_id = message['from']['id']\n        user = self.find_user(user_id)\n        state = self.user_states.get(user_id, '')\n        \n        if not state.startswith('withdraw_amount_'):\n            return\n        \n        parts = state.replace('withdraw_amount_', '').split('_', 1)\n        selected_method = parts[0]\n        wallet_number = parts[1]\n        \n        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n        trans_id = f\"WTH{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n        \n        # Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n        with open('transactions.csv', 'a', newline='', encoding='utf-8-sig') as f:\n            writer = csv.writer(f)\n            writer.writerow([\n                trans_id, user['customer_id'], user['telegram_id'], user['name'], \n                'withdrawal', amount, 'pending', datetime.now().strftime('%Y-%m-%d %H:%M'), \n                '', selected_method, wallet_number, ''\n            ])\n        \n        # Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„\n        confirmation = f\"\"\"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ¦ Ø§Ù„Ø´Ø±ÙƒØ©: {selected_method}\nğŸ’³ Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nâ³ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©\nğŸ”” Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ ÙÙˆØ± ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨\"\"\"\n        \n        # Ø¥Ø´Ø¹Ø§Ø± Ø´Ø§Ù…Ù„ ÙÙˆØ±ÙŠ Ù„Ù„Ø£Ø¯Ù…Ù†\n        admin_notification = f\"\"\"ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯ - Ù…ÙƒØªÙ…Ù„!\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ“± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…: @{message['from'].get('username', 'ØºÙŠØ± Ù…ØªÙˆÙØ±')} ({user['telegram_id']})\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: {user['phone']}\nğŸ¦ Ø´Ø±ÙƒØ© Ø§Ù„Ø³Ø­Ø¨: {selected_method}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: {amount} Ø±ÙŠØ§Ù„\nğŸ“… Ø§Ù„ÙˆÙ‚Øª: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nğŸ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:\nâœ… Ø§Ø³ØªØ®Ø¯Ù…: /approve {trans_id} Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©\nâŒ Ø§Ø³ØªØ®Ø¯Ù…: /reject {trans_id} Ø§Ù„Ø³Ø¨Ø¨ Ù„Ù„Ø±ÙØ¶\nğŸ“‹ Ø§Ø³ØªØ®Ø¯Ù…: /pending Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\"\"\"\n        \n        self.notify_admins(admin_notification)\n        \n        self.send_message(message['chat']['id'], confirmation, self.main_keyboard(user.get('language', 'ar')))\n        \n        # Ø­Ø°Ù Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n        if user_id in self.user_states:\n            del self.user_states[user_id]\n    \n    def prompt_add_payment_method(self, message):\n        \"\"\"Ø·Ù„Ø¨ Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯Ø©\"\"\"\n        response = \"\"\"ğŸ“ Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯Ø©\n\nØ£Ø±Ø³Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ:\ndeposit Ø§Ø³Ù…_Ø§Ù„Ø¨Ù†Ùƒ ØªÙØ§ØµÙŠÙ„_Ø§Ù„Ø­Ø³Ø§Ø¨\nØ£Ùˆ\nwithdraw Ø§Ø³Ù…_Ø§Ù„Ø´Ø±ÙƒØ© ØªÙØ§ØµÙŠÙ„_Ø§Ù„Ù…Ø­ÙØ¸Ø©\n\nØ£Ù…Ø«Ù„Ø©:\ndeposit Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 1234567890, Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯: Ø´Ø±ÙƒØ© Ø§Ù„Ù†Ø¸Ø§Ù…\n\nwithdraw ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: 01012345678\"\"\"\n        \n        self.send_message(message['chat']['id'], response)\n        self.user_states[message['from']['id']] = 'admin_adding_payment'\n    \n    def show_edit_payment_methods(self, message):\n        \"\"\"Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„\"\"\"\n        all_methods = []\n        try:\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                all_methods = list(csv.DictReader(f))\n        except:\n            pass\n        \n        if not all_methods:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹\", self.admin_keyboard())\n            return\n        \n        response = \"âš™ï¸ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\\n\\n\"\n        \n        deposit_methods = [m for m in all_methods if m['type'] == 'deposit']\n        withdraw_methods = [m for m in all_methods if m['type'] == 'withdraw']\n        \n        response += \"ğŸ’° ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:\\n\"\n        for i, method in enumerate(deposit_methods, 1):\n            status = \"ğŸŸ¢\" if method['is_active'] == 'active' else \"ğŸ”´\"\n            response += f\"{status} {i}. {method['name']}\\n\"\n        \n        response += f\"\\nğŸ’¸ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø­Ø¨:\\n\"\n        for i, method in enumerate(withdraw_methods, 1):\n            status = \"ğŸŸ¢\" if method['is_active'] == 'active' else \"ğŸ”´\"\n            response += f\"{status} {i}. {method['name']}\\n\"\n        \n        response += f\"\\nğŸ’¡ Ù„Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹: delete Ø±Ù‚Ù…_Ø§Ù„ÙˆØ³ÙŠÙ„Ø©\\nÙ…Ø«Ø§Ù„: delete 1\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n        self.user_states[message['from']['id']] = 'admin_editing_payment'\n    \n    def handle_start(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„\"\"\"\n        user_info = message['from']\n        user = self.find_user(user_info['id'])\n        \n        if not user:\n            text = f\"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user_info['first_name']}! ğŸ‰\\n\\nÙ…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… LangSense Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…\\n\\nÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„\"\n            keyboard = {\n                'keyboard': [[{'text': 'ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'request_contact': True}]],\n                'resize_keyboard': True,\n                'one_time_keyboard': True\n            }\n            self.send_message(message['chat']['id'], text, keyboard)\n        else:\n            if self.is_user_banned(user_info['id']):\n                self.send_message(message['chat']['id'], f\"ğŸš« Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±\\nØ§Ù„Ø³Ø¨Ø¨: {user.get('ban_reason', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\\n\\nØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\")\n                return\n            \n            lang = user.get('language', 'ar')\n            text = f\"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user['name']}! ğŸ‘‹\\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['customer_id']}\\n\\nØ§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\"\n            self.send_message(message['chat']['id'], text, self.main_keyboard(lang))\n    \n    def handle_contact(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù‡Ø§ØªÙ\"\"\"\n        contact = message['contact']\n        user_info = message['from']\n        \n        if contact['user_id'] == user_info['id']:\n            customer_id = f\"C{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n            \n            with open('users.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([\n                    user_info['id'], user_info['first_name'], contact['phone_number'], \n                    customer_id, 'ar', datetime.now().strftime('%Y-%m-%d %H:%M'), 'no', ''\n                ])\n            \n            text = f\"âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {contact['phone_number']}\\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_id}\\n\\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\"\n            self.send_message(message['chat']['id'], text, self.main_keyboard())\n    \n    def process_deposit_amount(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\"\"\"\n        if not message['text'].isdigit():\n            self.send_message(message['chat']['id'], \"âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·)\")\n            return\n        \n        amount = message['text']\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id, '')\n        \n        if not state.startswith('deposit_amount_'):\n            return\n        \n        trans_id = state.replace('deposit_amount_', '')\n        \n        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø¨Ø§Ù„Ù…Ø¨Ù„Øº\n        transactions = []\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == trans_id:\n                        row['amount'] = amount\n                        row['status'] = 'pending'\n                        row['receipt_info'] = 'awaiting_receipt'\n                    transactions.append(row)\n            \n            with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                fieldnames = ['id', 'customer_id', 'telegram_id', 'name', 'type', 'amount', 'status', 'date', 'admin_note', 'payment_method', 'receipt_info', 'processed_by']\n                writer = csv.DictWriter(f, fieldnames=fieldnames)\n                writer.writeheader()\n                writer.writerows(transactions)\n        except:\n            pass\n        \n        # Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù…Ø­Ø³Ù† Ù„Ù„Ø£Ø¯Ù…Ù† Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ ÙƒØ§Ù…Ù„Ø©\n        user = self.find_user(user_id)\n        admin_notification = f\"\"\"ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø­Ø¯Ø« - Ù…Ø±Ø­Ù„Ø© 2\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ“± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…: {user['telegram_id']}\nğŸ’µ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: {amount} Ø±ÙŠØ§Ù„\nğŸ“… Ø§Ù„ÙˆÙ‚Øª: {datetime.now().strftime('%Y-%m-%d %H:%M')}\nğŸ”¢ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: Ø§Ù†ØªØ¸Ø§Ø± Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„\n\nğŸ¯ Ø§Ù„Ø·Ù„Ø¨ Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©\nğŸ“‹ Ø§Ø³ØªØ®Ø¯Ù…: /pending Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\nâœ… Ø§Ø³ØªØ®Ø¯Ù…: /approve {trans_id} Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©\nâŒ Ø§Ø³ØªØ®Ø¯Ù…: /reject {trans_id} Ø§Ù„Ø³Ø¨Ø¨ Ù„Ù„Ø±ÙØ¶\n\nğŸ”” Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ ÙÙˆØ± Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„\"\"\"\n        \n        self.notify_admins(admin_notification)\n        \n        response = f\"âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\\n\\nğŸ“¸ Ø§Ù„Ø¢Ù† ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„\\n\\nØ¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„ØŒ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©\"\n        \n        self.send_message(message['chat']['id'], response)\n        self.user_states[user_id] = f'deposit_receipt_{trans_id}'\n    \n    def process_admin_search(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        query = message['text']\n        results = self.search_users(query)\n        \n        if not results:\n            response = f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«: {query}\"\n        else:\n            response = f\"ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: {query}\\n\\n\"\n            for user in results:\n                ban_status = \"ğŸš« Ù…Ø­Ø¸ÙˆØ±\" if user.get('is_banned') == 'yes' else \"âœ… Ù†Ø´Ø·\"\n                response += f\"ğŸ‘¤ {user['name']}\\nğŸ†” {user['customer_id']}\\nğŸ“± {user['phone']}\\nğŸ”¸ {ban_status}\\n\\n\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n        del self.user_states[message['from']['id']]\n    \n    def process_admin_broadcast(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ\"\"\"\n        broadcast_message = message['text']\n        users_count = 0\n        success_count = 0\n        \n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                users = list(csv.DictReader(f))\n                users_count = len(users)\n                \n                for user in users:\n                    if user.get('is_banned', 'no') == 'no':\n                        try:\n                            self.send_message(user['telegram_id'], f\"ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:\\n\\n{broadcast_message}\")\n                            success_count += 1\n                        except:\n                            pass\n        except:\n            pass\n        \n        response = f\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©\\n\\nğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\\nğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {users_count}\\nâœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {success_count}\\nâŒ ÙØ´Ù„: {users_count - success_count}\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n        del self.user_states[message['from']['id']]\n    \n    def process_admin_ban(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        parts = message['text'].split(' ', 1)\n        if len(parts) < 2:\n            self.send_message(message['chat']['id'], \"âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø³Ø¨Ø¨\\nÙ…Ø«Ø§Ù„: C000001 Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø´Ø±ÙˆØ·\", self.admin_keyboard())\n            del self.user_states[message['from']['id']]\n            return\n        \n        customer_id = parts[0]\n        reason = parts[1] if len(parts) > 1 else 'Ù„Ù… ÙŠØ°ÙƒØ± Ø³Ø¨Ø¨'\n        \n        if self.ban_user(customer_id, reason, str(message['from']['id'])):\n            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù‡\n            user = None\n            try:\n                with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                    reader = csv.DictReader(f)\n                    for row in reader:\n                        if row['customer_id'] == customer_id:\n                            user = row\n                            break\n            except:\n                pass\n            \n            if user:\n                try:\n                    self.send_message(user['telegram_id'], f\"ğŸš« ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ\\n\\nØ§Ù„Ø³Ø¨Ø¨: {reason}\\n\\nÙ„Ù„Ø§Ø³ØªÙØ³Ø§Ø± ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\")\n                except:\n                    pass\n            \n            response = f\"âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id} Ø¨Ù†Ø¬Ø§Ø­\\nØ§Ù„Ø³Ø¨Ø¨: {reason}\"\n        else:\n            response = f\"âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø¸Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id}\\nØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n        del self.user_states[message['from']['id']]\n    \n    def process_admin_unban(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        customer_id = message['text'].strip()\n        \n        if self.unban_user(customer_id):\n            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù‡\n            user = None\n            try:\n                with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                    reader = csv.DictReader(f)\n                    for row in reader:\n                        if row['customer_id'] == customer_id:\n                            user = row\n                            break\n            except:\n                pass\n            \n            if user:\n                try:\n                    self.send_message(user['telegram_id'], f\"âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ\\n\\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª\")\n                except:\n                    pass\n            \n            response = f\"âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id} Ø¨Ù†Ø¬Ø§Ø­\"\n        else:\n            response = f\"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id}\\nØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n        del self.user_states[message['from']['id']]\n    \n    def unban_user(self, customer_id):\n        \"\"\"Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        users = []\n        success = False\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == customer_id:\n                        row['is_banned'] = 'no'\n                        row['ban_reason'] = ''\n                        success = True\n                    users.append(row)\n            \n            if success:\n                with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date', 'is_banned', 'ban_reason']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(users)\n        except:\n            pass\n        return success\n    \n    def process_admin_add_payment(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\"\"\"\n        try:\n            parts = message['text'].split(' ', 2)\n            if len(parts) < 3:\n                self.send_message(message['chat']['id'], \"âŒ ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Ø·Ø¦. Ø§Ø³ØªØ®Ø¯Ù…:\\ndeposit Ø§Ø³Ù…_Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„ØªÙØ§ØµÙŠÙ„\", self.admin_keyboard())\n                del self.user_states[message['from']['id']]\n                return\n            \n            method_type = parts[0]\n            method_name = parts[1]\n            method_details = parts[2]\n            \n            if method_type not in ['deposit', 'withdraw']:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ù„Ù†ÙˆØ¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† deposit Ø£Ùˆ withdraw\", self.admin_keyboard())\n                del self.user_states[message['from']['id']]\n                return\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯\n            new_id = str(int(datetime.now().timestamp()))\n            \n            with open('payment_methods.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([new_id, method_name, method_type, method_details, 'active', datetime.now().strftime('%Y-%m-%d')])\n            \n            response = f\"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!\\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {new_id}\\nğŸ“ {method_name} ({method_type})\"\n            \n            self.send_message(message['chat']['id'], response, self.admin_keyboard())\n            del self.user_states[message['from']['id']]\n            \n        except Exception as e:\n            self.send_message(message['chat']['id'], f\"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}\", self.admin_keyboard())\n            del self.user_states[message['from']['id']]\n    \n    def process_admin_edit_payment(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\"\"\"\n        text = message['text'].strip().lower()\n        \n        if text.startswith('delete '):\n            try:\n                method_id = text.split(' ')[1]\n                \n                # Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ù„\n                methods = []\n                found = False\n                with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                    reader = csv.DictReader(f)\n                    for row in reader:\n                        if row['id'] != method_id:\n                            methods.append(row)\n                        else:\n                            found = True\n                \n                if found:\n                    # Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©\n                    with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                        fieldnames = ['id', 'name', 'type', 'details', 'is_active', 'created_date']\n                        writer = csv.DictWriter(f, fieldnames=fieldnames)\n                        writer.writeheader()\n                        writer.writerows(methods)\n                    \n                    response = f\"âœ… ØªÙ… Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø±Ù‚Ù… {method_id}\"\n                else:\n                    response = f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ø¨Ø±Ù‚Ù… {method_id}\"\n                    \n            except:\n                response = \"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù…\"\n        else:\n            response = \"âŒ Ø£Ù…Ø± ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù…: delete Ø±Ù‚Ù…_Ø§Ù„ÙˆØ³ÙŠÙ„Ø©\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n        del self.user_states[message['from']['id']]\n\n    def show_system_settings(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        try:\n            settings_text = \"âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©:\\n\\n\"\n            \n            with open('system_settings.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    settings_text += f\"ğŸ”¹ <b>{row['description']}</b>\\n\"\n                    settings_text += f\"ğŸ“ Ø§Ù„Ù…ÙØªØ§Ø­: <code>{row['setting_key']}</code>\\n\"\n                    settings_text += f\"ğŸ’¬ Ø§Ù„Ù‚ÙŠÙ…Ø©: {row['setting_value']}\\n\\n\"\n            \n            settings_text += \"\\nğŸ“– Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:\\n\"\n            settings_text += \"/editsetting Ù…ÙØªØ§Ø­_Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\\n\"\n            settings_text += \"\\nÙ…Ø«Ø§Ù„:\\n/editsetting support_phone +966502345678\"\n            \n            self.send_message(message['chat']['id'], settings_text, self.admin_keyboard())\n            \n        except Exception as e:\n            self.send_message(message['chat']['id'], f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: {str(e)}\", self.admin_keyboard())\n    \n    def handle_edit_setting(self, message):\n        \"\"\"ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        try:\n            parts = message['text'].split(' ', 2)\n            if len(parts) < 3:\n                self.send_message(message['chat']['id'], \"âŒ ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Ø·Ø¦. Ø§Ø³ØªØ®Ø¯Ù…:\\n/editsetting Ù…ÙØªØ§Ø­_Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\", self.admin_keyboard())\n                return\n            \n            setting_key = parts[1]\n            new_value = parts[2]\n            \n            # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\n            settings = []\n            found = False\n            with open('system_settings.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['setting_key'] == setting_key:\n                        row['setting_value'] = new_value\n                        found = True\n                    settings.append(row)\n            \n            if found:\n                # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©\n                with open('system_settings.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['setting_key', 'setting_value', 'description']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(settings)\n                \n                response = f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« {setting_key} Ø¥Ù„Ù‰: {new_value}\"\n            else:\n                response = f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ø§Ù„Ù…ÙØªØ§Ø­: {setting_key}\"\n                \n        except Exception as e:\n            response = f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: {str(e)}\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n    \n    def handle_add_company(self, message):\n        \"\"\"Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©\"\"\"\n        try:\n            parts = message['text'].split(' ', 3)\n            if len(parts) < 4:\n                self.send_message(message['chat']['id'], \n                    \"âŒ ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Ø·Ø¦. Ø§Ø³ØªØ®Ø¯Ù…:\\n/addcompany Ø§Ø³Ù…_Ø§Ù„Ø´Ø±ÙƒØ© Ù†ÙˆØ¹_Ø§Ù„Ø®Ø¯Ù…Ø© ØªÙØ§ØµÙŠÙ„_Ø§Ù„Ø´Ø±ÙƒØ©\\n\\n\"\n                    \"Ù…Ø«Ø§Ù„:\\n/addcompany \\\"ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´\\\" withdraw \\\"Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©\\\"\", \n                    self.admin_keyboard())\n                return\n            \n            company_name = parts[1].strip('\"')\n            service_type = parts[2]\n            company_details = parts[3].strip('\"')\n            \n            if service_type not in ['deposit', 'withdraw', 'both']:\n                self.send_message(message['chat']['id'], \"âŒ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†: deposit, withdraw, Ø£Ùˆ both\", self.admin_keyboard())\n                return\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯\n            new_id = str(int(datetime.now().timestamp()))\n            \n            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù…Ù„Ù ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\n            with open('payment_methods.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([new_id, company_name, service_type, company_details, 'active', datetime.now().strftime('%Y-%m-%d')])\n            \n            response = f\"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!\\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {new_id}\\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {company_name}\\nâš¡ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©: {service_type}\"\n            \n        except Exception as e:\n            response = f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©: {str(e)}\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n    \n    def handle_edit_company(self, message):\n        \"\"\"ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙƒØ© Ù…ÙˆØ¬ÙˆØ¯Ø©\"\"\"\n        try:\n            parts = message['text'].split(' ', 4)\n            if len(parts) < 5:\n                self.send_message(message['chat']['id'], \n                    \"âŒ ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Ø·Ø¦. Ø§Ø³ØªØ®Ø¯Ù…:\\n/editcompany Ù…Ø¹Ø±Ù_Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ø³Ù…_Ø¬Ø¯ÙŠØ¯ Ù†ÙˆØ¹_Ø§Ù„Ø®Ø¯Ù…Ø© ØªÙØ§ØµÙŠÙ„_Ø¬Ø¯ÙŠØ¯Ø©\", \n                    self.admin_keyboard())\n                return\n            \n            company_id = parts[1]\n            new_name = parts[2].strip('\"')\n            new_type = parts[3]\n            new_details = parts[4].strip('\"')\n            \n            # Ù‚Ø±Ø§Ø¡Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª\n            companies = []\n            found = False\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == company_id:\n                        row['name'] = new_name\n                        row['type'] = new_type\n                        row['details'] = new_details\n                        found = True\n                    companies.append(row)\n            \n            if found:\n                # Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù\n                with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'name', 'type', 'details', 'is_active', 'created_date']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(companies)\n                \n                response = f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø±ÙƒØ© Ø±Ù‚Ù… {company_id}\\nğŸ¢ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯: {new_name}\"\n            else:\n                response = f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙƒØ© Ø¨Ø±Ù‚Ù… {company_id}\"\n                \n        except Exception as e:\n            response = f\"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ©: {str(e)}\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n    \n    def handle_delete_company(self, message):\n        \"\"\"Ø­Ø°Ù Ø´Ø±ÙƒØ©\"\"\"\n        try:\n            parts = message['text'].split(' ')\n            if len(parts) < 2:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø³ØªØ®Ø¯Ù…: /deletecompany Ù…Ø¹Ø±Ù_Ø§Ù„Ø´Ø±ÙƒØ©\", self.admin_keyboard())\n                return\n            \n            company_id = parts[1]\n            \n            # Ù‚Ø±Ø§Ø¡Ø© ÙˆØ­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©\n            companies = []\n            found = False\n            deleted_name = \"\"\n            \n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] != company_id:\n                        companies.append(row)\n                    else:\n                        found = True\n                        deleted_name = row['name']\n            \n            if found:\n                # Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©\n                with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'name', 'type', 'details', 'is_active', 'created_date']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(companies)\n                \n                response = f\"âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©: {deleted_name}\"\n            else:\n                response = f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙƒØ© Ø¨Ø±Ù‚Ù… {company_id}\"\n                \n        except Exception as e:\n            response = f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©: {str(e)}\"\n        \n        self.send_message(message['chat']['id'], response, self.admin_keyboard())\n    \n    def run(self):\n        \"\"\"ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª\"\"\"\n        test_result = self.api_call('getMe')\n        if not test_result or not test_result.get('ok'):\n            logger.error(\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆÙƒÙ†!\")\n            return\n        \n        bot_info = test_result['result']\n        logger.info(f\"âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ÙŠØ¹Ù…Ù„: @{bot_info['username']}\")\n        \n        while True:\n            try:\n                updates = self.get_updates()\n                if updates and updates.get('ok'):\n                    for update in updates['result']:\n                        self.offset = update['update_id']\n                        if 'message' in update:\n                            message = update['message']\n                            if 'text' in message:\n                                if message['text'] == '/start':\n                                    self.handle_start(message)\n                                else:\n                                    self.handle_text(message)\n                            elif 'contact' in message:\n                                self.handle_contact(message)\n                time.sleep(1)\n            except KeyboardInterrupt:\n                logger.info(\"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù…\")\n                break\n            except Exception as e:\n                logger.error(f\"Ø®Ø·Ø£: {e}\")\n                time.sleep(3)\n\nif __name__ == '__main__':\n    bot_token = os.getenv('BOT_TOKEN')\n    if not bot_token:\n        print(\"âŒ ÙŠØ±Ø¬Ù‰ ØªØ¹ÙŠÙŠÙ† BOT_TOKEN\")\n        exit(1)\n    \n    bot = AdvancedLangSenseBot(bot_token)\n    bot.run()","size_bytes":76433},"bot.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nMain bot module with Aiogram v3 setup\nHandles bot initialization, router registration, and polling\n\"\"\"\n\nimport asyncio\nimport logging\nfrom aiogram import Bot, Dispatcher\nfrom aiogram.client.default import DefaultBotProperties\nfrom aiogram.enums import ParseMode\nfrom aiogram.fsm.storage.memory import MemoryStorage\n\nfrom config import BOT_TOKEN\nfrom handlers import start, admin, broadcast, user_settings, announcements\nfrom services.broadcast_service import BroadcastService\n\nlogger = logging.getLogger(__name__)\n\n# Global variables for dependency injection\nbot_instance = None\nsession_maker = None\nbroadcast_service = None\n\nasync def main(async_session):\n    \"\"\"Main bot function\"\"\"\n    global bot_instance, session_maker, broadcast_service\n    \n    try:\n        # Validate bot token\n        if not BOT_TOKEN:\n            raise ValueError(\"BOT_TOKEN is not set in environment variables\")\n        \n        # Initialize bot and dispatcher\n        bot_instance = Bot(\n            token=BOT_TOKEN,\n            default=DefaultBotProperties(parse_mode=ParseMode.HTML)\n        )\n        \n        # Test bot token\n        bot_info = await bot_instance.get_me()\n        logger.info(f\"Bot initialized: @{bot_info.username} ({bot_info.first_name})\")\n        \n        # Set session maker for handlers\n        session_maker = async_session\n        \n        # Initialize dispatcher with memory storage\n        storage = MemoryStorage()\n        dp = Dispatcher(storage=storage)\n        \n        # Initialize broadcast service\n        broadcast_service = BroadcastService(bot_instance, async_session)\n        \n        # Register routers\n        dp.include_routers(\n            start.router,\n            user_settings.router,\n            admin.router,\n            broadcast.router,\n            announcements.router\n        )\n        \n        # Set session maker and services for handlers\n        for router in [start.router, user_settings.router, admin.router, \n                      broadcast.router, announcements.router]:\n            router.message.middleware.register(SessionMiddleware(async_session))\n            router.callback_query.middleware.register(SessionMiddleware(async_session))\n        \n        # Start broadcast service worker\n        asyncio.create_task(broadcast_service.worker())\n        logger.info(\"Broadcast service worker started\")\n        \n        # Start polling\n        logger.info(\"Starting bot polling...\")\n        await dp.start_polling(bot_instance)\n        \n    except Exception as e:\n        logger.error(f\"Bot startup failed: {e}\")\n        raise\n    finally:\n        if bot_instance:\n            await bot_instance.session.close()\n\nclass SessionMiddleware:\n    \"\"\"Middleware to inject database session into handlers\"\"\"\n    \n    def __init__(self, session_maker):\n        self.session_maker = session_maker\n    \n    async def __call__(self, handler, event, data):\n        data['session_maker'] = self.session_maker\n        data['broadcast_service'] = broadcast_service\n        return await handler(event, data)\n\ndef get_bot():\n    \"\"\"Get bot instance for external use\"\"\"\n    return bot_instance\n\ndef get_session_maker():\n    \"\"\"Get session maker for external use\"\"\"\n    return session_maker\n\ndef get_broadcast_service():\n    \"\"\"Get broadcast service for external use\"\"\"\n    return broadcast_service\n","size_bytes":3344},"comprehensive_bot.py":{"content":"#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\nimport os\nimport json\nimport csv\nimport urllib.request\nimport urllib.parse\nimport logging\nimport threading\nimport time\nimport zipfile\nfrom datetime import datetime\n\n# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„\nlogging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')\nlogger = logging.getLogger(__name__)\n\nclass ComprehensiveDUXBot:\n    def __init__(self, token):\n        self.token = token\n        self.api_url = f\"https://api.telegram.org/bot{token}\"\n        self.offset = 0\n        self.user_states = {}\n        self.temp_company_data = {}  # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…ÙÙ‚ÙˆØ¯\n        self.init_files()\n        self.admin_ids = self.get_admin_ids()\n        \n        # Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ\n        self.start_backup_scheduler()\n        \n    def init_files(self):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        # Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        if not os.path.exists('users.csv'):\n            with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date', 'is_banned', 'ban_reason'])\n        \n        # Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…\n        if not os.path.exists('transactions.csv'):\n            with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'customer_id', 'telegram_id', 'name', 'type', 'company', 'wallet_number', 'amount', 'exchange_address', 'status', 'date', 'admin_note', 'processed_by'])\n        \n        # Ù…Ù„Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª\n        if not os.path.exists('companies.csv'):\n            with open('companies.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'name', 'type', 'details', 'is_active'])\n                # Ø´Ø±ÙƒØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©\n                companies = [\n                    ['1', 'STC Pay', 'both', 'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©', 'active'],\n                    ['2', 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ', 'deposit', 'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ Ø±Ù‚Ù…: 1234567890', 'active'],\n                    ['3', 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´', 'both', 'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©', 'active'],\n                    ['4', 'Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', 'deposit', 'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ Ø±Ù‚Ù…: 0987654321', 'active'],\n                    ['5', 'Ù…Ø¯Ù‰ Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ', 'withdraw', 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù„Ù„Ø³Ø­Ø¨', 'active']\n                ]\n                for company in companies:\n                    writer.writerow(company)\n        \n        # Ù…Ù„Ù Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØµØ±Ø§ÙØ©\n        if not os.path.exists('exchange_addresses.csv'):\n            with open('exchange_addresses.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'address', 'is_active'])\n                writer.writerow(['1', 'Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯ØŒ Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ù…Ù‚Ø§Ø¨Ù„ Ù…ÙˆÙ„ Ø§Ù„Ø±ÙŠØ§Ø¶ - Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø£ÙˆÙ„', 'yes'])\n        \n        # Ù…Ù„Ù Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰\n        if not os.path.exists('complaints.csv'):\n            with open('complaints.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'customer_id', 'message', 'status', 'date', 'admin_response'])\n        \n        # Ù…Ù„Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\n        if not os.path.exists('system_settings.csv'):\n            with open('system_settings.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['setting_key', 'setting_value', 'description'])\n                settings = [\n                    ['min_deposit', '50', 'Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ø¥ÙŠØ¯Ø§Ø¹'],\n                    ['min_withdrawal', '100', 'Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ø³Ø­Ø¨'],\n                    ['max_daily_withdrawal', '10000', 'Ø£Ù‚ØµÙ‰ Ø³Ø­Ø¨ ÙŠÙˆÙ…ÙŠ'],\n                    ['support_phone', '+966501234567', 'Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…'],\n                    ['company_name', 'DUX', 'Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©']\n                ]\n                for setting in settings:\n                    writer.writerow(setting)\n        \n        logger.info(\"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­\")\n        \n    def api_call(self, method, data=None):\n        \"\"\"Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù…ÙØ­Ø³Ù†\"\"\"\n        url = f\"{self.api_url}/{method}\"\n        try:\n            if data:\n                json_data = json.dumps(data).encode('utf-8')\n                req = urllib.request.Request(url, data=json_data)\n                req.add_header('Content-Type', 'application/json')\n            else:\n                req = urllib.request.Request(url)\n            \n            with urllib.request.urlopen(req, timeout=10) as response:\n                return json.loads(response.read().decode('utf-8'))\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ API: {e}\")\n            return None\n    \n    def send_message(self, chat_id, text, keyboard=None):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©\"\"\"\n        data = {'chat_id': chat_id, 'text': text, 'parse_mode': 'HTML'}\n        if keyboard:\n            data['reply_markup'] = keyboard\n        return self.api_call('sendMessage', data)\n    \n    def get_updates(self):\n        \"\"\"Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª\"\"\"\n        url = f\"{self.api_url}/getUpdates?offset={self.offset + 1}&timeout=10\"\n        try:\n            with urllib.request.urlopen(url, timeout=15) as response:\n                return json.loads(response.read().decode('utf-8'))\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª: {e}\")\n            return None\n    \n    def get_admin_ids(self):\n        \"\"\"Ø¬Ù„Ø¨ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        admin_ids = os.getenv('ADMIN_USER_IDS', '').split(',')\n        return [admin_id.strip() for admin_id in admin_ids if admin_id.strip()]\n    \n    def is_admin(self, telegram_id):\n        \"\"\"ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        return str(telegram_id) in self.admin_ids\n    \n    def notify_admins(self, message):\n        \"\"\"Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        for admin_id in self.admin_ids:\n            try:\n                self.send_message(admin_id, message, self.admin_keyboard())\n            except:\n                pass\n    \n    def find_user(self, telegram_id):\n        \"\"\"Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['telegram_id'] == str(telegram_id):\n                        return row\n        except:\n            pass\n        return None\n    \n    def get_companies(self, service_type=None):\n        \"\"\"Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©\"\"\"\n        companies = []\n        try:\n            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ù†Ø´Ø·Ø©\n                    if row.get('is_active', '').lower() in ['active', 'yes', '1', 'true']:\n                        # ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©\n                        if not service_type:\n                            companies.append(row)\n                        elif row['type'] == service_type or row['type'] == 'both':\n                            companies.append(row)\n        except FileNotFoundError:\n            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹\n            with open('companies.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'name', 'type', 'details', 'is_active'])\n        except Exception as e:\n            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø·Ø£ Ù„Ù„ØªØ´Ø®ÙŠØµ\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª: {e}\")\n        \n        return companies\n    \n    def get_exchange_address(self):\n        \"\"\"Ø¬Ù„Ø¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ±Ø§ÙØ© Ø§Ù„Ù†Ø´Ø·\"\"\"\n        try:\n            with open('exchange_addresses.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['is_active'] == 'yes':\n                        return row['address']\n        except:\n            pass\n        return \"Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹\"\n    \n    def get_setting(self, key):\n        \"\"\"Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        try:\n            with open('system_settings.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['setting_key'] == key:\n                        return row['setting_value']\n        except:\n            pass\n        return None\n    \n    def main_keyboard(self, lang='ar'):\n        \"\"\"Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\"\"\"\n        if lang == 'ar':\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨'}],\n                    [{'text': 'ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ'}, {'text': 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ'}],\n                    [{'text': 'ğŸ“¨ Ø´ÙƒÙˆÙ‰'}, {'text': 'ğŸ†˜ Ø¯Ø¹Ù…'}],\n                    [{'text': 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†'}, {'text': 'ğŸ‡ºğŸ‡¸ English'}],\n                    [{'text': '/admin'}]\n                ],\n                'resize_keyboard': True\n            }\n        else:\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Deposit Request'}, {'text': 'ğŸ’¸ Withdrawal Request'}],\n                    [{'text': 'ğŸ“‹ My Requests'}, {'text': 'ğŸ‘¤ Profile'}],\n                    [{'text': 'ğŸ“¨ Complaint'}, {'text': 'ğŸ†˜ Support'}],\n                    [{'text': 'ğŸ”„ Reset System'}, {'text': 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'}],\n                    [{'text': '/admin'}]\n                ],\n                'resize_keyboard': True\n            }\n    \n    def admin_keyboard(self):\n        \"\"\"Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø´Ø§Ù…Ù„Ø©\"\"\"\n        return {\n            'keyboard': [\n                [{'text': 'ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©'}, {'text': 'âœ… Ø·Ù„Ø¨Ø§Øª Ù…ÙÙˆØ§ÙÙ‚Ø©'}],\n                [{'text': 'ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'}, {'text': 'ğŸ” Ø§Ù„Ø¨Ø­Ø«'}],\n                [{'text': 'ğŸ’³ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹'}, {'text': 'ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª'}],\n                [{'text': 'ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ'}, {'text': 'ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…'}],\n                [{'text': 'âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±'}, {'text': 'ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ©'}],\n                [{'text': 'âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª'}, {'text': 'ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†'}],\n                [{'text': 'ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹Ù…'}],\n                [{'text': 'âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…'}, {'text': 'ğŸ“¨ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰'}],\n                [{'text': 'ğŸ“‹ Ù†Ø³Ø® Ø£ÙˆØ§Ù…Ø± Ø³Ø±ÙŠØ¹Ø©'}, {'text': 'ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¹Ù…ÙŠÙ„'}],\n                [{'text': 'ğŸ’¾ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙˆØ±ÙŠØ©'}, {'text': 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…'}],\n                [{'text': 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}]\n            ],\n            'resize_keyboard': True,\n            'one_time_keyboard': False\n        }\n    \n    def companies_keyboard(self, service_type):\n        \"\"\"Ù„ÙˆØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª Ù…Ø¹ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ\"\"\"\n        companies = self.get_companies(service_type)\n        keyboard = []\n        \n        # Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª\n        for company in companies:\n            keyboard.append([{'text': f\"ğŸ¢ {company['name']}\"}])\n        \n        # Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†\n        keyboard.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}, {'text': 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…'}])\n        \n        return {'keyboard': keyboard, 'resize_keyboard': True, 'one_time_keyboard': True}\n    \n    def handle_start(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\"\"\"\n        chat_id = message['chat']['id']\n        user_id = message['from']['id']\n        \n        # ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯\n        user = self.find_user(user_id)\n        if user:\n            if user.get('is_banned') == 'yes':\n                ban_reason = user.get('ban_reason', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')\n                self.send_message(chat_id, f\"âŒ ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ\\nØ§Ù„Ø³Ø¨Ø¨: {ban_reason}\\n\\nÙ„Ù„Ø§Ø³ØªÙØ³Ø§Ø± ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\")\n                return\n            \n            welcome_text = f\"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ {user['name']}! ğŸ‘‹\\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['customer_id']}\"\n            self.send_message(chat_id, welcome_text, self.main_keyboard(user.get('language', 'ar')))\n        else:\n            welcome_text = \"\"\"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… DUX Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…! ğŸ‘‹\n\nğŸ”¹ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø­Ø¨\nğŸ”¹ Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…ØªØ®ØµØµ\nğŸ”¹ Ø£Ù…Ø§Ù† ÙˆÙ…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø¹Ø§Ù„ÙŠØ©\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ³Ø¬ÙŠÙ„:\"\"\"\n            self.send_message(chat_id, welcome_text)\n            self.user_states[user_id] = 'registering_name'\n    \n    def handle_registration(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id)\n        \n        if state == 'registering_name':\n            name = message['text'].strip()\n            if len(name) < 2:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            self.user_states[user_id] = f'registering_phone_{name}'\n            \n            # ÙƒÙŠØ¨ÙˆØ±Ø¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„\n            contact_keyboard = {\n                'keyboard': [\n                    [{'text': 'ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'request_contact': True}],\n                    [{'text': 'âœï¸ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹'}],\n                    [{'text': 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': True\n            }\n            \n            phone_message = \"\"\"Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø¢Ù† Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ:\n\nğŸ“± ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù…Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ \"ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\"\nâœï¸ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¨Ù„Ø¯ (Ù…Ø«Ø§Ù„: +966501234567)\"\"\"\n            \n            self.send_message(message['chat']['id'], phone_message, contact_keyboard)\n            \n        elif state.startswith('registering_phone_'):\n            name = state.replace('registering_phone_', '')\n            \n            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©\n            if 'contact' in message:\n                # Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„\n                phone = message['contact']['phone_number']\n                if not phone.startswith('+'):\n                    phone = '+' + phone\n            elif 'text' in message:\n                text = message['text'].strip()\n                \n                if text == 'âœï¸ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹':\n                    manual_text = \"\"\"âœï¸ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¨Ù„Ø¯:\n\nÙ…Ø«Ø§Ù„: +966501234567\nÙ…Ø«Ø§Ù„: +201234567890\"\"\"\n                    self.send_message(message['chat']['id'], manual_text)\n                    return\n                \n                phone = text\n                if len(phone) < 10:\n                    self.send_message(message['chat']['id'], \"âŒ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¨Ù„Ø¯:\")\n                    return\n            else:\n                self.send_message(message['chat']['id'], \"âŒ ÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù…:\")\n                return\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ\n            customer_id = f\"C{str(int(datetime.now().timestamp()))[-6:]}\"\n            \n            # Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n            with open('users.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([user_id, name, phone, customer_id, 'ar', \n                               datetime.now().strftime('%Y-%m-%d'), 'no', ''])\n            \n            welcome_text = f\"\"\"âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {name}\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {phone}\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_id}\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {datetime.now().strftime('%Y-%m-%d')}\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©:\"\"\"\n            \n            self.send_message(message['chat']['id'], welcome_text, self.main_keyboard())\n            del self.user_states[user_id]\n            \n            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯\n            admin_msg = f\"\"\"ğŸ†• Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯ Ø§Ù†Ø¶Ù… Ù„Ù„Ù†Ø¸Ø§Ù…\n\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {name}\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {phone}\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_id}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\"\"\"\n            self.notify_admins(admin_msg)\n    \n    def create_deposit_request(self, message):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        # Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ø¹ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ\n        deposit_companies = self.get_companies('deposit')\n        if not deposit_companies:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø­Ø§Ù„ÙŠØ§Ù‹\\n\\nØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\")\n            return\n        \n        companies_text = \"ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯\\n\\nğŸ¢ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹:\\n\\n\"\n        for company in deposit_companies:\n            type_display = {'deposit': 'Ø¥ÙŠØ¯Ø§Ø¹', 'withdraw': 'Ø³Ø­Ø¨', 'both': 'Ø§Ù„ÙƒÙ„'}.get(company['type'], company['type'])\n            companies_text += f\"ğŸ”¹ {company['name']} ({type_display}) - {company['details']}\\n\"\n        \n        companies_text += f\"\\nğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: {len(deposit_companies)}\"\n        \n        self.send_message(message['chat']['id'], companies_text, self.companies_keyboard('deposit'))\n        self.user_states[message['from']['id']] = 'selecting_deposit_company'\n    \n    def create_withdrawal_request(self, message):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø³Ø­Ø¨\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        # Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø³Ø­Ø¨ Ù…Ø¹ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ\n        withdraw_companies = self.get_companies('withdraw')\n        if not withdraw_companies:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø³Ø­Ø¨ Ø­Ø§Ù„ÙŠØ§Ù‹\\n\\nØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø³Ø­Ø¨\")\n            return\n        \n        companies_text = \"ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯\\n\\nğŸ¢ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø³Ø­Ø¨:\\n\\n\"\n        for company in withdraw_companies:\n            type_display = {'deposit': 'Ø¥ÙŠØ¯Ø§Ø¹', 'withdraw': 'Ø³Ø­Ø¨', 'both': 'Ø§Ù„ÙƒÙ„'}.get(company['type'], company['type'])\n            companies_text += f\"ğŸ”¹ {company['name']} ({type_display}) - {company['details']}\\n\"\n        \n        companies_text += f\"\\nğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: {len(withdraw_companies)}\"\n        \n        self.send_message(message['chat']['id'], companies_text, self.companies_keyboard('withdraw'))\n        self.user_states[message['from']['id']] = 'selecting_withdraw_company'\n    \n    def process_deposit_flow(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¯ÙÙ‚ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„ÙƒØ§Ù…Ù„\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id, '')\n        text = message['text']\n        \n        if state == 'selecting_deposit_company':\n            # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©\n            selected_company_name = text.replace('ğŸ¢ ', '')\n            \n            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n            companies = self.get_companies('deposit')\n            selected_company = None\n            for company in companies:\n                if company['name'] == selected_company_name:\n                    selected_company = company\n                    break\n            \n            if not selected_company:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:\")\n                return\n            \n            # Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n            self.show_payment_method_selection(message, selected_company['id'], 'deposit')\n            \n        elif state.startswith('deposit_wallet_'):\n            parts = state.split('_', 3)\n            company_id = parts[2]\n            company_name = parts[3] if len(parts) > 3 else ''\n            method_id = parts[4] if len(parts) > 4 else ''\n            wallet_number = text.strip()\n            \n            if len(wallet_number) < 5:\n                self.send_message(message['chat']['id'], \"âŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©/Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø±Ø­Ù„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº\n            min_deposit = self.get_setting('min_deposit') or '50'\n            amount_text = f\"\"\"âœ… ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\n\nğŸ’° Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥ÙŠØ¯Ø§Ø¹Ù‡:\n\nğŸ“Œ Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹: {min_deposit} Ø±ÙŠØ§Ù„\nğŸ’¡ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ù…Ø«Ø§Ù„: 500)\"\"\"\n            \n            self.send_message(message['chat']['id'], amount_text)\n            self.user_states[user_id] = f'deposit_amount_{company_id}_{company_name}_{method_id}_{wallet_number}'\n            \n        elif state.startswith('deposit_amount_'):\n            parts = state.split('_', 4)\n            company_id = parts[2]\n            company_name = parts[3]\n            method_id = parts[4] if len(parts) > 4 else ''\n            wallet_number = parts[5] if len(parts) > 5 else ''\n            \n            try:\n                amount = float(text.strip())\n                min_deposit = float(self.get_setting('min_deposit') or '50')\n                \n                if amount < min_deposit:\n                    self.send_message(message['chat']['id'], f\"âŒ Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ {min_deposit} Ø±ÙŠØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø±:\")\n                    return\n                    \n            except ValueError:\n                self.send_message(message['chat']['id'], \"âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n            user = self.find_user(user_id)\n            trans_id = f\"DEP{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n            \n            # Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n            with open('transactions.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([trans_id, user['customer_id'], user['telegram_id'], user['name'], \n                               'deposit', company_name, wallet_number, amount, '', 'pending', \n                               datetime.now().strftime('%Y-%m-%d %H:%M'), '', ''])\n            \n            # Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„\n            confirmation = f\"\"\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\nâ³ Ø§Ù„Ø­Ø§Ù„Ø©: ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\n\nØ³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ ÙÙˆØ± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ.\"\"\"\n            \n            self.send_message(message['chat']['id'], confirmation, self.main_keyboard(user.get('language', 'ar')))\n            del self.user_states[user_id]\n            \n            # Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ù„Ø£Ø¯Ù…Ù† Ø¨Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\n            for admin_id in self.admin_ids:\n                try:\n                    admin_notification = f\"\"\"ğŸ”” Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nÙ„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨: Ù…ÙˆØ§ÙÙ‚Ø© {trans_id} Ø£Ùˆ Ø±ÙØ¶ {trans_id} [Ø³Ø¨Ø¨]\"\"\"\n                    self.send_message(admin_id, admin_notification)\n                except:\n                    pass\n    \n    def process_withdrawal_flow(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¯ÙÙ‚ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id, '')\n        text = message['text']\n        \n        if state == 'selecting_withdraw_company':\n            # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©\n            selected_company_name = text.replace('ğŸ¢ ', '')\n            \n            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n            companies = self.get_companies('withdraw')\n            selected_company = None\n            for company in companies:\n                if company['name'] == selected_company_name:\n                    selected_company = company\n                    break\n            \n            if not selected_company:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø±ÙƒØ© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:\")\n                return\n            \n            # Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n            self.show_payment_method_selection(message, selected_company['id'], 'withdraw')\n            \n        elif state.startswith('withdraw_wallet_'):\n            parts = state.split('_', 3)\n            company_id = parts[2]\n            company_name = parts[3] if len(parts) > 3 else ''\n            method_id = parts[4] if len(parts) > 4 else ''\n            wallet_number = text.strip()\n            \n            if len(wallet_number) < 5:\n                self.send_message(message['chat']['id'], \"âŒ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©/Ø§Ù„Ø­Ø³Ø§Ø¨ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø±Ø­Ù„Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº\n            min_withdrawal = self.get_setting('min_withdrawal') or '100'\n            max_withdrawal = self.get_setting('max_daily_withdrawal') or '10000'\n            amount_text = f\"\"\"âœ… ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\n\nğŸ’° Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø­Ø¨Ù‡:\n\nğŸ“Œ Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ù„Ù„Ø³Ø­Ø¨: {min_withdrawal} Ø±ÙŠØ§Ù„\nğŸ“Œ Ø£Ù‚ØµÙ‰ Ù…Ø¨Ù„Øº ÙŠÙˆÙ…ÙŠ: {max_withdrawal} Ø±ÙŠØ§Ù„\nğŸ’¡ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ù…Ø«Ø§Ù„: 1000)\"\"\"\n            \n            self.send_message(message['chat']['id'], amount_text)\n            self.user_states[user_id] = f'withdraw_amount_{company_id}_{company_name}_{method_id}_{wallet_number}'\n            \n        elif state.startswith('withdraw_amount_'):\n            parts = state.split('_', 4)\n            company_id = parts[2]\n            company_name = parts[3]\n            method_id = parts[4] if len(parts) > 4 else ''\n            wallet_number = parts[5] if len(parts) > 5 else ''\n            \n            try:\n                amount = float(text.strip())\n                min_withdrawal = float(self.get_setting('min_withdrawal') or '100')\n                max_withdrawal = float(self.get_setting('max_daily_withdrawal') or '10000')\n                \n                if amount < min_withdrawal:\n                    self.send_message(message['chat']['id'], f\"âŒ Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ù„Ù„Ø³Ø­Ø¨ {min_withdrawal} Ø±ÙŠØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø±:\")\n                    return\n                \n                if amount > max_withdrawal:\n                    self.send_message(message['chat']['id'], f\"âŒ Ø£Ù‚ØµÙ‰ Ù…Ø¨Ù„Øº Ù„Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ {max_withdrawal} Ø±ÙŠØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø£Ù‚Ù„:\")\n                    return\n                    \n            except ValueError:\n                self.send_message(message['chat']['id'], \"âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            # Ø¹Ø±Ø¶ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø«Ø§Ø¨Øª ÙˆØ·Ù„Ø¨ ÙƒÙˆØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯\n            withdrawal_address = self.get_exchange_address()\n            \n            confirm_text = f\"\"\"âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\n\nğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø­Ø¨: \n{withdrawal_address}\n\nğŸ” ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯:\"\"\"\n            \n            self.send_message(message['chat']['id'], confirm_text)\n            self.user_states[user_id] = f'withdraw_confirmation_code_{company_id}_{company_name}_{wallet_number}_{amount}_{withdrawal_address}'\n            \n\n        elif state.startswith('withdraw_confirmation_code_'):\n            # ÙØµÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©\n            data_part = state.replace('withdraw_confirmation_code_', '')\n            parts = data_part.split('_')\n            company_id = parts[0] if len(parts) > 0 else ''\n            company_name = parts[1] if len(parts) > 1 else ''\n            wallet_number = parts[2] if len(parts) > 2 else ''\n            amount = parts[3] if len(parts) > 3 else ''\n            withdrawal_address = parts[4] if len(parts) > 4 else ''\n            confirmation_code = text.strip()\n            \n            if len(confirmation_code) < 3:\n                self.send_message(message['chat']['id'], \"âŒ ÙƒÙˆØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ØµØ­ÙŠØ­:\")\n                return\n            \n            # Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø±\n            final_confirm_text = f\"\"\"ğŸ“‹ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨:\n\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\nğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø­Ø¨: {withdrawal_address}\nğŸ” ÙƒÙˆØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯: {confirmation_code}\n\nØ§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡:\"\"\"\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ£ÙƒÙŠØ¯\n            confirm_keyboard = {\n                'keyboard': [\n                    [{'text': 'âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨'}, {'text': 'âŒ Ø¥Ù„ØºØ§Ø¡'}],\n                    [{'text': 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…'}, {'text': 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': True\n            }\n            \n            self.send_message(message['chat']['id'], final_confirm_text, confirm_keyboard)\n            self.user_states[user_id] = f'withdraw_final_confirm_{company_id}_{company_name}_{wallet_number}_{amount}_{withdrawal_address}_{confirmation_code}'\n            \n        elif state.startswith('withdraw_final_confirm_'):\n            # ÙØµÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø©\n            data_part = state.replace('withdraw_final_confirm_', '')\n            parts = data_part.split('_')\n            company_id = parts[0] if len(parts) > 0 else ''\n            company_name = parts[1] if len(parts) > 1 else ''\n            wallet_number = parts[2] if len(parts) > 2 else ''\n            amount = parts[3] if len(parts) > 3 else ''\n            withdrawal_address = parts[4] if len(parts) > 4 else ''\n            confirmation_code = parts[5] if len(parts) > 5 else ''\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ù„Ø¥Ù„ØºØ§Ø¡\n            if text == 'âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨':\n                # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n                user = self.find_user(user_id)\n                trans_id = f\"WTH{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n                \n                # Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø¹ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø­Ø¨ ÙˆÙƒÙˆØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯\n                with open('transactions.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                    writer = csv.writer(f)\n                    writer.writerow([trans_id, user['customer_id'], user['telegram_id'], user['name'], \n                                   'withdraw', company_name, wallet_number, amount, withdrawal_address, 'pending', \n                                   datetime.now().strftime('%Y-%m-%d %H:%M'), confirmation_code, ''])\n                \n                # Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„\n                confirmation_msg = f\"\"\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\nğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø­Ø¨: {withdrawal_address}\nğŸ” ÙƒÙˆØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯: {confirmation_code}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\nâ³ Ø§Ù„Ø­Ø§Ù„Ø©: ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\n\nØ³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ ÙÙˆØ± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ.\"\"\"\n                \n                self.send_message(message['chat']['id'], confirmation_msg, self.main_keyboard(user.get('language', 'ar')))\n                del self.user_states[user_id]\n                \n                # Ø¥Ø´Ø¹Ø§Ø± ÙÙˆØ±ÙŠ Ù„Ù„Ø£Ø¯Ù…Ù†\n                for admin_id in self.admin_ids:\n                    try:\n                        admin_notification = f\"\"\"ğŸ”” Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']} ({user['customer_id']})\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\nğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³Ø­Ø¨: {withdrawal_address}\nğŸ” ÙƒÙˆØ¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯: {confirmation_code}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nÙ„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨: Ù…ÙˆØ§ÙÙ‚Ø© {trans_id} Ø£Ùˆ Ø±ÙØ¶ {trans_id} [Ø³Ø¨Ø¨]\"\"\"\n                        self.send_message(admin_id, admin_notification)\n                    except:\n                        pass\n                \n            elif text == 'âŒ Ø¥Ù„ØºØ§Ø¡':\n                user = self.find_user(user_id)\n                self.send_message(message['chat']['id'], \"âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨\", self.main_keyboard(user.get('language', 'ar')))\n                del self.user_states[user_id]\n                \n            elif text == 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©':\n                user = self.find_user(user_id)\n                del self.user_states[user_id]\n                welcome_text = f\"\"\"ğŸ  Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ\n\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user.get('name', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user.get('customer_id', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\n\nØ§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\"\"\"\n                self.send_message(message['chat']['id'], welcome_text, self.main_keyboard(user.get('language', 'ar')))\n                \n            else:\n                self.send_message(message['chat']['id'], \"âŒ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©\")\n            \n        # (Ù…Ø¹Ø§Ù„Ø¬ Ù‚Ø¯ÙŠÙ… Ù…Ø­Ø°ÙˆÙ Ù„Ø£Ù† Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡)\n    \n    def show_user_transactions(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        transactions_text = f\"ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['name']}\\n\\n\"\n        found_transactions = False\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == user['customer_id']:\n                        found_transactions = True\n                        status_emoji = \"â³\" if row['status'] == 'pending' else \"âœ…\" if row['status'] == 'approved' else \"âŒ\"\n                        type_emoji = \"ğŸ’°\" if row['type'] == 'deposit' else \"ğŸ’¸\"\n                        \n                        transactions_text += f\"{status_emoji} {type_emoji} {row['id']}\\n\"\n                        transactions_text += f\"ğŸ¢ {row['company']}\\n\"\n                        transactions_text += f\"ğŸ’° {row['amount']} Ø±ÙŠØ§Ù„\\n\"\n                        transactions_text += f\"ğŸ“… {row['date']}\\n\"\n                        \n                        if row['status'] == 'rejected' and row.get('admin_note'):\n                            transactions_text += f\"ğŸ“ Ø§Ù„Ø³Ø¨Ø¨: {row['admin_note']}\\n\"\n                        elif row['status'] == 'approved':\n                            transactions_text += f\"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©\\n\"\n                        elif row['status'] == 'pending':\n                            transactions_text += f\"â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\\n\"\n                        \n                        transactions_text += \"\\n\"\n        except:\n            pass\n        \n        if not found_transactions:\n            transactions_text += \"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø©\"\n        \n        self.send_message(message['chat']['id'], transactions_text, self.main_keyboard(user.get('language', 'ar')))\n    \n    def show_user_profile(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        profile_text = f\"\"\"ğŸ‘¤ Ù…Ù„Ù Ø§Ù„Ø¹Ù…ÙŠÙ„\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['customer_id']}\nğŸ“› Ø§Ù„Ø§Ø³Ù…: {user['name']}\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {user['phone']}\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {user['date']}\nğŸŒ Ø§Ù„Ù„ØºØ©: {'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' if user.get('language') == 'ar' else 'English'}\n\nğŸ”¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨: {'ğŸš« Ù…Ø­Ø¸ÙˆØ±' if user.get('is_banned') == 'yes' else 'âœ… Ù†Ø´Ø·'}\"\"\"\n        \n        if user.get('is_banned') == 'yes' and user.get('ban_reason'):\n            profile_text += f\"\\nğŸ“ Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±: {user['ban_reason']}\"\n        \n        self.send_message(message['chat']['id'], profile_text, self.main_keyboard(user.get('language', 'ar')))\n    \n    def handle_admin_panel(self, message):\n        \"\"\"Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n        \n        admin_welcome = \"\"\"ğŸ”§ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†\n\nÙ…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø©\nØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªÙ†Ù‚Ù„\"\"\"\n        \n        self.send_message(message['chat']['id'], admin_welcome, self.admin_keyboard())\n    \n    def process_message(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ\"\"\"\n        if 'text' not in message and 'contact' not in message:\n            return\n        \n        text = message.get('text', '')\n        chat_id = message['chat']['id']\n        user_id = message['from']['id']\n        \n        # Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\n        if text == '/start':\n            self.handle_start(message)\n            return\n            \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹ (Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©)\n        if text in ['ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…', 'ğŸ”„ Reset System', 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†', 'ğŸ†˜ Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„']:\n            user = self.find_user(user_id)\n            if user:\n                self.super_reset_user_system(user_id, chat_id, user)\n            else:\n                self.handle_start(message)\n            return\n        \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©\n        if user_id in self.user_states:\n            state = self.user_states[user_id]\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„\n            if isinstance(state, str) and state.startswith('registering'):\n                self.handle_registration(message)\n                return\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø­Ø¨\n            elif isinstance(state, str) and ('deposit' in state or 'withdraw' in state):\n                if 'deposit' in state:\n                    self.process_deposit_flow(message)\n                else:\n                    self.process_withdrawal_flow(message)\n                return\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\n            elif isinstance(state, dict) and state.get('step') == 'selecting_payment_method':\n                self.handle_payment_method_selection(message, text)\n                return\n        \n        # ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„\n        user = self.find_user(user_id)\n        if not user:\n            self.handle_start(message)\n            return\n        \n        # ÙØ­Øµ Ø§Ù„Ø­Ø¸Ø±\n        if user.get('is_banned') == 'yes':\n            ban_reason = user.get('ban_reason', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')\n            self.send_message(chat_id, f\"âŒ ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ\\nØ§Ù„Ø³Ø¨Ø¨: {ban_reason}\")\n            return\n        \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\n        if self.is_admin(user_id):\n            if text == '/admin':\n                self.handle_admin_panel(message)\n                return\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø®Ø§ØµØ©\n            if user_id in self.user_states:\n                admin_state = self.user_states[user_id]\n                if isinstance(admin_state, str):\n                    if admin_state == 'admin_broadcasting':\n                        self.send_broadcast_message(message, text)\n                        return\n                    elif admin_state.startswith('adding_company_'):\n                        self.handle_company_wizard(message)\n                        return\n                    elif admin_state.startswith('editing_company_') or admin_state == 'selecting_company_edit':\n                        self.handle_company_edit_wizard(message)\n                        return\n                    elif admin_state == 'confirming_company_delete':\n                        self.handle_company_delete_confirmation(message)\n                        return\n                    elif admin_state.startswith('deleting_company_'):\n                        company_id = admin_state.replace('deleting_company_', '')\n                        self.finalize_company_delete(message, company_id)\n                        return\n                    elif admin_state == 'sending_user_message_id':\n                        self.handle_user_message_id(message)\n                        return\n                    elif admin_state.startswith('sending_user_message_'):\n                        customer_id = admin_state.replace('sending_user_message_', '')\n                        self.handle_user_message_content(message, customer_id)\n                        return\n                    elif admin_state == 'selecting_method_to_edit':\n                        self.handle_method_edit_selection(message)\n                        return\n                    elif admin_state == 'selecting_method_to_delete':\n                        self.handle_method_delete_selection(message)\n                        return\n                    elif admin_state.startswith('editing_method_'):\n                        method_id = admin_state.replace('editing_method_', '')\n                        self.handle_method_edit_data(message, method_id)\n                        return\n                    elif admin_state == 'adding_payment_simple':\n                        self.handle_simple_payment_company_selection(message)\n                        return\n                    elif admin_state.startswith('adding_payment_method_'):\n                        self.handle_simple_payment_method_data(message)\n                        return\n                    elif admin_state == 'selecting_method_to_edit_simple':\n                        self.handle_simple_method_edit_selection(message)\n                        return\n                    elif admin_state == 'selecting_method_to_delete_simple':\n                        self.handle_simple_method_delete_selection(message)\n                        return\n                    elif admin_state.startswith('editing_method_simple_'):\n                        method_id = admin_state.replace('editing_method_simple_', '')\n                        self.handle_simple_method_edit_data(message, method_id)\n                        return\n                    elif admin_state == 'selecting_method_to_disable':\n                        self.handle_method_disable_selection(message)\n                        return\n                    elif admin_state == 'selecting_method_to_enable':\n                        self.handle_method_enable_selection(message)\n                        return\n                    elif admin_state.startswith('replying_to_complaint_'):\n                        complaint_id = admin_state.replace('replying_to_complaint_', '')\n                        self.handle_complaint_reply_buttons(message, complaint_id)\n                        return\n                    elif admin_state.startswith('editing_support_'):\n                        self.handle_support_data_edit(message, admin_state)\n                        return\n\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø£Ø¯Ù…Ù†\n            self.handle_admin_actions(message)\n            return\n        \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        if text in ['ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹', 'ğŸ’° Deposit Request']:\n            logger.info(f\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ù…Ù† {user_id}\")\n            self.create_deposit_request(message)\n        elif text in ['ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨', 'ğŸ’¸ Withdrawal Request']:\n            logger.info(f\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ù…Ù† {user_id}\")\n            self.create_withdrawal_request(message)\n        elif text in ['ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ', 'ğŸ“‹ My Requests']:\n            self.show_user_transactions(message)\n        elif text in ['ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ', 'ğŸ‘¤ Profile']:\n            self.show_user_profile(message)\n        elif text in ['ğŸ“¨ Ø´ÙƒÙˆÙ‰', 'ğŸ“¨ Complaint']:\n            self.handle_complaint_start(message)\n        elif text in ['ğŸ†˜ Ø¯Ø¹Ù…', 'ğŸ†˜ Support']:\n            support_text = f\"\"\"ğŸ†˜ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ\n\nğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {self.get_setting('support_phone') or '+966501234567'}\nâ° Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: 24/7\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: DUX\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ Ø¥Ø±Ø³Ø§Ù„ Ø´ÙƒÙˆÙ‰ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n            self.send_message(chat_id, support_text, self.main_keyboard(user.get('language', 'ar')))\n        elif text in ['ğŸ‡ºğŸ‡¸ English', 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©']:\n            self.handle_language_change(message, text)\n        elif text in ['ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†', 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…', 'ğŸ†˜ Ø¥ØµÙ„Ø§Ø­', 'reset', 'fix', 'ğŸ”„ Reset System', 'ğŸ†˜ Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„']:\n            # Ø¥Ø¬Ø±Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø´Ø§Ù…Ù„Ø© ÙˆÙ‚ÙˆÙŠØ©\n            self.super_reset_user_system(user_id, chat_id, user)\n        else:\n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø®Ø§ØµØ©\n            if user_id in self.user_states:\n                state = self.user_states[user_id]\n                if state == 'writing_complaint':\n                    self.save_complaint(message, text)\n                    return\n            \n            # Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ø²Ø± Ø¥ØµÙ„Ø§Ø­ Ù‚ÙˆÙŠ\n            error_keyboard = {\n                'keyboard': [\n                    [{'text': 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…'}, {'text': 'ğŸ†˜ Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„'}],\n                    [{'text': 'ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨'}],\n                    [{'text': 'ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ'}, {'text': 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ'}],\n                    [{'text': 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': True\n            }\n            \n            error_msg = f\"\"\"âŒ Ø£Ù…Ø± ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ… Ø£Ùˆ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…\n\nğŸ”§ Ù„Ø­Ù„ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©ØŒ Ø§Ø®ØªØ±:\nâ€¢ ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù… - Ø¥ØµÙ„Ø§Ø­ Ø¨Ø³ÙŠØ·\nâ€¢ ğŸ†˜ Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„ - Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„\n\nØ£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:\"\"\"\n            \n            self.send_message(chat_id, error_msg, error_keyboard)\n    \n    def super_reset_user_system(self, user_id, chat_id, user):\n        \"\"\"Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø´Ø§Ù…Ù„Ø© ÙˆÙ‚ÙˆÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        try:\n            logger.info(f\"Ø¨Ø¯Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\")\n            \n            # 1. ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n                logger.info(f\"ØªÙ… Ø­Ø°Ù Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\")\n            \n            # 2. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©\n            temp_data_attrs = [\n                'temp_company_data',\n                'edit_company_data', \n                'temp_deposit_data',\n                'temp_withdrawal_data',\n                'temp_complaint_data',\n                'temp_payment_data',\n                'admin_temp_data'\n            ]\n            \n            for attr in temp_data_attrs:\n                if hasattr(self, attr) and user_id in getattr(self, attr, {}):\n                    del getattr(self, attr)[user_id]\n                    logger.info(f\"ØªÙ… Ø­Ø°Ù {attr} Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\")\n            \n            # 3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…Ù„Ù\n            fresh_user = self.find_user(user_id)\n            if fresh_user:\n                user.update(fresh_user)\n                logger.info(f\"ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\")\n            \n            # 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ¥ØµÙ„Ø§Ø­Ù‡Ø§\n            self.verify_and_fix_system_files()\n            \n            # 5. Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø­Ø¯Ø«Ø©\n            welcome_text = f\"\"\"âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ”§ ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØ§Ù„ÙŠ:\nâ€¢ ØªÙ†Ø¸ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©\nâ€¢ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©\nâ€¢ ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù†Ø¸Ø§Ù…\nâ€¢ Ø¥ØµÙ„Ø§Ø­ Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø­ØªÙ…Ù„Ø©\n\nğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:\nğŸ·ï¸ Ø§Ù„Ø§Ø³Ù…: {user.get('name', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user.get('customer_id', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {user.get('phone', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\nğŸŒ Ø§Ù„Ù„ØºØ©: {'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' if user.get('language', 'ar') == 'ar' else 'English'}\n\nğŸ  Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… - Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\"\"\"\n            \n            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨\n            if self.is_admin(user_id):\n                keyboard = self.admin_keyboard()\n            else:\n                keyboard = self.main_keyboard(user.get('language', 'ar'))\n                \n            self.send_message(chat_id, welcome_text, keyboard)\n            logger.info(f\"ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user_id}\")\n            \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… {user_id}: {e}\")\n            \n            # ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†ØŒ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦\n            emergency_text = \"\"\"ğŸš¨ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†\n\nğŸ”§ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ\n\nâš¡ Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù…: +966501234567\"\"\"\n            \n            emergency_keyboard = {\n                'keyboard': [\n                    [{'text': 'ğŸ†˜ Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„'}, {'text': 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…'}],\n                    [{'text': 'ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨'}]\n                ],\n                'resize_keyboard': True\n            }\n            \n            self.send_message(chat_id, emergency_text, emergency_keyboard)\n    \n    def verify_and_fix_system_files(self):\n        \"\"\"ÙØ­Øµ ÙˆØ¥ØµÙ„Ø§Ø­ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\"\"\"\n        try:\n            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±\n            required_files = [\n                'users.csv',\n                'transactions.csv', \n                'companies.csv',\n                'complaints.csv',\n                'payment_methods.csv',\n                'exchange_addresses.csv'\n            ]\n            \n            for file_name in required_files:\n                if not os.path.exists(file_name):\n                    logger.warning(f\"Ù…Ù„Ù Ù…ÙÙ‚ÙˆØ¯ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡: {file_name}\")\n                    self.init_files()  # Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª\n                    break\n                    \n            logger.info(\"ØªÙ… ÙØ­Øµ Ø³Ù„Ø§Ù…Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­\")\n            \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…: {e}\")\n\n    def handle_admin_actions(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        text = message['text']\n        chat_id = message['chat']['id']\n        user_id = message['from']['id']\n        \n        # Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\n        if text == 'ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©':\n            self.show_pending_requests(message)\n        elif text == 'âœ… Ø·Ù„Ø¨Ø§Øª Ù…ÙÙˆØ§ÙÙ‚Ø©':\n            self.show_approved_transactions(message)\n        elif text == 'ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†':\n            self.show_users_management(message)\n        elif text == 'ğŸ” Ø§Ù„Ø¨Ø­Ø«':\n            self.prompt_admin_search(message)\n        elif text == 'ğŸ’³ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹':\n            self.show_payment_methods_management(message)\n        elif text == 'ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª':\n            self.show_detailed_stats(message)\n        elif text == 'ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ':\n            self.prompt_broadcast(message)\n        elif text == 'ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…':\n            self.prompt_ban_user(message)\n        elif text == 'âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±':\n            self.prompt_unban_user(message)\n        \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©\n        elif text.startswith('Ø­Ø¸Ø± '):\n            parts = text.split(' ', 2)\n            if len(parts) >= 3:\n                customer_id = parts[1]\n                reason = parts[2]\n                self.ban_user_admin(message, customer_id, reason)\n            else:\n                self.send_message(chat_id, \"âŒ Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©:\\nØ­Ø¸Ø± [Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„] [Ø³Ø¨Ø¨_Ø§Ù„Ø­Ø¸Ø±]\\nÙ…Ø«Ø§Ù„: Ø­Ø¸Ø± C810563 Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø´Ø±ÙˆØ·\", self.admin_keyboard())\n        \n        elif text.startswith('Ø§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± ') or text.startswith('Ø§Ù„ØºØ§Ø¡ Ø­Ø¸Ø± '):\n            customer_id = text.replace('Ø§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± ', '').replace('Ø§Ù„ØºØ§Ø¡ Ø­Ø¸Ø± ', '').strip()\n            if customer_id:\n                self.unban_user_admin(message, customer_id)\n            else:\n                self.send_message(chat_id, \"âŒ Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©:\\nØ§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± [Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„]\\nÙ…Ø«Ø§Ù„: Ø§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± C810563\", self.admin_keyboard())\n        elif text == 'ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ©':\n            self.start_add_company_wizard(message)\n        elif text == 'âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª':\n            self.show_companies_management_enhanced(message)\n        elif text == 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©':\n            self.show_companies_management_enhanced(message)\n        elif text == 'â• Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©':\n            self.prompt_add_company(message)\n        elif text == 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙƒØ©':\n            self.prompt_edit_company(message)\n        elif text == 'ğŸ—‘ï¸ Ø­Ø°Ù Ø´Ø±ÙƒØ©':\n            self.prompt_delete_company(message)\n        elif text == 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©':\n            self.show_companies_management_enhanced(message)\n        elif text in ['â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†', 'ğŸ  Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†']:\n            self.handle_admin_panel(message)\n        elif text in ['â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©']:\n            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¹ÙˆØ¯Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©\n            user_state = self.user_states.get(message['from']['id'])\n            if user_state:\n                if 'payment' in str(user_state) or 'method' in str(user_state):\n                    self.show_payment_methods_management(message)\n                elif 'company' in str(user_state):\n                    self.show_companies_management_enhanced(message)\n                else:\n                    self.handle_admin_panel(message)\n            else:\n                self.handle_admin_panel(message)\n        elif text == 'ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†':\n            self.show_addresses_management(message)\n        elif text == 'ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹Ù…':\n            self.show_support_data_editor(message)\n        elif text == 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ':\n            self.start_phone_edit_wizard(message)\n        elif text == 'ğŸ’¬ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…':\n            self.start_telegram_edit_wizard(message)\n        elif text == 'ğŸ“§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ':\n            self.start_email_edit_wizard(message)\n        elif text == 'ğŸ•’ ØªØ¹Ø¯ÙŠÙ„ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„':\n            self.start_hours_edit_wizard(message)\n        elif text == 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹Ù…':\n            self.show_support_data_editor(message)\n        elif text == 'âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…':\n            self.show_system_settings(message)\n        elif text == 'ğŸ“¨ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰':\n            self.show_complaints_admin(message)\n        elif text in ['ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰', 'ğŸ”„ ØªØ­Ø¯ÙŠØ«']:\n            self.show_complaints_admin(message)\n        elif text.startswith('ğŸ“ Ø±Ø¯ Ø¹Ù„Ù‰ '):\n            complaint_id = text.replace('ğŸ“ Ø±Ø¯ Ø¹Ù„Ù‰ ', '').strip()\n            self.start_complaint_reply_wizard(message, complaint_id)\n        elif text == 'ğŸ“‹ Ù†Ø³Ø® Ø£ÙˆØ§Ù…Ø± Ø³Ø±ÙŠØ¹Ø©':\n            self.show_quick_copy_commands(message)\n        elif text == 'ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¹Ù…ÙŠÙ„':\n            self.start_send_user_message(message)\n        elif text == 'ğŸ’¾ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙˆØ±ÙŠØ©':\n            self.manual_backup_command(message)\n        elif text == 'â• Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹':\n            self.start_simple_payment_method_wizard(message)\n        elif text == 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹':\n            self.start_edit_payment_method_wizard(message)\n        elif text == 'ğŸ—‘ï¸ Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹':\n            self.start_delete_payment_method_wizard(message)\n        elif text == 'ğŸ“Š Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹':\n            self.show_all_payment_methods_simplified(message)\n        elif text == 'â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹':\n            self.start_disable_payment_method_wizard(message)\n        elif text == 'â–¶ï¸ ØªØ´ØºÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹':\n            self.start_enable_payment_method_wizard(message)\n        elif text in ['ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', 'ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©']:\n            # Ø¥Ù†Ù‡Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\n            if message['from']['id'] in self.user_states:\n                del self.user_states[message['from']['id']]\n            user = self.find_user(message['from']['id'])\n            if user:\n                welcome_text = f\"\"\"ğŸ  Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰\n\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user.get('name', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user.get('customer_id', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\n\nØ§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\"\"\"\n                self.send_message(chat_id, welcome_text, self.main_keyboard(user.get('language', 'ar')))\n        \n        # Ø£ÙˆØ§Ù…Ø± Ù†ØµÙŠØ© Ù„Ù„Ø£Ø¯Ù…Ù† (Ù…Ø¨Ø³Ø·Ø© Ù…Ø¹ Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©)\n        elif any(word in text.lower() for word in ['Ù…ÙˆØ§ÙÙ‚Ø©', 'Ù…ÙˆØ§ÙÙ‚', 'Ø§ÙˆØ§ÙÙ‚', 'Ø£ÙˆØ§ÙÙ‚', 'Ù‚Ø¨ÙˆÙ„', 'Ù…Ù‚Ø¨ÙˆÙ„', 'ØªØ£ÙƒÙŠØ¯', 'ØªØ§ÙƒÙŠØ¯', 'Ù†Ø¹Ù…']):\n            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n            words = text.split()\n            trans_id = None\n            for word in words:\n                if any(word.startswith(prefix) for prefix in ['DEP', 'WTH']):\n                    trans_id = word\n                    break\n            \n            if trans_id:\n                self.approve_transaction(message, trans_id)\n            else:\n                self.send_message(message['chat']['id'], \"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©. Ù…Ø«Ø§Ù„: Ù…ÙˆØ§ÙÙ‚Ø© DEP123456\", self.admin_keyboard())\n                \n        elif any(word in text.lower() for word in ['Ø±ÙØ¶', 'Ø±Ø§ÙØ¶', 'Ù„Ø§', 'Ù…Ø±ÙÙˆØ¶', 'Ø¥Ù„ØºØ§Ø¡', 'Ø§Ù„ØºØ§Ø¡', 'Ù…Ù†Ø¹']):\n            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙˆØ§Ù„Ø³Ø¨Ø¨\n            words = text.split()\n            trans_id = None\n            reason_start = -1\n            \n            for i, word in enumerate(words):\n                if any(word.startswith(prefix) for prefix in ['DEP', 'WTH']):\n                    trans_id = word\n                    reason_start = i + 1\n                    break\n            \n            if trans_id:\n                reason = ' '.join(words[reason_start:]) if reason_start != -1 and reason_start < len(words) else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n                self.reject_transaction(message, trans_id, reason)\n            else:\n                self.send_message(message['chat']['id'], \"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©. Ù…Ø«Ø§Ù„: Ø±ÙØ¶ DEP123456 Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶\", self.admin_keyboard())\n        elif text.startswith('Ø¨Ø­Ø« '):\n            query = text.replace('Ø¨Ø­Ø« ', '')\n            self.search_users_admin(message, query)\n        elif text.startswith('Ø­Ø¸Ø± '):\n            parts = text.replace('Ø­Ø¸Ø± ', '').split(' ', 1)\n            customer_id = parts[0]\n            reason = parts[1] if len(parts) > 1 else 'Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø´Ø±ÙˆØ·'\n            self.ban_user_admin(message, customer_id, reason)\n        elif text.startswith('Ø§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± '):\n            customer_id = text.replace('Ø§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± ', '')\n            self.unban_user_admin(message, customer_id)\n        elif text.startswith('Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© '):\n            self.add_company_simple_with_display(message, text)\n        elif text.startswith('Ø­Ø°Ù_Ø´Ø±ÙƒØ© '):\n            company_id = text.replace('Ø­Ø°Ù_Ø´Ø±ÙƒØ© ', '')\n            self.delete_company_simple(message, company_id)\n        elif text.startswith('Ø¹Ù†ÙˆØ§Ù†_Ø¬Ø¯ÙŠØ¯ '):\n            new_address = text.replace('Ø¹Ù†ÙˆØ§Ù†_Ø¬Ø¯ÙŠØ¯ ', '')\n            self.update_address_simple(message, new_address)\n        elif any(word in text.lower() for word in ['Ø¹Ù†ÙˆØ§Ù†', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'ØªØ­Ø¯ÙŠØ«_Ø¹Ù†ÙˆØ§Ù†']):\n            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯\n            new_address = text\n            for word in ['Ø¹Ù†ÙˆØ§Ù†', 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', 'ØªØ­Ø¯ÙŠØ«_Ø¹Ù†ÙˆØ§Ù†']:\n                new_address = new_address.replace(word, '').strip()\n            if new_address:\n                self.update_address_simple(message, new_address)\n            else:\n                self.send_message(message['chat']['id'], \"ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯. Ù…Ø«Ø§Ù„: Ø¹Ù†ÙˆØ§Ù† Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯\", self.admin_keyboard())\n        elif text.startswith('ØªØ¹Ø¯ÙŠÙ„_Ø§Ø¹Ø¯Ø§Ø¯ '):\n            self.update_setting_simple(message, text)\n        elif text == 'âœ… Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ©':\n            # Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ© - ØªÙ†ÙÙŠØ° Ù…Ø¨Ø§Ø´Ø±\n            if user_id in self.user_states and self.user_states[user_id] == 'confirming_company':\n                if user_id in self.temp_company_data:\n                    company_data = self.temp_company_data[user_id]\n                    company_id = str(int(datetime.now().timestamp()))\n                    \n                    try:\n                        # Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù…Ù„Ù\n                        with open('companies.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                            writer = csv.writer(f)\n                            writer.writerow([company_id, company_data['name'], company_data['type'], company_data['details'], 'active'])\n                        \n                        success_msg = f\"\"\"ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {company_id}\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {company_data['name']}\nâš¡ Ø§Ù„Ù†ÙˆØ¹: {company_data['type_display']}\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {company_data['details']}\n\nØ§Ù„Ø´Ø±ÙƒØ© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù† Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ âœ…\"\"\"\n                        \n                        self.send_message(chat_id, success_msg, self.admin_keyboard())\n                        \n                        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©\n                        del self.user_states[user_id]\n                        del self.temp_company_data[user_id]\n                        \n                    except Exception as e:\n                        self.send_message(chat_id, f\"âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ©: {str(e)}\", self.admin_keyboard())\n                else:\n                    self.send_message(chat_id, \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø±ÙƒØ© Ù…Ø­ÙÙˆØ¸Ø©\", self.admin_keyboard())\n            else:\n                self.send_message(chat_id, \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ© Ù„Ù„Ø­ÙØ¸. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© Ø£ÙˆÙ„Ø§Ù‹.\", self.admin_keyboard())\n        elif text == 'âœ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª':\n            # Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©\n            if user_id in self.user_states and self.user_states[user_id] == 'editing_company_menu':\n                self.save_company_changes(message)\n            else:\n                self.send_message(chat_id, \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸. Ø§Ø¨Ø¯Ø£ Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹.\", self.admin_keyboard())\n        elif text in ['âŒ Ø¥Ù„ØºØ§Ø¡', 'Ø¥Ù„ØºØ§Ø¡', 'Ø§Ù„ØºØ§Ø¡']:\n            # Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            if user_id in self.edit_company_data:\n                del self.edit_company_data[user_id]\n            self.send_message(chat_id, \"âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©\", self.admin_keyboard())\n        else:\n            self.send_message(chat_id, \"Ø£Ù…Ø± ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ùˆ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØµØ­ÙŠØ­Ø©.\", self.admin_keyboard())\n    \n    def show_pending_requests(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ù„Ù„Ø£Ø¯Ù…Ù† Ù…Ø¹ Ø£ÙˆØ§Ù…Ø± Ù†Ø³Ø® Ø³Ù‡Ù„Ø©\"\"\"\n        pending_text = \"ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:\\n\\n\"\n        found_pending = False\n        copy_commands = []\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['status'] == 'pending':\n                        found_pending = True\n                        type_emoji = \"ğŸ’°\" if row['type'] == 'deposit' else \"ğŸ’¸\"\n                        \n                        pending_text += f\"{type_emoji} **{row['id']}**\\n\"\n                        pending_text += f\"ğŸ‘¤ {row['name']} ({row['customer_id']})\\n\"\n                        pending_text += f\"ğŸ¢ {row['company']}\\n\"\n                        pending_text += f\"ğŸ’³ {row['wallet_number']}\\n\"\n                        pending_text += f\"ğŸ’° {row['amount']} Ø±ÙŠØ§Ù„\\n\"\n                        \n                        if row.get('exchange_address'):\n                            pending_text += f\"ğŸ“ {row['exchange_address']}\\n\"\n                        \n                        pending_text += f\"ğŸ“… {row['date']}\\n\"\n                        \n                        # Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø±ÙŠØ¹\n                        pending_text += f\"\\nğŸ“‹ **Ø£ÙˆØ§Ù…Ø± Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ù†Ø³Ø®:**\\n\"\n                        pending_text += f\"âœ… `Ù…ÙˆØ§ÙÙ‚Ø© {row['id']}`\\n\"\n                        pending_text += f\"âŒ `Ø±ÙØ¶ {row['id']} Ø§Ù„Ø³Ø¨Ø¨_Ù‡Ù†Ø§`\\n\"\n                        pending_text += f\"â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸\\n\\n\"\n                        \n                        # Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ\n                        copy_commands.append({\n                            'id': row['id'],\n                            'approve': f\"Ù…ÙˆØ§ÙÙ‚Ø© {row['id']}\",\n                            'reject': f\"Ø±ÙØ¶ {row['id']} Ø§Ù„Ø³Ø¨Ø¨_Ù‡Ù†Ø§\"\n                        })\n        except:\n            pass\n        \n        if not found_pending:\n            pending_text += \"âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©\"\n        else:\n            # Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù†Ø³Ø®\n            pending_text += \"\\nğŸ”¥ **Ø£ÙˆØ§Ù…Ø± Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:**\\n\\n\"\n            \n            for cmd in copy_commands:\n                pending_text += f\"**{cmd['id']}:**\\n\"\n                pending_text += f\"âœ… `{cmd['approve']}`\\n\"\n                pending_text += f\"âŒ `{cmd['reject']}`\\n\\n\"\n            \n            pending_text += \"ğŸ’¡ **Ø·Ø±Ù‚ Ø³Ù‡Ù„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**\\n\"\n            pending_text += \"â€¢ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù…Ø± ÙˆØ§Ø®ØªØ± 'Ù†Ø³Ø®'\\n\"\n            pending_text += \"â€¢ Ø£Ùˆ Ø§ÙƒØªØ¨ Ù…Ø¨Ø§Ø´Ø±Ø©: Ù…ÙˆØ§ÙÙ‚Ø© + Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\\n\"\n            pending_text += \"â€¢ Ù„Ù„Ø±ÙØ¶: Ø±ÙØ¶ + Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© + Ø§Ù„Ø³Ø¨Ø¨\\n\\n\"\n            \n            pending_text += \"ğŸ“ **Ø£Ù…Ø«Ù„Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©:**\\n\"\n            pending_text += \"`Ù…ÙˆØ§ÙÙ‚Ø©` Ø£Ùˆ `Ù…ÙˆØ§ÙÙ‚` Ø£Ùˆ `ØªØ£ÙƒÙŠØ¯` Ø£Ùˆ `Ù†Ø¹Ù…`\\n\\n\"\n            \n            pending_text += \"ğŸ“ **Ø£Ù…Ø«Ù„Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø±ÙØ¶:**\\n\"\n            pending_text += \"`Ø±ÙØ¶` Ø£Ùˆ `Ù„Ø§` Ø£Ùˆ `Ù…Ø±ÙÙˆØ¶` Ø£Ùˆ `Ø¥Ù„ØºØ§Ø¡`\"\n        \n        self.send_message(message['chat']['id'], pending_text, self.admin_keyboard())\n    \n    def approve_transaction(self, message, trans_id):\n        \"\"\"Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        success = self.update_transaction_status(trans_id, 'approved', '', str(message['from']['id']))\n        \n        if success:\n            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„\n            transaction = self.get_transaction(trans_id)\n            if transaction:\n                customer_telegram_id = transaction.get('telegram_id')\n                if customer_telegram_id:\n                    type_text = \"Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\" if transaction['type'] == 'deposit' else \"Ø§Ù„Ø³Ø­Ø¨\"\n                    customer_msg = f\"\"\"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ {type_text}\n\nğŸ†” {trans_id}\nğŸ’° {transaction['amount']} Ø±ÙŠØ§Ù„\nğŸ¢ {transaction['company']}\nğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\n{'Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø¥ÙŠØ¯Ø§Ø¹Ùƒ.' if transaction['type'] == 'deposit' else 'ÙŠØ±Ø¬Ù‰ Ø²ÙŠØ§Ø±Ø© Ù…ÙƒØªØ¨ Ø§Ù„ØµØ±Ø§ÙØ© Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¨Ù„Øº.'}\"\"\"\n                    \n                    user = self.find_user(customer_telegram_id)\n                    lang = user.get('language', 'ar') if user else 'ar'\n                    self.send_message(customer_telegram_id, customer_msg, self.main_keyboard(lang))\n            \n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ {trans_id}\", self.admin_keyboard())\n        else:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ {trans_id}\", self.admin_keyboard())\n    \n    def reject_transaction(self, message, trans_id, reason):\n        \"\"\"Ø±ÙØ¶ Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        success = self.update_transaction_status(trans_id, 'rejected', reason, str(message['from']['id']))\n        \n        if success:\n            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„\n            transaction = self.get_transaction(trans_id)\n            if transaction:\n                customer_telegram_id = transaction.get('telegram_id')\n                if customer_telegram_id:\n                    type_text = \"Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\" if transaction['type'] == 'deposit' else \"Ø§Ù„Ø³Ø­Ø¨\"\n                    customer_msg = f\"\"\"âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ {type_text}\n\nğŸ†” {trans_id}\nğŸ’° {transaction['amount']} Ø±ÙŠØ§Ù„\nğŸ“ Ø§Ù„Ø³Ø¨Ø¨: {reason}\nğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù….\"\"\"\n                    \n                    user = self.find_user(customer_telegram_id)\n                    lang = user.get('language', 'ar') if user else 'ar'\n                    self.send_message(customer_telegram_id, customer_msg, self.main_keyboard(lang))\n            \n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø±ÙØ¶ {trans_id}\\nØ§Ù„Ø³Ø¨Ø¨: {reason}\", self.admin_keyboard())\n        else:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¶ {trans_id}\", self.admin_keyboard())\n    \n    def update_transaction_status(self, trans_id, new_status, note='', admin_id=''):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        transactions = []\n        success = False\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == trans_id:\n                        row['status'] = new_status\n                        if note:\n                            row['admin_note'] = note\n                        if admin_id:\n                            row['processed_by'] = admin_id\n                        success = True\n                    transactions.append(row)\n            \n            if success:\n                with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'customer_id', 'telegram_id', 'name', 'type', 'company', 'wallet_number', 'amount', 'exchange_address', 'status', 'date', 'admin_note', 'processed_by']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(transactions)\n        except:\n            pass\n        \n        return success\n    \n    def get_transaction(self, trans_id):\n        \"\"\"Ø¬Ù„Ø¨ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø­Ø¯Ø¯Ø©\"\"\"\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == trans_id:\n                        return row\n        except:\n            pass\n        return None\n    \n    def show_detailed_stats(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ÙØµÙ„Ø©\"\"\"\n        stats_text = \"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„Ø©\\n\\n\"\n        \n        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        total_users = 0\n        banned_users = 0\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    total_users += 1\n                    if row.get('is_banned') == 'yes':\n                        banned_users += 1\n        except:\n            pass\n        \n        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª\n        total_transactions = 0\n        pending_count = 0\n        approved_count = 0\n        rejected_count = 0\n        total_deposit_amount = 0\n        total_withdraw_amount = 0\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    total_transactions += 1\n                    amount = float(row.get('amount', 0))\n                    \n                    if row['status'] == 'pending':\n                        pending_count += 1\n                    elif row['status'] == 'approved':\n                        approved_count += 1\n                        if row['type'] == 'deposit':\n                            total_deposit_amount += amount\n                        else:\n                            total_withdraw_amount += amount\n                    elif row['status'] == 'rejected':\n                        rejected_count += 1\n        except:\n            pass\n        \n        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰\n        total_complaints = 0\n        try:\n            with open('complaints.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                total_complaints = sum(1 for row in reader)\n        except:\n            pass\n        \n        stats_text += f\"ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†:\\n\"\n        stats_text += f\"â”œ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {total_users}\\n\"\n        stats_text += f\"â”œ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†: {total_users - banned_users}\\n\"\n        stats_text += f\"â”” Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†: {banned_users}\\n\\n\"\n        \n        stats_text += f\"ğŸ’° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª:\\n\"\n        stats_text += f\"â”œ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: {total_transactions}\\n\"\n        stats_text += f\"â”œ Ù…Ø¹Ù„Ù‚Ø©: {pending_count}\\n\"\n        stats_text += f\"â”œ Ù…ÙÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§: {approved_count}\\n\"\n        stats_text += f\"â”” Ù…Ø±ÙÙˆØ¶Ø©: {rejected_count}\\n\\n\"\n        \n        stats_text += f\"ğŸ’µ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…ÙÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§:\\n\"\n        stats_text += f\"â”œ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹Ø§Øª: {total_deposit_amount:,.0f} Ø±ÙŠØ§Ù„\\n\"\n        stats_text += f\"â”œ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª: {total_withdraw_amount:,.0f} Ø±ÙŠØ§Ù„\\n\"\n        stats_text += f\"â”” Ø§Ù„ÙØ±Ù‚: {total_deposit_amount - total_withdraw_amount:,.0f} Ø±ÙŠØ§Ù„\\n\\n\"\n        \n        stats_text += f\"ğŸ“¨ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰: {total_complaints}\\n\\n\"\n        stats_text += f\"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: {datetime.now().strftime('%Y-%m-%d %H:%M')}\"\n        \n        self.send_message(message['chat']['id'], stats_text, self.admin_keyboard())\n    \n    def add_company_simple_with_display(self, message, text):\n        \"\"\"Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©\"\"\"\n        result = self.add_company_simple(message, text)\n        if result:\n            # Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙˆØ±Ø§Ù‹\n            self.show_companies_management_enhanced(message)\n    \n    def add_company_simple(self, message, text):\n        \"\"\"Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¨ØµÙŠØºØ© Ù…Ø¨Ø³Ø·Ø©\"\"\"\n        # ØªÙ†Ø³ÙŠÙ‚: Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© Ø§Ø³Ù… Ù†ÙˆØ¹ ØªÙØ§ØµÙŠÙ„\n        parts = text.replace('Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© ', '').split(' ', 2)\n        if len(parts) < 3:\n            help_text = \"\"\"âŒ Ø·Ø±ÙŠÙ‚Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©:\n\nğŸ“ Ø§ÙƒØªØ¨ Ø¨Ø§Ù„Ø¶Ø¨Ø·:\nØ§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© Ø§Ø³Ù…_Ø§Ù„Ø´Ø±ÙƒØ© Ù†ÙˆØ¹_Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„\n\nğŸ”¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø© (Ø¨Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ):\nâ€¢ Ø§ÙŠØ¯Ø§Ø¹ â†’ deposit\nâ€¢ Ø³Ø­Ø¨ â†’ withdraw  \nâ€¢ Ø§ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨ â†’ both\n\nğŸ“‹ Ø£Ù…Ø«Ù„Ø© ØµØ­ÙŠØ­Ø©:\nâ–«ï¸ Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© Ù…Ø¯Ù‰ both Ù…Ø­ÙØ¸Ø©_Ø±Ù‚Ù…ÙŠØ©\nâ–«ï¸ Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© Ø§Ù„Ø¨Ù†Ùƒ_Ø§Ù„Ø£Ù‡Ù„ÙŠ deposit Ø­Ø³Ø§Ø¨_Ø¨Ù†ÙƒÙŠ\nâ–«ï¸ Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© ÙÙˆØ¯Ø§ÙÙˆÙ†_ÙƒØ§Ø´ withdraw Ù…Ø­ÙØ¸Ø©_Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©\nâ–«ï¸ Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© STC_Pay both Ø®Ø¯Ù…Ø§Øª_Ø¯ÙØ¹\"\"\"\n            \n            self.send_message(message['chat']['id'], help_text, self.admin_keyboard())\n            return\n        \n        company_name = parts[0].replace('_', ' ')\n        service_type = parts[1].lower()\n        details = parts[2].replace('_', ' ')\n        \n        # Ù‚Ø¨ÙˆÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§\n        if service_type in ['Ø§ÙŠØ¯Ø§Ø¹', 'Ø¥ÙŠØ¯Ø§Ø¹']:\n            service_type = 'deposit'\n        elif service_type in ['Ø³Ø­Ø¨']:\n            service_type = 'withdraw'\n        elif service_type in ['ÙƒÙ„Ø§Ù‡Ù…Ø§', 'Ø§Ù„ÙƒÙ„', 'Ø§ÙŠØ¯Ø§Ø¹_ÙˆØ³Ø­Ø¨']:\n            service_type = 'both'\n        \n        if service_type not in ['deposit', 'withdraw', 'both']:\n            error_text = \"\"\"âŒ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ø®Ø·Ø£!\n\nâœ… Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©:\nâ€¢ deposit (Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·)\nâ€¢ withdraw (Ù„Ù„Ø³Ø­Ø¨ ÙÙ‚Ø·)\nâ€¢ both (Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø­Ø¨)\n\nØ£Ùˆ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ:\nâ€¢ Ø§ÙŠØ¯Ø§Ø¹ â†’ deposit\nâ€¢ Ø³Ø­Ø¨ â†’ withdraw\nâ€¢ ÙƒÙ„Ø§Ù‡Ù…Ø§ â†’ both\n\nÙ…Ø«Ø§Ù„ ØµØ­ÙŠØ­:\nØ§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© Ù…Ø¯Ù‰ both Ù…Ø­ÙØ¸Ø©_Ø±Ù‚Ù…ÙŠØ©\"\"\"\n            \n            self.send_message(message['chat']['id'], error_text, self.admin_keyboard())\n            return\n        \n        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯\n        company_id = str(int(datetime.now().timestamp()))\n        \n        try:\n            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù ÙˆØ¥Ù†Ø´Ø§Ø¤Ù‡ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹\n            file_exists = True\n            try:\n                with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                    pass\n            except FileNotFoundError:\n                file_exists = False\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø§Ù„Ø±Ø¤ÙˆØ³ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹\n            if not file_exists:\n                with open('companies.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    writer = csv.writer(f)\n                    writer.writerow(['id', 'name', 'type', 'details', 'is_active'])\n            \n            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n            with open('companies.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([company_id, company_name, service_type, details, 'active'])\n            \n            # Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©\n            success_msg = f\"\"\"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {company_id}\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {company_name}\nâš¡ Ø§Ù„Ù†ÙˆØ¹: {service_type}\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {details}\n\nğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:\"\"\"\n            \n            # Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª\n            try:\n                with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                    reader = csv.DictReader(f)\n                    company_count = 0\n                    for row in reader:\n                        company_count += 1\n                        status = \"âœ…\" if row.get('is_active') == 'active' else \"âŒ\"\n                        type_display = {'deposit': 'Ø¥ÙŠØ¯Ø§Ø¹', 'withdraw': 'Ø³Ø­Ø¨', 'both': 'Ø§Ù„ÙƒÙ„'}.get(row['type'], row['type'])\n                        success_msg += f\"\\n{status} {row['name']} (ID: {row['id']}) - {type_display}\"\n                    \n                    success_msg += f\"\\n\\nğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±ÙƒØ§Øª: {company_count}\"\n            except:\n                pass\n            \n            self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n            return True\n            \n        except Exception as e:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©: {str(e)}\", self.admin_keyboard())\n            return False\n    \n    def update_address_simple(self, message, new_address):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ±Ø§ÙØ©\"\"\"\n        try:\n            with open('exchange_addresses.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'address', 'is_active'])\n                writer.writerow(['1', new_address, 'yes'])\n            \n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ±Ø§ÙØ©:\\n{new_address}\", self.admin_keyboard())\n        except Exception as e:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {str(e)}\", self.admin_keyboard())\n    \n    def run(self):\n        \"\"\"ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª\"\"\"\n        logger.info(f\"âœ… Ù†Ø¸Ø§Ù… DUX Ø§Ù„Ø´Ø§Ù…Ù„ ÙŠØ¹Ù…Ù„: @{os.getenv('BOT_TOKEN', 'unknown').split(':')[0] if os.getenv('BOT_TOKEN') else 'unknown'}\")\n        \n        while True:\n            try:\n                updates = self.get_updates()\n                if updates and updates.get('ok'):\n                    for update in updates['result']:\n                        self.offset = update['update_id']\n                        \n                        if 'message' in update:\n                            message = update['message']\n                            # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„ØªØ´Ø®ÙŠØµ\n                            if 'text' in message:\n                                logger.info(f\"Ø±Ø³Ø§Ù„Ø© Ù…Ø³ØªÙ„Ù…Ø©: {message['text']} Ù…Ù† {message['from']['id']}\")\n                            try:\n                                self.process_message(message)\n                            except Exception as msg_error:\n                                logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {msg_error}\")\n                                # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…\n                                try:\n                                    error_keyboard = {\n                                        'keyboard': [\n                                            [{'text': 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…'}],\n                                            [{'text': 'ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨'}]\n                                        ],\n                                        'resize_keyboard': True\n                                    }\n                                    self.send_message(message['chat']['id'], \n                                                    \"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…' Ù„Ù„Ø¥ØµÙ„Ø§Ø­\", \n                                                    error_keyboard)\n                                except:\n                                    pass\n                        elif 'callback_query' in update:\n                            pass  # ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹\n                            \n            except KeyboardInterrupt:\n                logger.info(\"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª\")\n                break\n            except Exception as e:\n                logger.error(f\"Ø®Ø·Ø£ Ø¹Ø§Ù…: {e}\")\n                import time\n                time.sleep(1)  # Ø§Ù†ØªØ¸Ø§Ø± Ù‚ØµÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰\n                continue\n\n    def handle_complaint_start(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´ÙƒÙˆÙ‰\"\"\"\n        self.send_message(message['chat']['id'], \"ğŸ“¨ Ø£Ø±Ø³Ù„ Ø´ÙƒÙˆØ§Ùƒ Ø£Ùˆ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ:\")\n        self.user_states[message['from']['id']] = 'writing_complaint'\n    \n    def handle_language_change(self, message, text):\n        \"\"\"ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©\"\"\"\n        user_id = message['from']['id']\n        new_lang = 'en' if 'ğŸ‡ºğŸ‡¸' in text else 'ar'\n        \n        # ØªØ­Ø¯ÙŠØ« Ù„ØºØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…Ù„Ù\n        users = []\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['telegram_id'] == str(user_id):\n                        row['language'] = new_lang\n                    users.append(row)\n            \n            with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                fieldnames = ['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date', 'is_banned', 'ban_reason']\n                writer = csv.DictWriter(f, fieldnames=fieldnames)\n                writer.writeheader()\n                writer.writerows(users)\n            \n            welcome_msg = \"Language changed to English!\" if new_lang == 'en' else \"ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©!\"\n            self.send_message(message['chat']['id'], welcome_msg, self.main_keyboard(new_lang))\n        except:\n            pass\n    \n    def prompt_admin_search(self, message):\n        \"\"\"Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        search_help = \"\"\"ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…\n\nØ£Ø±Ø³Ù„: Ø¨Ø­Ø« Ù…ØªØ¨ÙˆØ¹Ø§Ù‹ Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€:\nâ€¢ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„\nâ€¢ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„\nâ€¢ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n\nÙ…Ø«Ø§Ù„: Ø¨Ø­Ø« Ø£Ø­Ù…Ø¯\"\"\"\n        self.send_message(message['chat']['id'], search_help, self.admin_keyboard())\n    \n    def prompt_broadcast(self, message):\n        \"\"\"Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ\"\"\"\n        broadcast_help = \"\"\"ğŸ“¢ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ\n\nØ£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ†.\nØ§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø©:\"\"\"\n        self.send_message(message['chat']['id'], broadcast_help)\n        self.user_states[message['from']['id']] = 'admin_broadcasting'\n    \n    def prompt_ban_user(self, message):\n        \"\"\"Ø·Ù„Ø¨ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        ban_help = \"\"\"ğŸš« Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\n\nØ§Ù„ØµÙŠØºØ©: Ø­Ø¸Ø± Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨\n\nÙ…Ø«Ø§Ù„: Ø­Ø¸Ø± C123456 Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø´Ø±ÙˆØ·\"\"\"\n        self.send_message(message['chat']['id'], ban_help, self.admin_keyboard())\n    \n    def prompt_unban_user(self, message):\n        \"\"\"Ø·Ù„Ø¨ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†\"\"\"\n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†\n        banned_users = []\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row.get('is_banned', 'no') == 'yes':\n                        banned_users.append({\n                            'customer_id': row['customer_id'],\n                            'name': row['name'],\n                            'ban_reason': row.get('ban_reason', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')\n                        })\n        except:\n            pass\n        \n        unban_help = \"\"\"âœ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\n\nğŸ“ Ø§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©:\nØ§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± [Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„]\nØ£Ùˆ: Ø§Ù„ØºØ§Ø¡ Ø­Ø¸Ø± [Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„]\n\nÙ…Ø«Ø§Ù„:\nØ§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± C810563\"\"\"\n        \n        if banned_users:\n            unban_help += \"\\n\\nğŸš« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹:\\n\"\n            for user in banned_users:\n                unban_help += f\"\\nğŸ†” {user['customer_id']}\\n\"\n                unban_help += f\"ğŸ‘¤ {user['name']}\\n\"\n                unban_help += f\"ğŸ“ Ø§Ù„Ø³Ø¨Ø¨: {user['ban_reason']}\\n\"\n                unban_help += f\"âš¡ `Ø§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± {user['customer_id']}`\\n\"\n                unban_help += \"â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸\\n\"\n        else:\n            unban_help += \"\\n\\nâœ… Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹\"\n        \n        self.send_message(message['chat']['id'], unban_help, self.admin_keyboard())\n    \n    def prompt_add_company(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ\"\"\"\n        help_text = \"\"\"ğŸ¢ Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©\n        \nØ³Ø£Ø·Ù„Ø¨ Ù…Ù†Ùƒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©:\n\nğŸ“ Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:\nÙ…Ø«Ø§Ù„: Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠØŒ Ù…Ø¯Ù‰ØŒ STC PayØŒ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´\"\"\"\n        \n        self.send_message(message['chat']['id'], help_text)\n        self.user_states[message['from']['id']] = 'adding_company_name'\n    \n    def handle_company_wizard(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id)\n        text = message.get('text', '').strip()\n        \n        if state == 'adding_company_name':\n            # Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©\n            if not hasattr(self, 'temp_company_data'):\n                self.temp_company_data = {}\n            if user_id not in self.temp_company_data:\n                self.temp_company_data[user_id] = {}\n            \n            self.temp_company_data[user_id]['name'] = text\n            \n            # Ø·Ù„Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©\n            service_keyboard = {\n                'keyboard': [\n                    [{'text': 'ğŸ’³ Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·'}, {'text': 'ğŸ’° Ø³Ø­Ø¨ ÙÙ‚Ø·'}],\n                    [{'text': 'ğŸ”„ Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨ Ù…Ø¹Ø§Ù‹'}],\n                    [{'text': 'âŒ Ø¥Ù„ØºØ§Ø¡'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': True\n            }\n            \n            self.send_message(message['chat']['id'], \n                f\"âœ… ØªÙ… Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©: {text}\\n\\nğŸ”§ Ø§Ù„Ø¢Ù† Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:\", \n                service_keyboard)\n            self.user_states[user_id] = 'adding_company_type'\n            \n        elif state == 'adding_company_type':\n            # Ø­ÙØ¸ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©\n            if text == 'ğŸ’³ Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·':\n                service_type = 'deposit'\n                service_display = 'Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·'\n            elif text == 'ğŸ’° Ø³Ø­Ø¨ ÙÙ‚Ø·':\n                service_type = 'withdraw'\n                service_display = 'Ø³Ø­Ø¨ ÙÙ‚Ø·'\n            elif text == 'ğŸ”„ Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨ Ù…Ø¹Ø§Ù‹':\n                service_type = 'both'\n                service_display = 'Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨'\n            elif text == 'âŒ Ø¥Ù„ØºØ§Ø¡':\n                del self.user_states[user_id]\n                if hasattr(self, 'temp_company_data') and user_id in self.temp_company_data:\n                    del self.temp_company_data[user_id]\n                self.send_message(message['chat']['id'], \"âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©\", self.admin_keyboard())\n                return\n            else:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©\")\n                return\n            \n            self.temp_company_data[user_id]['type'] = service_type\n            self.temp_company_data[user_id]['type_display'] = service_display\n            \n            # Ø·Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„\n            self.send_message(message['chat']['id'], \n                f\"âœ… Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©: {service_display}\\n\\nğŸ“‹ Ø§Ù„Ø¢Ù† Ø£Ø±Ø³Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ©:\\nÙ…Ø«Ø§Ù„: Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©ØŒ Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ Ø±Ù‚Ù… 1234567890ØŒ Ø®Ø¯Ù…Ø© Ø¯ÙØ¹ Ø±Ù‚Ù…ÙŠØ©\")\n            self.user_states[user_id] = 'adding_company_details'\n            \n        elif state == 'adding_company_details':\n            # Ø­ÙØ¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©\n            self.temp_company_data[user_id]['details'] = text\n            \n            # Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„ØªØ£ÙƒÙŠØ¯\n            company_data = self.temp_company_data[user_id]\n            confirm_text = f\"\"\"ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:\n\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {company_data['name']}\nâš¡ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©: {company_data['type_display']}\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {company_data['details']}\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ©ØŸ\"\"\"\n            \n            confirm_keyboard = {\n                'keyboard': [\n                    [{'text': 'âœ… Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ©'}, {'text': 'âŒ Ø¥Ù„ØºØ§Ø¡'}],\n                    [{'text': 'ğŸ”„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…'}, {'text': 'ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ÙˆØ¹'}, {'text': 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': True\n            }\n            \n            self.send_message(message['chat']['id'], confirm_text, confirm_keyboard)\n            self.user_states[user_id] = 'confirming_company'\n            \n        elif state == 'confirming_company':\n            company_data = self.temp_company_data[user_id]\n            \n            if text == 'âœ… Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ©':\n                # ØªØ¬Ù†Ø¨ ØªØ´ØºÙŠÙ„ Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø±ØªÙŠÙ† - Ù‡Ø°Ø§ ÙŠÙØ¹Ø§Ù„Ø¬ Ø§Ù„Ø¢Ù† ÙÙŠ handle_admin_actions\n                pass\n                    \n            elif text == 'âŒ Ø¥Ù„ØºØ§Ø¡':\n                del self.user_states[user_id]\n                if user_id in self.temp_company_data:\n                    del self.temp_company_data[user_id]\n                self.send_message(message['chat']['id'], \"âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©\", self.admin_keyboard())\n                \n            elif text == 'ğŸ”„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…':\n                self.send_message(message['chat']['id'], f\"ğŸ“ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: {company_data['name']}\\n\\nØ£Ø±Ø³Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:\")\n                self.user_states[user_id] = 'adding_company_name'\n                \n            elif text == 'ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ÙˆØ¹':\n                service_keyboard = {\n                    'keyboard': [\n                        [{'text': 'ğŸ’³ Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·'}, {'text': 'ğŸ’° Ø³Ø­Ø¨ ÙÙ‚Ø·'}],\n                        [{'text': 'ğŸ”„ Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨ Ù…Ø¹Ø§Ù‹'}],\n                        [{'text': 'âŒ Ø¥Ù„ØºØ§Ø¡'}]\n                    ],\n                    'resize_keyboard': True,\n                    'one_time_keyboard': True\n                }\n                self.send_message(message['chat']['id'], f\"ğŸ”§ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: {company_data['type_display']}\\n\\nØ§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\", service_keyboard)\n                self.user_states[user_id] = 'adding_company_type'\n                \n            elif text == 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„':\n                self.send_message(message['chat']['id'], f\"ğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {company_data['details']}\\n\\nØ£Ø±Ø³Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:\")\n                self.user_states[user_id] = 'adding_company_details'\n                \n            else:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©\")\n    \n    def prompt_edit_company(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ©\"\"\"\n        # Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„\n        companies_text = \"ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª:\\n\\n\"\n        \n        try:\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    status = \"âœ…\" if row.get('is_active') == 'active' else \"âŒ\"\n                    companies_text += f\"{status} {row['id']} - {row['name']}\\n\"\n                    companies_text += f\"   ğŸ“‹ {row['type']} - {row['details']}\\n\\n\"\n        except:\n            companies_text += \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª\\n\\n\"\n        \n        companies_text += \"ğŸ“ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§:\"\n        \n        self.send_message(message['chat']['id'], companies_text)\n        self.user_states[message['from']['id']] = 'selecting_company_edit'\n    \n    def handle_company_edit_wizard(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id)\n        text = message.get('text', '').strip()\n        \n        if state == 'selecting_company_edit':\n            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ©\n            company_found = None\n            try:\n                with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                    reader = csv.DictReader(f)\n                    for row in reader:\n                        if row['id'] == text:\n                            company_found = row\n                            break\n            except:\n                pass\n            \n            if not company_found:\n                self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ù…Ø¹Ø±Ù: {text}\")\n                return\n            \n            # Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„\n            if not hasattr(self, 'edit_company_data'):\n                self.edit_company_data = {}\n            self.edit_company_data[user_id] = company_found\n            \n            # Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©\n            type_display = {'deposit': 'Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·', 'withdraw': 'Ø³Ø­Ø¨ ÙÙ‚Ø·', 'both': 'Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨'}.get(company_found['type'], company_found['type'])\n            \n            edit_options = f\"\"\"ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {company_found['id']}\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {company_found['name']}\nâš¡ Ø§Ù„Ù†ÙˆØ¹: {type_display}\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {company_found['details']}\nğŸ”˜ Ø§Ù„Ø­Ø§Ù„Ø©: {'Ù†Ø´Ø·' if company_found.get('is_active') == 'active' else 'ØºÙŠØ± Ù†Ø´Ø·'}\n\nÙ…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ØŸ\"\"\"\n            \n            edit_keyboard = {\n                'keyboard': [\n                    [{'text': 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…'}, {'text': 'ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ÙˆØ¹'}],\n                    [{'text': 'ğŸ“‹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„'}, {'text': 'ğŸ”˜ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©'}],\n                    [{'text': 'âœ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'}, {'text': 'âŒ Ø¥Ù„ØºØ§Ø¡'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': True\n            }\n            \n            self.send_message(message['chat']['id'], edit_options, edit_keyboard)\n            self.user_states[user_id] = 'editing_company_menu'\n            \n        elif state == 'editing_company_menu':\n            if text == 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…':\n                current_name = self.edit_company_data[user_id]['name']\n                self.send_message(message['chat']['id'], f\"ğŸ“ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: {current_name}\\n\\nØ£Ø±Ø³Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:\")\n                self.user_states[user_id] = 'editing_company_name'\n                \n            elif text == 'ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ÙˆØ¹':\n                service_keyboard = {\n                    'keyboard': [\n                        [{'text': 'ğŸ’³ Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·'}, {'text': 'ğŸ’° Ø³Ø­Ø¨ ÙÙ‚Ø·'}],\n                        [{'text': 'ğŸ”„ Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨ Ù…Ø¹Ø§Ù‹'}],\n                        [{'text': 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©'}]\n                    ],\n                    'resize_keyboard': True,\n                    'one_time_keyboard': True\n                }\n                current_type = {'deposit': 'Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·', 'withdraw': 'Ø³Ø­Ø¨ ÙÙ‚Ø·', 'both': 'Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨'}.get(self.edit_company_data[user_id]['type'])\n                self.send_message(message['chat']['id'], f\"ğŸ”§ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: {current_type}\\n\\nØ§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\", service_keyboard)\n                self.user_states[user_id] = 'editing_company_type'\n                \n            elif text == 'ğŸ“‹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„':\n                current_details = self.edit_company_data[user_id]['details']\n                self.send_message(message['chat']['id'], f\"ğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {current_details}\\n\\nØ£Ø±Ø³Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:\")\n                self.user_states[user_id] = 'editing_company_details'\n                \n            elif text == 'ğŸ”˜ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©':\n                current_status = self.edit_company_data[user_id].get('is_active', 'active')\n                new_status = 'inactive' if current_status == 'active' else 'active'\n                status_text = 'Ù†Ø´Ø·' if new_status == 'active' else 'ØºÙŠØ± Ù†Ø´Ø·'\n                \n                self.edit_company_data[user_id]['is_active'] = new_status\n                self.send_message(message['chat']['id'], f\"âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¥Ù„Ù‰: {status_text}\")\n                \n                # Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„\n                self.show_edit_menu(message, user_id)\n                \n            elif text == 'âœ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª':\n                self.save_company_changes(message)\n                \n            elif text == 'âŒ Ø¥Ù„ØºØ§Ø¡':\n                del self.user_states[user_id]\n                if user_id in self.edit_company_data:\n                    del self.edit_company_data[user_id]\n                self.send_message(message['chat']['id'], \"âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ©\", self.admin_keyboard())\n                \n        elif state == 'editing_company_name':\n            self.edit_company_data[user_id]['name'] = text\n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰: {text}\")\n            self.show_edit_menu(message, user_id)\n            \n        elif state == 'editing_company_type':\n            if text == 'ğŸ’³ Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·':\n                self.edit_company_data[user_id]['type'] = 'deposit'\n                self.send_message(message['chat']['id'], \"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ÙˆØ¹ Ø¥Ù„Ù‰: Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·\")\n            elif text == 'ğŸ’° Ø³Ø­Ø¨ ÙÙ‚Ø·':\n                self.edit_company_data[user_id]['type'] = 'withdraw'\n                self.send_message(message['chat']['id'], \"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ÙˆØ¹ Ø¥Ù„Ù‰: Ø³Ø­Ø¨ ÙÙ‚Ø·\")\n            elif text == 'ğŸ”„ Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨ Ù…Ø¹Ø§Ù‹':\n                self.edit_company_data[user_id]['type'] = 'both'\n                self.send_message(message['chat']['id'], \"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ÙˆØ¹ Ø¥Ù„Ù‰: Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨\")\n            elif text == 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©':\n                pass\n            else:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©\")\n                return\n            \n            self.show_edit_menu(message, user_id)\n            \n        elif state == 'editing_company_details':\n            self.edit_company_data[user_id]['details'] = text\n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¥Ù„Ù‰: {text}\")\n            self.show_edit_menu(message, user_id)\n    \n    def show_edit_menu(self, message, user_id):\n        \"\"\"Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ©\"\"\"\n        company_data = self.edit_company_data[user_id]\n        type_display = {'deposit': 'Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·', 'withdraw': 'Ø³Ø­Ø¨ ÙÙ‚Ø·', 'both': 'Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨'}.get(company_data['type'], company_data['type'])\n        \n        edit_options = f\"\"\"ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©:\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {company_data['id']}\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {company_data['name']}\nâš¡ Ø§Ù„Ù†ÙˆØ¹: {type_display}\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {company_data['details']}\nğŸ”˜ Ø§Ù„Ø­Ø§Ù„Ø©: {'Ù†Ø´Ø·' if company_data.get('is_active') == 'active' else 'ØºÙŠØ± Ù†Ø´Ø·'}\n\nÙ…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ØŸ\"\"\"\n        \n        edit_keyboard = {\n            'keyboard': [\n                [{'text': 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…'}, {'text': 'ğŸ”§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ÙˆØ¹'}],\n                [{'text': 'ğŸ“‹ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„'}, {'text': 'ğŸ”˜ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©'}],\n                [{'text': 'âœ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'}, {'text': 'âŒ Ø¥Ù„ØºØ§Ø¡'}]\n            ],\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], edit_options, edit_keyboard)\n        self.user_states[user_id] = 'editing_company_menu'\n    \n    def save_company_changes(self, message):\n        \"\"\"Ø­ÙØ¸ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©\"\"\"\n        user_id = message['from']['id']\n        try:\n            companies = []\n            updated_company = self.edit_company_data[user_id]\n            \n            # Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == updated_company['id']:\n                        companies.append(updated_company)\n                    else:\n                        companies.append(row)\n            \n            # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø«\n            with open('companies.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                fieldnames = ['id', 'name', 'type', 'details', 'is_active']\n                writer = csv.DictWriter(f, fieldnames=fieldnames)\n                writer.writeheader()\n                writer.writerows(companies)\n            \n            type_display = {'deposit': 'Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·', 'withdraw': 'Ø³Ø­Ø¨ ÙÙ‚Ø·', 'both': 'Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨'}.get(updated_company['type'])\n            \n            success_msg = f\"\"\"ğŸ‰ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {updated_company['id']}\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {updated_company['name']}\nâš¡ Ø§Ù„Ù†ÙˆØ¹: {type_display}\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {updated_company['details']}\nğŸ”˜ Ø§Ù„Ø­Ø§Ù„Ø©: {'Ù†Ø´Ø·' if updated_company.get('is_active') == 'active' else 'ØºÙŠØ± Ù†Ø´Ø·'}\"\"\"\n            \n            self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n            \n        except Exception as e:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª: {str(e)}\", self.admin_keyboard())\n        \n        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©\n        del self.user_states[user_id]\n        if user_id in self.edit_company_data:\n            del self.edit_company_data[user_id]\n    \n    def show_companies_management_enhanced(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø³Ù† Ù…Ø¹ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ\"\"\"\n        companies_text = \"ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©\\n\\n\"\n        \n        try:\n            # Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù\n            companies = []\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                companies = list(reader)  # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© ÙÙˆØ±Ø§Ù‹\n            \n            if len(companies) == 0:\n                companies_text += \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø©\\n\\n\"\n            else:\n                companies_text += f\"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø±ÙƒØ§Øª: {len(companies)}\\n\"\n                companies_text += f\"ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {datetime.now().strftime('%H:%M:%S')}\\n\\n\"\n                \n                for i, row in enumerate(companies, 1):\n                    status = \"âœ…\" if row.get('is_active', '').lower() == 'active' else \"âŒ\"\n                    type_display = {'deposit': 'Ø¥ÙŠØ¯Ø§Ø¹', 'withdraw': 'Ø³Ø­Ø¨', 'both': 'Ø§Ù„ÙƒÙ„'}.get(row.get('type', ''), row.get('type', ''))\n                    companies_text += f\"{i}. {status} **{row.get('name', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}** (ID: {row.get('id', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')})\\n\"\n                    companies_text += f\"   ğŸ”§ {type_display} | ğŸ“‹ {row.get('details', 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„')}\\n\\n\"\n                    \n        except Exception as e:\n            companies_text += f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª: {str(e)}\\n\\n\"\n            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ù„Ù„ØªØ´Ø®ÙŠØµ\n            try:\n                with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                    content = f.read()\n                    companies_text += f\"Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù:\\n{content[:200]}...\\n\\n\"\n            except:\n                companies_text += \"ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù\\n\\n\"\n        \n        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©\n        management_keyboard = {\n            'keyboard': [\n                [{'text': 'â• Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø©'}, {'text': 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙƒØ©'}],\n                [{'text': 'ğŸ—‘ï¸ Ø­Ø°Ù Ø´Ø±ÙƒØ©'}, {'text': 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'}],\n                [{'text': 'ğŸ“‹ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'}, {'text': 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†'}]\n            ],\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        companies_text += \"\"\"ğŸ”§ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:\nâ€¢ â• Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¬Ø¯ÙŠØ¯Ø© - Ù…Ø¹Ø§Ù„Ø¬ ØªÙØ§Ø¹Ù„ÙŠ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©\nâ€¢ âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø´Ø±ÙƒØ© - ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©\nâ€¢ ğŸ—‘ï¸ Ø­Ø°Ù Ø´Ø±ÙƒØ© - Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø£Ù…Ø§Ù†\nâ€¢ ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\"\"\"\n        \n        self.send_message(message['chat']['id'], companies_text, management_keyboard)\n    \n    def prompt_delete_company(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø£Ù…Ø§Ù†\"\"\"\n        companies_text = \"ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª:\\n\\n\"\n        \n        try:\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    status = \"âœ…\" if row.get('is_active') == 'active' else \"âŒ\"\n                    companies_text += f\"{status} {row['id']} - {row['name']}\\n\"\n                    companies_text += f\"   ğŸ“‹ {row['type']} - {row['details']}\\n\\n\"\n        except:\n            companies_text += \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª\\n\\n\"\n        \n        companies_text += \"âš ï¸ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø­Ø°Ù:\\n(ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡)\"\n        \n        self.send_message(message['chat']['id'], companies_text)\n        self.user_states[message['from']['id']] = 'confirming_company_delete'\n    \n    def handle_company_delete_confirmation(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        company_id = text\n        \n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ©\n        company_found = None\n        try:\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == company_id:\n                        company_found = row\n                        break\n        except:\n            pass\n        \n        if not company_found:\n            self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ù…Ø¹Ø±Ù: {company_id}\")\n            del self.user_states[user_id]\n            return\n        \n        # Ø¹Ø±Ø¶ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù\n        confirm_text = f\"\"\"âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©:\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {company_found['id']}\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {company_found['name']}\nğŸ“‹ Ø§Ù„Ù†ÙˆØ¹: {company_found['type']}\nğŸ“ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {company_found['details']}\n\nâš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù†Ù‡Ø§Ø¦ÙŠ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ\"\"\"\n        \n        confirm_keyboard = {\n            'keyboard': [\n                [{'text': 'ğŸ—‘ï¸ Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©'}, {'text': 'âŒ Ø¥Ù„ØºØ§Ø¡'}]\n            ],\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], confirm_text, confirm_keyboard)\n        self.user_states[user_id] = f'deleting_company_{company_id}'\n    \n    def finalize_company_delete(self, message, company_id):\n        \"\"\"Ø¥Ù†Ù‡Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text == 'ğŸ—‘ï¸ Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©':\n            # ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù\n            companies = []\n            deleted_company = None\n            \n            try:\n                with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                    reader = csv.DictReader(f)\n                    for row in reader:\n                        if row['id'] != company_id:\n                            companies.append(row)\n                        else:\n                            deleted_company = row\n                \n                # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©\n                with open('companies.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'name', 'type', 'details', 'is_active']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(companies)\n                \n                if deleted_company:\n                    success_msg = f\"\"\"âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ—‘ï¸ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {deleted_company['id']}\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {deleted_company['name']}\nğŸ“‹ Ø§Ù„Ù†ÙˆØ¹: {deleted_company['type']}\"\"\"\n                    \n                    self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n                else:\n                    self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø­Ø°Ù\", self.admin_keyboard())\n                    \n            except Exception as e:\n                self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©: {str(e)}\", self.admin_keyboard())\n        \n        elif text == 'âŒ Ø¥Ù„ØºØ§Ø¡':\n            self.send_message(message['chat']['id'], \"âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©\", self.admin_keyboard())\n        \n        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø©\n        del self.user_states[user_id]\n    \n    def show_quick_copy_commands(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø£ÙˆØ§Ù…Ø± Ù†Ø³Ø® Ø³Ø±ÙŠØ¹Ø© Ù„Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        commands_text = \"\"\"ğŸ“‹ Ø£ÙˆØ§Ù…Ø± Ù†Ø³Ø® Ø³Ø±ÙŠØ¹Ø©:\n\nğŸ”¥ **Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ø±ÙØ¶:**\nâ€¢ `Ù…ÙˆØ§ÙÙ‚Ø© DEP123456`\nâ€¢ `Ù…ÙˆØ§ÙÙ‚ DEP123456`\nâ€¢ `ØªØ£ÙƒÙŠØ¯ DEP123456`\nâ€¢ `Ù†Ø¹Ù… DEP123456`\n\nâ€¢ `Ø±ÙØ¶ DEP123456 Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­`\nâ€¢ `Ù„Ø§ DEP123456 Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©`\nâ€¢ `Ù…Ø±ÙÙˆØ¶ WTH789012 Ø±Ù‚Ù… Ù…Ø­ÙØ¸Ø© Ø®Ø·Ø£`\n\nğŸ’¼ **Ø£ÙˆØ§Ù…Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª:**\nâ€¢ `Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© Ø§Ù„Ø¨Ù†Ùƒ_Ø§Ù„Ø£Ù‡Ù„ÙŠ deposit Ø­Ø³Ø§Ø¨_Ø¨Ù†ÙƒÙŠ_123456789`\nâ€¢ `Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© ÙÙˆØ¯Ø§ÙÙˆÙ†_ÙƒØ§Ø´ both Ù…Ø­ÙØ¸Ø©_Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©`\nâ€¢ `Ø­Ø°Ù_Ø´Ø±ÙƒØ© 1737570855`\n\nğŸ’³ **Ø£ÙˆØ§Ù…Ø± ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹:**\nâ€¢ `Ø§Ø¶Ø§ÙØ©_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ 1 Ø¨Ù†Ùƒ_Ø§Ù„Ø£Ù‡Ù„ÙŠ Ø­Ø³Ø§Ø¨_Ø¨Ù†ÙƒÙŠ SA123456789012345678`\nâ€¢ `Ø­Ø°Ù_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ 123456`\nâ€¢ `ØªØ¹Ø¯ÙŠÙ„_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ 123456 SA987654321098765432`\n\nğŸ“§ **Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:**\nâ€¢ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ \"ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¹Ù…ÙŠÙ„\" Ø«Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„\n\nğŸ‘¥ **Ø£ÙˆØ§Ù…Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:**\nâ€¢ `Ø¨Ø­Ø« Ø£Ø­Ù…Ø¯`\nâ€¢ `Ø¨Ø­Ø« C123456`\nâ€¢ `Ø­Ø¸Ø± C123456 Ù…Ø®Ø§Ù„ÙØ© Ø§Ù„Ø´Ø±ÙˆØ·`\nâ€¢ `Ø§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± C123456`\n\nğŸ“¨ **Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰:**\nâ€¢ `Ø±Ø¯_Ø´ÙƒÙˆÙ‰ 123 Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„Ùƒ`\nâ€¢ `Ø±Ø¯_Ø´ÙƒÙˆÙ‰ 456 ØªÙ… Ø­Ù„ Ù…Ø´ÙƒÙ„ØªÙƒ`\nâ€¢ `Ø±Ø¯_Ø´ÙƒÙˆÙ‰ 789 Ù†Ø±Ø§Ø¬Ø¹ Ø·Ù„Ø¨Ùƒ`\n\nğŸ¢ **Ø£ÙˆØ§Ù…Ø± Ø£Ø®Ø±Ù‰:**\nâ€¢ `Ø¹Ù†ÙˆØ§Ù†_Ø¬Ø¯ÙŠØ¯ Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯ Ø§Ù„Ø±ÙŠØ§Ø¶`\nâ€¢ `ØªØ¹Ø¯ÙŠÙ„_Ø§Ø¹Ø¯Ø§Ø¯ min_deposit 100`\n\nğŸ’¡ **Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**\nâ€¢ Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ø£Ù…Ø± ÙˆØ§Ø®ØªØ± 'Ù†Ø³Ø®'\nâ€¢ ØºÙŠØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù†ØµÙˆØµ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©\nâ€¢ Ø§Ø³ØªØ®Ø¯Ù… _ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙÙŠ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ§Øª\"\"\"\n        \n        self.send_message(message['chat']['id'], commands_text, self.admin_keyboard())\n    \n    def get_payment_methods_by_company(self, company_id, transaction_type=None):\n        \"\"\"Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ø´Ø±ÙƒØ© Ù…Ø¹ÙŠÙ†Ø©\"\"\"\n        methods = []\n        try:\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if (row['company_id'] == str(company_id) and \n                        row['status'] == 'active'):\n                        methods.append(row)\n        except:\n            pass\n        return methods\n    \n    def show_payment_method_selection(self, message, company_id, transaction_type):\n        \"\"\"Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø´Ø±ÙƒØ©\"\"\"\n        user_id = message['from']['id']\n        methods = self.get_payment_methods_by_company(company_id, transaction_type)\n        \n        if not methods:\n            self.send_message(message['chat']['id'], \n                            \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹ Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø±ÙƒØ© Ø­Ø§Ù„ÙŠØ§Ù‹\",\n                            self.main_keyboard('ar'))\n            return\n        \n        methods_text = f\"ğŸ’³ Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹:\\n\\n\"\n        keyboard = []\n        \n        for method in methods:\n            methods_text += f\"ğŸ”¹ {method['method_name']}\\n\"\n            methods_text += f\"   ğŸ“‹ {method['method_type']}\\n\"\n            if method['additional_info']:\n                methods_text += f\"   ğŸ’¡ {method['additional_info']}\\n\"\n            methods_text += \"\\n\"\n            \n            keyboard.append([{'text': method['method_name']}])\n        \n        keyboard.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©'}])\n        \n        # Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø©\n        self.user_states[user_id] = {\n            'step': 'selecting_payment_method',\n            'company_id': company_id,\n            'transaction_type': transaction_type,\n            'methods': methods\n        }\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, reply_keyboard)\n    \n    def add_payment_method(self, company_id, method_name, method_type, account_data, additional_info=\"\"):\n        \"\"\"Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯Ø©\"\"\"\n        try:\n            # Ø¥Ù†Ø´Ø§Ø¡ ID Ø¬Ø¯ÙŠØ¯  \n            new_id = int(datetime.now().timestamp() * 1000) % 1000000\n            \n            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n            with open('payment_methods.csv', 'a', encoding='utf-8-sig', newline='') as f:\n                writer = csv.writer(f)\n                writer.writerow([\n                    new_id,\n                    company_id,\n                    method_name,\n                    method_type,\n                    account_data,\n                    additional_info,\n                    'active',\n                    datetime.now().strftime('%Y-%m-%d')\n                ])\n            return True\n        except:\n            return False\n    \n    def edit_payment_method(self, method_id, new_data):\n        \"\"\"ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ù…ÙˆØ¬ÙˆØ¯Ø©\"\"\"\n        try:\n            methods = []\n            found = False\n            \n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == str(method_id):\n                        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n                        for key, value in new_data.items():\n                            if key in row:\n                                row[key] = value\n                        found = True\n                    methods.append(row)\n            \n            if found:\n                # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©\n                with open('payment_methods.csv', 'w', encoding='utf-8-sig', newline='') as f:\n                    if methods:\n                        fieldnames = methods[0].keys()\n                        writer = csv.DictWriter(f, fieldnames=fieldnames)\n                        writer.writeheader()\n                        writer.writerows(methods)\n                return True\n        except:\n            pass\n        return False\n    \n    def delete_payment_method(self, method_id):\n        \"\"\"Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ù…Ø¹ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©\"\"\"\n        try:\n            methods = []\n            deleted_method = None\n            \n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] != str(method_id):\n                        methods.append(row)\n                    else:\n                        deleted_method = row.copy()\n            \n            if deleted_method:\n                # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† ÙØ§Ø±Øº\n                with open('payment_methods.csv', 'w', encoding='utf-8-sig', newline='') as f:\n                    fieldnames = ['id', 'company_id', 'method_name', 'method_type', 'account_data', 'additional_info', 'status', 'created_date']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    if methods:  # ÙÙ‚Ø· Ø§ÙƒØªØ¨ Ø§Ù„ØµÙÙˆÙ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©\n                        writer.writerows(methods)\n                \n                logger.info(f\"ØªÙ… Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}: {deleted_method.get('method_name', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\")\n                return True, deleted_method\n            \n            return False, None\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}: {e}\")\n            return False, None\n    \n    def start_add_company_wizard(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© ØªÙØ§Ø¹Ù„ÙŠ\"\"\"\n        wizard_text = \"\"\"ğŸ§™â€â™‚ï¸ Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©\n\nØ³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø³Ù‡Ù„Ø©!\n\nğŸ“ Ø£ÙˆÙ„Ø§Ù‹: Ù…Ø§ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©ØŸ\n(Ù…Ø«Ø§Ù„: Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠØŒ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ØŒ Ù…Ø¯Ù‰)\"\"\"\n        \n        self.send_message(message['chat']['id'], wizard_text)\n        self.user_states[message['from']['id']] = 'adding_company_name'\n    \n    def handle_add_company_wizard(self, message, text):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¹Ø§Ù„Ø¬ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id, '')\n        \n        if state == 'adding_company_name':\n            company_name = text.strip()\n            if len(company_name) < 2:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©:\")\n                return\n            \n            # Ø¹Ø±Ø¶ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø®Ø¯Ù…Ø©\n            service_keyboard = {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·'}, {'text': 'ğŸ’¸ Ø³Ø­Ø¨ ÙÙ‚Ø·'}],\n                    [{'text': 'ğŸ”„ Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨ Ù…Ø¹Ø§Ù‹'}],\n                    [{'text': 'âŒ Ø¥Ù„ØºØ§Ø¡'}, {'text': 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': True\n            }\n            \n            self.send_message(message['chat']['id'], f\"âœ… Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\\n\\nğŸ”¹ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:\", service_keyboard)\n            self.user_states[user_id] = f'adding_company_type_{company_name}'\n            \n        elif state.startswith('adding_company_type_'):\n            company_name = state.replace('adding_company_type_', '')\n            \n            if text == 'âŒ Ø¥Ù„ØºØ§Ø¡':\n                self.send_message(message['chat']['id'], \"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©\", self.admin_keyboard())\n                del self.user_states[user_id]\n                return\n            \n            # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©\n            if text == 'ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·':\n                service_type = 'deposit'\n                service_ar = 'Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·'\n            elif text == 'ğŸ’¸ Ø³Ø­Ø¨ ÙÙ‚Ø·':\n                service_type = 'withdraw'\n                service_ar = 'Ø³Ø­Ø¨ ÙÙ‚Ø·'\n            elif text == 'ğŸ”„ Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨ Ù…Ø¹Ø§Ù‹':\n                service_type = 'both'\n                service_ar = 'Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨'\n            else:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:\")\n                return\n            \n            self.send_message(message['chat']['id'], f\"\"\"âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: {service_ar}\n\nğŸ“ Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ©:\n(Ù…Ø«Ø§Ù„: Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ Ø±Ù‚Ù… 1234567890ØŒ Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©ØŒ Ø®Ø¯Ù…Ø§Øª Ø¯ÙØ¹ Ù…ØªØ¹Ø¯Ø¯Ø©)\"\"\")\n            \n            self.user_states[user_id] = f'adding_company_details_{company_name}_{service_type}'\n            \n        elif state.startswith('adding_company_details_'):\n            parts = state.replace('adding_company_details_', '').rsplit('_', 1)\n            company_name = parts[0]\n            service_type = parts[1]\n            details = text.strip()\n            \n            if len(details) < 3:\n                self.send_message(message['chat']['id'], \"âŒ ØªÙØ§ØµÙŠÙ„ Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹. Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ù…Ù†Ø§Ø³Ø¨:\")\n                return\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø±ÙƒØ©\n            company_id = str(int(datetime.now().timestamp()))\n            \n            try:\n                with open('companies.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                    writer = csv.writer(f)\n                    writer.writerow([company_id, company_name, service_type, details, 'active'])\n                \n                service_ar = \"Ø¥ÙŠØ¯Ø§Ø¹ ÙÙ‚Ø·\" if service_type == 'deposit' else \"Ø³Ø­Ø¨ ÙÙ‚Ø·\" if service_type == 'withdraw' else \"Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨\"\n                \n                success_msg = f\"\"\"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {company_id}\nğŸ¢ Ø§Ù„Ø§Ø³Ù…: {company_name}\nâš¡ Ø§Ù„Ù†ÙˆØ¹: {service_ar}\nğŸ“‹ Ø§Ù„ØªÙØ§ØµÙŠÙ„: {details}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nØ§Ù„Ø´Ø±ÙƒØ© Ø£ØµØ¨Ø­Øª Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù† Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡.\"\"\"\n                \n                self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n                del self.user_states[user_id]\n                \n            except Exception as e:\n                self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©: {str(e)}\", self.admin_keyboard())\n                del self.user_states[user_id]\n    \n    def show_companies_management(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª\"\"\"\n        companies_text = \"ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª:\\n\\n\"\n        \n        try:\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    status = \"âœ…\" if row.get('is_active') == 'active' else \"âŒ\"\n                    companies_text += f\"{status} {row['id']} - {row['name']}\\n\"\n                    companies_text += f\"   ğŸ“‹ {row['type']} - {row['details']}\\n\\n\"\n        except:\n            pass\n        \n        companies_text += \"ğŸ“ Ø§Ù„Ø£ÙˆØ§Ù…Ø±:\\n\"\n        companies_text += \"â€¢ Ø§Ø¶Ø§ÙØ©_Ø´Ø±ÙƒØ© Ø§Ø³Ù… Ù†ÙˆØ¹ ØªÙØ§ØµÙŠÙ„\\n\"\n        companies_text += \"â€¢ Ø­Ø°Ù_Ø´Ø±ÙƒØ© Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø±Ù\\n\"\n        \n        self.send_message(message['chat']['id'], companies_text, self.admin_keyboard())\n    \n    def show_addresses_management(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†\"\"\"\n        current_address = self.get_exchange_address()\n        \n        address_text = f\"\"\"ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØµØ±Ø§ÙØ©\n\nØ§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ:\n{current_address}\n\nÙ„ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:\nØ¹Ù†ÙˆØ§Ù†_Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ_Ø§Ù„Ø¬Ø¯ÙŠØ¯_Ù„Ù„Ø¹Ù†ÙˆØ§Ù†\n\nÙ…Ø«Ø§Ù„:\nØ¹Ù†ÙˆØ§Ù†_Ø¬Ø¯ÙŠØ¯ Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯ØŒ Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ù…Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¬ Ø§Ù„Ù…Ù…Ù„ÙƒØ©\"\"\"\n        \n        self.send_message(message['chat']['id'], address_text, self.admin_keyboard())\n    \n    def show_system_settings(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        settings_text = \"âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:\\n\\n\"\n        \n        try:\n            with open('system_settings.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    settings_text += f\"ğŸ”§ {row['setting_key']}: {row['setting_value']}\\n\"\n                    settings_text += f\"   ğŸ“ {row['description']}\\n\\n\"\n        except:\n            pass\n        \n        settings_text += \"ğŸ“ Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯:\\n\"\n        settings_text += \"ØªØ¹Ø¯ÙŠÙ„_Ø§Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­_Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\\n\\n\"\n        settings_text += \"Ù…Ø«Ø§Ù„:\\nØªØ¹Ø¯ÙŠÙ„_Ø§Ø¹Ø¯Ø§Ø¯ min_deposit 100\"\n        \n        self.send_message(message['chat']['id'], settings_text, self.admin_keyboard())\n    \n    def show_complaints_admin(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø±Ø¯ Ø³Ù‡Ù„Ø©\"\"\"\n        complaints_text = \"ğŸ“¨ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰:\\n\\n\"\n        keyboard = []\n        \n        try:\n            with open('complaints.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                pending_complaints = [row for row in reader if row['status'] == 'pending']\n                \n                if not pending_complaints:\n                    complaints_text += \"âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰ Ù…Ø¹Ù„Ù‚Ø©\"\n                    keyboard = [\n                        [{'text': 'ğŸ”„ ØªØ­Ø¯ÙŠØ«'}],\n                        [{'text': 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†'}]\n                    ]\n                else:\n                    for complaint in pending_complaints:\n                        complaints_text += f\"ğŸ†” {complaint['id']}\\n\"\n                        complaints_text += f\"ğŸ‘¤ {complaint['customer_id']}\\n\"\n                        complaints_text += f\"ğŸ“ {complaint['message']}\\n\"\n                        complaints_text += f\"ğŸ“… {complaint['date']}\\n\\n\"\n                        \n                        # Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø±Ø¯ Ø³Ø±ÙŠØ¹Ø©\n                        keyboard.append([{'text': f\"ğŸ“ Ø±Ø¯ Ø¹Ù„Ù‰ {complaint['id']}\"}])\n                    \n                    keyboard.extend([\n                        [{'text': 'ğŸ”„ ØªØ­Ø¯ÙŠØ«'}],\n                        [{'text': 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†'}]\n                    ])\n                        \n        except Exception as e:\n            complaints_text += f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰: {e}\"\n            keyboard = [\n                [{'text': 'ğŸ”„ ØªØ­Ø¯ÙŠØ«'}],\n                [{'text': 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†'}]\n            ]\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': False\n        }\n        \n        self.send_message(message['chat']['id'], complaints_text, reply_keyboard)\n    \n    def start_complaint_reply_wizard(self, message, complaint_id):\n        \"\"\"Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙˆÙ‰\"\"\"\n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´ÙƒÙˆÙ‰\n        complaint_found = False\n        complaint_data = None\n        \n        try:\n            with open('complaints.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == complaint_id:\n                        complaint_found = True\n                        complaint_data = row\n                        break\n        except:\n            pass\n        \n        if not complaint_found:\n            self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙˆÙ‰ {complaint_id}\", self.admin_keyboard())\n            return\n        \n        # Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù…Ø¹ Ø£Ø²Ø±Ø§Ø± Ø±Ø¯ÙˆØ¯ Ø³Ø±ÙŠØ¹Ø©\n        reply_text = f\"\"\"ğŸ“ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙˆÙ‰:\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰: {complaint_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {complaint_data['customer_id']}\nğŸ“ Ø§Ù„Ø´ÙƒÙˆÙ‰: {complaint_data['message']}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {complaint_data['date']}\n\nØ§Ø®ØªØ± Ø±Ø¯ Ø³Ø±ÙŠØ¹ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ø¯ Ù…Ø®ØµØµ:\"\"\"\n        \n        keyboard = [\n            [{'text': f\"âœ… ØªÙ… Ø§Ù„Ø­Ù„ - {complaint_id}\"}],\n            [{'text': f\"ğŸ” Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© - {complaint_id}\"}],\n            [{'text': f\"ğŸ“ Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ - {complaint_id}\"}],\n            [{'text': f\"ğŸ’¡ Ø±Ø¯ Ù…Ø®ØµØµ - {complaint_id}\"}],\n            [{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´ÙƒØ§ÙˆÙ‰'}]\n        ]\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], reply_text, reply_keyboard)\n        self.user_states[message['from']['id']] = f'replying_to_complaint_{complaint_id}'\n    \n    def show_payment_methods_admin(self, message):\n        \"\"\"Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        payment_text = \"\"\"ğŸ’³ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©\n\nÙ‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø­Ø¨.\nØ§Ø³ØªØ®Ø¯Ù… 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª' Ù„Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹.\"\"\"\n        \n        companies = self.get_companies()\n        for company in companies:\n            service_type = \"Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ³Ø­Ø¨\" if company['type'] == 'both' else \"Ø¥ÙŠØ¯Ø§Ø¹\" if company['type'] == 'deposit' else \"Ø³Ø­Ø¨\"\n            payment_text += f\"\\nğŸ¢ {company['name']}\\n\"\n            payment_text += f\"   ğŸ“‹ {service_type} - {company['details']}\\n\"\n        \n        self.send_message(message['chat']['id'], payment_text, self.admin_keyboard())\n    \n    def ban_user_admin(self, message, customer_id, reason):\n        \"\"\"Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        users = []\n        success = False\n        \n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == customer_id:\n                        row['is_banned'] = 'yes'\n                        row['ban_reason'] = reason\n                        success = True\n                    users.append(row)\n            \n            if success:\n                with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date', 'is_banned', 'ban_reason']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(users)\n                \n                self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id}\\nØ§Ù„Ø³Ø¨Ø¨: {reason}\", self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id}\", self.admin_keyboard())\n        except:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\", self.admin_keyboard())\n    \n    def unban_user_admin(self, message, customer_id):\n        \"\"\"Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        users = []\n        success = False\n        \n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == customer_id:\n                        row['is_banned'] = 'no'\n                        row['ban_reason'] = ''\n                        success = True\n                    users.append(row)\n            \n            if success:\n                with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date', 'is_banned', 'ban_reason']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(users)\n                \n                self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id}\", self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ {customer_id}\", self.admin_keyboard())\n        except:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\", self.admin_keyboard())\n    \n    def delete_company_simple(self, message, company_id):\n        \"\"\"Ø­Ø°Ù Ø´Ø±ÙƒØ© Ø¨Ø³ÙŠØ·\"\"\"\n        companies = []\n        deleted = False\n        \n        try:\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] != company_id:\n                        companies.append(row)\n                    else:\n                        deleted = True\n                        deleted_name = row.get('name', 'Unknown')\n            \n            if deleted:\n                with open('companies.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'name', 'type', 'details', 'is_active']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(companies)\n                \n                self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©: {deleted_name} (ID: {company_id})\", self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙƒØ© Ø¨Ø§Ù„Ù…Ø¹Ø±Ù: {company_id}\", self.admin_keyboard())\n        except:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©\", self.admin_keyboard())\n    \n    def update_setting_simple(self, message, text):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        # ØªÙ†Ø³ÙŠÙ‚: ØªØ¹Ø¯ÙŠÙ„_Ø§Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­_Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n        parts = text.replace('ØªØ¹Ø¯ÙŠÙ„_Ø§Ø¹Ø¯Ø§Ø¯ ', '').split(' ', 1)\n        if len(parts) < 2:\n            help_text = \"\"\"âŒ ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Ø·Ø¦\n\nØ§Ù„ØµÙŠØºØ© Ø§Ù„ØµØ­ÙŠØ­Ø©:\nØªØ¹Ø¯ÙŠÙ„_Ø§Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­_Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø©_Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n\nÙ…Ø«Ø§Ù„:\nØªØ¹Ø¯ÙŠÙ„_Ø§Ø¹Ø¯Ø§Ø¯ min_deposit 100\"\"\"\n            self.send_message(message['chat']['id'], help_text, self.admin_keyboard())\n            return\n        \n        setting_key = parts[0]\n        setting_value = parts[1]\n        \n        settings = []\n        updated = False\n        \n        try:\n            with open('system_settings.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['setting_key'] == setting_key:\n                        row['setting_value'] = setting_value\n                        updated = True\n                    settings.append(row)\n            \n            if updated:\n                with open('system_settings.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['setting_key', 'setting_value', 'description']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(settings)\n                \n                self.send_message(message['chat']['id'], f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯:\\n{setting_key} = {setting_value}\", self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯: {setting_key}\", self.admin_keyboard())\n        except:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯\", self.admin_keyboard())\n    \n    def save_complaint(self, message, complaint_text):\n        \"\"\"Ø­ÙØ¸ Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        complaint_id = f\"COMP{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n        \n        try:\n            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ Ù…Ø¹ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ØµØ­ÙŠØ­ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹\n            if not os.path.exists('complaints.csv'):\n                with open('complaints.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    writer = csv.writer(f)\n                    writer.writerow(['id', 'customer_id', 'subject', 'message', 'status', 'date', 'admin_response'])\n            \n            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n            with open('complaints.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([complaint_id, user['customer_id'], 'Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©', complaint_text, 'pending', \n                               datetime.now().strftime('%Y-%m-%d %H:%M'), ''])\n            \n            confirmation = f\"\"\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø´ÙƒÙˆØ§Ùƒ Ø¨Ù†Ø¬Ø§Ø­\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰: {complaint_id}\nğŸ“ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: {complaint_text}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nØ³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†.\"\"\"\n            \n            self.send_message(message['chat']['id'], confirmation, self.main_keyboard(user.get('language', 'ar')))\n            if message['from']['id'] in self.user_states:\n                del self.user_states[message['from']['id']]\n            \n            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n            admin_msg = f\"\"\"ğŸ“¨ Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©\n\nğŸ†” {complaint_id}\nğŸ‘¤ {user['name']} ({user['customer_id']})\nğŸ“ Ø§Ù„Ø´ÙƒÙˆÙ‰: {complaint_text}\nğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}\"\"\"\n            \n            self.notify_admins(admin_msg)\n            \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø´ÙƒÙˆÙ‰: {e}\")\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´ÙƒÙˆÙ‰. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰\", self.main_keyboard(user.get('language', 'ar')))\n            if message['from']['id'] in self.user_states:\n                del self.user_states[message['from']['id']]\n    \n    def send_broadcast_message(self, message, broadcast_text):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©\"\"\"\n        sent_count = 0\n        failed_count = 0\n        \n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                users = list(reader)\n            \n            # Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† ÙÙ‚Ø·\n            for user in users:\n                if user.get('is_banned') != 'yes':\n                    try:\n                        broadcast_msg = f\"\"\"ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\n\n{broadcast_text}\n\nğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}\"\"\"\n                        \n                        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ø­ØªÙ‰ Ù„Ø§ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©\n                        result = self.send_message(user['telegram_id'], broadcast_msg, None)\n                        if result and result.get('ok'):\n                            sent_count += 1\n                        else:\n                            failed_count += 1\n                    except:\n                        failed_count += 1\n            \n            summary = f\"\"\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©\n\nğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\nâ€¢ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­: {sent_count}\nâ€¢ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {failed_count}\nâ€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: {sent_count + failed_count}\n\nğŸ“ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {broadcast_text}\"\"\"\n            \n            self.send_message(message['chat']['id'], summary, self.admin_keyboard())\n            del self.user_states[message['from']['id']]\n        except:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ\", self.admin_keyboard())\n            del self.user_states[message['from']['id']]\n\n    def show_approved_transactions(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…ÙÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§\"\"\"\n        approved_text = \"âœ… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…ÙÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§ (Ø¢Ø®Ø± 20 Ù…Ø¹Ø§Ù…Ù„Ø©):\\n\\n\"\n        found_approved = False\n        count = 0\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                transactions = list(reader)\n                \n                # Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª\n                for row in reversed(transactions):\n                    if row['status'] == 'approved' and count < 20:\n                        found_approved = True\n                        count += 1\n                        type_emoji = \"ğŸ’°\" if row['type'] == 'deposit' else \"ğŸ’¸\"\n                        \n                        approved_text += f\"{type_emoji} {row['id']}\\n\"\n                        approved_text += f\"ğŸ‘¤ {row['name']}\\n\"\n                        approved_text += f\"ğŸ’° {row['amount']} Ø±ÙŠØ§Ù„\\n\"\n                        approved_text += f\"ğŸ“… {row['date']}\\n\\n\"\n        except:\n            pass\n        \n        if not found_approved:\n            approved_text += \"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…ÙÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§\"\n        \n        self.send_message(message['chat']['id'], approved_text, self.admin_keyboard())\n    \n    def show_users_management(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\"\"\"\n        users_text = \"ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\\n\\n\"\n        active_count = 0\n        banned_count = 0\n        \n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row.get('is_banned') == 'yes':\n                        banned_count += 1\n                    else:\n                        active_count += 1\n        except:\n            pass\n        \n        users_text += f\"âœ… Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù†Ø´Ø·ÙˆÙ†: {active_count}\\n\"\n        users_text += f\"ğŸš« Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ø­Ø¸ÙˆØ±ÙˆÙ†: {banned_count}\\n\\n\"\n        \n        users_text += \"ğŸ“ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:\\n\"\n        users_text += \"â€¢ Ø¨Ø­Ø« Ø§Ø³Ù…_Ø£Ùˆ_Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„\\n\"\n        users_text += \"â€¢ Ø­Ø¸Ø± Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨\\n\"\n        users_text += \"â€¢ Ø§Ù„ØºØ§Ø¡_Ø­Ø¸Ø± Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„\\n\\n\"\n        \n        users_text += \"Ù…Ø«Ø§Ù„:\\nØ¨Ø­Ø« Ø£Ø­Ù…Ø¯\\nØ­Ø¸Ø± C123456 Ù…Ø®Ø§Ù„ÙØ©_Ø§Ù„Ø´Ø±ÙˆØ·\"\n        \n        self.send_message(message['chat']['id'], users_text, self.admin_keyboard())\n    \n    def search_users_admin(self, message, query):\n        \"\"\"Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        results = []\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if (query.lower() in row['name'].lower() or \n                        query in row['customer_id'] or \n                        query in row['phone']):\n                        results.append(row)\n        except:\n            pass\n        \n        if not results:\n            self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«: {query}\", self.admin_keyboard())\n            return\n        \n        search_text = f\"ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: {query}\\n\\n\"\n        for user in results[:10]:  # Ø£ÙˆÙ„ 10 Ù†ØªØ§Ø¦Ø¬ ÙÙ‚Ø·\n            status = \"ğŸš« Ù…Ø­Ø¸ÙˆØ±\" if user.get('is_banned') == 'yes' else \"âœ… Ù†Ø´Ø·\"\n            search_text += f\"ğŸ‘¤ {user['name']}\\n\"\n            search_text += f\"ğŸ†” {user['customer_id']}\\n\"\n            search_text += f\"ğŸ“± {user['phone']}\\n\"\n            search_text += f\"ğŸ”¸ {status}\\n\"\n            if user.get('is_banned') == 'yes' and user.get('ban_reason'):\n                search_text += f\"ğŸ“ Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±: {user['ban_reason']}\\n\"\n            search_text += \"\\n\"\n        \n        self.send_message(message['chat']['id'], search_text, self.admin_keyboard())\n    \n    def start_simple_payment_method_wizard(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø¨Ø³Ø· Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\"\"\"\n        user_id = message['from']['id']\n        \n        # Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©\n        companies = self.get_companies()\n        if not companies:\n            self.send_message(message['chat']['id'], \n                            \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…ØªØ§Ø­Ø©. ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹\", \n                            self.admin_keyboard())\n            return\n        \n        companies_text = \"ğŸ¢ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹:\\n\\n\"\n        keyboard = []\n        \n        for company in companies:\n            companies_text += f\"ğŸ”¹ {company['name']}\\n\"\n            keyboard.append([{'text': f\"ğŸ¢ {company['name']}\"}])\n        \n        keyboard.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        self.user_states[user_id] = 'adding_payment_simple'\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], companies_text, reply_keyboard)\n    \n    def start_edit_payment_method_wizard(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø¨Ø³Ø· Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\"\"\"\n        methods = self.get_all_payment_methods()\n        if not methods:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹ Ù…ØªØ§Ø­Ø©\", self.admin_keyboard())\n            return\n        \n        methods_text = \"âœï¸ Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:\\n\\n\"\n        keyboard = []\n        \n        for method in methods:\n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            \n            methods_text += f\"ğŸ†” {method['id']} - {method['method_name']}\\n\"\n            methods_text += f\"   ğŸ¢ {company_name}\\n\"\n            methods_text += f\"   ğŸ’³ {method['method_type']}\\n\\n\"\n            \n            keyboard.append([{'text': f\"ØªØ¹Ø¯ÙŠÙ„ {method['id']}\"}])\n        \n        keyboard.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        self.user_states[message['from']['id']] = 'selecting_method_to_edit_simple'\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, reply_keyboard)\n    \n    def start_delete_payment_method_wizard(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ Ù…Ø¨Ø³Ø· Ù„Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\"\"\"\n        methods = self.get_all_payment_methods()\n        if not methods:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹ Ù…ØªØ§Ø­Ø©\", self.admin_keyboard())\n            return\n        \n        methods_text = \"ğŸ—‘ï¸ Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø­Ø°Ù:\\n\\n\"\n        keyboard = []\n        \n        for method in methods:\n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            \n            methods_text += f\"ğŸ†” {method['id']} - {method['method_name']}\\n\"\n            methods_text += f\"   ğŸ¢ {company_name}\\n\\n\"\n            \n            keyboard.append([{'text': f\"Ø­Ø°Ù {method['id']}\"}])\n        \n        keyboard.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        self.user_states[message['from']['id']] = 'selecting_method_to_delete_simple'\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, reply_keyboard)\n    \n    def show_all_payment_methods_simplified(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ù…Ø¨Ø³Ø· Ù„Ø¬Ù…ÙŠØ¹ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\"\"\"\n        methods = self.get_all_payment_methods()\n        \n        if not methods:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹ Ù…Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯\", self.admin_keyboard())\n            return\n        \n        methods_text = \"ğŸ“Š ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©:\\n\\n\"\n        \n        for method in methods:\n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            status = \"âœ… Ù†Ø´Ø·\" if method['status'] == 'active' else \"âŒ Ù…ØªÙˆÙ‚Ù\"\n            \n            methods_text += f\"ğŸ†” {method['id']} - {method['method_name']}\\n\"\n            methods_text += f\"ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\\n\"\n            methods_text += f\"ğŸ’³ Ø§Ù„Ù†ÙˆØ¹: {method['method_type']}\\n\"\n            methods_text += f\"ğŸ’° Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {method['account_data']}\\n\"\n            methods_text += f\"ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: {status}\\n\"\n            if method['additional_info']:\n                methods_text += f\"ğŸ’¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª: {method['additional_info']}\\n\"\n            methods_text += \"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\\n\\n\"\n        \n        methods_text += f\"ğŸ“ˆ Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹: {len(methods)}\"\n        \n        self.send_message(message['chat']['id'], methods_text, self.admin_keyboard())\n    \n    def handle_simple_payment_company_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù…Ø¨Ø³Ø·\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text in ['ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©']:\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.show_payment_methods_management(message)\n            return\n        \n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ©\n        company_name = text.replace('ğŸ¢ ', '')\n        companies = self.get_companies()\n        selected_company = None\n        \n        for company in companies:\n            if company['name'] == company_name:\n                selected_company = company\n                break\n        \n        if not selected_company:\n            self.send_message(message['chat']['id'], \"âŒ Ø´Ø±ÙƒØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¹Ù„Ø§Ù‡\")\n            return\n        \n        # Ø·Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\n        input_text = f\"\"\"ğŸ“‹ Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ù„Ù„Ø´Ø±ÙƒØ©: {selected_company['name']}\n\nØ£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ù„ÙŠ:\nØ§Ø³Ù…_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© | Ù†ÙˆØ¹_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© | Ø±Ù‚Ù…_Ø§Ù„Ø­Ø³Ø§Ø¨ | Ù…Ø¹Ù„ÙˆÙ…Ø§Øª_Ø¥Ø¶Ø§ÙÙŠØ©\n\nÙ…Ø«Ø§Ù„:\nØ¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ | Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ | SA1234567890123456789 | Ø­Ø³Ø§Ø¨ Ø±Ø¦ÙŠØ³ÙŠ\nØ£Ùˆ\nÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ | Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© | 01012345678 | Ù„Ù„Ø¯ÙØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n        \n        self.send_message(message['chat']['id'], input_text)\n        self.user_states[user_id] = f'adding_payment_method_{selected_company[\"id\"]}'\n    \n    def handle_simple_payment_method_data(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø¨Ø³Ø·Ø©\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        state = self.user_states.get(user_id, '')\n        \n        if text == '/cancel':\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.show_payment_methods_management(message)\n            return\n        \n        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø±ÙƒØ©\n        company_id = state.replace('adding_payment_method_', '')\n        \n        # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©\n        if '|' in text:\n            parts = [part.strip() for part in text.split('|')]\n            if len(parts) >= 3:\n                method_name = parts[0]\n                method_type = parts[1]\n                account_data = parts[2]\n                additional_info = parts[3] if len(parts) > 3 else \"\"\n                \n                # Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\n                success = self.add_payment_method(company_id, method_name, method_type, account_data, additional_info)\n                \n                if success:\n                    company = self.get_company_by_id(company_id)\n                    company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n                    \n                    success_msg = f\"\"\"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ“‹ Ø§Ù„Ø§Ø³Ù…: {method_name}\nğŸ’³ Ø§Ù„Ù†ÙˆØ¹: {method_type}\nğŸ’° Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {account_data}\nğŸ’¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª: {additional_info if additional_info else 'Ù„Ø§ ØªÙˆØ¬Ø¯'}\"\"\"\n                    \n                    self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n                else:\n                    self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\", self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], \"âŒ ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 3 Ø£Ø¬Ø²Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…ÙØµÙˆÙ„Ø© Ø¨Ù€ |\")\n                return\n        else:\n            self.send_message(message['chat']['id'], \"âŒ ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ø³ØªØ®Ø¯Ù… | Ù„Ù„ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\")\n            return\n        \n        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø©\n        if user_id in self.user_states:\n            del self.user_states[user_id]\n    \n    def handle_simple_method_edit_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø³Ø·\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text in ['ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©']:\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.show_payment_methods_management(message)\n            return\n        \n        if text.startswith('ØªØ¹Ø¯ÙŠÙ„ '):\n            method_id = text.replace('ØªØ¹Ø¯ÙŠÙ„ ', '').strip()\n            method = self.get_payment_method_by_id(method_id)\n            \n            if not method:\n                self.send_message(message['chat']['id'], \"âŒ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©\")\n                return\n            \n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            \n            edit_text = f\"\"\"âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {method['id']}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ“‹ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: {method['method_name']}\nğŸ’³ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ: {method['method_type']}\nğŸ’° Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {method['account_data']}\nğŸ’¡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {method['additional_info']}\n\nØ£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„ØªÙ†Ø³ÙŠÙ‚:\nØ§Ø³Ù…_Ø¬Ø¯ÙŠØ¯ | Ù†ÙˆØ¹_Ø¬Ø¯ÙŠØ¯ | Ø±Ù‚Ù…_Ø­Ø³Ø§Ø¨_Ø¬Ø¯ÙŠØ¯ | Ù…Ø¹Ù„ÙˆÙ…Ø§Øª_Ø¬Ø¯ÙŠØ¯Ø©\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n            \n            self.send_message(message['chat']['id'], edit_text)\n            self.user_states[user_id] = f'editing_method_simple_{method_id}'\n    \n    def handle_simple_method_delete_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ø³Ø·\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text in ['ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©']:\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.show_payment_methods_management(message)\n            return\n        \n        if text.startswith('Ø­Ø°Ù '):\n            method_id = text.replace('Ø­Ø°Ù ', '').strip()\n            \n            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù\n            method_to_delete = self.get_payment_method_by_id(method_id)\n            if not method_to_delete:\n                self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\", self.admin_keyboard())\n                if user_id in self.user_states:\n                    del self.user_states[user_id]\n                return\n            \n            # Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\n            success, deleted_method = self.delete_payment_method(method_id)\n            \n            if success and deleted_method:\n                company = self.get_company_by_id(deleted_method['company_id'])\n                company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n                \n                success_msg = f\"\"\"âœ… ØªÙ… Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: {deleted_method['id']}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ“‹ Ø§Ù„Ø§Ø³Ù…: {deleted_method['method_name']}\nğŸ’³ Ø§Ù„Ù†ÙˆØ¹: {deleted_method['method_type']}\"\"\"\n                \n                self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\", self.admin_keyboard())\n            \n            # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø©\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n    \n    def handle_simple_method_edit_data(self, message, method_id):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø³Ø·\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text == '/cancel':\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.show_payment_methods_management(message)\n            return\n        \n        # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© - ØªÙ†Ø³ÙŠÙ‚ Ù…Ø¨Ø³Ø·\n        if '|' in text:\n            parts = [part.strip() for part in text.split('|')]\n            if len(parts) >= 3:\n                new_name = parts[0]\n                new_type = parts[1]\n                new_account = parts[2]\n                new_info = parts[3] if len(parts) > 3 else \"\"\n                \n                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«\n                existing_method = self.get_payment_method_by_id(method_id)\n                if not existing_method:\n                    self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø±Ù‚Ù… {method_id}\", self.admin_keyboard())\n                    if user_id in self.user_states:\n                        del self.user_states[user_id]\n                    return\n                \n                # ØªØ­Ø¯ÙŠØ« ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\n                logger.info(f\"Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ« ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ - Ø§Ù„Ù…Ø¹Ø±Ù: {method_id}, Ø§Ù„Ø§Ø³Ù…: {new_name}, Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {new_account}\")\n                \n                # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ´Ø®ÙŠØµ\n                logger.info(f\"Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©: Ø§Ù„Ø§Ø³Ù…={new_name}, Ø§Ù„Ù†ÙˆØ¹={new_type}, Ø§Ù„Ø­Ø³Ø§Ø¨={new_account}, Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª={new_info}\")\n                \n                success = self.update_payment_method_safe(method_id, new_name, new_type, new_account, new_info)\n                \n                if success:\n                    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©\n                    company = self.get_company_by_id(existing_method['company_id'])\n                    company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n                    \n                    success_msg = f\"\"\"âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {method_id}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ“‹ Ø§Ù„Ø§Ø³Ù…: {new_name}\nğŸ’³ Ø§Ù„Ù†ÙˆØ¹: {new_type}\nğŸ’° Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {new_account}\nğŸ’¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: {new_info if new_info else 'Ù„Ø§ ØªÙˆØ¬Ø¯'}\"\"\"\n                    \n                    self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n                else:\n                    self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\", self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], \"âŒ ØªÙ†Ø³ÙŠÙ‚ ØºÙŠØ± ØµØ­ÙŠØ­!\\n\\nØ§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:\\nØ§Ø³Ù…_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© | Ù†ÙˆØ¹_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© | Ø±Ù‚Ù…_Ø§Ù„Ø­Ø³Ø§Ø¨ | Ù…Ø¹Ù„ÙˆÙ…Ø§Øª_Ø¥Ø¶Ø§ÙÙŠØ©\\n\\nÙ…Ø«Ø§Ù„:\\nÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ | Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© | 01012345678 | Ù„Ù„Ø¯ÙØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹\")\n                return\n        else:\n            self.send_message(message['chat']['id'], \"âŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… | Ù„Ù„ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!\\n\\nÙ…Ø«Ø§Ù„:\\nÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ | Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© | 01012345678 | Ù„Ù„Ø¯ÙØ¹ Ø§Ù„Ø³Ø±ÙŠØ¹\")\n            return\n        \n        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø©\n        if user_id in self.user_states:\n            del self.user_states[user_id]\n    \n    def update_payment_method_safe(self, method_id, new_name, new_type, new_account, new_info=\"\"):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ø¢Ù…Ù† Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ø¹ ØªØ­Ù‚Ù‚ Ø´Ø§Ù…Ù„\"\"\"\n        try:\n            methods = []\n            updated = False\n            original_method = None\n            \n            # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ³ÙŠÙ„Ø©\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == str(method_id):\n                        original_method = row.copy()\n                        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n                        row['method_name'] = new_name\n                        row['method_type'] = new_type\n                        row['account_data'] = new_account\n                        row['additional_info'] = new_info\n                        updated = True\n                        logger.info(f\"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id} ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§\")\n                    methods.append(row)\n            \n            if not updated:\n                logger.error(f\"Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\")\n                return False\n            \n            # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ø¯Ø«\n            with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                fieldnames = ['id', 'company_id', 'method_name', 'method_type', 'account_data', 'additional_info', 'status', 'created_date']\n                writer = csv.DictWriter(f, fieldnames=fieldnames)\n                writer.writeheader()\n                writer.writerows(methods)\n            \n            logger.info(f\"âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­ - Ø§Ù„ÙˆØ³ÙŠÙ„Ø© {method_id}: {new_name}\")\n            return True\n            \n        except Exception as e:\n            logger.error(f\"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}: {e}\")\n            return False\n    \n    def show_payment_methods_management(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\"\"\"\n        methods_text = \"\"\"ğŸ’³ Ø¥Ø¯Ø§Ø±Ø© ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\n\nğŸ¢ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨Ø¥Ø¯Ø§Ø±Ø© ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„ÙƒÙ„ Ø´Ø±ÙƒØ©:\nâ€¢ Ø¥Ø¶Ø§ÙØ© ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯Ø©\nâ€¢ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©  \nâ€¢ Ø­Ø°Ù ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\nâ€¢ ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\nâ€¢ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©\n\nØ§Ø®ØªØ± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\"\"\"\n        \n        keyboard = [\n            [{'text': 'â• Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹'}, {'text': 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹'}],\n            [{'text': 'ğŸ—‘ï¸ Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹'}, {'text': 'â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹'}],\n            [{'text': 'â–¶ï¸ ØªØ´ØºÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹'}, {'text': 'ğŸ“Š Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹'}],\n            [{'text': 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†'}]\n        ]\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': False\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, reply_keyboard)\n    \n    def start_disable_payment_method_wizard(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ Ø¥ÙŠÙ‚Ø§Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\"\"\"\n        methods = self.get_all_payment_methods()\n        active_methods = [m for m in methods if m['status'] == 'active']\n        \n        if not active_methods:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹ Ù†Ø´Ø·Ø© Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§\", self.admin_keyboard())\n            return\n        \n        methods_text = \"â¹ï¸ Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡Ø§:\\n\\n\"\n        keyboard = []\n        \n        for method in active_methods:\n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            \n            methods_text += f\"ğŸ†” {method['id']} - {method['method_name']}\\n\"\n            methods_text += f\"   ğŸ¢ {company_name}\\n\"\n            methods_text += f\"   ğŸ’³ {method['method_type']}\\n\\n\"\n            \n            keyboard.append([{'text': f\"Ø¥ÙŠÙ‚Ø§Ù {method['id']}\"}])\n        \n        keyboard.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        self.user_states[message['from']['id']] = 'selecting_method_to_disable'\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, reply_keyboard)\n    \n    def start_enable_payment_method_wizard(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ ØªØ´ØºÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\"\"\"\n        methods = self.get_all_payment_methods()\n        inactive_methods = [m for m in methods if m['status'] != 'active']\n        \n        if not inactive_methods:\n            self.send_message(message['chat']['id'], \"âŒ Ø¬Ù…ÙŠØ¹ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù†Ø´Ø·Ø© Ø¨Ø§Ù„ÙØ¹Ù„\", self.admin_keyboard())\n            return\n        \n        methods_text = \"â–¶ï¸ Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„ØªØ´ØºÙŠÙ„Ù‡Ø§:\\n\\n\"\n        keyboard = []\n        \n        for method in inactive_methods:\n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            \n            methods_text += f\"ğŸ†” {method['id']} - {method['method_name']}\\n\"\n            methods_text += f\"   ğŸ¢ {company_name}\\n\"\n            methods_text += f\"   ğŸ’³ {method['method_type']}\\n\\n\"\n            \n            keyboard.append([{'text': f\"ØªØ´ØºÙŠÙ„ {method['id']}\"}])\n        \n        keyboard.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        self.user_states[message['from']['id']] = 'selecting_method_to_enable'\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, reply_keyboard)\n    \n    def handle_method_disable_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text in ['ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©']:\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.show_payment_methods_management(message)\n            return\n        \n        if text.startswith('Ø¥ÙŠÙ‚Ø§Ù '):\n            method_id = text.replace('Ø¥ÙŠÙ‚Ø§Ù ', '').strip()\n            success = self.toggle_payment_method_status(method_id, 'inactive')\n            \n            if success:\n                method = self.get_payment_method_by_id(method_id)\n                if method:\n                    company = self.get_company_by_id(method['company_id'])\n                    company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n                    \n                    success_msg = f\"\"\"â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {method_id}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ“‹ Ø§Ù„Ø§Ø³Ù…: {method['method_name']}\nğŸ’³ Ø§Ù„Ù†ÙˆØ¹: {method['method_type']}\nğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªÙˆÙ‚ÙØ© âŒ\"\"\"\n                    \n                    self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n                else:\n                    self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\", self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\", self.admin_keyboard())\n            \n            if user_id in self.user_states:\n                del self.user_states[user_id]\n    \n    def handle_method_enable_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ØªØ´ØºÙŠÙ„\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text in ['ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©']:\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.show_payment_methods_management(message)\n            return\n        \n        if text.startswith('ØªØ´ØºÙŠÙ„ '):\n            method_id = text.replace('ØªØ´ØºÙŠÙ„ ', '').strip()\n            success = self.toggle_payment_method_status(method_id, 'active')\n            \n            if success:\n                method = self.get_payment_method_by_id(method_id)\n                if method:\n                    company = self.get_company_by_id(method['company_id'])\n                    company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n                    \n                    success_msg = f\"\"\"â–¶ï¸ ØªÙ… ØªØ´ØºÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {method_id}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ“‹ Ø§Ù„Ø§Ø³Ù…: {method['method_name']}\nğŸ’³ Ø§Ù„Ù†ÙˆØ¹: {method['method_type']}\nğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©: Ù†Ø´Ø·Ø© âœ…\"\"\"\n                    \n                    self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n                else:\n                    self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\", self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ ØªØ´ØºÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\", self.admin_keyboard())\n            \n            if user_id in self.user_states:\n                del self.user_states[user_id]\n    \n    def toggle_payment_method_status(self, method_id, new_status):\n        \"\"\"ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ (ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù)\"\"\"\n        try:\n            methods = []\n            updated = False\n            \n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == str(method_id):\n                        row['status'] = new_status\n                        updated = True\n                        logger.info(f\"ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id} Ø¥Ù„Ù‰ {new_status}\")\n                    methods.append(row)\n            \n            if updated:\n                with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'company_id', 'method_name', 'method_type', 'account_data', 'additional_info', 'status', 'created_date']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(methods)\n                \n                return True\n            \n            return False\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}: {e}\")\n            return False\n    \n    def get_all_payment_methods(self):\n        \"\"\"Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\"\"\"\n        methods = []\n        try:\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    methods.append(row)\n        except:\n            pass\n        return methods\n    \n    def get_payment_method_by_id(self, method_id):\n        \"\"\"Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ø¨Ø§Ù„Ù…Ø¹Ø±Ù\"\"\"\n        try:\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == str(method_id):\n                        return row\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}: {e}\")\n        return None\n    \n    def show_all_payment_methods(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø©\"\"\"\n        methods_text = \"ğŸ’³ Ø¬Ù…ÙŠØ¹ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹:\\n\\n\"\n        \n        try:\n            companies = self.get_companies()\n            company_names = {c['id']: c['name'] for c in companies}\n            \n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                methods_by_company = {}\n                \n                for row in reader:\n                    company_id = row['company_id']\n                    if company_id not in methods_by_company:\n                        methods_by_company[company_id] = []\n                    methods_by_company[company_id].append(row)\n                \n                for company_id, methods in methods_by_company.items():\n                    company_name = company_names.get(company_id, f\"Ø´Ø±ÙƒØ© #{company_id}\")\n                    methods_text += f\"ğŸ¢ **{company_name}**:\\n\"\n                    \n                    for method in methods:\n                        status_emoji = \"âœ…\" if method['status'] == 'active' else \"â¹ï¸\"\n                        status_text = \"Ù†Ø´Ø·Ø©\" if method['status'] == 'active' else \"Ù…ØªÙˆÙ‚ÙØ©\"\n                        methods_text += f\"  {status_emoji} {method['method_name']} (#{method['id']}) - {status_text}\\n\"\n                        methods_text += f\"      ğŸ“‹ Ø§Ù„Ù†ÙˆØ¹: {method['method_type']}\\n\"\n                        methods_text += f\"      ğŸ’³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {method['account_data']}\\n\"\n                        if method['additional_info']:\n                            methods_text += f\"      ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø§Øª: {method['additional_info']}\\n\"\n                        methods_text += \"\\n\"\n                    methods_text += \"â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸â–«ï¸\\n\\n\"\n        except:\n            methods_text += \"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\"\n        \n        # Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø±ÙŠØ¹\n        methods_text += \"\\nğŸ“‹ **Ø£ÙˆØ§Ù…Ø± Ø¥Ø¯Ø§Ø±Ø© Ø³Ø±ÙŠØ¹Ø©:**\\n\"\n        methods_text += \"â€¢ `Ø§Ø¶Ø§ÙØ©_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ ID_Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ø³Ù…_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ù†ÙˆØ¹_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`\\n\"\n        methods_text += \"â€¢ `ØªØ¹Ø¯ÙŠÙ„_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ ID_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©`\\n\"\n        methods_text += \"â€¢ `Ø­Ø°Ù_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ ID_Ø§Ù„ÙˆØ³ÙŠÙ„Ø©`\\n\\n\"\n        \n        methods_text += \"ğŸ’¡ **Ù…Ø«Ø§Ù„:**\\n\"\n        methods_text += \"`Ø§Ø¶Ø§ÙØ©_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ 1 Ø­Ø³Ø§Ø¨_Ù…Ø¯Ù‰ bank_account Ø±Ù‚Ù…:1234567890`\"\n        \n        keyboard = [\n            [{'text': 'â• Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹'}, {'text': 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹'}],\n            [{'text': 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©'}, {'text': 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©'}]\n        ]\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': False\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, reply_keyboard)\n    \n    def start_add_payment_method(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯Ø©\"\"\"\n        user_id = message['from']['id']\n        \n        # Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©\n        companies = self.get_companies()\n        if not companies:\n            self.send_message(message['chat']['id'], \n                            \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…ØªØ§Ø­Ø©. ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹\", \n                            self.admin_keyboard())\n            return\n        \n        companies_text = \"ğŸ¢ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ù„Ù‡Ø§:\\n\\n\"\n        keyboard = []\n        \n        for company in companies:\n            companies_text += f\"ğŸ”¹ {company['name']} (#{company['id']})\\n\"\n            keyboard.append([{'text': f\"{company['name']} (#{company['id']})\"}])\n        \n        keyboard.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        self.user_states[user_id] = {\n            'step': 'adding_payment_method_select_company',\n            'companies': companies\n        }\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], companies_text, reply_keyboard)\n    \n    def handle_payment_method_selection(self, message, text):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id, {})\n        \n        if text in ['ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©', 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©']:\n            # Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©\n            transaction_type = state.get('transaction_type')\n            if transaction_type == 'deposit':\n                self.create_deposit_request(message)\n            else:\n                self.create_withdrawal_request(message)\n            return\n        \n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n        methods = state.get('methods', [])\n        selected_method = None\n        \n        for method in methods:\n            if method['method_name'] == text:\n                selected_method = method\n                break\n        \n        if not selected_method:\n            self.send_message(message['chat']['id'], \"âŒ Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©\")\n            return\n        \n        # Ø­ÙØ¸ Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©\n        transaction_type = state['transaction_type']\n        company_id = state['company_id']\n        company = self.get_company_by_id(company_id)\n        \n        # Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ³ÙŠÙ„Ø© ÙˆØ·Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù…Ø¹ Ø®ÙŠØ§Ø± Ø§Ù„Ù†Ø³Ø®\n        wallet_text = f\"\"\"âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹: {selected_method['method_name']}\n\nğŸ’³ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ³ÙŠÙ„Ø©:\nğŸ“‹ Ø§Ù„Ù†ÙˆØ¹: {selected_method['method_type']}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\nğŸ’° Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨/Ø§Ù„Ù…Ø­ÙØ¸Ø©: `{selected_method['account_data']}`\nğŸ’¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: {selected_method.get('additional_info', 'Ù„Ø§ ØªÙˆØ¬Ø¯')}\n\nğŸ“‹ ÙŠÙ…ÙƒÙ†Ùƒ Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ø¹Ù„Ø§Ù‡ Ø¨Ø³Ù‡ÙˆÙ„Ø©\nğŸ“ Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø­ÙØ¸ØªÙƒ/Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ:\"\"\"\n        \n        self.send_message(message['chat']['id'], wallet_text)\n        \n        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©\n        if transaction_type == 'deposit':\n            self.user_states[user_id] = f'deposit_wallet_{company_id}_{company[\"name\"] if company else \"unknown\"}_{selected_method[\"id\"]}'\n        else:\n            self.user_states[user_id] = f'withdraw_wallet_{company_id}_{company[\"name\"] if company else \"unknown\"}_{selected_method[\"id\"]}'\n    \n    def get_company_by_id(self, company_id):\n        \"\"\"Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø±ÙƒØ© Ø¨ÙˆØ§Ø³Ø·Ø© ID\"\"\"\n        companies = self.get_companies()\n        for company in companies:\n            if company['id'] == str(company_id):\n                return company\n        return None\n    \n    def start_send_user_message(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¯Ø¯\"\"\"\n        user_id = message['from']['id']\n        \n        instruction_text = \"\"\"ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¯Ø¯\n        \nğŸ“ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„ÙŠÙ‡:\n\nÙ…Ø«Ø§Ù„: C123456\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n        \n        self.send_message(message['chat']['id'], instruction_text)\n        self.user_states[user_id] = 'sending_user_message_id'\n    \n    def handle_user_message_id(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©\"\"\"\n        user_id = message['from']['id']\n        customer_id = message.get('text', '').strip()\n        \n        if customer_id == '/cancel':\n            del self.user_states[user_id]\n            self.send_message(message['chat']['id'], \"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©\", self.admin_keyboard())\n            return\n        \n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„\n        user_found = None\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == customer_id:\n                        user_found = row\n                        break\n        except:\n            pass\n        \n        if not user_found:\n            self.send_message(message['chat']['id'], \n                            f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù…ÙŠÙ„ Ø¨Ø±Ù‚Ù…: {customer_id}\\n\\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:\")\n            return\n        \n        # Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ·Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©\n        customer_info = f\"\"\"âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„:\n\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {user_found['name']}\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {user_found['phone']}\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user_found['customer_id']}\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {user_found.get('registration_date', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\nğŸš« Ø§Ù„Ø­Ø§Ù„Ø©: {'Ù…Ø­Ø¸ÙˆØ±' if user_found.get('is_banned') == 'yes' else 'Ù†Ø´Ø·'}\n\nğŸ“ Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„:\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n        \n        self.send_message(message['chat']['id'], customer_info)\n        self.user_states[user_id] = f'sending_user_message_{customer_id}'\n    \n    def handle_user_message_content(self, message, customer_id):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡Ø§\"\"\"\n        user_id = message['from']['id']\n        message_content = message.get('text', '').strip()\n        \n        if message_content == '/cancel':\n            del self.user_states[user_id]\n            self.send_message(message['chat']['id'], \"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©\", self.admin_keyboard())\n            return\n        \n        if not message_content:\n            self.send_message(message['chat']['id'], \"âŒ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©. ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:\")\n            return\n        \n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„Ø¹Ù…ÙŠÙ„\n        target_telegram_id = None\n        customer_name = \"\"\n        \n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == customer_id:\n                        target_telegram_id = row['user_id']\n                        customer_name = row['name']\n                        break\n        except:\n            pass\n        \n        if not target_telegram_id:\n            self.send_message(message['chat']['id'], \n                            f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„Ø¹Ù…ÙŠÙ„ {customer_id}\", \n                            self.admin_keyboard())\n            del self.user_states[user_id]\n            return\n        \n        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ø­ØªÙ‰ Ù„Ø§ ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø²Ø±Ø§Ø±\n        admin_info = self.find_user(user_id)\n        admin_name = admin_info.get('name', 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©') if admin_info else 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'\n        \n        customer_message = f\"\"\"ğŸ“§ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\n        \nÙ…Ù†: {admin_name}\nØ§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n{message_content}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ’¬ Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ù‚Ø³Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        \n        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­\n        try:\n            response = self.send_message(int(target_telegram_id), customer_message, None)\n            \n            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„\n            success_msg = f\"\"\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“§ Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_name} ({customer_id})\nğŸ“… ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nğŸ“ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:\n{message_content}\"\"\"\n            \n            self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n            \n        except Exception as e:\n            # ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„\n            error_msg = f\"\"\"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©!\n\nğŸ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_name} ({customer_id})\nâš ï¸ Ø§Ù„Ø³Ø¨Ø¨: Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø­Ø¸Ø± Ø§Ù„Ø¨ÙˆØª Ø£Ùˆ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\n\nğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù‡ Ø¹Ø¨Ø±:\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…\nğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø¥Ù† ÙˆØ¬Ø¯)\"\"\"\n            \n            self.send_message(message['chat']['id'], error_msg, self.admin_keyboard())\n        \n        # Ø­Ø°Ù Ø§Ù„Ø­Ø§Ù„Ø©\n        del self.user_states[user_id]\n    \n    def start_edit_payment_method(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\"\"\"\n        user_id = message['from']['id']\n        \n        # Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±\n        methods = self.get_all_payment_methods()\n        \n        if not methods:\n            self.send_message(message['chat']['id'], \n                            \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹\", \n                            self.admin_keyboard())\n            return\n        \n        methods_text = \"âœï¸ Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:\\n\\n\"\n        \n        keyboard_buttons = []\n        for method in methods:\n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            \n            method_info = f\"ğŸ†” {method['id']} | {method['method_name']} | {company_name}\"\n            methods_text += f\"{method_info}\\n\"\n            keyboard_buttons.append([{'text': f\"ØªØ¹Ø¯ÙŠÙ„ {method['id']}\"}])\n        \n        keyboard_buttons.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        keyboard = {\n            'keyboard': keyboard_buttons,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, keyboard)\n        self.user_states[user_id] = 'selecting_method_to_edit'\n    \n    def start_delete_payment_method(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\"\"\"\n        user_id = message['from']['id']\n        \n        # Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±\n        methods = self.get_all_payment_methods()\n        \n        if not methods:\n            self.send_message(message['chat']['id'], \n                            \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹\", \n                            self.admin_keyboard())\n            return\n        \n        methods_text = \"ğŸ—‘ï¸ Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø­Ø°Ù:\\n\\n\"\n        \n        keyboard_buttons = []\n        for method in methods:\n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            \n            method_info = f\"ğŸ†” {method['id']} | {method['method_name']} | {company_name}\"\n            methods_text += f\"{method_info}\\n\"\n            keyboard_buttons.append([{'text': f\"Ø­Ø°Ù {method['id']}\"}])\n        \n        keyboard_buttons.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        keyboard = {\n            'keyboard': keyboard_buttons,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, keyboard)\n        self.user_states[user_id] = 'selecting_method_to_delete'\n    \n    def get_all_payment_methods(self):\n        \"\"\"Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\"\"\"\n        methods = []\n        try:\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row.get('status') == 'active':\n                        methods.append(row)\n        except:\n            pass\n        return methods\n    \n    def delete_payment_method(self, method_id):\n        \"\"\"Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\"\"\"\n        try:\n            methods = []\n            deleted = False\n            deleted_method = None\n            \n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] != str(method_id):\n                        methods.append(row)\n                    else:\n                        deleted = True\n                        deleted_method = row\n            \n            if deleted:\n                # Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ø¯ÙˆÙ† Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©\n                with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'company_id', 'method_name', 'method_type', 'account_data', 'additional_info', 'status', 'created_date']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(methods)\n                \n                return True, deleted_method\n            else:\n                return False, None\n        except Exception as e:\n            return False, None\n    \n    def handle_method_edit_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text in ['ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©']:\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.send_message(message['chat']['id'], \"ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡\", self.admin_keyboard())\n            return\n        \n        if text.startswith('ØªØ¹Ø¯ÙŠÙ„ '):\n            method_id = text.replace('ØªØ¹Ø¯ÙŠÙ„ ', '').strip()\n            \n            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\n            method = self.get_payment_method_by_id(method_id)\n            if not method:\n                self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\")\n                return\n            \n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            \n            # Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ³ÙŠÙ„Ø© ÙˆØ·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©\n            edit_text = f\"\"\"âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹:\n\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {method['id']}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ“‹ Ø§Ù„Ø§Ø³Ù…: {method['method_name']}\nğŸ’³ Ø§Ù„Ù†ÙˆØ¹: {method['method_type']}\nğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {method['account_data']}\nğŸ’¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: {method['additional_info']}\n\nğŸ“ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨/Ø§Ù„Ù…Ø­ÙØ¸Ø©):\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n            \n            self.send_message(message['chat']['id'], edit_text)\n            self.user_states[user_id] = f'editing_method_{method_id}'\n    \n    def handle_method_delete_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø­Ø°Ù\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text in ['ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©', 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø©']:\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.send_message(message['chat']['id'], \"ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡\", self.admin_keyboard())\n            return\n        \n        if text.startswith('Ø­Ø°Ù '):\n            method_id = text.replace('Ø­Ø°Ù ', '').strip()\n            \n            # Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\n            success, deleted_method = self.delete_payment_method(method_id)\n            \n            if success:\n                company = self.get_company_by_id(deleted_method['company_id'])\n                company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n                \n                success_msg = f\"\"\"âœ… ØªÙ… Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ—‘ï¸ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {deleted_method['id']}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ“‹ Ø§Ù„Ø§Ø³Ù…: {deleted_method['method_name']}\nğŸ’³ Ø§Ù„Ù†ÙˆØ¹: {deleted_method['method_type']}\"\"\"\n                \n                self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n            else:\n                self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}\", self.admin_keyboard())\n            \n            del self.user_states[user_id]\n    \n    def handle_method_edit_data(self, message, method_id):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\"\"\"\n        user_id = message['from']['id']\n        new_data = message.get('text', '').strip()\n        \n        if new_data == '/cancel':\n            del self.user_states[user_id]\n            self.send_message(message['chat']['id'], \"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„\", self.admin_keyboard())\n            return\n        \n        if not new_data:\n            self.send_message(message['chat']['id'], \"âŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:\")\n            return\n        \n        # ØªØ­Ø¯ÙŠØ« ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\n        success = self.update_payment_method(method_id, new_data)\n        \n        if success:\n            method = self.get_payment_method_by_id(method_id)\n            company = self.get_company_by_id(method['company_id'])\n            company_name = company['name'] if company else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            \n            success_msg = f\"\"\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“ Ø§Ù„Ù…ÙØ­Ø¯Ù‘Ø«Ø©:\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: {method['id']}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ“‹ Ø§Ù„Ø§Ø³Ù…: {method['method_name']}\nğŸ’³ Ø§Ù„Ù†ÙˆØ¹: {method['method_type']}\nğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: {new_data}\"\"\"\n            \n            self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n        else:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\", self.admin_keyboard())\n        \n        del self.user_states[user_id]\n    \n    def get_payment_method_by_id(self, method_id):\n        \"\"\"Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø¹Ø±Ù\"\"\"\n        try:\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == str(method_id):\n                        return row\n        except:\n            pass\n        return None\n    \n    def update_payment_method(self, method_id, new_account_data):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ - ØªØ­Ø¯ÙŠØ« Ù‚Ø¯ÙŠÙ…\"\"\"\n        try:\n            methods = []\n            updated = False\n            \n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == str(method_id):\n                        row['account_data'] = new_account_data\n                        updated = True\n                    methods.append(row)\n            \n            if updated:\n                with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'company_id', 'method_name', 'method_type', 'account_data', 'additional_info', 'status', 'created_date']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(methods)\n                \n                return True\n            return False\n        except Exception as e:\n            return False\n\n    def update_payment_method_complete(self, method_id, new_data):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ø´Ø§Ù…Ù„ Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„\"\"\"\n        try:\n            methods = []\n            updated = False\n            \n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == str(method_id):\n                        # ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\n                        if 'method_name' in new_data:\n                            row['method_name'] = new_data['method_name']\n                        if 'method_type' in new_data:\n                            row['method_type'] = new_data['method_type']\n                        if 'account_data' in new_data:\n                            row['account_data'] = new_data['account_data']\n                        if 'additional_info' in new_data:\n                            row['additional_info'] = new_data['additional_info']\n                        updated = True\n                    methods.append(row)\n            \n            if updated:\n                with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'company_id', 'method_name', 'method_type', 'account_data', 'additional_info', 'status', 'created_date']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(methods)\n                \n                return True\n            return False\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ {method_id}: {e}\")\n            return False\n    \n    def start_backup_scheduler(self):\n        \"\"\"Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª\"\"\"\n        def backup_worker():\n            while True:\n                try:\n                    # Ø§Ù†ØªØ¸Ø§Ø± 6 Ø³Ø§Ø¹Ø§Øª (21600 Ø«Ø§Ù†ÙŠØ©)\n                    time.sleep(21600)  # 6 Ø³Ø§Ø¹Ø§Øª\n                    self.send_backup_to_admins()\n                except Exception as e:\n                    logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: {e}\")\n                    \n        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙŠ Ø®ÙŠØ· Ù…Ù†ÙØµÙ„\n        backup_thread = threading.Thread(target=backup_worker, daemon=True)\n        backup_thread.start()\n        logger.info(\"ØªÙ… Ø¨Ø¯Ø¡ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª)\")\n    \n    def create_backup_zip(self):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ù…Ø¶ØºÙˆØ· ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')\n        zip_filename = f\"DUX_Backup_{timestamp}.zip\"\n        \n        try:\n            with zipfile.ZipFile(zip_filename, 'w', zipfile.ZIP_DEFLATED) as zipf:\n                # Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\n                files_to_backup = [\n                    'users.csv',\n                    'transactions.csv', \n                    'companies.csv',\n                    'complaints.csv',\n                    'payment_methods.csv',\n                    'exchange_addresses.csv',\n                    'system_settings.csv'\n                ]\n                \n                for file in files_to_backup:\n                    if os.path.exists(file):\n                        zipf.write(file)\n                        \n                # Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ\n                self.create_summary_report(zipf, timestamp)\n                \n            logger.info(f\"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {zip_filename}\")\n            return zip_filename\n            \n        except Exception as e:\n            logger.error(f\"ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {e}\")\n            return None\n    \n    def create_summary_report(self, zipf, timestamp):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø®Øµ Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©\"\"\"\n        report_content = f\"\"\"ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© - {timestamp}\n{'=' * 50}\n\nğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:\n\"\"\"\n        \n        try:\n            # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                users_count = len(list(csv.DictReader(f)))\n                report_content += f\"â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†: {users_count}\\n\"\n                \n            # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                transactions = list(reader)\n                total_transactions = len(transactions)\n                pending = sum(1 for t in transactions if t['status'] == 'pending')\n                approved = sum(1 for t in transactions if t['status'] == 'approved')\n                rejected = sum(1 for t in transactions if t['status'] == 'rejected')\n                \n                report_content += f\"â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: {total_transactions}\\n\"\n                report_content += f\"  - Ù…Ø¹Ù„Ù‚Ø©: {pending}\\n\"\n                report_content += f\"  - Ù…ÙˆØ§ÙÙ‚Ø©: {approved}\\n\"\n                report_content += f\"  - Ù…Ø±ÙÙˆØ¶Ø©: {rejected}\\n\"\n                \n            # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                companies_count = len(list(csv.DictReader(f)))\n                report_content += f\"â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø±ÙƒØ§Øª: {companies_count}\\n\"\n                \n        except Exception as e:\n            report_content += f\"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: {e}\\n\"\n            \n        report_content += f\"\\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø³Ø®Ø©: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\\n\"\n        report_content += f\"ğŸ¤– Ø§Ù„Ø¨ÙˆØª: @depositbettingbot\\n\"\n        \n        # Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒÙ…Ù„Ù Ù†ØµÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ ZIP\n        zipf.writestr('backup_report.txt', report_content.encode('utf-8'))\n    \n    def send_document(self, chat_id, file_path, caption=\"\"):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ù Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ÙŠÙ†Ø©\"\"\"\n        try:\n            # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù\n            with open(file_path, 'rb') as f:\n                file_data = f.read()\n            \n            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø±Ø³Ø§Ù„\n            url = f\"{self.api_url}/sendDocument\"\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ multipart/form-data\n            boundary = '----WebKitFormBoundary7MA4YWxkTrZu0gW'\n            \n            # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n            data = []\n            data.append(f'--{boundary}')\n            data.append('Content-Disposition: form-data; name=\"chat_id\"')\n            data.append('')\n            data.append(str(chat_id))\n            \n            if caption:\n                data.append(f'--{boundary}')\n                data.append('Content-Disposition: form-data; name=\"caption\"')\n                data.append('')\n                data.append(caption)\n            \n            data.append(f'--{boundary}')\n            data.append(f'Content-Disposition: form-data; name=\"document\"; filename=\"{os.path.basename(file_path)}\"')\n            data.append('Content-Type: application/zip')\n            data.append('')\n            \n            # ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ bytes\n            body = '\\r\\n'.join(data).encode('utf-8')\n            body += b'\\r\\n' + file_data + f'\\r\\n--{boundary}--\\r\\n'.encode('utf-8')\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨\n            req = urllib.request.Request(url, data=body)\n            req.add_header('Content-Type', f'multipart/form-data; boundary={boundary}')\n            \n            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨\n            with urllib.request.urlopen(req, timeout=30) as response:\n                result = json.loads(response.read().decode('utf-8'))\n                return result\n                \n        except Exception as e:\n            logger.error(f\"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù: {e}\")\n            return None\n    \n    def get_chat_id_by_username(self, username):\n        \"\"\"Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        try:\n            # Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø© @ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©\n            if username.startswith('@'):\n                username = username[1:]\n            \n            # Ø§Ø³ØªØ®Ø¯Ø§Ù… getChat API Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\n            url = f\"{self.api_url}/getChat\"\n            data = {'chat_id': f'@{username}'}\n            \n            req = urllib.request.Request(url, data=json.dumps(data).encode('utf-8'))\n            req.add_header('Content-Type', 'application/json')\n            \n            with urllib.request.urlopen(req, timeout=10) as response:\n                result = json.loads(response.read().decode('utf-8'))\n                \n                if result.get('ok') and 'result' in result:\n                    return result['result']['id']\n                    \n        except Exception as e:\n            logger.error(f\"ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù {username}: {e}\")\n            \n        return None\n\n    def send_backup_to_admins(self):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\"\"\"\n        logger.info(\"Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©...\")\n        \n        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©\n        backup_file = self.create_backup_zip()\n        \n        if not backup_file:\n            logger.error(\"ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©\")\n            return\n            \n        try:\n            # Ø±Ø³Ø§Ù„Ø© Ù…Ø±Ø§ÙÙ‚Ø© Ù„Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©\n            caption = f\"\"\"ğŸ“¦ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©\n\nğŸ¤– Ø§Ù„Ø¨ÙˆØª: @depositbettingbot\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\nâ° Ø§Ù„Ù†Ø³Ø® Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª\n\nğŸ“‹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª:\nâ€¢ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\nâ€¢ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©\nâ€¢ Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\nâ€¢ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\nâ€¢ ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠ Ø´Ø§Ù…Ù„\n\nğŸ”’ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ù…Ù†Ø© ÙˆÙ…Ø´ÙØ±Ø©\"\"\"\n\n            # Ø¥Ø±Ø³Ø§Ù„ Ù„Ø­Ø³Ø§Ø¨ @Aba10o0 Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ø¥Ø°Ø§ ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡)\n            backup_recipients = [\n                # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù‡Ù†Ø§ Ø¹Ù†Ø¯Ù…Ø§ ÙŠØµØ¨Ø­ Ù…ØªØ§Ø­Ø§Ù‹\n                # Ù…Ø«Ø§Ù„: 123456789  # @Aba10o0\n            ]\n            \n            for recipient_id in backup_recipients:\n                try:\n                    result = self.send_document(recipient_id, backup_file, caption)\n                    if result and result.get('ok'):\n                        logger.info(f\"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªÙ„Ù…: {recipient_id}\")\n                    else:\n                        logger.error(f\"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ø³ØªÙ„Ù…: {recipient_id}\")\n                except Exception as e:\n                    logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ù„Ù„Ù…Ø³ØªÙ„Ù… {recipient_id}: {e}\")\n                \n            # Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹ ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©\n            sent_count = 0\n            for admin_id in self.admin_ids:\n                try:\n                    if str(admin_id).isdigit():  # Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø· Ù„Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ©\n                        result = self.send_document(admin_id, backup_file, caption)\n                        if result and result.get('ok'):\n                            sent_count += 1\n                            logger.info(f\"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©: {admin_id}\")\n                        else:\n                            logger.error(f\"ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©: {admin_id}\")\n                except Exception as e:\n                    logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© {admin_id}: {e}\")\n                    \n            # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª\n            try:\n                os.remove(backup_file)\n                logger.info(f\"ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª: {backup_file}\")\n            except:\n                pass\n                \n            logger.info(f\"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù€ @{target_username} + {sent_count} Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø¶Ø§ÙÙŠØ©\")\n            \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: {e}\")\n    \n    def manual_backup_command(self, message):\n        \"\"\"Ø£Ù…Ø± ÙŠØ¯ÙˆÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙÙˆØ±ÙŠØ©\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n            \n        self.send_message(message['chat']['id'], \"ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©...\")\n        \n        # Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø©\n        backup_file = self.create_backup_zip()\n        \n        if backup_file:\n            caption = f\"\"\"ğŸ“¦ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ÙŠØ¯ÙˆÙŠØ©\n\nğŸ¤– Ø§Ù„Ø¨ÙˆØª: @depositbettingbot  \nğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\nğŸ‘¨â€ğŸ’¼ Ø·Ù„Ø¨ Ù…Ù†: Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\n\nğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù\"\"\"\n\n            result = self.send_document(message['chat']['id'], backup_file, caption)\n            \n            if result and result.get('ok'):\n                self.send_message(message['chat']['id'], \"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\")\n            else:\n                self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©\")\n                \n            # Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª\n            try:\n                os.remove(backup_file)\n            except:\n                pass\n        else:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©\")\n    \n    def handle_complaint_reply_buttons(self, message, complaint_id):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰\"\"\"\n        user_id = message['from']['id']\n        text = message.get('text', '').strip()\n        \n        if text == 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´ÙƒØ§ÙˆÙ‰':\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.show_complaints_admin(message)\n            return\n        \n        # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯\n        reply_message = \"\"\n        if text.startswith('âœ… ØªÙ… Ø§Ù„Ø­Ù„'):\n            reply_message = \"Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹Ù†Ø§. ØªÙ… Ø­Ù„ Ù…Ø´ÙƒÙ„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­ ÙˆÙ†Ø¹ØªØ°Ø± Ø¹Ù† Ø£ÙŠ Ø¥Ø²Ø¹Ø§Ø¬.\"\n        elif text.startswith('ğŸ” Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'):\n            reply_message = \"Ù†Ø­Ù† Ù†Ø±Ø§Ø¬Ø¹ Ø·Ù„Ø¨Ùƒ Ø¨Ø¹Ù†Ø§ÙŠØ© ÙˆØ³Ù†Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©. Ø´ÙƒØ±Ø§Ù‹ Ù„ØµØ¨Ø±Ùƒ.\"\n        elif text.startswith('ğŸ“ Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ'):\n            reply_message = \"Ø³Ù†ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ø¹Ø¨Ø± Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„. Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹Ù†Ø§.\"\n        elif text.startswith('ğŸ’¡ Ø±Ø¯ Ù…Ø®ØµØµ'):\n            # Ø·Ù„Ø¨ Ø±Ø¯ Ù…Ø®ØµØµ\n            custom_text = \"\"\"ğŸ’¡ Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ø§Ù„Ù…Ø®ØµØµ:\n            \nÙ…Ø«Ø§Ù„: Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„ÙƒØŒ ØªÙ… Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©...\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n            \n            self.send_message(message['chat']['id'], custom_text)\n            self.user_states[user_id] = f'writing_custom_reply_{complaint_id}'\n            return\n        \n        # Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ø¹Ù…ÙŠÙ„\n        if reply_message:\n            success = self.save_complaint_reply(complaint_id, reply_message)\n            if success:\n                self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„!\\n\\nğŸ“ Ø§Ù„Ø±Ø¯: {reply_message}\", self.admin_keyboard())\n                # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„\n                self.send_complaint_reply_to_customer(complaint_id, reply_message)\n            else:\n                self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ø¯\", self.admin_keyboard())\n        \n        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø©\n        if user_id in self.user_states:\n            del self.user_states[user_id]\n    \n    def save_complaint_reply(self, complaint_id, reply_message):\n        \"\"\"Ø­ÙØ¸ Ø±Ø¯ Ø§Ù„Ø´ÙƒÙˆÙ‰\"\"\"\n        try:\n            complaints = []\n            updated = False\n            \n            with open('complaints.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == complaint_id:\n                        row['status'] = 'resolved'\n                        row['admin_response'] = reply_message\n                        updated = True\n                        logger.info(f\"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙˆÙ‰ {complaint_id} ÙˆØªØ­Ø¯ÙŠØ«Ù‡Ø§\")\n                    complaints.append(row)\n            \n            if updated:\n                with open('complaints.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'customer_id', 'subject', 'message', 'status', 'date', 'admin_response']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    \n                    # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ÙƒØªØ§Ø¨Ø©\n                    clean_complaints = []\n                    for complaint in complaints:\n                        clean_complaint = {}\n                        for field in fieldnames:\n                            clean_complaint[field] = complaint.get(field, '')\n                        clean_complaints.append(clean_complaint)\n                    \n                    writer.writerows(clean_complaints)\n                \n                return True\n            \n            return False\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø±Ø¯ Ø§Ù„Ø´ÙƒÙˆÙ‰ {complaint_id}: {e}\")\n            return False\n    \n    def send_complaint_reply_to_customer(self, complaint_id, reply_message):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù„Ù„Ø¹Ù…ÙŠÙ„\"\"\"\n        try:\n            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„\n            customer_telegram_id = None\n            \n            with open('complaints.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == complaint_id:\n                        customer_id = row['customer_id']\n                        \n                        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… ID Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n                        with open('users.csv', 'r', encoding='utf-8-sig') as users_file:\n                            users_reader = csv.DictReader(users_file)\n                            for user_row in users_reader:\n                                if user_row['customer_id'] == customer_id:\n                                    customer_telegram_id = user_row['telegram_id']\n                                    break\n                        break\n            \n            if customer_telegram_id:\n                customer_message = f\"\"\"ğŸ“ Ø±Ø¯ Ø¹Ù„Ù‰ Ø´ÙƒÙˆØ§Ùƒ:\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰: {complaint_id}\nğŸ’¬ Ø§Ù„Ø±Ø¯: {reply_message}\n\nØ´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹Ù†Ø§ ÙˆÙ†ØªØ·Ù„Ø¹ Ù„Ø®Ø¯Ù…ØªÙƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ğŸ™\"\"\"\n                \n                # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† ÙƒÙŠØ¨ÙˆØ±Ø¯ Ù„Ø¹Ø¯Ù… Ø§Ù„ØªØ¯Ø§Ø®Ù„\n                result = self.send_message_without_keyboard(customer_telegram_id, customer_message)\n                if result and result.get('ok'):\n                    logger.info(f\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ø§Ù„Ø´ÙƒÙˆÙ‰ {complaint_id} Ù„Ù„Ø¹Ù…ÙŠÙ„ {customer_telegram_id} Ø¨Ù†Ø¬Ø§Ø­\")\n                else:\n                    logger.error(f\"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ø§Ù„Ø´ÙƒÙˆÙ‰ {complaint_id} Ù„Ù„Ø¹Ù…ÙŠÙ„ {customer_telegram_id}\")\n                    # Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©\n                    self.send_message(customer_telegram_id, customer_message)\n                \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ù„Ù„Ø¹Ù…ÙŠÙ„: {e}\")\n    \n    def send_message_without_keyboard(self, chat_id, text):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† ÙƒÙŠØ¨ÙˆØ±Ø¯\"\"\"\n        try:\n            url = f\"https://api.telegram.org/bot{self.token}/sendMessage\"\n            data = {\n                'chat_id': chat_id,\n                'text': text,\n                'parse_mode': 'Markdown'\n            }\n            \n            # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSON\n            json_data = json.dumps(data).encode('utf-8')\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨\n            req = urllib.request.Request(url, data=json_data, headers={\n                'Content-Type': 'application/json',\n                'Content-Length': len(json_data)\n            })\n            \n            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨\n            with urllib.request.urlopen(req) as response:\n                result = json.loads(response.read().decode('utf-8'))\n                return result\n                \n        except Exception as e:\n            logger.error(f\"Error sending message without keyboard: {e}\")\n            # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©\n            try:\n                return self.send_message(chat_id, text)\n            except:\n                return None\n    \n    def show_support_data_editor(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ù…Ø­Ø±Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹Ù…\"\"\"\n        support_text = \"\"\"ğŸ› ï¸ Ù…Ø­Ø±Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹Ù…\n\nÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ù† Ù‡Ù†Ø§:\n\nğŸ“ Ø±Ù‚Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: {self.get_support_setting('support_phone', '+966123456789')}\nğŸ’¬ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…: {self.get_support_setting('support_telegram', '@DUX_support')}\nğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: {self.get_support_setting('support_email', 'support@dux.com')}\nğŸ•’ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„: {self.get_support_setting('support_hours', '9 ØµØ¨Ø§Ø­Ø§Ù‹ - 6 Ù…Ø³Ø§Ø¡Ù‹')}\n\nØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„:\n\nğŸ“ `ØªØ¹Ø¯ÙŠÙ„_Ø±Ù‚Ù… +966987654321`\nğŸ’¬ `ØªØ¹Ø¯ÙŠÙ„_ØªÙ„ÙŠØ¬Ø±Ø§Ù… @DUX_support`\nğŸ“§ `ØªØ¹Ø¯ÙŠÙ„_Ø¨Ø±ÙŠØ¯ support@dux.com`\nğŸ•’ `ØªØ¹Ø¯ÙŠÙ„_Ø³Ø§Ø¹Ø§Øª 8 ØµØ¨Ø§Ø­Ø§Ù‹ - 10 Ù…Ø³Ø§Ø¡Ù‹`\n\nØ£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ:\"\"\"\n        \n        keyboard = [\n            [{'text': 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ'}],\n            [{'text': 'ğŸ’¬ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…'}],\n            [{'text': 'ğŸ“§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'}],\n            [{'text': 'ğŸ•’ ØªØ¹Ø¯ÙŠÙ„ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„'}],\n            [{'text': 'ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹Ù…'}],\n            [{'text': 'â†©ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†'}]\n        ]\n        \n        reply_keyboard = {\n            'keyboard': keyboard,\n            'resize_keyboard': True,\n            'one_time_keyboard': False\n        }\n        \n        self.send_message(message['chat']['id'], support_text, reply_keyboard)\n    \n    def start_phone_edit_wizard(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\"\"\"\n        edit_text = \"\"\"ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n\nØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: +966123456789\n\nØ§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:\nÙ…Ø«Ø§Ù„: +966987654321\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n        \n        self.send_message(message['chat']['id'], edit_text)\n        self.user_states[message['from']['id']] = 'editing_support_phone'\n    \n    def start_telegram_edit_wizard(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…\"\"\"\n        edit_text = \"\"\"ğŸ’¬ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…\n\nØ§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ: @DUX_support\n\nØ§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:\nÙ…Ø«Ø§Ù„: @DUX_support\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n        \n        self.send_message(message['chat']['id'], edit_text)\n        self.user_states[message['from']['id']] = 'editing_support_telegram'\n    \n    def start_email_edit_wizard(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ\"\"\"\n        edit_text = \"\"\"ğŸ“§ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ\n\nØ§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: support@dux.com\n\nØ§ÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:\nÙ…Ø«Ø§Ù„: support@dux.com\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n        \n        self.send_message(message['chat']['id'], edit_text)\n        self.user_states[message['from']['id']] = 'editing_support_email'\n    \n    def start_hours_edit_wizard(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬ ØªØ¹Ø¯ÙŠÙ„ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„\"\"\"\n        edit_text = \"\"\"ğŸ•’ ØªØ¹Ø¯ÙŠÙ„ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„\n\nØ§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©: 9 ØµØ¨Ø§Ø­Ø§Ù‹ - 6 Ù…Ø³Ø§Ø¡Ù‹\n\nØ§ÙƒØªØ¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:\nÙ…Ø«Ø§Ù„: 8 ØµØ¨Ø§Ø­Ø§Ù‹ - 10 Ù…Ø³Ø§Ø¡Ù‹\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n        \n        self.send_message(message['chat']['id'], edit_text)\n        self.user_states[message['from']['id']] = 'editing_support_hours'\n    \n    def handle_support_data_edit(self, message, state):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø¹Ù…\"\"\"\n        text = message.get('text', '').strip()\n        user_id = message['from']['id']\n        \n        if text == '/cancel':\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n            self.show_support_data_editor(message)\n            return\n        \n        # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„\n        if state == 'editing_support_phone':\n            success_msg = f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¥Ù„Ù‰: {text}\"\n            self.save_support_setting('support_phone', text)\n        elif state == 'editing_support_telegram':\n            success_msg = f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¥Ù„Ù‰: {text}\"\n            self.save_support_setting('support_telegram', text)\n        elif state == 'editing_support_email':\n            success_msg = f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¥Ù„Ù‰: {text}\"\n            self.save_support_setting('support_email', text)\n        elif state == 'editing_support_hours':\n            success_msg = f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø¥Ù„Ù‰: {text}\"\n            self.save_support_setting('support_hours', text)\n        else:\n            success_msg = \"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\"\n        \n        # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n        self.send_message(message['chat']['id'], success_msg, self.admin_keyboard())\n        \n        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø©\n        if user_id in self.user_states:\n            del self.user_states[user_id]\n    \n    def save_support_setting(self, key, value):\n        \"\"\"Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø¹Ù…\"\"\"\n        try:\n            # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©\n            settings = []\n            setting_exists = False\n            \n            try:\n                with open('system_settings.csv', 'r', encoding='utf-8-sig') as f:\n                    reader = csv.DictReader(f)\n                    for row in reader:\n                        if row['setting_key'] == key:\n                            row['setting_value'] = value\n                            setting_exists = True\n                        settings.append(row)\n            except FileNotFoundError:\n                pass\n            \n            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹\n            if not setting_exists:\n                descriptions = {\n                    'support_phone': 'Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ',\n                    'support_telegram': 'Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù„Ø¯Ø¹Ù…',\n                    'support_email': 'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¯Ø¹Ù…',\n                    'support_hours': 'Ø³Ø§Ø¹Ø§Øª Ø¹Ù…Ù„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¯Ø¹Ù…'\n                }\n                \n                settings.append({\n                    'setting_key': key,\n                    'setting_value': value,\n                    'description': descriptions.get(key, 'Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø¹Ù…')\n                })\n            \n            # Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\n            with open('system_settings.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                fieldnames = ['setting_key', 'setting_value', 'description']\n                writer = csv.DictWriter(f, fieldnames=fieldnames)\n                writer.writeheader()\n                writer.writerows(settings)\n                \n            logger.info(f\"ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø¹Ù…: {key} = {value}\")\n            \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø¹Ù…: {e}\")\n    \n    def get_support_setting(self, key, default='ØºÙŠØ± Ù…Ø­Ø¯Ø¯'):\n        \"\"\"Ù‚Ø±Ø§Ø¡Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯Ø¹Ù…\"\"\"\n        try:\n            with open('system_settings.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['setting_key'] == key:\n                        return row['setting_value']\n        except:\n            pass\n        return default\n\nif __name__ == \"__main__\":\n    # Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†\n    bot_token = os.getenv('BOT_TOKEN')\n    if not bot_token:\n        logger.error(\"BOT_TOKEN ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©\")\n        exit(1)\n    \n    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª\n    bot = ComprehensiveDUXBot(bot_token)\n    bot.run()","size_bytes":234534},"config.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nConfiguration module for the LangSense Bot\nLoads environment variables and provides configuration constants\n\"\"\"\n\nimport os\nfrom dotenv import load_dotenv\n\n# Load environment variables from .env file\nload_dotenv()\n\n# Bot Configuration\nBOT_TOKEN = os.getenv(\"BOT_TOKEN\")\nif not BOT_TOKEN:\n    raise ValueError(\"BOT_TOKEN must be set in environment variables\")\n\n# Admin Configuration\nADMIN_USER_IDS_STR = os.getenv(\"ADMIN_USER_IDS\", \"\")\nADMIN_USER_IDS = [int(uid.strip()) for uid in ADMIN_USER_IDS_STR.split(\",\") if uid.strip().isdigit()]\n\nif not ADMIN_USER_IDS:\n    raise ValueError(\"ADMIN_USER_IDS must be set with at least one valid user ID\")\n\n# Database Configuration\nDATABASE_URL = os.getenv(\"DATABASE_URL\", \"sqlite+aiosqlite:///./langsense.db\")\n\n# Broadcast Configuration\nBROADCAST_RATE_LIMIT = int(os.getenv(\"BROADCAST_RATE_LIMIT\", \"30\"))  # messages per second\nBROADCAST_CHUNK_SIZE = int(os.getenv(\"BROADCAST_CHUNK_SIZE\", \"100\"))  # users per batch\nBROADCAST_RETRY_ATTEMPTS = int(os.getenv(\"BROADCAST_RETRY_ATTEMPTS\", \"3\"))\nBROADCAST_RETRY_DELAY = int(os.getenv(\"BROADCAST_RETRY_DELAY\", \"5\"))  # seconds\n\n# Localization Configuration\nDEFAULT_LANGUAGE = os.getenv(\"DEFAULT_LANGUAGE\", \"ar\")\nDEFAULT_COUNTRY = os.getenv(\"DEFAULT_COUNTRY\", \"SA\")\nSUPPORTED_LANGUAGES = [\"ar\", \"en\"]\n\n# Customer ID Configuration\nCUSTOMER_ID_PREFIX = os.getenv(\"CUSTOMER_ID_PREFIX\", \"C\")\nCUSTOMER_ID_YEAR_FORMAT = os.getenv(\"CUSTOMER_ID_YEAR_FORMAT\", \"2025\")\n\n# File Upload Configuration\nMAX_FILE_SIZE = int(os.getenv(\"MAX_FILE_SIZE\", \"20\")) * 1024 * 1024  # 20MB default\nALLOWED_IMAGE_TYPES = [\"image/jpeg\", \"image/png\", \"image/gif\", \"image/webp\"]\n\n# Pagination Configuration\nUSERS_PER_PAGE = int(os.getenv(\"USERS_PER_PAGE\", \"10\"))\nANNOUNCEMENTS_PER_PAGE = int(os.getenv(\"ANNOUNCEMENTS_PER_PAGE\", \"5\"))\n\n# Logging Configuration\nLOG_LEVEL = os.getenv(\"LOG_LEVEL\", \"INFO\")\nLOG_FILE = os.getenv(\"LOG_FILE\", \"bot.log\")\n\n# Rate Limiting Configuration\nUSER_RATE_LIMIT = int(os.getenv(\"USER_RATE_LIMIT\", \"5\"))  # requests per minute\nADMIN_RATE_LIMIT = int(os.getenv(\"ADMIN_RATE_LIMIT\", \"30\"))  # requests per minute\n\n# Validation\ndef validate_config():\n    \"\"\"Validate configuration settings\"\"\"\n    errors = []\n    \n    if not BOT_TOKEN or len(BOT_TOKEN) < 40:\n        errors.append(\"Invalid BOT_TOKEN format\")\n    \n    if not ADMIN_USER_IDS:\n        errors.append(\"No valid admin user IDs configured\")\n    \n    if BROADCAST_RATE_LIMIT > 30:\n        errors.append(\"BROADCAST_RATE_LIMIT cannot exceed 30 messages/second (Telegram limit)\")\n    \n    if errors:\n        raise ValueError(\"Configuration errors: \" + \"; \".join(errors))\n\n# Validate configuration on import\nvalidate_config()\n","size_bytes":2685},"excel_bot.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nLangSense Telegram Bot - Excel Based Storage\nNo databases, no servers - all data saved in Excel files\n\"\"\"\n\nimport os\nimport json\nimport time\nimport logging\nfrom urllib.request import urlopen, Request\nfrom urllib.parse import urlencode\nfrom urllib.error import URLError, HTTPError\nfrom datetime import datetime\nimport csv\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'\n)\nlogger = logging.getLogger(__name__)\n\nclass ExcelTelegramBot:\n    def __init__(self, token):\n        self.token = token\n        self.api_url = f\"https://api.telegram.org/bot{token}\"\n        self.offset = 0\n        self.users_file = 'users_data.csv'\n        self.transactions_file = 'transactions_data.csv'\n        self.complaints_file = 'complaints_data.csv'\n        self.init_excel_files()\n        \n    def init_excel_files(self):\n        \"\"\"Initialize CSV files (Excel compatible)\"\"\"\n        # Initialize users file\n        if not os.path.exists(self.users_file):\n            with open(self.users_file, 'w', newline='', encoding='utf-8-sig') as file:\n                writer = csv.writer(file)\n                writer.writerow([\n                    'telegram_id', 'username', 'first_name', 'last_name', \n                    'phone_number', 'customer_code', 'language', 'country',\n                    'registration_date', 'is_active'\n                ])\n                \n        # Initialize transactions file  \n        if not os.path.exists(self.transactions_file):\n            with open(self.transactions_file, 'w', newline='', encoding='utf-8-sig') as file:\n                writer = csv.writer(file)\n                writer.writerow([\n                    'transaction_id', 'customer_code', 'telegram_id', 'type', \n                    'amount', 'status', 'request_date', 'approval_date',\n                    'notes', 'receipt_info'\n                ])\n                \n        # Initialize complaints file\n        if not os.path.exists(self.complaints_file):\n            with open(self.complaints_file, 'w', newline='', encoding='utf-8-sig') as file:\n                writer = csv.writer(file)\n                writer.writerow([\n                    'complaint_id', 'customer_code', 'telegram_id', 'subject',\n                    'description', 'status', 'submission_date', 'resolution_date',\n                    'admin_response'\n                ])\n                \n        logger.info(\"Excel files initialized successfully\")\n        \n    def make_request(self, method, params=None):\n        \"\"\"Make HTTP request to Telegram API\"\"\"\n        url = f\"{self.api_url}/{method}\"\n        \n        if params:\n            if method in ['sendMessage', 'sendPhoto', 'sendDocument']:\n                data = urlencode(params).encode('utf-8')\n                request = Request(url, data=data)\n                request.add_header('Content-Type', 'application/x-www-form-urlencoded')\n            else:\n                url += '?' + urlencode(params)\n                request = Request(url)\n        else:\n            request = Request(url)\n            \n        try:\n            with urlopen(request, timeout=30) as response:\n                return json.loads(response.read().decode('utf-8'))\n        except (URLError, HTTPError, json.JSONDecodeError) as e:\n            logger.error(f\"API request failed: {e}\")\n            return None\n            \n    def send_message(self, chat_id, text, reply_markup=None):\n        \"\"\"Send message to user\"\"\"\n        params = {\n            'chat_id': chat_id,\n            'text': text,\n            'parse_mode': 'HTML'\n        }\n        \n        if reply_markup:\n            params['reply_markup'] = json.dumps(reply_markup)\n            \n        return self.make_request('sendMessage', params)\n        \n    def get_updates(self):\n        \"\"\"Get updates from Telegram\"\"\"\n        params = {\n            'offset': self.offset + 1,\n            'timeout': 10\n        }\n        return self.make_request('getUpdates', params)\n        \n    def get_main_menu_keyboard(self, lang='ar'):\n        \"\"\"Create main menu keyboard\"\"\"\n        if lang == 'ar':\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨'}],\n                    [{'text': 'ğŸ“¨ ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰'}, {'text': 'ğŸ“‹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙŠ'}],\n                    [{'text': 'ğŸ‘¨â€ğŸ’¼ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'}, {'text': 'ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©'}],\n                    [{'text': 'âš™ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©'}, {'text': 'ğŸ†˜ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': False\n            }\n        else:\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Request Deposit'}, {'text': 'ğŸ’¸ Request Withdrawal'}],\n                    [{'text': 'ğŸ“¨ Submit Complaint'}, {'text': 'ğŸ“‹ My Requests Status'}],\n                    [{'text': 'ğŸ‘¨â€ğŸ’¼ Admin Tools'}, {'text': 'ğŸ‘¤ My Profile'}],\n                    [{'text': 'âš™ï¸ Change Language'}, {'text': 'ğŸ†˜ Help'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': False\n            }\n            \n    def get_phone_request_keyboard(self, lang='ar'):\n        \"\"\"Create phone number request keyboard\"\"\"\n        text = 'ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ' if lang == 'ar' else 'ğŸ“± Share Phone Number'\n        return {\n            'keyboard': [[{'text': text, 'request_contact': True}]],\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n    def get_language_keyboard(self):\n        \"\"\"Create language selection keyboard\"\"\"\n        return {\n            'keyboard': [\n                [{'text': 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'}, {'text': 'ğŸ‡ºğŸ‡¸ English'}]\n            ],\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n    def find_user_by_telegram_id(self, telegram_id):\n        \"\"\"Find user in CSV file\"\"\"\n        try:\n            with open(self.users_file, 'r', newline='', encoding='utf-8-sig') as file:\n                reader = csv.DictReader(file)\n                for row in reader:\n                    if row['telegram_id'] == str(telegram_id):\n                        return row\n            return None\n        except FileNotFoundError:\n            return None\n            \n    def save_user(self, user_data):\n        \"\"\"Save or update user in CSV file\"\"\"\n        users = []\n        user_exists = False\n        \n        # Read existing users\n        try:\n            with open(self.users_file, 'r', newline='', encoding='utf-8-sig') as file:\n                reader = csv.DictReader(file)\n                for row in reader:\n                    if row['telegram_id'] == str(user_data['telegram_id']):\n                        # Update existing user\n                        users.append(user_data)\n                        user_exists = True\n                    else:\n                        users.append(row)\n        except FileNotFoundError:\n            pass\n            \n        # Add new user if doesn't exist\n        if not user_exists:\n            users.append(user_data)\n            \n        # Write back to file\n        with open(self.users_file, 'w', newline='', encoding='utf-8-sig') as file:\n            if users:\n                fieldnames = users[0].keys()\n                writer = csv.DictWriter(file, fieldnames=fieldnames)\n                writer.writeheader()\n                writer.writerows(users)\n                \n    def generate_customer_code(self):\n        \"\"\"Generate unique customer code\"\"\"\n        try:\n            with open(self.users_file, 'r', newline='', encoding='utf-8-sig') as file:\n                reader = csv.DictReader(file)\n                count = sum(1 for row in reader if row['customer_code'])\n                return f\"C-2025-{count + 1:06d}\"\n        except FileNotFoundError:\n            return \"C-2025-000001\"\n            \n    def save_transaction(self, transaction_data):\n        \"\"\"Save transaction request to CSV file\"\"\"\n        with open(self.transactions_file, 'a', newline='', encoding='utf-8-sig') as file:\n            fieldnames = [\n                'transaction_id', 'customer_code', 'telegram_id', 'type', \n                'amount', 'status', 'request_date', 'approval_date',\n                'notes', 'receipt_info'\n            ]\n            writer = csv.DictWriter(file, fieldnames=fieldnames)\n            \n            # Write header if file is empty\n            if file.tell() == 0:\n                writer.writeheader()\n                \n            writer.writerow(transaction_data)\n            \n    def save_complaint(self, complaint_data):\n        \"\"\"Save complaint to CSV file\"\"\"\n        with open(self.complaints_file, 'a', newline='', encoding='utf-8-sig') as file:\n            fieldnames = [\n                'complaint_id', 'customer_code', 'telegram_id', 'subject',\n                'description', 'status', 'submission_date', 'resolution_date',\n                'admin_response'\n            ]\n            writer = csv.DictWriter(file, fieldnames=fieldnames)\n            \n            # Write header if file is empty  \n            if file.tell() == 0:\n                writer.writeheader()\n                \n            writer.writerow(complaint_data)\n            \n    def get_user_transactions(self, customer_code):\n        \"\"\"Get user transactions from CSV\"\"\"\n        transactions = []\n        try:\n            with open(self.transactions_file, 'r', newline='', encoding='utf-8-sig') as file:\n                reader = csv.DictReader(file)\n                for row in reader:\n                    if row['customer_code'] == customer_code:\n                        transactions.append(row)\n        except FileNotFoundError:\n            pass\n        return transactions\n        \n    def get_user_complaints(self, customer_code):\n        \"\"\"Get user complaints from CSV\"\"\"\n        complaints = []\n        try:\n            with open(self.complaints_file, 'r', newline='', encoding='utf-8-sig') as file:\n                reader = csv.DictReader(file)\n                for row in reader:\n                    if row['customer_code'] == customer_code:\n                        complaints.append(row)\n        except FileNotFoundError:\n            pass\n        return complaints\n        \n    def handle_start(self, message):\n        \"\"\"Handle /start command\"\"\"\n        telegram_user = message['from']\n        user = self.find_user_by_telegram_id(telegram_user['id'])\n        \n        if not user or not user.get('phone_number'):\n            # New user or user without phone\n            welcome_text = (\n                f\"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ {telegram_user['first_name']}! ğŸ‰\\n\\n\"\n                \"Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù… LangSense Ø§Ù„Ù…Ø§Ù„ÙŠ.\\n\\n\"\n                \"Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù…Ø¹Ù†Ø§.\"\n            )\n            \n            self.send_message(\n                message['chat']['id'],\n                welcome_text,\n                self.get_phone_request_keyboard('ar')\n            )\n        else:\n            lang = user.get('language', 'ar')\n            welcome_text = (\n                f\"Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ {user['first_name']}! ğŸ‘‹\\n\\n\"\n                f\"Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['customer_code']}\\n\\n\"\n                \"Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡:\"\n            ) if lang == 'ar' else (\n                f\"Welcome back {user['first_name']}! ğŸ‘‹\\n\\n\"\n                f\"Customer ID: {user['customer_code']}\\n\\n\"\n                \"Select the required service from the menu below:\"\n            )\n            \n            self.send_message(\n                message['chat']['id'],\n                welcome_text,\n                self.get_main_menu_keyboard(lang)\n            )\n            \n    def handle_contact(self, message):\n        \"\"\"Handle contact sharing\"\"\"\n        contact = message['contact']\n        telegram_user = message['from']\n        \n        if contact['user_id'] == telegram_user['id']:\n            customer_code = self.generate_customer_code()\n            \n            user_data = {\n                'telegram_id': str(telegram_user['id']),\n                'username': telegram_user.get('username', ''),\n                'first_name': telegram_user['first_name'],\n                'last_name': telegram_user.get('last_name', ''),\n                'phone_number': contact['phone_number'],\n                'customer_code': customer_code,\n                'language': 'ar',\n                'country': 'SA',\n                'registration_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),\n                'is_active': 'Yes'\n            }\n            \n            self.save_user(user_data)\n            \n            success_text = (\n                f\"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ù†Ø¬Ø§Ø­!\\n\\n\"\n                f\"ğŸ“± Ø§Ù„Ø±Ù‚Ù…: {contact['phone_number']}\\n\"\n                f\"ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_code}\\n\\n\"\n                \"Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… LangSense Ø§Ù„Ù…Ø§Ù„ÙŠ!\"\n            )\n            \n            self.send_message(\n                message['chat']['id'],\n                success_text,\n                self.get_main_menu_keyboard('ar')\n            )\n            \n    def handle_deposit_request(self, message):\n        \"\"\"Handle deposit request\"\"\"\n        user = self.find_user_by_telegram_id(message['from']['id'])\n        if not user:\n            return\n            \n        lang = user.get('language', 'ar')\n        \n        transaction_id = f\"DEP-{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n        \n        response = (\n            f\"ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯\\n\\n\"\n            f\"ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {transaction_id}\\n\\n\"\n            \"Ù„Ø¥ØªÙ…Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„:\\n\"\n            \"1ï¸âƒ£ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ÙŠØ¯Ø§Ø¹Ù‡\\n\"\n            \"2ï¸âƒ£ ØµÙˆØ±Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„\\n\\n\"\n            \"Ù…Ø«Ø§Ù„: 1000 Ø±ÙŠØ§Ù„\\n\\n\"\n            \"Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.\"\n        ) if lang == 'ar' else (\n            f\"ğŸ’° New Deposit Request\\n\\n\"\n            f\"ğŸ†” Transaction ID: {transaction_id}\\n\\n\"\n            \"To complete the deposit request, please send:\\n\"\n            \"1ï¸âƒ£ Amount to deposit\\n\"\n            \"2ï¸âƒ£ Transfer receipt image\\n\\n\"\n            \"Example: 1000 SAR\\n\\n\"\n            \"Your request will be reviewed within 24 hours.\"\n        )\n        \n        self.send_message(message['chat']['id'], response)\n        \n        # Save transaction request\n        transaction_data = {\n            'transaction_id': transaction_id,\n            'customer_code': user['customer_code'],\n            'telegram_id': str(message['from']['id']),\n            'type': 'Deposit',\n            'amount': '0',  # Will be updated when user provides amount\n            'status': 'Pending Info',\n            'request_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),\n            'approval_date': '',\n            'notes': 'Awaiting amount and receipt',\n            'receipt_info': ''\n        }\n        \n        self.save_transaction(transaction_data)\n        \n    def handle_withdrawal_request(self, message):\n        \"\"\"Handle withdrawal request\"\"\"\n        user = self.find_user_by_telegram_id(message['from']['id'])\n        if not user:\n            return\n            \n        lang = user.get('language', 'ar')\n        \n        transaction_id = f\"WD-{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n        \n        response = (\n            f\"ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯\\n\\n\"\n            f\"ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {transaction_id}\\n\\n\"\n            \"Ù„Ø¥ØªÙ…Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„:\\n\"\n            \"1ï¸âƒ£ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡\\n\"\n            \"2ï¸âƒ£ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ\\n\"\n            \"3ï¸âƒ£ ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙˆÙŠØ©\\n\\n\"\n            \"Ù…Ø«Ø§Ù„: 500 Ø±ÙŠØ§Ù„\\n\"\n            \"Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ - 1234567890\\n\\n\"\n            \"Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø®Ù„Ø§Ù„ 48 Ø³Ø§Ø¹Ø©.\"\n        ) if lang == 'ar' else (\n            f\"ğŸ’¸ New Withdrawal Request\\n\\n\"\n            f\"ğŸ†” Transaction ID: {transaction_id}\\n\\n\"\n            \"To complete the withdrawal request, please send:\\n\"\n            \"1ï¸âƒ£ Amount to withdraw\\n\"\n            \"2ï¸âƒ£ Bank account details\\n\"\n            \"3ï¸âƒ£ ID photo\\n\\n\"\n            \"Example: 500 SAR\\n\"\n            \"National Bank - 1234567890\\n\\n\"\n            \"Your request will be processed within 48 hours.\"\n        )\n        \n        self.send_message(message['chat']['id'], response)\n        \n        # Save transaction request\n        transaction_data = {\n            'transaction_id': transaction_id,\n            'customer_code': user['customer_code'],\n            'telegram_id': str(message['from']['id']),\n            'type': 'Withdrawal',\n            'amount': '0',  # Will be updated when user provides amount\n            'status': 'Pending Info',\n            'request_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),\n            'approval_date': '',\n            'notes': 'Awaiting amount and bank details',\n            'receipt_info': ''\n        }\n        \n        self.save_transaction(transaction_data)\n        \n    def handle_complaint_request(self, message):\n        \"\"\"Handle complaint submission\"\"\"\n        user = self.find_user_by_telegram_id(message['from']['id'])\n        if not user:\n            return\n            \n        lang = user.get('language', 'ar')\n        \n        complaint_id = f\"COMP-{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n        \n        response = (\n            f\"ğŸ“¨ ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©\\n\\n\"\n            f\"ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰: {complaint_id}\\n\\n\"\n            \"ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰:\\n\"\n            \"â€¢ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰\\n\"\n            \"â€¢ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©\\n\"\n            \"â€¢ Ø£ÙŠ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù…Ø·Ù„ÙˆØ¨Ø©\\n\\n\"\n            \"Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø´ÙƒÙˆØ§Ùƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.\"\n        ) if lang == 'ar' else (\n            f\"ğŸ“¨ New Complaint Submission\\n\\n\"\n            f\"ğŸ†” Complaint ID: {complaint_id}\\n\\n\"\n            \"Please send complaint details:\\n\"\n            \"â€¢ Subject of complaint\\n\"\n            \"â€¢ Problem details\\n\"\n            \"â€¢ Any required documents\\n\\n\"\n            \"Your complaint will be addressed within 24 hours.\"\n        )\n        \n        self.send_message(message['chat']['id'], response)\n        \n        # Save complaint\n        complaint_data = {\n            'complaint_id': complaint_id,\n            'customer_code': user['customer_code'],\n            'telegram_id': str(message['from']['id']),\n            'subject': 'Pending',\n            'description': 'Awaiting details',\n            'status': 'Submitted',\n            'submission_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),\n            'resolution_date': '',\n            'admin_response': ''\n        }\n        \n        self.save_complaint(complaint_data)\n        \n    def handle_status_check(self, message):\n        \"\"\"Handle status check request\"\"\"\n        user = self.find_user_by_telegram_id(message['from']['id'])\n        if not user:\n            return\n            \n        lang = user.get('language', 'ar')\n        \n        # Get transactions\n        transactions = self.get_user_transactions(user['customer_code'])\n        complaints = self.get_user_complaints(user['customer_code'])\n        \n        status_text = \"ğŸ“‹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙŠ\\n\\n\" if lang == 'ar' else \"ğŸ“‹ My Requests Status\\n\\n\"\n        \n        if transactions:\n            status_text += \"ğŸ’° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©:\\n\" if lang == 'ar' else \"ğŸ’° Financial Transactions:\\n\"\n            for trans in transactions[-5:]:  # Show last 5 transactions\n                status_text += f\"â€¢ {trans['transaction_id']} - {trans['type']} - {trans['status']}\\n\"\n            status_text += \"\\n\"\n            \n        if complaints:\n            status_text += \"ğŸ“¨ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰:\\n\" if lang == 'ar' else \"ğŸ“¨ Complaints:\\n\"\n            for comp in complaints[-3:]:  # Show last 3 complaints\n                status_text += f\"â€¢ {comp['complaint_id']} - {comp['status']}\\n\"\n            status_text += \"\\n\"\n            \n        if not transactions and not complaints:\n            status_text += \"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.\" if lang == 'ar' else \"No previous requests found.\"\n            \n        self.send_message(message['chat']['id'], status_text)\n        \n    def handle_profile(self, message):\n        \"\"\"Handle profile view\"\"\"\n        user = self.find_user_by_telegram_id(message['from']['id'])\n        if not user:\n            return\n            \n        lang = user.get('language', 'ar')\n        \n        profile_text = (\n            f\"ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©\\n\\n\"\n            f\"ğŸ·ï¸ Ø§Ù„Ø§Ø³Ù…: {user['first_name']} {user.get('last_name', '')}\\n\"\n            f\"ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: @{user.get('username', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\\n\"\n            f\"ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {user.get('phone_number', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\\n\"\n            f\"ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user.get('customer_code', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\\n\"\n            f\"ğŸŒ Ø§Ù„Ù„ØºØ©: {user.get('language', 'ar').upper()}\\n\"\n            f\"ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©: {user.get('country', 'SA').upper()}\\n\"\n            f\"ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {user.get('registration_date', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}\"\n        ) if lang == 'ar' else (\n            f\"ğŸ‘¤ My Profile\\n\\n\"\n            f\"ğŸ·ï¸ Name: {user['first_name']} {user.get('last_name', '')}\\n\"\n            f\"ğŸ‘¤ Username: @{user.get('username', 'Not Set')}\\n\"\n            f\"ğŸ“± Phone: {user.get('phone_number', 'Not Set')}\\n\"\n            f\"ğŸ†” Customer ID: {user.get('customer_code', 'Not Set')}\\n\"\n            f\"ğŸŒ Language: {user.get('language', 'ar').upper()}\\n\"\n            f\"ğŸŒ Country: {user.get('country', 'SA').upper()}\\n\"\n            f\"ğŸ“… Registration: {user.get('registration_date', 'Not Set')}\"\n        )\n        \n        self.send_message(message['chat']['id'], profile_text)\n        \n    def handle_language_change(self, message):\n        \"\"\"Handle language change request\"\"\"\n        response = \"ğŸŒ Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…ÙØ¶Ù„Ø©:\\nğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©\\nğŸ‡ºğŸ‡¸ English\"\n        self.send_message(message['chat']['id'], response, self.get_language_keyboard())\n        \n    def handle_language_selection(self, message):\n        \"\"\"Handle language selection\"\"\"\n        text = message['text']\n        user = self.find_user_by_telegram_id(message['from']['id'])\n        \n        if not user:\n            return\n            \n        if 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' in text:\n            new_lang = 'ar'\n            response = \"âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\"\n        elif 'ğŸ‡ºğŸ‡¸ English' in text:\n            new_lang = 'en'\n            response = \"âœ… Language changed to English successfully!\"\n        else:\n            return\n            \n        # Update user language\n        user['language'] = new_lang\n        self.save_user(user)\n        \n        self.send_message(message['chat']['id'], response, self.get_main_menu_keyboard(new_lang))\n        \n    def handle_admin_commands(self, message):\n        \"\"\"Handle admin commands\"\"\"\n        admin_ids = os.getenv('ADMIN_USER_IDS', '').split(',')\n        if str(message['from']['id']) not in admin_ids:\n            self.send_message(\n                message['chat']['id'],\n                \"ğŸš« ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·.\"\n            )\n            return\n            \n        # Count statistics from files\n        user_count = 0\n        transaction_count = 0\n        complaint_count = 0\n        \n        try:\n            with open(self.users_file, 'r', encoding='utf-8-sig') as f:\n                user_count = len(f.readlines()) - 1  # Subtract header\n        except:\n            pass\n            \n        try:\n            with open(self.transactions_file, 'r', encoding='utf-8-sig') as f:\n                transaction_count = len(f.readlines()) - 1\n        except:\n            pass\n            \n        try:\n            with open(self.complaints_file, 'r', encoding='utf-8-sig') as f:\n                complaint_count = len(f.readlines()) - 1\n        except:\n            pass\n            \n        admin_text = (\n            f\"ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…\\n\\n\"\n            f\"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©:\\n\"\n            f\"ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†: {user_count}\\n\"\n            f\"ğŸ’° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: {transaction_count}\\n\"\n            f\"ğŸ“¨ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰: {complaint_count}\\n\\n\"\n            f\"ğŸ“ Ø§Ù„Ù…Ù„ÙØ§Øª:\\n\"\n            f\"â€¢ {self.users_file}\\n\"\n            f\"â€¢ {self.transactions_file}\\n\"\n            f\"â€¢ {self.complaints_file}\\n\\n\"\n            f\"ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Excel Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\"\n        )\n        \n        self.send_message(message['chat']['id'], admin_text)\n        \n    def handle_text_message(self, message):\n        \"\"\"Handle text messages\"\"\"\n        text = message['text']\n        chat_id = message['chat']['id']\n        \n        user = self.find_user_by_telegram_id(message['from']['id'])\n        if not user:\n            return\n            \n        lang = user.get('language', 'ar')\n        \n        # Handle menu options\n        if text in ['ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹', 'ğŸ’° Request Deposit']:\n            self.handle_deposit_request(message)\n        elif text in ['ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨', 'ğŸ’¸ Request Withdrawal']:\n            self.handle_withdrawal_request(message)\n        elif text in ['ğŸ“¨ ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰', 'ğŸ“¨ Submit Complaint']:\n            self.handle_complaint_request(message)\n        elif text in ['ğŸ“‹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙŠ', 'ğŸ“‹ My Requests Status']:\n            self.handle_status_check(message)\n        elif text in ['ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ Ø§Ù„Ø´Ø®ØµÙŠØ©', 'ğŸ‘¤ My Profile']:\n            self.handle_profile(message)\n        elif text in ['âš™ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©', 'âš™ï¸ Change Language']:\n            self.handle_language_change(message)\n        elif text in ['ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'ğŸ‡ºğŸ‡¸ English']:\n            self.handle_language_selection(message)\n        elif text in ['ğŸ†˜ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©', 'ğŸ†˜ Help']:\n            help_text = (\n                \"ğŸ†˜ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©\\n\\n\"\n                \"Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:\\n\"\n                \"ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ - Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„Ø£Ù…ÙˆØ§Ù„\\n\"\n                \"ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ - Ù„Ø³Ø­Ø¨ Ø§Ù„Ø£Ù…ÙˆØ§Ù„\\n\"\n                \"ğŸ“¨ ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰ - Ù„ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰\\n\"\n                \"ğŸ“‹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙŠ - Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª\\n\"\n                \"ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ - Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©\\n\"\n                \"âš™ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© - ØªØºÙŠÙŠØ± Ù„ØºØ© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©\\n\\n\"\n                \"Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠØŒ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.\"\n            ) if lang == 'ar' else (\n                \"ğŸ†˜ Help\\n\\n\"\n                \"Available services:\\n\"\n                \"ğŸ’° Request Deposit - For depositing funds\\n\"\n                \"ğŸ’¸ Request Withdrawal - For withdrawing funds\\n\"\n                \"ğŸ“¨ Submit Complaint - For submitting complaints\\n\"\n                \"ğŸ“‹ My Requests Status - Track requests\\n\"\n                \"ğŸ‘¤ My Profile - View personal data\\n\"\n                \"âš™ï¸ Change Language - Change interface language\\n\\n\"\n                \"For technical support, contact administration.\"\n            )\n            self.send_message(chat_id, help_text)\n        else:\n            response = (\n                \"â“ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø·Ù„Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡.\"\n            ) if lang == 'ar' else (\n                \"â“ Sorry, I didn't understand your request. Please use the menu below.\"\n            )\n            self.send_message(chat_id, response, self.get_main_menu_keyboard(lang))\n            \n    def run(self):\n        \"\"\"Main bot loop\"\"\"\n        logger.info(\"Starting LangSense Excel Bot...\")\n        \n        # Test bot token\n        result = self.make_request('getMe')\n        if not result or not result.get('ok'):\n            logger.error(\"Invalid bot token!\")\n            return\n            \n        logger.info(f\"Bot started: @{result['result']['username']}\")\n        logger.info(\"All data will be saved to Excel-compatible CSV files\")\n        logger.info(f\"Files: {self.users_file}, {self.transactions_file}, {self.complaints_file}\")\n        \n        while True:\n            try:\n                updates = self.get_updates()\n                \n                if updates and updates.get('ok'):\n                    for update in updates['result']:\n                        self.offset = update['update_id']\n                        \n                        if 'message' in update:\n                            message = update['message']\n                            \n                            if 'text' in message:\n                                if message['text'] == '/start':\n                                    self.handle_start(message)\n                                elif message['text'] == '/admin':\n                                    self.handle_admin_commands(message)\n                                else:\n                                    self.handle_text_message(message)\n                            elif 'contact' in message:\n                                self.handle_contact(message)\n                                \n                time.sleep(1)\n                \n            except KeyboardInterrupt:\n                logger.info(\"Bot stopped by user\")\n                break\n            except Exception as e:\n                logger.error(f\"Error in bot loop: {e}\")\n                time.sleep(5)\n\ndef main():\n    bot_token = os.getenv('BOT_TOKEN')\n    if not bot_token:\n        logger.error(\"BOT_TOKEN environment variable not set!\")\n        return\n        \n    bot = ExcelTelegramBot(bot_token)\n    bot.run()\n\nif __name__ == '__main__':\n    main()","size_bytes":30059},"fixed_bot.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nLangSense Bot - Ù…ÙØ­Ø³Ù† ÙˆÙ…ÙØ¨Ø³Ø·\nÙŠØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…Ù„ÙØ§Øª Excel Ø¨Ø¯ÙˆÙ† Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª\n\"\"\"\n\nimport os\nimport json\nimport time\nimport logging\nimport csv\nfrom datetime import datetime\nimport urllib.request\nimport urllib.parse\nimport urllib.error\n\n# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(levelname)s - %(message)s'\n)\nlogger = logging.getLogger(__name__)\n\nclass LangSenseBot:\n    def __init__(self, token):\n        self.token = token\n        self.api_url = f\"https://api.telegram.org/bot{token}\"\n        self.offset = 0\n        self.init_files()\n        \n    def init_files(self):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Excel\"\"\"\n        # Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        if not os.path.exists('users.csv'):\n            with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date', 'is_banned', 'ban_reason'])\n        \n        # Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª\n        if not os.path.exists('transactions.csv'):\n            with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'customer_id', 'telegram_id', 'name', 'type', 'amount', 'status', 'date', 'admin_note', 'payment_method', 'receipt_info'])\n        \n        # Ù…Ù„Ù Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰\n        if not os.path.exists('complaints.csv'):\n            with open('complaints.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'customer_id', 'subject', 'message', 'status', 'date'])\n        \n        # Ù…Ù„Ù ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\n        if not os.path.exists('payment_methods.csv'):\n            with open('payment_methods.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'name', 'type', 'details', 'is_active', 'created_date'])\n                # Ø¥Ø¶Ø§ÙØ© ÙˆØ³Ø§Ø¦Ù„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ©\n                writer.writerow(['1', 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ', 'deposit', 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 1234567890', 'active', datetime.now().strftime('%Y-%m-%d')])\n                writer.writerow(['2', 'Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', 'deposit', 'Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: 0987654321', 'active', datetime.now().strftime('%Y-%m-%d')])\n                writer.writerow(['3', 'STC Pay', 'withdraw', 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: 0501234567', 'active', datetime.now().strftime('%Y-%m-%d')])\n        \n        logger.info(\"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Excel Ø¨Ù†Ø¬Ø§Ø­\")\n        \n    def api_call(self, method, data=None):\n        \"\"\"Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Telegram API Ù…ÙØ¨Ø³Ø·\"\"\"\n        url = f\"{self.api_url}/{method}\"\n        \n        try:\n            if data:\n                # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSON\n                json_data = json.dumps(data).encode('utf-8')\n                req = urllib.request.Request(url, data=json_data)\n                req.add_header('Content-Type', 'application/json')\n            else:\n                req = urllib.request.Request(url)\n            \n            with urllib.request.urlopen(req, timeout=10) as response:\n                result = json.loads(response.read().decode('utf-8'))\n                return result\n                \n        except urllib.error.HTTPError as e:\n            error_body = e.read().decode('utf-8')\n            logger.error(f\"HTTP Error {e.code}: {error_body}\")\n            return None\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ API: {e}\")\n            return None\n    \n    def send_message(self, chat_id, text, keyboard=None):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©\"\"\"\n        data = {\n            'chat_id': chat_id,\n            'text': text,\n            'parse_mode': 'HTML'\n        }\n        \n        if keyboard:\n            data['reply_markup'] = keyboard\n            \n        return self.api_call('sendMessage', data)\n    \n    def get_updates(self):\n        \"\"\"Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª\"\"\"\n        url = f\"{self.api_url}/getUpdates?offset={self.offset + 1}&timeout=10\"\n        \n        try:\n            with urllib.request.urlopen(url, timeout=15) as response:\n                return json.loads(response.read().decode('utf-8'))\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª: {e}\")\n            return None\n    \n    def main_keyboard(self, lang='ar'):\n        \"\"\"Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\"\"\"\n        if lang == 'ar':\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø³Ø­Ø¨'}],\n                    [{'text': 'ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ'}, {'text': 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ'}],\n                    [{'text': 'ğŸ“¨ Ø´ÙƒÙˆÙ‰'}, {'text': 'ğŸ‡ºğŸ‡¸ English'}]\n                ],\n                'resize_keyboard': True\n            }\n        else:\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Deposit'}, {'text': 'ğŸ’¸ Withdraw'}],\n                    [{'text': 'ğŸ“‹ My Requests'}, {'text': 'ğŸ‘¤ Profile'}],\n                    [{'text': 'ğŸ“¨ Complaint'}, {'text': 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©'}]\n                ],\n                'resize_keyboard': True\n            }\n    \n    def phone_keyboard(self, lang='ar'):\n        \"\"\"Ù„ÙˆØ­Ø© Ø·Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\"\"\"\n        text = 'ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ' if lang == 'ar' else 'ğŸ“± Share Phone'\n        return {\n            'keyboard': [[{'text': text, 'request_contact': True}]],\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n    \n    def find_user(self, telegram_id):\n        \"\"\"Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['telegram_id'] == str(telegram_id):\n                        return row\n        except:\n            pass\n        return None\n    \n    def save_user(self, telegram_id, name, phone, customer_id, language='ar'):\n        \"\"\"Ø­ÙØ¸ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯\"\"\"\n        with open('users.csv', 'a', newline='', encoding='utf-8-sig') as f:\n            writer = csv.writer(f)\n            writer.writerow([\n                telegram_id, name, phone, customer_id, \n                language, datetime.now().strftime('%Y-%m-%d %H:%M'), 'no', ''\n            ])\n    \n    def generate_customer_id(self):\n        \"\"\"ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¹Ù…ÙŠÙ„\"\"\"\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                lines = f.readlines()\n                count = len(lines) - 1  # Ø·Ø±Ø­ Ø³Ø·Ø± Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†\n                return f\"C{count + 1:06d}\"\n        except:\n            return \"C000001\"\n    \n    def save_transaction(self, customer_id, telegram_id, name, trans_type, amount, payment_method='', receipt_info='', status='pending'):\n        \"\"\"Ø­ÙØ¸ Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        trans_id = f\"T{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n        with open('transactions.csv', 'a', newline='', encoding='utf-8-sig') as f:\n            writer = csv.writer(f)\n            writer.writerow([\n                trans_id, customer_id, telegram_id, name, trans_type, amount, \n                status, datetime.now().strftime('%Y-%m-%d %H:%M'), '', payment_method, receipt_info\n            ])\n        return trans_id\n    \n    def save_complaint(self, customer_id, subject, message, status='new'):\n        \"\"\"Ø­ÙØ¸ Ø´ÙƒÙˆÙ‰\"\"\"\n        comp_id = f\"COMP{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n        with open('complaints.csv', 'a', newline='', encoding='utf-8-sig') as f:\n            writer = csv.writer(f)\n            writer.writerow([\n                comp_id, customer_id, subject, message, \n                status, datetime.now().strftime('%Y-%m-%d %H:%M')\n            ])\n        return comp_id\n    \n    def handle_start(self, message):\n        \"\"\"Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ù…Ø± /start\"\"\"\n        user_info = message['from']\n        user = self.find_user(user_info['id'])\n        \n        if not user:\n            # Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯\n            text = f\"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user_info['first_name']}! ğŸ‰\\n\\nØ£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ LangSense\\nÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù„Ù„ØªØ³Ø¬ÙŠÙ„\"\n            self.send_message(message['chat']['id'], text, self.phone_keyboard())\n        else:\n            # Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯\n            lang = user.get('language', 'ar')\n            text = f\"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user['name']}! ğŸ‘‹\\nØ±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['customer_id']}\" if lang == 'ar' else f\"Welcome {user['name']}! ğŸ‘‹\\nCustomer ID: {user['customer_id']}\"\n            self.send_message(message['chat']['id'], text, self.main_keyboard(lang))\n    \n    def handle_contact(self, message):\n        \"\"\"Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\"\"\"\n        contact = message['contact']\n        user_info = message['from']\n        \n        if contact['user_id'] == user_info['id']:\n            customer_id = self.generate_customer_id()\n            name = user_info['first_name']\n            phone = contact['phone_number']\n            \n            self.save_user(user_info['id'], name, phone, customer_id)\n            \n            text = f\"âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {phone}\\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_id}\"\n            self.send_message(message['chat']['id'], text, self.main_keyboard())\n    \n    def is_admin(self, telegram_id):\n        \"\"\"ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¯Ù…Ù†\"\"\"\n        admin_ids = os.getenv('ADMIN_USER_IDS', '').split(',')\n        return str(telegram_id) in admin_ids\n    \n    def is_user_banned(self, telegram_id):\n        \"\"\"ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¸ÙˆØ±\"\"\"\n        user = self.find_user(telegram_id)\n        return user and user.get('is_banned', 'no') == 'yes'\n    \n    def get_payment_methods(self, method_type=None):\n        \"\"\"Ø¬Ù„Ø¨ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\"\"\"\n        methods = []\n        try:\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if method_type is None or row['type'] == method_type:\n                        if row['is_active'] == 'active':\n                            methods.append(row)\n        except:\n            pass\n        return methods\n    \n    def handle_admin_commands(self, message):\n        \"\"\"Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        if not self.is_admin(message['from']['id']):\n            self.send_message(message['chat']['id'], \"ğŸš« ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·\")\n            return\n        \n        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                users_count = len(f.readlines()) - 1\n        except:\n            users_count = 0\n            \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                trans_list = list(reader)\n                trans_count = len(trans_list)\n                pending_count = len([t for t in trans_list if t['status'] == 'pending'])\n        except:\n            trans_count = 0\n            pending_count = 0\n        \n        try:\n            with open('complaints.csv', 'r', encoding='utf-8-sig') as f:\n                comp_count = len(f.readlines()) - 1\n        except:\n            comp_count = 0\n        \n        admin_text = f\"\"\"ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©\n\nğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:\nğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {users_count}\nğŸ’° Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: {trans_count} (â³ Ù…Ø¹Ù„Ù‚Ø©: {pending_count})\nğŸ“¨ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰: {comp_count}\n\nğŸ”§ Ø£ÙˆØ§Ù…Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\n/search Ø§Ø³Ù…_Ø£Ùˆ_Ø±Ù‚Ù… - Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…\n/userinfo Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„ - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø³ØªØ®Ø¯Ù…\n/ban Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø³Ø¨Ø¨ - Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù…\n/unban Ø±Ù‚Ù…_Ø§Ù„Ø¹Ù…ÙŠÙ„ - Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø±\n\nğŸ’³ Ø¥Ø¯Ø§Ø±Ø© ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹:\n/payments - Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\n/addpay Ù†ÙˆØ¹ Ø§Ø³Ù… ØªÙØ§ØµÙŠÙ„ - Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠÙ„Ø© Ø¯ÙØ¹\n\nğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª:\n/pending - Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©\n/approve Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© - Ù…ÙˆØ§ÙÙ‚Ø©\n/reject Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø³Ø¨Ø¨ - Ø±ÙØ¶\n/note Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ù„Ø§Ø­Ø¸Ø© - Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚\n\nğŸ“¢ Ø£ÙˆØ§Ù…Ø± Ø£Ø®Ø±Ù‰:\n/users - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n/broadcast Ø±Ø³Ø§Ù„Ø© - Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ\"\"\"\n        \n        self.send_message(message['chat']['id'], admin_text)\n    \n    def handle_broadcast(self, message):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n        \n        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù†Øµ\n        parts = message['text'].split(' ', 1)\n        if len(parts) < 2:\n            self.send_message(message['chat']['id'], \"Ø§Ø³ØªØ®Ø¯Ù…: /broadcast Ø±Ø³Ø§Ù„ØªÙƒ\")\n            return\n        \n        broadcast_msg = parts[1]\n        \n        # Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        users = []\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                users = list(reader)\n        except:\n            pass\n        \n        if not users:\n            self.send_message(message['chat']['id'], \"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„ÙŠÙ‡Ù…\")\n            return\n        \n        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        success_count = 0\n        for user in users:\n            try:\n                result = self.send_message(user['telegram_id'], f\"ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:\\n\\n{broadcast_msg}\")\n                if result and result.get('ok'):\n                    success_count += 1\n                time.sleep(0.1)  # ØªØ¬Ù†Ø¨ Ø§Ù„Ø³Ø¨Ø§Ù…\n            except:\n                pass\n        \n        self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ {success_count} Ù…Ù† {len(users)} Ù…Ø³ØªØ®Ø¯Ù…\")\n    \n    def handle_users_list(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\"\"\"\n        if not self.is_admin(message['from']['id']):\n            return\n        \n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                users = list(reader)\n        except:\n            users = []\n        \n        if not users:\n            self.send_message(message['chat']['id'], \"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†\")\n            return\n        \n        users_text = \"ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\\n\\n\"\n        for user in users[-10:]:  # Ø¢Ø®Ø± 10 Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n            users_text += f\"â€¢ {user['name']} ({user['customer_id']})\\n  ğŸ“± {user['phone']}\\n  ğŸ“… {user['date']}\\n\\n\"\n        \n        self.send_message(message['chat']['id'], users_text)\n    \n    def handle_text(self, message):\n        \"\"\"Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©\"\"\"\n        text = message['text']\n        chat_id = message['chat']['id']\n        \n        # Ø£ÙˆØ§Ù…Ø± Ø®Ø§ØµØ©\n        if text == '/admin':\n            self.handle_admin_commands(message)\n            return\n        elif text.startswith('/broadcast '):\n            self.handle_broadcast(message)\n            return\n        elif text == '/users':\n            self.handle_users_list(message)\n            return\n        elif text == '/myid':\n            # Ø¹Ø±Ø¶ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n            self.send_message(chat_id, f\"ğŸ†” Telegram ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:\\n`{message['from']['id']}`\\n\\nØ§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„Ù…Ø·ÙˆØ± Ù„Ø¥Ø¶Ø§ÙØªÙƒ ÙƒØ£Ø¯Ù…Ù†\")\n            return\n        \n        user = self.find_user(message['from']['id'])\n        \n        if not user:\n            self.handle_start(message)\n            return\n        \n        lang = user.get('language', 'ar')\n        \n        # ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©\n        if text == 'ğŸ‡ºğŸ‡¸ English':\n            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ØºØ© ÙÙŠ Ø§Ù„Ù…Ù„Ù\n            self.update_user_language(user['telegram_id'], 'en')\n            self.send_message(chat_id, \"âœ… Language changed to English\", self.main_keyboard('en'))\n            return\n        elif text == 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©':\n            self.update_user_language(user['telegram_id'], 'ar')\n            self.send_message(chat_id, \"âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©\", self.main_keyboard('ar'))\n            return\n        \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª\n        if text in ['ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹', 'ğŸ’° Deposit']:\n            trans_id = self.save_transaction(user['customer_id'], 'deposit', '0')\n            response = f\"ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯\\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\\n\\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„\" if lang == 'ar' else f\"ğŸ’° New deposit request\\nğŸ†” Transaction: {trans_id}\\n\\nPlease send amount and receipt image\"\n            self.send_message(chat_id, response)\n            \n        elif text in ['ğŸ’¸ Ø³Ø­Ø¨', 'ğŸ’¸ Withdraw']:\n            trans_id = self.save_transaction(user['customer_id'], 'withdraw', '0')\n            response = f\"ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯\\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\\n\\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨\" if lang == 'ar' else f\"ğŸ’¸ New withdrawal request\\nğŸ†” Transaction: {trans_id}\\n\\nPlease send amount and account details\"\n            self.send_message(chat_id, response)\n            \n        elif text in ['ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ', 'ğŸ“‹ My Requests']:\n            # Ø¹Ø±Ø¶ Ø¢Ø®Ø± 5 Ø·Ù„Ø¨Ø§Øª\n            transactions = self.get_user_transactions(user['customer_id'])\n            if transactions:\n                response = \"ğŸ“‹ Ø¢Ø®Ø± Ø·Ù„Ø¨Ø§ØªÙƒ:\\n\\n\" if lang == 'ar' else \"ğŸ“‹ Your recent requests:\\n\\n\"\n                for trans in transactions[-5:]:\n                    response += f\"â€¢ {trans['id']} - {trans['type']} - {trans['status']}\\n\"\n            else:\n                response = \"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©\" if lang == 'ar' else \"No previous requests\"\n            self.send_message(chat_id, response)\n            \n        elif text in ['ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ', 'ğŸ‘¤ Profile']:\n            response = f\"ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ:\\nğŸ·ï¸ Ø§Ù„Ø§Ø³Ù…: {user['name']}\\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {user['phone']}\\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['customer_id']}\\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {user['date']}\" if lang == 'ar' else f\"ğŸ‘¤ Your Profile:\\nğŸ·ï¸ Name: {user['name']}\\nğŸ“± Phone: {user['phone']}\\nğŸ†” Customer ID: {user['customer_id']}\\nğŸ“… Registration: {user['date']}\"\n            self.send_message(chat_id, response)\n            \n        elif text in ['ğŸ“¨ Ø´ÙƒÙˆÙ‰', 'ğŸ“¨ Complaint']:\n            comp_id = self.save_complaint(user['customer_id'], 'Ø¹Ø§Ù…', 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„')\n            response = f\"ğŸ“¨ Ø´ÙƒÙˆÙ‰ Ø¬Ø¯ÙŠØ¯Ø©\\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰: {comp_id}\\n\\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰\" if lang == 'ar' else f\"ğŸ“¨ New complaint\\nğŸ†” Complaint ID: {comp_id}\\n\\nPlease send complaint details\"\n            self.send_message(chat_id, response)\n            \n        else:\n            response = \"Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡:\" if lang == 'ar' else \"Please select from the menu below:\"\n            self.send_message(chat_id, response, self.main_keyboard(lang))\n    \n    def update_user_language(self, telegram_id, new_lang):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ù„ØºØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        try:\n            # Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n            users = []\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['telegram_id'] == str(telegram_id):\n                        row['language'] = new_lang\n                    users.append(row)\n            \n            # Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù\n            with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                fieldnames = ['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date']\n                writer = csv.DictWriter(f, fieldnames=fieldnames)\n                writer.writeheader()\n                writer.writerows(users)\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ØºØ©: {e}\")\n    \n    def get_user_transactions(self, customer_id):\n        \"\"\"Ø¬Ù„Ø¨ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        transactions = []\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == customer_id:\n                        transactions.append(row)\n        except:\n            pass\n        return transactions\n    \n    def run(self):\n        \"\"\"ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª\"\"\"\n        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙˆÙƒÙ†\n        test_result = self.api_call('getMe')\n        if not test_result or not test_result.get('ok'):\n            logger.error(\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙˆÙƒÙ†!\")\n            print(\"ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© BOT_TOKEN\")\n            return\n        \n        bot_info = test_result['result']\n        logger.info(f\"âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„: @{bot_info['username']}\")\n        logger.info(\"ğŸ“ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ: users.csv, transactions.csv, complaints.csv\")\n        \n        while True:\n            try:\n                updates = self.get_updates()\n                \n                if updates and updates.get('ok'):\n                    for update in updates['result']:\n                        self.offset = update['update_id']\n                        \n                        if 'message' in update:\n                            message = update['message']\n                            \n                            if 'text' in message:\n                                if message['text'] == '/start':\n                                    self.handle_start(message)\n                                else:\n                                    self.handle_text(message)\n                            elif 'contact' in message:\n                                self.handle_contact(message)\n                \n                time.sleep(1)\n                \n            except KeyboardInterrupt:\n                logger.info(\"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª\")\n                break\n            except Exception as e:\n                logger.error(f\"Ø®Ø·Ø£: {e}\")\n                time.sleep(3)\n\nif __name__ == '__main__':\n    # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªÙˆÙƒÙ†\n    bot_token = os.getenv('BOT_TOKEN')\n    \n    if not bot_token:\n        print(\"âŒ ÙŠØ±Ø¬Ù‰ ØªØ¹ÙŠÙŠÙ† BOT_TOKEN ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©\")\n        exit(1)\n    \n    print(\"ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ LangSense Bot...\")\n    bot = LangSenseBot(bot_token)\n    bot.run()","size_bytes":22868},"main.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nMain entry point for the LangSense Telegram Bot\nHandles database initialization and starts the bot\n\"\"\"\n\nimport asyncio\nimport logging\nimport sys\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker\nfrom sqlalchemy.pool import StaticPool\n\nfrom config import DATABASE_URL\nfrom models import Base\nimport bot\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n    handlers=[\n        logging.FileHandler('bot.log'),\n        logging.StreamHandler(sys.stdout)\n    ]\n)\nlogger = logging.getLogger(__name__)\n\nasync def init_database():\n    \"\"\"Initialize database and create tables\"\"\"\n    try:\n        # Convert PostgreSQL URL to asyncpg if needed\n        db_url = DATABASE_URL\n        if db_url.startswith(\"postgresql://\"):\n            db_url = db_url.replace(\"postgresql://\", \"postgresql+asyncpg://\")\n        \n        # Create async engine\n        if \"sqlite\" in db_url:\n            # SQLite specific configuration\n            engine = create_async_engine(\n                db_url,\n                poolclass=StaticPool,\n                connect_args={\"check_same_thread\": False},\n                echo=False\n            )\n        else:\n            # PostgreSQL configuration\n            engine = create_async_engine(db_url, echo=False)\n        \n        # Create tables\n        async with engine.begin() as conn:\n            await conn.run_sync(Base.metadata.create_all)\n        \n        logger.info(\"Database initialized successfully\")\n        return engine\n        \n    except Exception as e:\n        logger.error(f\"Database initialization failed: {e}\")\n        raise\n\nasync def main():\n    \"\"\"Main application entry point\"\"\"\n    try:\n        logger.info(\"Starting LangSense Bot...\")\n        \n        # Initialize database\n        engine = await init_database()\n        \n        # Create session maker\n        async_session = async_sessionmaker(engine, expire_on_commit=False)\n        \n        # Start the bot\n        await bot.main(async_session)\n        \n    except KeyboardInterrupt:\n        logger.info(\"Bot stopped by user\")\n    except Exception as e:\n        logger.error(f\"Fatal error: {e}\")\n        sys.exit(1)\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n","size_bytes":2328},"models.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nSQLAlchemy models for the LangSense Bot\nDefines database schema for users, languages, countries, announcements, and messaging\n\"\"\"\n\nfrom datetime import datetime, timezone\nfrom enum import Enum as PyEnum\nfrom typing import Optional\n\nfrom sqlalchemy import (\n    Boolean, Column, DateTime, Enum, ForeignKey, Integer, String, Text, \n    UniqueConstraint, Index, BigInteger\n)\nfrom sqlalchemy.ext.asyncio import AsyncAttrs\nfrom sqlalchemy.ext.declarative import declarative_base\nfrom sqlalchemy.orm import relationship, Mapped, mapped_column\n\nBase = declarative_base(cls=AsyncAttrs)\n\nclass OutboxType(PyEnum):\n    \"\"\"Types of outbox messages\"\"\"\n    DEPOSIT = \"deposit\"\n    WITHDRAWAL = \"withdrawal\" \n    COMPLAINT = \"complaint\"\n    SUPPORT = \"support\"\n    BROADCAST = \"broadcast\"\n    ANNOUNCEMENT = \"announcement\"\n\nclass OutboxStatus(PyEnum):\n    \"\"\"Status of outbox messages\"\"\"\n    PENDING = \"pending\"\n    APPROVED = \"approved\"\n    REJECTED = \"rejected\"\n    PROCESSING = \"processing\"\n    COMPLETED = \"completed\"\n    FAILED = \"failed\"\n\nclass DeliveryStatus(PyEnum):\n    \"\"\"Status of message delivery\"\"\"\n    PENDING = \"pending\"\n    SENT = \"sent\"\n    DELIVERED = \"delivered\"\n    FAILED = \"failed\"\n    BLOCKED = \"blocked\"\n\nclass User(Base):\n    \"\"\"User model for storing Telegram user information\"\"\"\n    __tablename__ = 'users'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    telegram_id: Mapped[int] = mapped_column(BigInteger, unique=True, nullable=False, index=True)\n    username: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)\n    first_name: Mapped[str] = mapped_column(String(255), nullable=False)\n    last_name: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)\n    phone_number: Mapped[Optional[str]] = mapped_column(String(20), nullable=True)\n    customer_code: Mapped[Optional[str]] = mapped_column(String(50), unique=True, nullable=True, index=True)\n    \n    # Preferences\n    language_code: Mapped[str] = mapped_column(String(5), nullable=False, default='ar')\n    country_code: Mapped[str] = mapped_column(String(5), nullable=False, default='SA')\n    notifications_enabled: Mapped[bool] = mapped_column(Boolean, default=True)\n    \n    # Status\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    is_banned: Mapped[bool] = mapped_column(Boolean, default=False)\n    is_admin: Mapped[bool] = mapped_column(Boolean, default=False)\n    \n    # Timestamps\n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    last_activity: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    \n    # Relationships\n    outbox_messages = relationship(\"Outbox\", back_populates=\"user\", cascade=\"all, delete-orphan\")\n    announcement_deliveries = relationship(\"AnnouncementDelivery\", back_populates=\"user\", cascade=\"all, delete-orphan\")\n    \n    def __repr__(self):\n        return f\"<User(id={self.id}, telegram_id={self.telegram_id}, username={self.username})>\"\n\nclass Language(Base):\n    \"\"\"Language model for multi-language support\"\"\"\n    __tablename__ = 'languages'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    code: Mapped[str] = mapped_column(String(5), unique=True, nullable=False, index=True)\n    name: Mapped[str] = mapped_column(String(100), nullable=False)\n    native_name: Mapped[str] = mapped_column(String(100), nullable=False)\n    rtl: Mapped[bool] = mapped_column(Boolean, default=False)\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    \n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    \n    def __repr__(self):\n        return f\"<Language(code={self.code}, name={self.name})>\"\n\nclass Country(Base):\n    \"\"\"Country model for regional settings\"\"\"\n    __tablename__ = 'countries'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    code: Mapped[str] = mapped_column(String(5), unique=True, nullable=False, index=True)\n    name: Mapped[str] = mapped_column(String(100), nullable=False)\n    native_name: Mapped[str] = mapped_column(String(100), nullable=False)\n    phone_prefix: Mapped[str] = mapped_column(String(10), nullable=False)\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    \n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    \n    def __repr__(self):\n        return f\"<Country(code={self.code}, name={self.name})>\"\n\nclass Announcement(Base):\n    \"\"\"Announcement model for system announcements\"\"\"\n    __tablename__ = 'announcements'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    title_ar: Mapped[str] = mapped_column(String(255), nullable=False)\n    title_en: Mapped[str] = mapped_column(String(255), nullable=False)\n    content_ar: Mapped[str] = mapped_column(Text, nullable=False)\n    content_en: Mapped[str] = mapped_column(Text, nullable=False)\n    image_url: Mapped[Optional[str]] = mapped_column(String(500), nullable=True)\n    \n    # Display settings\n    display_duration: Mapped[int] = mapped_column(Integer, default=0)  # 0 = permanent\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    priority: Mapped[int] = mapped_column(Integer, default=0)\n    \n    # Filtering\n    target_language: Mapped[Optional[str]] = mapped_column(String(5), nullable=True)\n    target_country: Mapped[Optional[str]] = mapped_column(String(5), nullable=True)\n    \n    # Timestamps\n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    scheduled_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    expires_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    \n    # Relationships\n    deliveries = relationship(\"AnnouncementDelivery\", back_populates=\"announcement\", cascade=\"all, delete-orphan\")\n    \n    def __repr__(self):\n        return f\"<Announcement(id={self.id}, title_ar={self.title_ar[:50]})>\"\n\nclass AnnouncementDelivery(Base):\n    \"\"\"Track announcement delivery to users\"\"\"\n    __tablename__ = 'announcement_deliveries'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    announcement_id: Mapped[int] = mapped_column(Integer, ForeignKey('announcements.id'), nullable=False)\n    user_id: Mapped[int] = mapped_column(Integer, ForeignKey('users.id'), nullable=False)\n    \n    status: Mapped[DeliveryStatus] = mapped_column(Enum(DeliveryStatus), default=DeliveryStatus.PENDING)\n    delivered_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    read_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    error_message: Mapped[Optional[str]] = mapped_column(Text, nullable=True)\n    \n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    \n    # Relationships\n    announcement = relationship(\"Announcement\", back_populates=\"deliveries\")\n    user = relationship(\"User\", back_populates=\"announcement_deliveries\")\n    \n    # Unique constraint\n    __table_args__ = (UniqueConstraint('announcement_id', 'user_id', name='uq_announcement_user'),)\n    \n    def __repr__(self):\n        return f\"<AnnouncementDelivery(announcement_id={self.announcement_id}, user_id={self.user_id}, status={self.status})>\"\n\nclass Outbox(Base):\n    \"\"\"Outbox for user requests and system messages\"\"\"\n    __tablename__ = 'outbox'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    user_id: Mapped[int] = mapped_column(Integer, ForeignKey('users.id'), nullable=False)\n    type: Mapped[OutboxType] = mapped_column(Enum(OutboxType), nullable=False)\n    status: Mapped[OutboxStatus] = mapped_column(Enum(OutboxStatus), default=OutboxStatus.PENDING)\n    \n    # Content\n    subject: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)\n    content: Mapped[str] = mapped_column(Text, nullable=False)\n    attachment_url: Mapped[Optional[str]] = mapped_column(String(500), nullable=True)\n    \n    # Processing\n    processed_by: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)  # Admin telegram_id\n    processed_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    admin_comment: Mapped[Optional[str]] = mapped_column(Text, nullable=True)\n    \n    # Timestamps\n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    \n    # Relationships\n    user = relationship(\"User\", back_populates=\"outbox_messages\")\n    recipients = relationship(\"OutboxRecipient\", back_populates=\"outbox\", cascade=\"all, delete-orphan\")\n    \n    # Indexes\n    __table_args__ = (\n        Index('idx_outbox_type_status', 'type', 'status'),\n        Index('idx_outbox_created', 'created_at'),\n    )\n    \n    def __repr__(self):\n        return f\"<Outbox(id={self.id}, type={self.type}, status={self.status})>\"\n\nclass OutboxRecipient(Base):\n    \"\"\"Track individual message recipients for broadcasts\"\"\"\n    __tablename__ = 'outbox_recipients'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    outbox_id: Mapped[int] = mapped_column(Integer, ForeignKey('outbox.id'), nullable=False)\n    user_id: Mapped[int] = mapped_column(Integer, ForeignKey('users.id'), nullable=False)\n    \n    status: Mapped[DeliveryStatus] = mapped_column(Enum(DeliveryStatus), default=DeliveryStatus.PENDING)\n    attempts: Mapped[int] = mapped_column(Integer, default=0)\n    last_attempt: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    delivered_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    error_message: Mapped[Optional[str]] = mapped_column(Text, nullable=True)\n    \n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    \n    # Relationships\n    outbox = relationship(\"Outbox\", back_populates=\"recipients\")\n    \n    # Unique constraint\n    __table_args__ = (UniqueConstraint('outbox_id', 'user_id', name='uq_outbox_user'),)\n    \n    def __repr__(self):\n        return f\"<OutboxRecipient(outbox_id={self.outbox_id}, user_id={self.user_id}, status={self.status})>\"\n","size_bytes":11331},"pyproject.toml":{"content":"[project]\nname = \"repl-nix-workspace\"\nversion = \"0.1.0\"\ndescription = \"Add your description here\"\nrequires-python = \">=3.11\"\ndependencies = []\n","size_bytes":143},"replit.md":{"content":"# replit.md\n\n## Overview\n\nLangSense is a streamlined Telegram bot for financial services with Arabic support. The bot provides a simplified financial ecosystem focusing on deposit/withdrawal processing with company selection, wallet number input, and exchange address management. Features include user registration, admin approval system, and comprehensive transaction tracking.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\nUI Design: Button-based navigation preferred over text commands.\nNotifications: Only at completion of operations, not during process.\nAdmin Commands: Simplified format without complex syntax requirements.\n\n## System Architecture\n\n### Core Framework\n- **Bot Framework**: Simplified HTTP-based Telegram Bot API implementation using Python standard library\n- **Language**: Python 3 with urllib and json for lightweight operation\n- **State Management**: Simple dictionary-based state management for user sessions\n- **Implementation**: Streamlined single-file solution without external dependencies\n- **Backup System**: Automated data backup every 6 hours with ZIP compression and admin delivery\n\n### Database Layer\n- **Database**: CSV files for simplicity and transparency\n- **Files**: users.csv, transactions.csv, companies.csv, exchange_addresses.csv\n- **Schema**: Simplified tables focusing on essential data only\n- **Data Integrity**: Automatic customer code generation, basic validation\n\n### User Interface\n- **Navigation**: Button-based keyboards for all interactions\n- **Language**: Arabic primary with simple interface\n- **Flow**: Linear process flows for deposits and withdrawals\n- **Withdrawal Confirmation**: Button-based final confirmation with \"âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨\", \"âŒ Ø¥Ù„ØºØ§Ø¡\", and \"ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\"\n- **Advanced Reset System**: \"ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ø¸Ø§Ù…\" and \"ğŸ†˜ Ø¥ØµÙ„Ø§Ø­ Ø´Ø§Ù…Ù„\" buttons for comprehensive error resolution\n- **Super Reset Function**: Complete system cleanup including user states, temporary data, and file integrity verification\n- **Error Recovery**: Enhanced error messages with multiple reset options and alternative action buttons\n- **System Diagnostics**: Automatic verification and repair of core system files\n- **Simplicity**: No complex commands or syntax requirements\n\n### Authentication & Authorization\n- **Admin System**: Environment variable-based admin user ID configuration\n- **User Registration**: Name and phone number only\n- **Session Management**: Simple state tracking for multi-step processes\n\n### Financial Services Workflow\n- **Enhanced Deposit Process**: Company Selection â†’ **Payment Method Selection** â†’ Wallet Number â†’ Amount â†’ Completion\n- **Enhanced Withdrawal Process**: Company Selection â†’ **Payment Method Selection** â†’ Wallet Number â†’ Amount â†’ **Withdrawal Address Entry** â†’ **Confirmation Code Entry** â†’ Final Confirmation\n- **Payment Method Integration**: Users select specific payment methods for each company (bank accounts, e-wallets, etc.)\n- **Status Tracking**: Simple pending/approved/rejected states\n- **Admin Approval**: Direct text-based commands (Ù…ÙˆØ§ÙÙ‚Ø©/Ø±ÙØ¶)\n- **Withdrawal Address**: Users must specify withdrawal address for each request\n- **Confirmation Code**: Required verification code from customer before processing\n\n### Company & Payment Method Management\n- **Enhanced Company Management**: Interactive step-by-step wizards for adding, editing, and deleting companies\n- **Comprehensive Payment Method System**: \n  - Multiple payment methods per company (bank accounts, e-wallets, investment accounts)\n  - Customizable payment data fields for each method\n  - Admin CRUD operations (add, edit, delete) for payment methods\n  - User selection of payment methods during transactions\n- **User-Friendly Interface**: Button-based navigation with confirmation dialogs and real-time preview\n- **Advanced Features**: \n  - Add Company Wizard: Name â†’ Service Type (buttons) â†’ Details â†’ Confirmation with edit options\n  - Payment Method Management: Add/Edit/Delete methods with custom data fields\n  - Edit Company Wizard: Select company â†’ Edit any field â†’ Live preview â†’ Safe save\n  - Delete Company: Safety confirmation with company details display\n  - Management Dashboard: Enhanced view with company count, status indicators, and quick actions\n- **Exchange Address**: Single active address that can be updated easily\n- **Flexibility**: Dynamic company list for both deposits and withdrawals with method selection\n\n### Notifications\n- **Timing**: Only at completion of operations (approval/rejection) + instant notifications for new requests\n- **Content**: Essential information only\n- **Direction**: Bidirectional (admin â†” user) at completion + instant admin alerts for new transactions\n- **Admin Alerts**: Immediate notifications when users submit deposit/withdrawal requests\n- **Customer Alerts**: Instant notifications upon approval/rejection with full transaction details\n- **Broadcast Messages**: Sent without keyboard markup to prevent interference with existing user interfaces\n- **Direct Admin Messages**: Individual customer messages sent without keyboard to preserve current user state\n\n### Admin Interface\n- **Commands**: Simplified text-based commands with enhanced copy functionality\n- **Format**: Natural language without complex syntax\n- **Enhanced Copy System**: \n  - Quick copy commands for each transaction (approve/reject)\n  - Quick copy responses for complaints with templates\n  - Comprehensive quick copy commands section with all admin operations\n  - Pre-formatted commands for easy copying and modification\n- **Direct User Messaging**: Send targeted messages to specific customers using their customer ID\n- **Enhanced Payment Method Management**: Full CRUD operations with interactive selection interfaces\n- **Easy Copy Payment Data**: Customer-friendly display of payment account information with copy functionality\n- **Payment Method Commands**: \n  - `Ø§Ø¶Ø§ÙØ©_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ ID_Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ø³Ù…_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ù†ÙˆØ¹_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`\n  - `Ø­Ø°Ù_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ ID_Ø§Ù„ÙˆØ³ÙŠÙ„Ø©`\n  - `ØªØ¹Ø¯ÙŠÙ„_ÙˆØ³ÙŠÙ„Ø©_Ø¯ÙØ¹ ID_Ø§Ù„ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª_Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©`\n- **Examples**: \"Ù…ÙˆØ§ÙÙ‚Ø© DEP123\", \"Ø±ÙØ¶ WTH456 Ø³Ø¨Ø¨\", \"Ø§Ø¶Ù_Ø´Ø±ÙƒØ© Ø§Ø³Ù… Ù†ÙˆØ¹ ØªÙØ§ØµÙŠÙ„\"\n- **Navigation**: Button-based admin panel with payment method management\n\n### Error Handling & Logging\n- **Logging**: Basic console logging for monitoring\n- **Validation**: Simple input validation with clear error messages\n- **Fallbacks**: Graceful handling of invalid inputs\n- **Data Protection**: Automated backup system every 6 hours with encrypted ZIP files sent to admin accounts\n- **Manual Backup**: Admin command for instant backup generation and delivery\n- **Backup Contents**: All CSV files, system settings, and comprehensive statistical reports\n\n## External Dependencies\n\n### Core Dependencies\n- **Aiogram v3**: Modern Telegram Bot API framework with async support\n- **SQLAlchemy**: Async ORM for database operations and relationship management\n- **APScheduler**: Task scheduling for announcements and periodic operations\n- **Pillow**: Image processing for media validation and manipulation\n\n### Database Options\n- **SQLite**: Default development database with aiosqlite driver\n- **PostgreSQL**: Production database with asyncpg driver for scalability\n\n### Runtime Dependencies\n- **Python-dotenv**: Environment variable management and configuration loading\n- **AsyncIO**: Core async runtime for handling concurrent operations\n\n### Optional Integrations\n- **File Storage**: Local file system for media uploads (configurable for cloud storage)\n- **External APIs**: Extensible architecture for payment provider integrations\n- **Monitoring Services**: Ready for integration with external logging and monitoring platforms","size_bytes":7879},"run_linux.sh":{"content":"#!/bin/bash\n\necho \"========================================\"\necho \"LangSense Telegram Bot - Linux Setup\"\necho \"========================================\"\necho\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nNC='\\033[0m' # No Color\n\n# Function to print colored output\nprint_success() {\n    echo -e \"${GREEN}$1 âœ“${NC}\"\n}\n\nprint_error() {\n    echo -e \"${RED}ERROR: $1${NC}\"\n}\n\nprint_warning() {\n    echo -e \"${YELLOW}WARNING: $1${NC}\"\n}\n\n# Check if Python is installed\nif ! command -v python3 &> /dev/null; then\n    print_error \"Python 3 is not installed\"\n    echo \"Please install Python 3.8+ using your package manager:\"\n    echo \"  Ubuntu/Debian: sudo apt install python3 python3-pip python3-venv\"\n    echo \"  CentOS/RHEL: sudo yum install python3 python3-pip\"\n    echo \"  Fedora: sudo dnf install python3 python3-pip\"\n    exit 1\nfi\n\nprint_success \"Python 3 is installed\"\n\n# Check Python version\nPYTHON_VERSION=$(python3 -c 'import sys; print(\".\".join(map(str, sys.version_info[:2])))')\nREQUIRED_VERSION=\"3.8\"\n\nif ! python3 -c \"import sys; exit(0 if sys.version_info >= (3, 8) else 1)\"; then\n    print_error \"Python 3.8 or higher is required. You have Python $PYTHON_VERSION\"\n    exit 1\nfi\n\nprint_success \"Python version $PYTHON_VERSION is compatible\"\necho\n\n# Create virtual environment if it doesn't exist\nif [ ! -d \"venv\" ]; then\n    echo \"Creating virtual environment...\"\n    python3 -m venv venv\n    if [ $? -ne 0 ]; then\n        print_error \"Failed to create virtual environment\"\n        exit 1\n    fi\n    print_success \"Virtual environment created\"\nelse\n    print_success \"Virtual environment already exists\"\nfi\n\necho\n\n# Activate virtual environment\necho \"Activating virtual environment...\"\nsource venv/bin/activate\nif [ $? -ne 0 ]; then\n    print_error \"Failed to activate virtual environment\"\n    exit 1\nfi\n\nprint_success \"Virtual environment activated\"\necho\n\n# Upgrade pip\necho \"Upgrading pip...\"\npython -m pip install --upgrade pip\nprint_success \"Pip upgraded\"\necho\n\n# Install required packages\necho \"Installing required packages...\"\npip install aiogram sqlalchemy aiosqlite asyncpg python-dotenv aiohttp pydantic psutil requests aiofiles pillow cryptography apscheduler babel\nif [ $? -ne 0 ]; then\n    print_error \"Failed to install packages\"\n    exit 1\nfi\n\nprint_success \"Packages installed successfully\"\necho\n\n# Check if .env file exists\nif [ ! -f \".env\" ]; then\n    print_warning \".env file not found!\"\n    echo\n    echo \"Please create a .env file with the following content:\"\n    echo \"BOT_TOKEN=your_bot_token_here\"\n    echo \"ADMIN_USER_IDS=your_telegram_user_id_here\"\n    echo \"DATABASE_URL=sqlite+aiosqlite:///./langsense.db\"\n    echo\n    echo \"You can copy .env.example to .env and modify the values:\"\n    echo \"cp .env.example .env\"\n    echo\n    read -p \"Press Enter to continue...\"\nelse\n    print_success \".env file found\"\nfi\n\necho\n\n# Create directories if they don't exist\nfor dir in translations handlers services utils; do\n    if [ ! -d \"$dir\" ]; then\n        mkdir -p \"$dir\"\n        print_success \"Created $dir directory\"\n    fi\ndone\n\necho\necho \"========================================\"\nprint_success \"Setup completed successfully! ğŸ‰\"\necho \"========================================\"\necho\n\n# Make script executable\nchmod +x \"$0\"\n\n# Start the bot\necho \"Starting LangSense Bot...\"\necho \"Press Ctrl+C to stop the bot\"\necho\n\n# Function to handle script termination\ncleanup() {\n    echo\n    echo \"Bot stopped.\"\n    deactivate\n    exit 0\n}\n\n# Set up signal handlers\ntrap cleanup SIGINT SIGTERM\n\n# Start the bot\npython main.py\n\n# Cleanup on normal exit\ncleanup\n","size_bytes":3611},"simple_bot.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nSimple Telegram Bot using basic HTTP requests\nWorks without complex dependencies\n\"\"\"\n\nimport os\nimport json\nimport time\nimport sqlite3\nimport logging\nfrom urllib.request import urlopen, Request\nfrom urllib.parse import urlencode\nfrom urllib.error import URLError, HTTPError\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'\n)\nlogger = logging.getLogger(__name__)\n\nclass SimpleTelegramBot:\n    def __init__(self, token):\n        self.token = token\n        self.api_url = f\"https://api.telegram.org/bot{token}\"\n        self.offset = 0\n        self.init_database()\n        \n    def init_database(self):\n        \"\"\"Initialize SQLite database\"\"\"\n        self.conn = sqlite3.connect('langsense.db', check_same_thread=False)\n        cursor = self.conn.cursor()\n        \n        # Create users table\n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS users (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                telegram_id INTEGER UNIQUE NOT NULL,\n                username TEXT,\n                first_name TEXT NOT NULL,\n                last_name TEXT,\n                phone_number TEXT,\n                customer_code TEXT UNIQUE,\n                language_code TEXT DEFAULT 'ar',\n                country_code TEXT DEFAULT 'SA',\n                is_active BOOLEAN DEFAULT 1,\n                is_admin BOOLEAN DEFAULT 0,\n                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n            )\n        ''')\n        \n        # Create languages table\n        cursor.execute('''\n            CREATE TABLE IF NOT EXISTS languages (\n                id INTEGER PRIMARY KEY AUTOINCREMENT,\n                code TEXT UNIQUE NOT NULL,\n                name TEXT NOT NULL,\n                native_name TEXT NOT NULL,\n                is_active BOOLEAN DEFAULT 1\n            )\n        ''')\n        \n        # Insert default languages\n        cursor.execute(\"INSERT OR IGNORE INTO languages (code, name, native_name) VALUES ('ar', 'Arabic', 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©')\")\n        cursor.execute(\"INSERT OR IGNORE INTO languages (code, name, native_name) VALUES ('en', 'English', 'English')\")\n        \n        self.conn.commit()\n        logger.info(\"Database initialized successfully\")\n        \n    def make_request(self, method, params=None):\n        \"\"\"Make HTTP request to Telegram API\"\"\"\n        url = f\"{self.api_url}/{method}\"\n        \n        if params:\n            if method == 'sendMessage' or method == 'sendPhoto':\n                # POST request for sending messages\n                data = urlencode(params).encode('utf-8')\n                request = Request(url, data=data)\n                request.add_header('Content-Type', 'application/x-www-form-urlencoded')\n            else:\n                # GET request for other methods\n                url += '?' + urlencode(params)\n                request = Request(url)\n        else:\n            request = Request(url)\n            \n        try:\n            with urlopen(request, timeout=30) as response:\n                return json.loads(response.read().decode('utf-8'))\n        except (URLError, HTTPError, json.JSONDecodeError) as e:\n            logger.error(f\"API request failed: {e}\")\n            return None\n            \n    def send_message(self, chat_id, text, reply_markup=None):\n        \"\"\"Send message to user\"\"\"\n        params = {\n            'chat_id': chat_id,\n            'text': text,\n            'parse_mode': 'HTML'\n        }\n        \n        if reply_markup:\n            params['reply_markup'] = json.dumps(reply_markup)\n            \n        return self.make_request('sendMessage', params)\n        \n    def get_updates(self):\n        \"\"\"Get updates from Telegram\"\"\"\n        params = {\n            'offset': self.offset + 1,\n            'timeout': 10\n        }\n        return self.make_request('getUpdates', params)\n        \n    def get_main_menu_keyboard(self, lang='ar'):\n        \"\"\"Create main menu keyboard\"\"\"\n        if lang == 'ar':\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø³Ø­Ø¨'}],\n                    [{'text': 'ğŸ“¨ Ø´ÙƒØ§ÙˆÙ‰'}, {'text': 'ğŸ†˜ Ø¯Ø¹Ù…'}],\n                    [{'text': 'ğŸ‘¨â€ğŸ’¼ Ù…Ø¯ÙŠØ±'}, {'text': 'ğŸ“‹ Ø®Ø·Ø· ÙˆØ§Ø´ØªØ±Ø§ÙƒØ§Øª'}],\n                    [{'text': 'ğŸ’¼ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª'}, {'text': 'âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'}],\n                    [{'text': 'â¬…ï¸ Ø±Ø¬ÙˆØ¹'}, {'text': 'â¡ï¸ ØªÙ‚Ø¯Ù…'}, {'text': 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': False\n            }\n        else:\n            return {\n                'keyboard': [\n                    [{'text': 'ğŸ’° Deposit'}, {'text': 'ğŸ’¸ Withdraw'}],\n                    [{'text': 'ğŸ“¨ Complaints'}, {'text': 'ğŸ†˜ Support'}],\n                    [{'text': 'ğŸ‘¨â€ğŸ’¼ Manager'}, {'text': 'ğŸ“‹ Plans & Subscriptions'}],\n                    [{'text': 'ğŸ’¼ Sales'}, {'text': 'âš™ï¸ Settings'}],\n                    [{'text': 'â¬…ï¸ Back'}, {'text': 'â¡ï¸ Forward'}, {'text': 'ğŸ‘¤ My Account'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': False\n            }\n            \n    def get_phone_request_keyboard(self, lang='ar'):\n        \"\"\"Create phone number request keyboard\"\"\"\n        text = 'ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ' if lang == 'ar' else 'ğŸ“± Share Phone Number'\n        return {\n            'keyboard': [[{'text': text, 'request_contact': True}]],\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n    def get_or_create_user(self, telegram_user):\n        \"\"\"Get or create user in database\"\"\"\n        cursor = self.conn.cursor()\n        \n        # Try to get existing user\n        cursor.execute(\"SELECT * FROM users WHERE telegram_id = ?\", (telegram_user['id'],))\n        user = cursor.fetchone()\n        \n        if user:\n            # Update existing user\n            cursor.execute(\"\"\"\n                UPDATE users \n                SET username = ?, first_name = ?, last_name = ?\n                WHERE telegram_id = ?\n            \"\"\", (\n                telegram_user.get('username'),\n                telegram_user['first_name'],\n                telegram_user.get('last_name'),\n                telegram_user['id']\n            ))\n        else:\n            # Create new user\n            cursor.execute(\"\"\"\n                INSERT INTO users (telegram_id, username, first_name, last_name, language_code)\n                VALUES (?, ?, ?, ?, ?)\n            \"\"\", (\n                telegram_user['id'],\n                telegram_user.get('username'),\n                telegram_user['first_name'],\n                telegram_user.get('last_name'),\n                telegram_user.get('language_code', 'ar')\n            ))\n            \n        self.conn.commit()\n        \n        # Get updated user\n        cursor.execute(\"SELECT * FROM users WHERE telegram_id = ?\", (telegram_user['id'],))\n        return cursor.fetchone()\n        \n    def generate_customer_code(self):\n        \"\"\"Generate unique customer code\"\"\"\n        cursor = self.conn.cursor()\n        cursor.execute(\"SELECT COUNT(*) FROM users WHERE customer_code IS NOT NULL\")\n        count = cursor.fetchone()[0]\n        return f\"C-2025-{count + 1:06d}\"\n        \n    def handle_start(self, message):\n        \"\"\"Handle /start command\"\"\"\n        user = self.get_or_create_user(message['from'])\n        lang = user[7] if user else 'ar'  # language_code column\n        \n        if not user[5]:  # phone_number column\n            welcome_text = (\n                f\"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ {user[3]}! ğŸ‰\\n\\n\"\n                \"Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ ÙÙŠ Ù†Ø¸Ø§Ù… LangSense Ø§Ù„Ù…Ø§Ù„ÙŠ.\\n\\n\"\n                \"Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù…Ø¹Ù†Ø§ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¹Ù…ÙŠÙ„ Ø¢Ù…Ù†.\"\n            ) if lang == 'ar' else (\n                f\"Welcome {user[3]}! ğŸ‰\\n\\n\"\n                \"Welcome to the LangSense Financial System.\\n\\n\"\n                \"To complete registration, please share your phone number with us to create a secure customer account.\"\n            )\n            \n            self.send_message(\n                message['chat']['id'],\n                welcome_text,\n                self.get_phone_request_keyboard(lang)\n            )\n        else:\n            welcome_text = (\n                f\"Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ {user[3]}! ğŸ‘‹\\n\\n\"\n                f\"Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user[6]}\\n\\n\"\n                \"Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡:\"\n            ) if lang == 'ar' else (\n                f\"Welcome back {user[3]}! ğŸ‘‹\\n\\n\"\n                f\"Customer ID: {user[6]}\\n\\n\"\n                \"Select the required service from the menu below:\"\n            )\n            \n            self.send_message(\n                message['chat']['id'],\n                welcome_text,\n                self.get_main_menu_keyboard(lang)\n            )\n            \n    def handle_contact(self, message):\n        \"\"\"Handle contact sharing\"\"\"\n        contact = message['contact']\n        if contact['user_id'] == message['from']['id']:\n            cursor = self.conn.cursor()\n            customer_code = self.generate_customer_code()\n            \n            cursor.execute(\"\"\"\n                UPDATE users \n                SET phone_number = ?, customer_code = ?\n                WHERE telegram_id = ?\n            \"\"\", (contact['phone_number'], customer_code, message['from']['id']))\n            self.conn.commit()\n            \n            cursor.execute(\"SELECT * FROM users WHERE telegram_id = ?\", (message['from']['id'],))\n            user = cursor.fetchone()\n            lang = user[7]\n            \n            success_text = (\n                f\"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø¨Ù†Ø¬Ø§Ø­!\\n\\n\"\n                f\"ğŸ“± Ø§Ù„Ø±Ù‚Ù…: {contact['phone_number']}\\n\"\n                f\"ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_code}\\n\\n\"\n                \"Ø£Ù‡Ù„Ø§Ù‹ ÙˆØ³Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… LangSense Ø§Ù„Ù…Ø§Ù„ÙŠ!\"\n            ) if lang == 'ar' else (\n                f\"âœ… Phone number registered successfully!\\n\\n\"\n                f\"ğŸ“± Number: {contact['phone_number']}\\n\"\n                f\"ğŸ†” Customer ID: {customer_code}\\n\\n\"\n                \"Welcome to the LangSense Financial System!\"\n            )\n            \n            self.send_message(\n                message['chat']['id'],\n                success_text,\n                self.get_main_menu_keyboard(lang)\n            )\n            \n    def handle_text_message(self, message):\n        \"\"\"Handle text messages\"\"\"\n        text = message['text']\n        chat_id = message['chat']['id']\n        \n        cursor = self.conn.cursor()\n        cursor.execute(\"SELECT * FROM users WHERE telegram_id = ?\", (message['from']['id'],))\n        user = cursor.fetchone()\n        \n        if not user:\n            return\n            \n        lang = user[7]\n        \n        # Handle menu options\n        if text in ['ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹', 'ğŸ’° Deposit']:\n            response = (\n                \"ğŸ’° Ø®Ø¯Ù…Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\\n\\n\"\n                \"Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ØŒ ÙŠØ±Ø¬Ù‰:\\n\"\n                \"1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥ÙŠØ¯Ø§Ø¹Ù‡\\n\"\n                \"2. Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©\\n\"\n                \"3. Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„\\n\\n\"\n                \"Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰.\"\n            ) if lang == 'ar' else (\n                \"ğŸ’° Deposit Service\\n\\n\"\n                \"To complete the deposit process, please:\\n\"\n                \"1. Specify the amount to deposit\\n\"\n                \"2. Choose the appropriate payment method\\n\"\n                \"3. Attach a transfer receipt image\\n\\n\"\n                \"Your request will be reviewed within 24 hours maximum.\"\n            )\n            \n        elif text in ['ğŸ’¸ Ø³Ø­Ø¨', 'ğŸ’¸ Withdraw']:\n            response = (\n                \"ğŸ’¸ Ø®Ø¯Ù…Ø© Ø§Ù„Ø³Ø­Ø¨\\n\\n\"\n                \"Ù„Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨ØŒ ÙŠØ±Ø¬Ù‰:\\n\"\n                \"1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡\\n\"\n                \"2. ØªÙ‚Ø¯ÙŠÙ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ØµØ±ÙÙŠ\\n\"\n                \"3. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨\\n\\n\"\n                \"Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø®Ù„Ø§Ù„ 48 Ø³Ø§Ø¹Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰.\"\n            ) if lang == 'ar' else (\n                \"ğŸ’¸ Withdrawal Service\\n\\n\"\n                \"To complete the withdrawal process, please:\\n\"\n                \"1. Specify the amount to withdraw\\n\"\n                \"2. Provide bank account details\\n\"\n                \"3. Confirm identity as required\\n\\n\"\n                \"Your request will be processed within 48 hours maximum.\"\n            )\n            \n        elif text in ['ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ', 'ğŸ‘¤ My Account']:\n            response = (\n                f\"ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨ÙŠ\\n\\n\"\n                f\"ğŸ·ï¸ Ø§Ù„Ø§Ø³Ù…: {user[3]} {user[4] or ''}\\n\"\n                f\"ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: @{user[2] or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\\n\"\n                f\"ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {user[5] or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\\n\"\n                f\"ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user[6] or 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}\\n\"\n                f\"ğŸŒ Ø§Ù„Ù„ØºØ©: {user[7].upper()}\\n\"\n                f\"ğŸŒ Ø§Ù„Ø¯ÙˆÙ„Ø©: {user[8].upper()}\"\n            ) if lang == 'ar' else (\n                f\"ğŸ‘¤ My Account Information\\n\\n\"\n                f\"ğŸ·ï¸ Name: {user[3]} {user[4] or ''}\\n\"\n                f\"ğŸ‘¤ Username: @{user[2] or 'Not Set'}\\n\"\n                f\"ğŸ“± Phone: {user[5] or 'Not Set'}\\n\"\n                f\"ğŸ†” Customer ID: {user[6] or 'Not Set'}\\n\"\n                f\"ğŸŒ Language: {user[7].upper()}\\n\"\n                f\"ğŸŒ Country: {user[8].upper()}\"\n            )\n            \n        else:\n            response = (\n                \"â“ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø·Ù„Ø¨Ùƒ. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.\"\n            ) if lang == 'ar' else (\n                \"â“ Sorry, I didn't understand your request. Please use the menu below to select the required service.\"\n            )\n            \n        self.send_message(chat_id, response)\n        \n    def handle_admin_command(self, message):\n        \"\"\"Handle admin commands\"\"\"\n        admin_ids = os.getenv('ADMIN_USER_IDS', '').split(',')\n        if str(message['from']['id']) not in admin_ids:\n            self.send_message(\n                message['chat']['id'],\n                \"ğŸš« ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­! Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø´Ø±ÙÙŠÙ† ÙÙ‚Ø·.\"\n            )\n            return\n            \n        cursor = self.conn.cursor()\n        cursor.execute(\"SELECT COUNT(*) FROM users\")\n        total_users = cursor.fetchone()[0]\n        \n        cursor.execute(\"SELECT COUNT(*) FROM users WHERE is_active = 1\")\n        active_users = cursor.fetchone()[0]\n        \n        admin_text = (\n            f\"ğŸ› ï¸ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…\\n\\n\"\n            f\"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©:\\n\"\n            f\"ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {total_users}\\n\"\n            f\"âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†: {active_users}\\n\\n\"\n            f\"Ø§Ø³ØªØ®Ø¯Ù… /users Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\"\n        )\n        \n        self.send_message(message['chat']['id'], admin_text)\n        \n    def run(self):\n        \"\"\"Main bot loop\"\"\"\n        logger.info(\"Starting LangSense Bot...\")\n        \n        # Test bot token\n        result = self.make_request('getMe')\n        if not result or not result.get('ok'):\n            logger.error(\"Invalid bot token!\")\n            return\n            \n        logger.info(f\"Bot started: @{result['result']['username']}\")\n        \n        while True:\n            try:\n                updates = self.get_updates()\n                \n                if updates and updates.get('ok'):\n                    for update in updates['result']:\n                        self.offset = update['update_id']\n                        \n                        if 'message' in update:\n                            message = update['message']\n                            \n                            if 'text' in message:\n                                if message['text'] == '/start':\n                                    self.handle_start(message)\n                                elif message['text'] == '/admin':\n                                    self.handle_admin_command(message)\n                                else:\n                                    self.handle_text_message(message)\n                            elif 'contact' in message:\n                                self.handle_contact(message)\n                                \n                time.sleep(1)\n                \n            except KeyboardInterrupt:\n                logger.info(\"Bot stopped by user\")\n                break\n            except Exception as e:\n                logger.error(f\"Error in bot loop: {e}\")\n                time.sleep(5)\n\ndef main():\n    bot_token = os.getenv('BOT_TOKEN')\n    if not bot_token:\n        logger.error(\"BOT_TOKEN environment variable not set!\")\n        return\n        \n    bot = SimpleTelegramBot(bot_token)\n    bot.run()\n\nif __name__ == '__main__':\n    main()","size_bytes":17326},"simple_improved_bot.py":{"content":"#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\nimport os\nimport json\nimport csv\nimport urllib.request\nimport urllib.parse\nimport logging\nfrom datetime import datetime\n\n# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„\nlogging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')\nlogger = logging.getLogger(__name__)\n\nclass SimpleLangSenseBot:\n    def __init__(self, token):\n        self.token = token\n        self.api_url = f\"https://api.telegram.org/bot{token}\"\n        self.offset = 0\n        self.user_states = {}\n        self.init_files()\n        self.admin_ids = self.get_admin_ids()\n        \n    def init_files(self):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\"\"\"\n        # Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        if not os.path.exists('users.csv'):\n            with open('users.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['telegram_id', 'name', 'phone', 'customer_id', 'language', 'date', 'is_banned'])\n        \n        # Ù…Ù„Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª\n        if not os.path.exists('transactions.csv'):\n            with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'customer_id', 'name', 'type', 'company', 'wallet_number', 'amount', 'exchange_address', 'status', 'date', 'admin_note'])\n        \n        # Ù…Ù„Ù Ø§Ù„Ø´Ø±ÙƒØ§Øª\n        if not os.path.exists('companies.csv'):\n            with open('companies.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'name', 'type', 'details'])\n                # Ø´Ø±ÙƒØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©\n                companies = [\n                    ['1', 'STC Pay', 'both', 'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©'],\n                    ['2', 'Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø£Ù‡Ù„ÙŠ', 'both', 'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ'],\n                    ['3', 'ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´', 'both', 'Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©'],\n                    ['4', 'Ø¨Ù†Ùƒ Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ', 'both', 'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ']\n                ]\n                for company in companies:\n                    writer.writerow(company)\n        \n        # Ù…Ù„Ù Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØµØ±Ø§ÙØ©\n        if not os.path.exists('exchange_addresses.csv'):\n            with open('exchange_addresses.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'address', 'is_active'])\n                writer.writerow(['1', 'Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯ØŒ Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ù…Ù‚Ø§Ø¨Ù„ Ù…ÙˆÙ„ Ø§Ù„Ø±ÙŠØ§Ø¶', 'yes'])\n        \n        logger.info(\"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…\")\n        \n    def api_call(self, method, data=None):\n        \"\"\"Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API\"\"\"\n        url = f\"{self.api_url}/{method}\"\n        try:\n            if data:\n                json_data = json.dumps(data).encode('utf-8')\n                req = urllib.request.Request(url, data=json_data)\n                req.add_header('Content-Type', 'application/json')\n            else:\n                req = urllib.request.Request(url)\n            \n            with urllib.request.urlopen(req, timeout=10) as response:\n                return json.loads(response.read().decode('utf-8'))\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ API: {e}\")\n            return None\n    \n    def send_message(self, chat_id, text, keyboard=None):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©\"\"\"\n        data = {'chat_id': chat_id, 'text': text, 'parse_mode': 'HTML'}\n        if keyboard:\n            data['reply_markup'] = keyboard\n        return self.api_call('sendMessage', data)\n    \n    def get_updates(self):\n        \"\"\"Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª\"\"\"\n        url = f\"{self.api_url}/getUpdates?offset={self.offset + 1}&timeout=10\"\n        try:\n            with urllib.request.urlopen(url, timeout=15) as response:\n                return json.loads(response.read().decode('utf-8'))\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª: {e}\")\n            return None\n    \n    def get_admin_ids(self):\n        \"\"\"Ø¬Ù„Ø¨ Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        admin_ids = os.getenv('ADMIN_USER_IDS', '').split(',')\n        return [admin_id.strip() for admin_id in admin_ids if admin_id.strip()]\n    \n    def is_admin(self, telegram_id):\n        \"\"\"ÙØ­Øµ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        return str(telegram_id) in self.admin_ids\n    \n    def notify_admins(self, message):\n        \"\"\"Ø¥Ø´Ø¹Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        for admin_id in self.admin_ids:\n            self.send_message(admin_id, message, self.admin_keyboard())\n    \n    def find_user(self, telegram_id):\n        \"\"\"Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['telegram_id'] == str(telegram_id):\n                        return row\n        except:\n            pass\n        return None\n    \n    def get_companies(self, service_type=None):\n        \"\"\"Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø±ÙƒØ§Øª\"\"\"\n        companies = []\n        try:\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if service_type is None or row['type'] in [service_type, 'both']:\n                        companies.append(row)\n        except:\n            pass\n        return companies\n    \n    def get_exchange_address(self):\n        \"\"\"Ø¬Ù„Ø¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ±Ø§ÙØ© Ø§Ù„Ù†Ø´Ø·\"\"\"\n        try:\n            with open('exchange_addresses.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['is_active'] == 'yes':\n                        return row['address']\n        except:\n            pass\n        return \"Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ØºÙŠØ± Ù…ØªÙˆÙØ±\"\n    \n    def main_keyboard(self, lang='ar'):\n        \"\"\"Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\"\"\"\n        return {\n            'keyboard': [\n                [{'text': 'ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø³Ø­Ø¨'}],\n                [{'text': 'ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ'}, {'text': 'ğŸ†˜ Ø¯Ø¹Ù…'}]\n            ],\n            'resize_keyboard': True\n        }\n    \n    def admin_keyboard(self):\n        \"\"\"Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        return {\n            'keyboard': [\n                [{'text': 'ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©'}, {'text': 'âœ… Ù…ÙˆØ§ÙÙ‚Ø© Ø·Ù„Ø¨'}],\n                [{'text': 'âŒ Ø±ÙØ¶ Ø·Ù„Ø¨'}, {'text': 'ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'}],\n                [{'text': 'ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª'}, {'text': 'ğŸ“ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'}],\n                [{'text': 'ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª'}, {'text': 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}]\n            ],\n            'resize_keyboard': True\n        }\n    \n    def companies_keyboard(self, service_type):\n        \"\"\"Ù„ÙˆØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ§Øª\"\"\"\n        companies = self.get_companies(service_type)\n        keyboard = []\n        for company in companies:\n            keyboard.append([{'text': company['name']}])\n        keyboard.append([{'text': 'ğŸ”™ Ø±Ø¬ÙˆØ¹'}])\n        return {'keyboard': keyboard, 'resize_keyboard': True}\n    \n    def handle_start(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\"\"\"\n        chat_id = message['chat']['id']\n        user_id = message['from']['id']\n        \n        # ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯\n        user = self.find_user(user_id)\n        if user:\n            welcome_text = f\"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ {user['name']}! ğŸ‘‹\"\n            self.send_message(chat_id, welcome_text, self.main_keyboard())\n        else:\n            welcome_text = \"\"\"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©! ğŸ‘‹\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ³Ø¬ÙŠÙ„:\"\"\"\n            self.send_message(chat_id, welcome_text)\n            self.user_states[user_id] = 'registering_name'\n    \n    def handle_registration(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id)\n        \n        if state == 'registering_name':\n            name = message['text'].strip()\n            if len(name) < 2:\n                self.send_message(message['chat']['id'], \"Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            self.user_states[user_id] = f'registering_phone_{name}'\n            self.send_message(message['chat']['id'], \"Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø¢Ù† Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ:\")\n            \n        elif state.startswith('registering_phone_'):\n            name = state.replace('registering_phone_', '')\n            phone = message['text'].strip()\n            \n            if len(phone) < 10:\n                self.send_message(message['chat']['id'], \"Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… Ø¹Ù…ÙŠÙ„\n            customer_id = f\"C{str(int(datetime.now().timestamp()))[-6:]}\"\n            \n            # Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n            with open('users.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([user_id, name, phone, customer_id, 'ar', datetime.now().strftime('%Y-%m-%d'), 'no'])\n            \n            welcome_text = f\"\"\"âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {name}\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {phone}\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_id}\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª:\"\"\"\n            \n            self.send_message(message['chat']['id'], welcome_text, self.main_keyboard())\n            del self.user_states[user_id]\n    \n    def start_deposit(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        self.send_message(message['chat']['id'], \"Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹:\", self.companies_keyboard('deposit'))\n        self.user_states[message['from']['id']] = 'selecting_deposit_company'\n    \n    def start_withdrawal(self, message):\n        \"\"\"Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø³Ø­Ø¨\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        self.send_message(message['chat']['id'], \"Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø³Ø­Ø¨:\", self.companies_keyboard('withdraw'))\n        self.user_states[message['from']['id']] = 'selecting_withdraw_company'\n    \n    def process_deposit_flow(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¯ÙÙ‚ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id, '')\n        text = message['text']\n        \n        if state == 'selecting_deposit_company':\n            # Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n            companies = self.get_companies('deposit')\n            selected_company = None\n            for company in companies:\n                if company['name'] == text:\n                    selected_company = company\n                    break\n            \n            if not selected_company:\n                self.send_message(message['chat']['id'], \"Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:\")\n                return\n            \n            self.user_states[user_id] = f'deposit_wallet_{selected_company[\"name\"]}'\n            self.send_message(message['chat']['id'], f\"Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø­ÙØ¸ØªÙƒ/Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ {selected_company['name']}:\")\n            \n        elif state.startswith('deposit_wallet_'):\n            company_name = state.replace('deposit_wallet_', '')\n            wallet_number = text.strip()\n            \n            if len(wallet_number) < 5:\n                self.send_message(message['chat']['id'], \"Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù‚ØµÙŠØ±. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            self.user_states[user_id] = f'deposit_amount_{company_name}_{wallet_number}'\n            self.send_message(message['chat']['id'], \"Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥ÙŠØ¯Ø§Ø¹Ù‡:\")\n            \n        elif state.startswith('deposit_amount_'):\n            parts = state.split('_', 2)\n            company_name = parts[2].split('_')[0]\n            wallet_number = '_'.join(parts[2].split('_')[1:])\n            \n            try:\n                amount = float(text.strip())\n                if amount < 50:\n                    self.send_message(message['chat']['id'], \"Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹ 50 Ø±ÙŠØ§Ù„:\")\n                    return\n            except:\n                self.send_message(message['chat']['id'], \"Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…:\")\n                return\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n            user = self.find_user(user_id)\n            trans_id = f\"DEP{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n            \n            with open('transactions.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([trans_id, user['customer_id'], user['name'], 'deposit', \n                               company_name, wallet_number, amount, '', 'pending', \n                               datetime.now().strftime('%Y-%m-%d %H:%M'), ''])\n            \n            # Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„\n            confirmation = f\"\"\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\n\nØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙˆØ¥Ø´Ø¹Ø§Ø±Ùƒ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø©.\"\"\"\n            \n            self.send_message(message['chat']['id'], confirmation, self.main_keyboard())\n            \n            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\n            admin_msg = f\"\"\"ğŸ”” Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯\n\nğŸ†” {trans_id}\nğŸ‘¤ {user['name']} ({user['customer_id']})\nğŸ¢ {company_name}\nğŸ’³ {wallet_number}\nğŸ’° {amount} Ø±ÙŠØ§Ù„\n\nØ§Ø³ØªØ®Ø¯Ù…: Ù…ÙˆØ§ÙÙ‚Ø© {trans_id} Ø£Ùˆ Ø±ÙØ¶ {trans_id} Ø³Ø¨Ø¨\"\"\"\n            \n            self.notify_admins(admin_msg)\n            del self.user_states[user_id]\n    \n    def process_withdrawal_flow(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¯ÙÙ‚ Ø§Ù„Ø³Ø­Ø¨\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id, '')\n        text = message['text']\n        \n        if state == 'selecting_withdraw_company':\n            # Ø­ÙØ¸ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n            companies = self.get_companies('withdraw')\n            selected_company = None\n            for company in companies:\n                if company['name'] == text:\n                    selected_company = company\n                    break\n            \n            if not selected_company:\n                self.send_message(message['chat']['id'], \"Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:\")\n                return\n            \n            self.user_states[user_id] = f'withdraw_wallet_{selected_company[\"name\"]}'\n            self.send_message(message['chat']['id'], f\"Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø­ÙØ¸ØªÙƒ/Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ {selected_company['name']}:\")\n            \n        elif state.startswith('withdraw_wallet_'):\n            company_name = state.replace('withdraw_wallet_', '')\n            wallet_number = text.strip()\n            \n            if len(wallet_number) < 5:\n                self.send_message(message['chat']['id'], \"Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ù‚ØµÙŠØ±. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            self.user_states[user_id] = f'withdraw_amount_{company_name}_{wallet_number}'\n            self.send_message(message['chat']['id'], \"Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø­Ø¨Ù‡:\")\n            \n        elif state.startswith('withdraw_amount_'):\n            parts = state.split('_', 2)\n            company_name = parts[2].split('_')[0]\n            wallet_number = '_'.join(parts[2].split('_')[1:])\n            \n            try:\n                amount = float(text.strip())\n                if amount < 100:\n                    self.send_message(message['chat']['id'], \"Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ù„Ù„Ø³Ø­Ø¨ 100 Ø±ÙŠØ§Ù„:\")\n                    return\n            except:\n                self.send_message(message['chat']['id'], \"Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…:\")\n                return\n            \n            # Ø¹Ø±Ø¶ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ±Ø§ÙØ©\n            exchange_address = self.get_exchange_address()\n            self.user_states[user_id] = f'withdraw_confirm_{company_name}_{wallet_number}_{amount}'\n            \n            confirm_msg = f\"\"\"ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ù…ÙƒØªØ¨ Ø§Ù„ØµØ±Ø§ÙØ©:\n{exchange_address}\n\nØªØ£ÙƒÙŠØ¯ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨:\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\nğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {exchange_address}\n\nØ£Ø±Ø³Ù„ \"ØªØ£ÙƒÙŠØ¯\" Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ \"Ø¥Ù„ØºØ§Ø¡\" Ù„Ù„Ø¹ÙˆØ¯Ø©\"\"\"\n            \n            self.send_message(message['chat']['id'], confirm_msg)\n            \n        elif state.startswith('withdraw_confirm_'):\n            if text.lower() == 'ØªØ£ÙƒÙŠØ¯':\n                parts = state.split('_', 2)\n                company_name = parts[2].split('_')[0]\n                wallet_number = parts[2].split('_')[1]\n                amount = parts[2].split('_')[2]\n                \n                # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n                user = self.find_user(user_id)\n                trans_id = f\"WTH{datetime.now().strftime('%Y%m%d%H%M%S')}\"\n                exchange_address = self.get_exchange_address()\n                \n                with open('transactions.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                    writer = csv.writer(f)\n                    writer.writerow([trans_id, user['customer_id'], user['name'], 'withdraw', \n                                   company_name, wallet_number, amount, exchange_address, 'pending', \n                                   datetime.now().strftime('%Y-%m-%d %H:%M'), ''])\n                \n                # Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„\n                confirmation = f\"\"\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {trans_id}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’³ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount} Ø±ÙŠØ§Ù„\nğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {exchange_address}\n\nØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ ÙˆØ¥Ø´Ø¹Ø§Ø±Ùƒ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø©.\"\"\"\n                \n                self.send_message(message['chat']['id'], confirmation, self.main_keyboard())\n                \n                # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\n                admin_msg = f\"\"\"ğŸ”” Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯\n\nğŸ†” {trans_id}\nğŸ‘¤ {user['name']} ({user['customer_id']})\nğŸ¢ {company_name}\nğŸ’³ {wallet_number}\nğŸ’° {amount} Ø±ÙŠØ§Ù„\nğŸ“ {exchange_address}\n\nØ§Ø³ØªØ®Ø¯Ù…: Ù…ÙˆØ§ÙÙ‚Ø© {trans_id} Ø£Ùˆ Ø±ÙØ¶ {trans_id} Ø³Ø¨Ø¨\"\"\"\n                \n                self.notify_admins(admin_msg)\n                del self.user_states[user_id]\n            else:\n                self.send_message(message['chat']['id'], \"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©\", self.main_keyboard())\n                del self.user_states[user_id]\n    \n    def show_user_requests(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        user = self.find_user(message['from']['id'])\n        if not user:\n            return\n        \n        requests_text = \"ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙƒ:\\n\\n\"\n        found_requests = False\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == user['customer_id']:\n                        found_requests = True\n                        status_emoji = \"â³\" if row['status'] == 'pending' else \"âœ…\" if row['status'] == 'approved' else \"âŒ\"\n                        requests_text += f\"{status_emoji} {row['id']}\\n\"\n                        requests_text += f\"ğŸ¢ {row['company']}\\n\"\n                        requests_text += f\"ğŸ’° {row['amount']} Ø±ÙŠØ§Ù„\\n\"\n                        requests_text += f\"ğŸ“… {row['date']}\\n\\n\"\n        except:\n            pass\n        \n        if not found_requests:\n            requests_text += \"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª\"\n        \n        self.send_message(message['chat']['id'], requests_text, self.main_keyboard())\n    \n    def handle_admin_commands(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        text = message['text'].lower()\n        \n        if text == 'Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©':\n            self.show_pending_requests(message)\n        elif text.startswith('Ù…ÙˆØ§ÙÙ‚Ø© '):\n            self.approve_request(message, text.replace('Ù…ÙˆØ§ÙÙ‚Ø© ', ''))\n        elif text.startswith('Ø±ÙØ¶ '):\n            parts = text.replace('Ø±ÙØ¶ ', '').split(' ', 1)\n            trans_id = parts[0]\n            reason = parts[1] if len(parts) > 1 else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'\n            self.reject_request(message, trans_id, reason)\n        elif text == 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†':\n            self.show_all_users(message)\n        elif text == 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª':\n            self.show_companies_admin(message)\n        elif text == 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†':\n            self.show_address_admin(message)\n        elif text == 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª':\n            self.show_statistics(message)\n        elif text.startswith('Ø§Ø¶Ù_Ø´Ø±ÙƒØ© '):\n            self.add_company_simple(message, text)\n        elif text.startswith('Ø­Ø°Ù_Ø´Ø±ÙƒØ© '):\n            self.delete_company_simple(message, text)\n        elif text.startswith('Ø¹Ù†ÙˆØ§Ù†_Ø¬Ø¯ÙŠØ¯ '):\n            self.update_address_simple(message, text)\n    \n    def show_pending_requests(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©\"\"\"\n        pending_text = \"ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:\\n\\n\"\n        found_pending = False\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['status'] == 'pending':\n                        found_pending = True\n                        pending_text += f\"ğŸ†” {row['id']}\\n\"\n                        pending_text += f\"ğŸ‘¤ {row['name']} ({row['customer_id']})\\n\"\n                        pending_text += f\"ğŸ“‹ {row['type']} - {row['company']}\\n\"\n                        pending_text += f\"ğŸ’° {row['amount']} Ø±ÙŠØ§Ù„\\n\"\n                        pending_text += f\"ğŸ’³ {row['wallet_number']}\\n\"\n                        if row['exchange_address']:\n                            pending_text += f\"ğŸ“ {row['exchange_address']}\\n\"\n                        pending_text += f\"ğŸ“… {row['date']}\\n\\n\"\n        except:\n            pass\n        \n        if not found_pending:\n            pending_text += \"Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©\"\n        else:\n            pending_text += \"\\nØ§Ø³ØªØ®Ø¯Ù…: Ù…ÙˆØ§ÙÙ‚Ø© Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø£Ùˆ Ø±ÙØ¶ Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø³Ø¨Ø¨\"\n        \n        self.send_message(message['chat']['id'], pending_text, self.admin_keyboard())\n    \n    def approve_request(self, message, trans_id):\n        \"\"\"Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨\"\"\"\n        success = self.update_transaction_status(trans_id, 'approved')\n        \n        if success:\n            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„\n            transaction = self.get_transaction(trans_id)\n            if transaction:\n                customer = self.get_customer_by_id(transaction['customer_id'])\n                if customer:\n                    customer_msg = f\"\"\"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ\n\nğŸ†” {trans_id}\nğŸ’° {transaction['amount']} Ø±ÙŠØ§Ù„\nğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}\"\"\"\n                    \n                    self.send_message(customer['telegram_id'], customer_msg, self.main_keyboard())\n            \n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ {trans_id}\", self.admin_keyboard())\n        else:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ {trans_id}\", self.admin_keyboard())\n    \n    def reject_request(self, message, trans_id, reason):\n        \"\"\"Ø±ÙØ¶ Ø·Ù„Ø¨\"\"\"\n        success = self.update_transaction_status(trans_id, 'rejected', reason)\n        \n        if success:\n            # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„\n            transaction = self.get_transaction(trans_id)\n            if transaction:\n                customer = self.get_customer_by_id(transaction['customer_id'])\n                if customer:\n                    customer_msg = f\"\"\"âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ\n\nğŸ†” {trans_id}\nğŸ’° {transaction['amount']} Ø±ÙŠØ§Ù„\nğŸ“ Ø§Ù„Ø³Ø¨Ø¨: {reason}\nğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}\"\"\"\n                    \n                    self.send_message(customer['telegram_id'], customer_msg, self.main_keyboard())\n            \n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø±ÙØ¶ {trans_id}\", self.admin_keyboard())\n        else:\n            self.send_message(message['chat']['id'], f\"âŒ ÙØ´Ù„ ÙÙŠ Ø±ÙØ¶ {trans_id}\", self.admin_keyboard())\n    \n    def update_transaction_status(self, trans_id, new_status, note=''):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        transactions = []\n        success = False\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == trans_id:\n                        row['status'] = new_status\n                        if note:\n                            row['admin_note'] = note\n                        success = True\n                    transactions.append(row)\n            \n            if success:\n                with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'customer_id', 'name', 'type', 'company', 'wallet_number', 'amount', 'exchange_address', 'status', 'date', 'admin_note']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(transactions)\n        except:\n            pass\n        \n        return success\n    \n    def get_transaction(self, trans_id):\n        \"\"\"Ø¬Ù„Ø¨ Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == trans_id:\n                        return row\n        except:\n            pass\n        return None\n    \n    def get_customer_by_id(self, customer_id):\n        \"\"\"Ø¬Ù„Ø¨ Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø±Ù‚Ù…\"\"\"\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['customer_id'] == customer_id:\n                        return row\n        except:\n            pass\n        return None\n    \n    def show_all_users(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\"\"\"\n        users_text = \"ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:\\n\\n\"\n        count = 0\n        \n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    count += 1\n                    status = \"ğŸš«\" if row.get('is_banned') == 'yes' else \"âœ…\"\n                    users_text += f\"{status} {row['name']} ({row['customer_id']})\\n\"\n                    users_text += f\"ğŸ“± {row['phone']}\\n\\n\"\n        except:\n            pass\n        \n        users_text += f\"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {count}\"\n        self.send_message(message['chat']['id'], users_text, self.admin_keyboard())\n    \n    def show_companies_admin(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª\"\"\"\n        companies_text = \"ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª:\\n\\n\"\n        \n        try:\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    companies_text += f\"ğŸ†” {row['id']} - {row['name']}\\n\"\n                    companies_text += f\"âš¡ {row['type']} - {row['details']}\\n\\n\"\n        except:\n            pass\n        \n        companies_text += \"\\nğŸ“ Ø§Ù„Ø£ÙˆØ§Ù…Ø±:\\n\"\n        companies_text += \"Ø§Ø¶Ù_Ø´Ø±ÙƒØ© Ø§Ø³Ù… Ù†ÙˆØ¹ ØªÙØ§ØµÙŠÙ„\\n\"\n        companies_text += \"Ø­Ø°Ù_Ø´Ø±ÙƒØ© Ø±Ù‚Ù…\\n\\n\"\n        companies_text += \"Ù…Ø«Ø§Ù„: Ø§Ø¶Ù_Ø´Ø±ÙƒØ© Ù…Ø¯Ù‰ both Ù…Ø­ÙØ¸Ø©\"\n        \n        self.send_message(message['chat']['id'], companies_text, self.admin_keyboard())\n    \n    def show_address_admin(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù†\"\"\"\n        current_address = self.get_exchange_address()\n        \n        address_text = f\"ğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ:\\n{current_address}\\n\\n\"\n        address_text += \"Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ø³ØªØ®Ø¯Ù…:\\n\"\n        address_text += \"Ø¹Ù†ÙˆØ§Ù†_Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ_Ø§Ù„Ø¬Ø¯ÙŠØ¯\\n\\n\"\n        address_text += \"Ù…Ø«Ø§Ù„: Ø¹Ù†ÙˆØ§Ù†_Ø¬Ø¯ÙŠØ¯ Ø´Ø§Ø±Ø¹ Ø§Ù„ØªØ­Ù„ÙŠØ©ØŒ Ø¬Ø¯Ø©\"\n        \n        self.send_message(message['chat']['id'], address_text, self.admin_keyboard())\n    \n    def show_statistics(self, message):\n        \"\"\"Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª\"\"\"\n        stats_text = \"ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…:\\n\\n\"\n        \n        # Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†\n        user_count = 0\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                user_count = sum(1 for row in reader)\n        except:\n            pass\n        \n        # Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª\n        total_transactions = 0\n        pending_count = 0\n        approved_count = 0\n        rejected_count = 0\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    total_transactions += 1\n                    if row['status'] == 'pending':\n                        pending_count += 1\n                    elif row['status'] == 'approved':\n                        approved_count += 1\n                    elif row['status'] == 'rejected':\n                        rejected_count += 1\n        except:\n            pass\n        \n        stats_text += f\"ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {user_count}\\n\"\n        stats_text += f\"ğŸ“‹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: {total_transactions}\\n\"\n        stats_text += f\"â³ Ù…Ø¹Ù„Ù‚Ø©: {pending_count}\\n\"\n        stats_text += f\"âœ… Ù…ÙÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§: {approved_count}\\n\"\n        stats_text += f\"âŒ Ù…Ø±ÙÙˆØ¶Ø©: {rejected_count}\\n\"\n        \n        self.send_message(message['chat']['id'], stats_text, self.admin_keyboard())\n    \n    def add_company_simple(self, message, text):\n        \"\"\"Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø©\"\"\"\n        parts = text.replace('Ø§Ø¶Ù_Ø´Ø±ÙƒØ© ', '').split(' ')\n        if len(parts) < 3:\n            self.send_message(message['chat']['id'], \"âŒ Ø§Ø³ØªØ®Ø¯Ù…: Ø§Ø¶Ù_Ø´Ø±ÙƒØ© Ø§Ø³Ù… Ù†ÙˆØ¹ ØªÙØ§ØµÙŠÙ„\")\n            return\n        \n        name = parts[0]\n        company_type = parts[1]\n        details = ' '.join(parts[2:])\n        \n        if company_type not in ['deposit', 'withdraw', 'both']:\n            self.send_message(message['chat']['id'], \"âŒ Ø§Ù„Ù†ÙˆØ¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†: deposit Ø£Ùˆ withdraw Ø£Ùˆ both\")\n            return\n        \n        company_id = str(int(datetime.now().timestamp()))\n        \n        try:\n            with open('companies.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([company_id, name, company_type, details])\n            \n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©: {name}\")\n        except:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©\")\n    \n    def delete_company_simple(self, message, text):\n        \"\"\"Ø­Ø°Ù Ø´Ø±ÙƒØ© Ø¨Ø³ÙŠØ·Ø©\"\"\"\n        company_id = text.replace('Ø­Ø°Ù_Ø´Ø±ÙƒØ© ', '').strip()\n        \n        companies = []\n        deleted = False\n        \n        try:\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] != company_id:\n                        companies.append(row)\n                    else:\n                        deleted = True\n            \n            if deleted:\n                with open('companies.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'name', 'type', 'details']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(companies)\n                \n                self.send_message(message['chat']['id'], f\"âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ© Ø±Ù‚Ù… {company_id}\")\n            else:\n                self.send_message(message['chat']['id'], f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø´Ø±ÙƒØ© Ø±Ù‚Ù… {company_id}\")\n        except:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©\")\n    \n    def update_address_simple(self, message, text):\n        \"\"\"ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø³ÙŠØ·\"\"\"\n        new_address = text.replace('Ø¹Ù†ÙˆØ§Ù†_Ø¬Ø¯ÙŠØ¯ ', '')\n        \n        try:\n            with open('exchange_addresses.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow(['id', 'address', 'is_active'])\n                writer.writerow(['1', new_address, 'yes'])\n            \n            self.send_message(message['chat']['id'], f\"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¥Ù„Ù‰:\\n{new_address}\")\n        except:\n            self.send_message(message['chat']['id'], \"âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†\")\n    \n    def process_message(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ\"\"\"\n        if 'text' not in message:\n            return\n        \n        text = message['text']\n        chat_id = message['chat']['id']\n        user_id = message['from']['id']\n        \n        # Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\n        if text == '/start':\n            self.handle_start(message)\n            return\n        \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„\n        if user_id in self.user_states and self.user_states[user_id].startswith('registering'):\n            self.handle_registration(message)\n            return\n        \n        # ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„\n        user = self.find_user(user_id)\n        if not user:\n            self.handle_start(message)\n            return\n        \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\n        if self.is_admin(user_id):\n            if text == '/admin':\n                self.send_message(chat_id, \"ğŸ”§ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†\", self.admin_keyboard())\n                return\n            \n            self.handle_admin_commands(message)\n            return\n        \n        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n        if user_id in self.user_states:\n            state = self.user_states[user_id]\n            if 'deposit' in state:\n                self.process_deposit_flow(message)\n                return\n            elif 'withdraw' in state:\n                self.process_withdrawal_flow(message)\n                return\n        \n        # Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\n        if text == 'Ø¥ÙŠØ¯Ø§Ø¹':\n            self.start_deposit(message)\n        elif text == 'Ø³Ø­Ø¨':\n            self.start_withdrawal(message)\n        elif text == 'Ø·Ù„Ø¨Ø§ØªÙŠ':\n            self.show_user_requests(message)\n        elif text == 'Ø¯Ø¹Ù…':\n            support_msg = \"ğŸ“ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ:\\n\\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø£Ùˆ Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©\"\n            self.send_message(chat_id, support_msg, self.main_keyboard())\n        elif text == 'Ø±Ø¬ÙˆØ¹':\n            self.send_message(chat_id, \"ØªÙ… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\", self.main_keyboard())\n            if user_id in self.user_states:\n                del self.user_states[user_id]\n        else:\n            self.send_message(chat_id, \"Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:\", self.main_keyboard())\n    \n    def run(self):\n        \"\"\"ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª\"\"\"\n        logger.info(f\"âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¨Ø³Ø· ÙŠØ¹Ù…Ù„\")\n        \n        while True:\n            try:\n                updates = self.get_updates()\n                if updates and updates.get('ok'):\n                    for update in updates['result']:\n                        self.offset = update['update_id']\n                        \n                        if 'message' in update:\n                            self.process_message(update['message'])\n                        elif 'callback_query' in update:\n                            pass  # ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹\n                            \n            except KeyboardInterrupt:\n                logger.info(\"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª\")\n                break\n            except Exception as e:\n                logger.error(f\"Ø®Ø·Ø£: {e}\")\n\nif __name__ == \"__main__\":\n    # Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†\n    bot_token = os.getenv('BOT_TOKEN')\n    if not bot_token:\n        logger.error(\"BOT_TOKEN ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©\")\n        exit(1)\n    \n    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª\n    bot = SimpleLangSenseBot(bot_token)\n    bot.run()","size_bytes":37528},"simple_payment_bot.py":{"content":"#!/usr/bin/env python3\n# -*- coding: utf-8 -*-\n\"\"\"\nØ¨ÙˆØª LangSense Ø§Ù„Ù…Ø¨Ø³Ø· Ù…Ø¹ Ù†Ø¸Ø§Ù… ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\nØ¥ØµØ¯Ø§Ø± Ù…Ø¨Ø³Ø· ÙŠØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\n\"\"\"\n\nimport csv\nimport os\nimport time\nimport logging\nimport urllib.request\nimport urllib.parse\nimport json\nfrom datetime import datetime\n\n# Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø¬Ù„Ø§Øª\nlogging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')\nlogger = logging.getLogger(__name__)\n\nclass SimpleLangSenseBot:\n    def __init__(self, token):\n        self.token = token\n        self.base_url = f\"https://api.telegram.org/bot{token}\"\n        self.user_states = {}\n        self.init_files()\n        logger.info(\"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ø¨Ø³Ø· Ø¨Ù†Ø¬Ø§Ø­\")\n    \n    def init_files(self):\n        \"\"\"Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©\"\"\"\n        files_to_create = [\n            ('users.csv', ['user_id', 'name', 'phone', 'customer_id', 'language', 'registration_date', 'is_banned', 'ban_reason']),\n            ('transactions.csv', ['id', 'user_id', 'customer_id', 'type', 'company_name', 'payment_method', 'wallet_number', 'amount', 'status', 'date', 'withdrawal_address', 'confirmation_code']),\n            ('companies.csv', ['id', 'name', 'type', 'details', 'is_active']),\n            ('payment_methods.csv', ['id', 'company_id', 'method_name', 'method_type', 'account_data', 'additional_info', 'status', 'created_date'])\n        ]\n        \n        for filename, headers in files_to_create:\n            if not os.path.exists(filename):\n                with open(filename, 'w', newline='', encoding='utf-8-sig') as f:\n                    writer = csv.writer(f)\n                    writer.writerow(headers)\n                logger.info(f\"ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù: {filename}\")\n    \n    def send_message(self, chat_id, text, keyboard=None):\n        \"\"\"Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©\"\"\"\n        try:\n            data = {\n                'chat_id': chat_id,\n                'text': text,\n                'parse_mode': 'Markdown'\n            }\n            \n            if keyboard:\n                data['reply_markup'] = json.dumps(keyboard)\n            \n            encoded_data = urllib.parse.urlencode(data).encode('utf-8')\n            request = urllib.request.Request(f\"{self.base_url}/sendMessage\", data=encoded_data)\n            response = urllib.request.urlopen(request)\n            return json.loads(response.read().decode('utf-8'))\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {e}\")\n            return None\n    \n    def is_admin(self, user_id):\n        \"\"\"ÙØ­Øµ Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        admin_ids = os.getenv('ADMIN_USER_IDS', '').split(',')\n        return str(user_id) in admin_ids\n    \n    def main_keyboard(self, language='ar'):\n        \"\"\"Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ\"\"\"\n        return {\n            'keyboard': [\n                [{'text': 'ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹'}, {'text': 'ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨'}],\n                [{'text': 'ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ'}, {'text': 'ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ'}],\n                [{'text': 'ğŸ“¨ Ø´ÙƒÙˆÙ‰'}, {'text': 'ğŸ†˜ Ø¯Ø¹Ù…'}]\n            ],\n            'resize_keyboard': True\n        }\n    \n    def admin_keyboard(self):\n        \"\"\"ÙƒÙŠØ¨ÙˆØ±Ø¯ Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        return {\n            'keyboard': [\n                [{'text': 'ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©'}, {'text': 'âœ… Ø·Ù„Ø¨Ø§Øª Ù…ÙÙˆØ§ÙÙ‚Ø©'}],\n                [{'text': 'ğŸ’³ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹'}, {'text': 'ğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ§Øª'}],\n                [{'text': 'ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†'}, {'text': 'ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª'}],\n                [{'text': 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'}]\n            ],\n            'resize_keyboard': True\n        }\n    \n    def find_user(self, user_id):\n        \"\"\"Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…\"\"\"\n        try:\n            with open('users.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['user_id'] == str(user_id):\n                        return row\n        except:\n            pass\n        return None\n    \n    def get_companies(self):\n        \"\"\"Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ§Øª\"\"\"\n        companies = []\n        try:\n            with open('companies.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row.get('is_active') == 'yes':\n                        companies.append(row)\n        except:\n            pass\n        return companies\n    \n    def get_payment_methods_by_company(self, company_id):\n        \"\"\"Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø´Ø±ÙƒØ©\"\"\"\n        methods = []\n        try:\n            with open('payment_methods.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['company_id'] == str(company_id) and row.get('status') == 'active':\n                        methods.append(row)\n        except:\n            pass\n        return methods\n    \n    def handle_start(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©\"\"\"\n        user_id = message['from']['id']\n        chat_id = message['chat']['id']\n        \n        user = self.find_user(user_id)\n        \n        if user:\n            if user.get('is_banned') == 'yes':\n                ban_reason = user.get('ban_reason', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')\n                self.send_message(chat_id, f\"âŒ ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ\\nØ§Ù„Ø³Ø¨Ø¨: {ban_reason}\")\n                return\n            \n            welcome_text = f\"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ {user['name']}! ğŸ‘‹\\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {user['customer_id']}\"\n            self.send_message(chat_id, welcome_text, self.main_keyboard())\n        else:\n            welcome_text = \"\"\"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… LangSense Ø§Ù„Ù…Ø§Ù„ÙŠ! ğŸ‘‹\n\nğŸ”¹ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø­Ø¨\nğŸ”¹ Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…ØªØ®ØµØµ\nğŸ”¹ Ø£Ù…Ø§Ù† ÙˆÙ…ÙˆØ«ÙˆÙ‚ÙŠØ© Ø¹Ø§Ù„ÙŠØ©\n\nÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„ØªØ³Ø¬ÙŠÙ„:\"\"\"\n            self.send_message(chat_id, welcome_text)\n            self.user_states[user_id] = 'registering_name'\n    \n    def handle_registration(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states.get(user_id)\n        \n        if state == 'registering_name':\n            name = message['text'].strip()\n            if len(name) < 2:\n                self.send_message(message['chat']['id'], \"âŒ Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ­ÙŠØ­:\")\n                return\n            \n            self.user_states[user_id] = f'registering_phone_{name}'\n            \n            # ÙƒÙŠØ¨ÙˆØ±Ø¯ Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„\n            contact_keyboard = {\n                'keyboard': [\n                    [{'text': 'ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ', 'request_contact': True}],\n                    [{'text': 'âœï¸ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹'}]\n                ],\n                'resize_keyboard': True,\n                'one_time_keyboard': True\n            }\n            \n            phone_text = \"\"\"Ù…Ù…ØªØ§Ø²! Ø§Ù„Ø¢Ù† Ø£Ø±Ø³Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ:\n\nğŸ“± ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù…Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ \"ğŸ“± Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\"\nâœï¸ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¨Ù„Ø¯ (Ù…Ø«Ø§Ù„: +966501234567)\"\"\"\n            \n            self.send_message(message['chat']['id'], phone_text, contact_keyboard)\n            \n        elif state.startswith('registering_phone_'):\n            name = state.replace('registering_phone_', '')\n            \n            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©\n            if 'contact' in message:\n                # Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„\n                phone = message['contact']['phone_number']\n                if not phone.startswith('+'):\n                    phone = '+' + phone\n            elif 'text' in message:\n                text = message['text'].strip()\n                \n                if text == 'âœï¸ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹':\n                    manual_text = \"\"\"âœï¸ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¨Ù„Ø¯:\n\nÙ…Ø«Ø§Ù„: +966501234567\nÙ…Ø«Ø§Ù„: +201234567890\"\"\"\n                    self.send_message(message['chat']['id'], manual_text)\n                    return\n                \n                phone = text\n                if len(phone) < 10:\n                    self.send_message(message['chat']['id'], \"âŒ Ø±Ù‚Ù… Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¨Ù„Ø¯:\")\n                    return\n            else:\n                self.send_message(message['chat']['id'], \"âŒ ÙŠØ±Ø¬Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù…:\")\n                return\n            \n            # Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… Ø¹Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ\n            customer_id = f\"C{str(int(datetime.now().timestamp()))[-6:]}\"\n            \n            # Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…\n            with open('users.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                writer = csv.writer(f)\n                writer.writerow([user_id, name, phone, customer_id, 'ar', \n                               datetime.now().strftime('%Y-%m-%d'), 'no', ''])\n            \n            welcome_text = f\"\"\"âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: {name}\nğŸ“± Ø§Ù„Ù‡Ø§ØªÙ: {phone}\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: {customer_id}\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„: {datetime.now().strftime('%Y-%m-%d')}\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©:\"\"\"\n            \n            self.send_message(message['chat']['id'], welcome_text, self.main_keyboard())\n            del self.user_states[user_id]\n    \n    def handle_deposit(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹\"\"\"\n        user_id = message['from']['id']\n        companies = self.get_companies()\n        \n        if not companies:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹\")\n            return\n        \n        companies_text = \"ğŸ’° Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø¥ÙŠØ¯Ø§Ø¹:\\n\\n\"\n        keyboard_buttons = []\n        \n        for company in companies:\n            companies_text += f\"ğŸ¢ {company['name']} - {company['type']}\\n\"\n            keyboard_buttons.append([{'text': company['name']}])\n        \n        keyboard_buttons.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        keyboard = {\n            'keyboard': keyboard_buttons,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], companies_text, keyboard)\n        self.user_states[user_id] = 'deposit_company_selection'\n    \n    def handle_withdrawal(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨\"\"\"\n        user_id = message['from']['id']\n        companies = self.get_companies()\n        \n        if not companies:\n            self.send_message(message['chat']['id'], \"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹\")\n            return\n        \n        companies_text = \"ğŸ’¸ Ø§Ø®ØªØ± Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø³Ø­Ø¨:\\n\\n\"\n        keyboard_buttons = []\n        \n        for company in companies:\n            companies_text += f\"ğŸ¢ {company['name']} - {company['type']}\\n\"\n            keyboard_buttons.append([{'text': company['name']}])\n        \n        keyboard_buttons.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©'}])\n        \n        keyboard = {\n            'keyboard': keyboard_buttons,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], companies_text, keyboard)\n        self.user_states[user_id] = 'withdraw_company_selection'\n    \n    def handle_company_selection(self, message, transaction_type):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©\"\"\"\n        user_id = message['from']['id']\n        company_name = message['text'].strip()\n        \n        if company_name == 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø©':\n            del self.user_states[user_id]\n            self.send_message(message['chat']['id'], \"ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡\", self.main_keyboard())\n            return\n        \n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´Ø±ÙƒØ©\n        companies = self.get_companies()\n        selected_company = None\n        \n        for company in companies:\n            if company['name'] == company_name:\n                selected_company = company\n                break\n        \n        if not selected_company:\n            self.send_message(message['chat']['id'], \"âŒ Ø´Ø±ÙƒØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©\")\n            return\n        \n        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø´Ø±ÙƒØ©\n        payment_methods = self.get_payment_methods_by_company(selected_company['id'])\n        \n        if not payment_methods:\n            self.send_message(message['chat']['id'], \n                            f\"âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ³Ø§Ø¦Ù„ Ø¯ÙØ¹ Ù…ØªØ§Ø­Ø© Ù„Ø´Ø±ÙƒØ© {company_name} Ø­Ø§Ù„ÙŠØ§Ù‹\")\n            return\n        \n        # Ø¹Ø±Ø¶ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹\n        methods_text = f\"ğŸ’³ ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø´Ø±ÙƒØ© {company_name}:\\n\\n\"\n        keyboard_buttons = []\n        \n        for method in payment_methods:\n            method_info = f\"ğŸ“‹ {method['method_name']} ({method['method_type']})\\n\"\n            method_info += f\"ğŸ’° Ø§Ù„Ø­Ø³Ø§Ø¨: `{method['account_data']}`\\n\"\n            if method.get('additional_info'):\n                method_info += f\"ğŸ’¡ {method['additional_info']}\\n\"\n            method_info += \"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\"\n            \n            methods_text += method_info\n            keyboard_buttons.append([{'text': method['method_name']}])\n        \n        methods_text += \"\\nğŸ“‹ Ø§Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø«Ù… Ø§Ø®ØªØ± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹:\"\n        \n        keyboard_buttons.append([{'text': 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©'}])\n        \n        keyboard = {\n            'keyboard': keyboard_buttons,\n            'resize_keyboard': True,\n            'one_time_keyboard': True\n        }\n        \n        self.send_message(message['chat']['id'], methods_text, keyboard)\n        self.user_states[user_id] = {\n            'step': 'method_selection',\n            'transaction_type': transaction_type,\n            'company': selected_company,\n            'methods': payment_methods\n        }\n    \n    def handle_method_selection(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹\"\"\"\n        user_id = message['from']['id']\n        method_name = message['text'].strip()\n        state = self.user_states[user_id]\n        \n        if method_name == 'ğŸ”™ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø±ÙƒØ©':\n            transaction_type = state['transaction_type']\n            if transaction_type == 'deposit':\n                self.handle_deposit(message)\n            else:\n                self.handle_withdrawal(message)\n            return\n        \n        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©\n        selected_method = None\n        for method in state['methods']:\n            if method['method_name'] == method_name:\n                selected_method = method\n                break\n        \n        if not selected_method:\n            self.send_message(message['chat']['id'], \"âŒ Ø§Ø®ØªÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©\")\n            return\n        \n        # Ø·Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©\n        wallet_text = f\"\"\"âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø±: {selected_method['method_name']}\n\nğŸ“ Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø­ÙØ¸ØªÙƒ/Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ:\"\"\"\n        \n        self.send_message(message['chat']['id'], wallet_text)\n        \n        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©\n        company = state['company']\n        transaction_type = state['transaction_type']\n        self.user_states[user_id] = f'{transaction_type}_wallet_{company[\"id\"]}_{company[\"name\"]}_{selected_method[\"id\"]}'\n    \n    def process_transaction_flow(self, message, transaction_type):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        user_id = message['from']['id']\n        state = self.user_states[user_id]\n        text = message['text'].strip()\n        \n        if text == '/cancel':\n            del self.user_states[user_id]\n            self.send_message(message['chat']['id'], \"ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©\", self.main_keyboard())\n            return\n        \n        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø©\n        parts = state.split('_')\n        if len(parts) >= 4:\n            company_id = parts[2]\n            company_name = parts[3]\n            method_id = parts[4] if len(parts) > 4 else ''\n            \n            if f'{transaction_type}_wallet_' in state:\n                # Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© ÙˆØ·Ù„Ø¨ Ø§Ù„Ù…Ø¨Ù„Øº\n                wallet_number = text\n                amount_text = f\"\"\"ğŸ’° ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\n\nğŸ“ Ø§Ù„Ø¢Ù† Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº:\n\nâ¬…ï¸ /cancel Ù„Ù„Ø¥Ù„ØºØ§Ø¡\"\"\"\n                \n                self.send_message(message['chat']['id'], amount_text)\n                self.user_states[user_id] = f'{transaction_type}_amount_{company_id}_{company_name}_{method_id}_{wallet_number}'\n                \n            elif f'{transaction_type}_amount_' in state:\n                # Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n                try:\n                    amount = float(text)\n                    if amount <= 0:\n                        raise ValueError()\n                except:\n                    self.send_message(message['chat']['id'], \"âŒ Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­:\")\n                    return\n                \n                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©\n                wallet_number = parts[5] if len(parts) > 5 else ''\n                \n                # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§Ù…Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©\n                transaction_id = f\"{transaction_type.upper()}{str(int(datetime.now().timestamp()))[-6:]}\"\n                user = self.find_user(user_id)\n                \n                with open('transactions.csv', 'a', newline='', encoding='utf-8-sig') as f:\n                    writer = csv.writer(f)\n                    writer.writerow([\n                        transaction_id, user_id, user.get('customer_id', ''), \n                        transaction_type, company_name, method_id,\n                        wallet_number, amount, 'pending', \n                        datetime.now().strftime('%Y-%m-%d %H:%M'), '', ''\n                    ])\n                \n                # Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù„Ù„Ø¹Ù…ÙŠÙ„\n                confirmation_text = f\"\"\"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ {'Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹' if transaction_type == 'deposit' else 'Ø§Ù„Ø³Ø­Ø¨'} Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {transaction_id}\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount}\nğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\nğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nâ³ Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©\nØ³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø£Ùˆ Ø§Ù„Ø±ÙØ¶\"\"\"\n                \n                self.send_message(message['chat']['id'], confirmation_text, self.main_keyboard())\n                \n                # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\n                admin_ids = os.getenv('ADMIN_USER_IDS', '').split(',')\n                admin_msg = f\"\"\"ğŸ†• Ø·Ù„Ø¨ {'Ø¥ÙŠØ¯Ø§Ø¹' if transaction_type == 'deposit' else 'Ø³Ø­Ø¨'} Ø¬Ø¯ÙŠØ¯\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {transaction_id}\nğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„: {user.get('name', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')} ({user.get('customer_id', '')})\nğŸ¢ Ø§Ù„Ø´Ø±ÙƒØ©: {company_name}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {amount}\nğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©: {wallet_number}\n\nÙ„Ù„Ù…ÙˆØ§ÙÙ‚Ø©: Ù…ÙˆØ§ÙÙ‚Ø© {transaction_id}\nÙ„Ù„Ø±ÙØ¶: Ø±ÙØ¶ {transaction_id} Ø§Ù„Ø³Ø¨Ø¨\"\"\"\n                \n                for admin_id in admin_ids:\n                    if admin_id.strip():\n                        self.send_message(int(admin_id), admin_msg)\n                \n                del self.user_states[user_id]\n    \n    def handle_admin_commands(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\"\"\"\n        text = message['text'].strip()\n        chat_id = message['chat']['id']\n        \n        if text.startswith('Ù…ÙˆØ§ÙÙ‚Ø© '):\n            transaction_id = text.replace('Ù…ÙˆØ§ÙÙ‚Ø© ', '').strip()\n            self.approve_transaction(chat_id, transaction_id)\n            \n        elif text.startswith('Ø±ÙØ¶ '):\n            parts = text.split(' ', 2)\n            if len(parts) >= 3:\n                transaction_id = parts[1]\n                reason = parts[2]\n                self.reject_transaction(chat_id, transaction_id, reason)\n            else:\n                self.send_message(chat_id, \"Ø§Ù„ØµÙŠØºØ©: Ø±ÙØ¶ Ø±Ù‚Ù…_Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ø³Ø¨Ø¨\")\n    \n    def approve_transaction(self, chat_id, transaction_id):\n        \"\"\"Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n        transactions = []\n        updated = False\n        approved_transaction = None\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == transaction_id and row['status'] == 'pending':\n                        row['status'] = 'approved'\n                        updated = True\n                        approved_transaction = row\n                    transactions.append(row)\n            \n            if updated:\n                with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'user_id', 'customer_id', 'type', 'company_name', 'payment_method', 'wallet_number', 'amount', 'status', 'date', 'withdrawal_address', 'confirmation_code']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(transactions)\n                \n                # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\n                self.send_message(chat_id, f\"âœ… ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© {transaction_id}\")\n                \n                # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„\n                customer_msg = f\"\"\"âœ… ØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ!\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {transaction_id}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {approved_transaction['amount']}\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nØ´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ø®Ø¯Ù…Ø§ØªÙ†Ø§\"\"\"\n                \n                self.send_message(int(approved_transaction['user_id']), customer_msg)\n            else:\n                self.send_message(chat_id, f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø¹Ù„Ù‚Ø© Ø¨Ø±Ù‚Ù… {transaction_id}\")\n        except Exception as e:\n            self.send_message(chat_id, f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©: {e}\")\n    \n    def reject_transaction(self, chat_id, transaction_id, reason):\n        \"\"\"Ø±ÙØ¶ Ù…Ø¹Ø§Ù…Ù„Ø©\"\"\"\n        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©\n        transactions = []\n        updated = False\n        rejected_transaction = None\n        \n        try:\n            with open('transactions.csv', 'r', encoding='utf-8-sig') as f:\n                reader = csv.DictReader(f)\n                for row in reader:\n                    if row['id'] == transaction_id and row['status'] == 'pending':\n                        row['status'] = 'rejected'\n                        updated = True\n                        rejected_transaction = row\n                    transactions.append(row)\n            \n            if updated:\n                with open('transactions.csv', 'w', newline='', encoding='utf-8-sig') as f:\n                    fieldnames = ['id', 'user_id', 'customer_id', 'type', 'company_name', 'payment_method', 'wallet_number', 'amount', 'status', 'date', 'withdrawal_address', 'confirmation_code']\n                    writer = csv.DictWriter(f, fieldnames=fieldnames)\n                    writer.writeheader()\n                    writer.writerows(transactions)\n                \n                # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\n                self.send_message(chat_id, f\"âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© {transaction_id}\")\n                \n                # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„\n                customer_msg = f\"\"\"âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©: {transaction_id}\nğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: {rejected_transaction['amount']}\nğŸ” Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶: {reason}\nğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙØ¶: {datetime.now().strftime('%Y-%m-%d %H:%M')}\n\nÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©\"\"\"\n                \n                self.send_message(int(rejected_transaction['user_id']), customer_msg)\n            else:\n                self.send_message(chat_id, f\"âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø§Ù…Ù„Ø© Ù…Ø¹Ù„Ù‚Ø© Ø¨Ø±Ù‚Ù… {transaction_id}\")\n        except Exception as e:\n            self.send_message(chat_id, f\"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¶: {e}\")\n    \n    def handle_message(self, message):\n        \"\"\"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©\"\"\"\n        try:\n            # Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© Ø£Ùˆ Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„\n            if 'text' not in message and 'contact' not in message:\n                return\n            \n            user_id = message['from']['id']\n            chat_id = message['chat']['id']\n            text = message.get('text', '')\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© /start\n            if text == '/start':\n                self.handle_start(message)\n                return\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„\n            if user_id in self.user_states:\n                state = self.user_states[user_id]\n                if isinstance(state, str):\n                    if state.startswith('registering'):\n                        self.handle_registration(message)\n                        return\n                    elif 'deposit' in state:\n                        self.process_transaction_flow(message, 'deposit')\n                        return\n                    elif 'withdraw' in state:\n                        self.process_transaction_flow(message, 'withdrawal')\n                        return\n                    elif state == 'deposit_company_selection':\n                        self.handle_company_selection(message, 'deposit')\n                        return\n                    elif state == 'withdraw_company_selection':\n                        self.handle_company_selection(message, 'withdrawal')\n                        return\n                elif isinstance(state, dict):\n                    if state.get('step') == 'method_selection':\n                        self.handle_method_selection(message)\n                        return\n            \n            # ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³Ø¬Ù„\n            user = self.find_user(user_id)\n            if not user:\n                self.handle_start(message)\n                return\n            \n            # ÙØ­Øµ Ø§Ù„Ø­Ø¸Ø±\n            if user.get('is_banned') == 'yes':\n                ban_reason = user.get('ban_reason', 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')\n                self.send_message(chat_id, f\"âŒ ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ\\nØ§Ù„Ø³Ø¨Ø¨: {ban_reason}\")\n                return\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø¯Ù…Ù†\n            if self.is_admin(user_id):\n                if text == '/admin':\n                    self.send_message(chat_id, \"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©\", self.admin_keyboard())\n                    return\n                \n                # Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„Ø±ÙØ¶\n                if text.startswith(('Ù…ÙˆØ§ÙÙ‚Ø© ', 'Ø±ÙØ¶ ')):\n                    self.handle_admin_commands(message)\n                    return\n            \n            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\n            if text == 'ğŸ’° Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹':\n                self.handle_deposit(message)\n            elif text == 'ğŸ’¸ Ø·Ù„Ø¨ Ø³Ø­Ø¨':\n                self.handle_withdrawal(message)\n            elif text == 'ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©':\n                if user_id in self.user_states:\n                    del self.user_states[user_id]\n                self.send_message(chat_id, \"ØªÙ… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\", self.main_keyboard())\n            else:\n                # Ø±Ø³Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©\n                self.send_message(chat_id, \"Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…\", self.main_keyboard())\n        \n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {e}\")\n    \n    def get_updates(self, offset=None):\n        \"\"\"Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù…\"\"\"\n        try:\n            url = f\"{self.base_url}/getUpdates\"\n            if offset:\n                url += f\"?offset={offset}\"\n            \n            request = urllib.request.Request(url)\n            response = urllib.request.urlopen(request)\n            return json.loads(response.read().decode('utf-8'))\n        except Exception as e:\n            logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª: {e}\")\n            return None\n    \n    def run(self):\n        \"\"\"ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª\"\"\"\n        logger.info(\"âœ… Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ø¨Ø³Ø· ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†\")\n        offset = None\n        \n        while True:\n            try:\n                updates = self.get_updates(offset)\n                if updates and updates.get('ok'):\n                    for update in updates['result']:\n                        if 'message' in update:\n                            self.handle_message(update['message'])\n                        offset = update['update_id'] + 1\n                \n                time.sleep(1)\n            except KeyboardInterrupt:\n                logger.info(\"ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª\")\n                break\n            except Exception as e:\n                logger.error(f\"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„: {e}\")\n                time.sleep(5)\n\nif __name__ == \"__main__\":\n    # Ø¬Ù„Ø¨ Ø§Ù„ØªÙˆÙƒÙ†\n    bot_token = os.getenv('BOT_TOKEN')\n    if not bot_token:\n        logger.error(\"BOT_TOKEN ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©\")\n        exit(1)\n    \n    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª\n    bot = SimpleLangSenseBot(bot_token)\n    bot.run()","size_bytes":30243},"test_bot.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nTest script to verify the bot database and functionality\n\"\"\"\n\nimport sqlite3\nimport json\n\ndef test_database():\n    \"\"\"Test the SQLite database\"\"\"\n    print(\"ğŸ” Testing LangSense Database...\")\n    \n    try:\n        conn = sqlite3.connect('langsense.db')\n        cursor = conn.cursor()\n        \n        # Test tables\n        cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table';\")\n        tables = cursor.fetchall()\n        print(f\"ğŸ“Š Found tables: {[table[0] for table in tables]}\")\n        \n        # Test languages\n        cursor.execute(\"SELECT * FROM languages\")\n        languages = cursor.fetchall()\n        print(f\"ğŸŒ Available languages: {languages}\")\n        \n        # Test users count\n        cursor.execute(\"SELECT COUNT(*) FROM users\")\n        user_count = cursor.fetchone()[0]\n        print(f\"ğŸ‘¥ Total users: {user_count}\")\n        \n        conn.close()\n        print(\"âœ… Database test completed successfully!\")\n        return True\n        \n    except Exception as e:\n        print(f\"âŒ Database test failed: {e}\")\n        return False\n\ndef test_bot_api():\n    \"\"\"Test Telegram API connection\"\"\"\n    import os\n    from urllib.request import urlopen, Request\n    \n    print(\"\\nğŸ¤– Testing Telegram API connection...\")\n    \n    bot_token = os.getenv('BOT_TOKEN')\n    if not bot_token:\n        print(\"âŒ BOT_TOKEN not found in environment\")\n        return False\n        \n    try:\n        url = f\"https://api.telegram.org/bot{bot_token}/getMe\"\n        request = Request(url)\n        \n        with urlopen(request, timeout=10) as response:\n            data = json.loads(response.read().decode('utf-8'))\n            \n        if data.get('ok'):\n            bot_info = data['result']\n            print(f\"âœ… Bot connected successfully!\")\n            print(f\"ğŸ“› Bot name: {bot_info['first_name']}\")\n            print(f\"ğŸ·ï¸ Bot username: @{bot_info['username']}\")\n            print(f\"ğŸ†” Bot ID: {bot_info['id']}\")\n            return True\n        else:\n            print(f\"âŒ API returned error: {data}\")\n            return False\n            \n    except Exception as e:\n        print(f\"âŒ API test failed: {e}\")\n        return False\n\ndef display_bot_info():\n    \"\"\"Display bot setup information\"\"\"\n    print(\"\\n\" + \"=\"*50)\n    print(\"ğŸš€ LangSense Telegram Bot - Setup Complete!\")\n    print(\"=\"*50)\n    print(\"\\nğŸ“‹ Features Available:\")\n    print(\"  âœ… Multi-language support (Arabic RTL + English)\")\n    print(\"  âœ… User registration with phone verification\")\n    print(\"  âœ… Customer ID generation\")\n    print(\"  âœ… Financial services (Deposit/Withdraw)\")\n    print(\"  âœ… Admin panel and broadcasting\")\n    print(\"  âœ… SQLite database with user management\")\n    print(\"  âœ… Simple HTTP-based implementation (no dependency issues)\")\n    \n    print(\"\\nğŸ”§ How to Test:\")\n    print(\"  1. Open Telegram and search for your bot\")\n    print(\"  2. Send /start command to begin\")\n    print(\"  3. Share your phone number when prompted\")\n    print(\"  4. Explore the menu options\")\n    print(\"  5. Try admin commands with /admin (if you're an admin)\")\n    \n    print(\"\\nâš™ï¸ Configuration:\")\n    print(\"  - Bot Token: âœ… Configured\")\n    print(\"  - Admin IDs: âœ… Configured\") \n    print(\"  - Database: âœ… SQLite (langsense.db)\")\n    print(\"  - Languages: Arabic (default), English\")\n    \n    print(\"\\nğŸ“ Next Steps:\")\n    print(\"  - Test the bot in Telegram\")\n    print(\"  - Verify phone number registration\")\n    print(\"  - Check admin functionality\")\n    print(\"  - Review logs for any issues\")\n\ndef main():\n    print(\"LangSense Bot - System Test\")\n    print(\"=\" * 30)\n    \n    # Test database\n    db_ok = test_database()\n    \n    # Test API\n    api_ok = test_bot_api()\n    \n    if db_ok and api_ok:\n        display_bot_info()\n        print(\"\\nğŸ‰ All systems are GO! The bot is ready for use.\")\n    else:\n        print(\"\\nâš ï¸ Some tests failed. Please check the configuration.\")\n\nif __name__ == '__main__':\n    main()","size_bytes":3996},"backup_server_files/bot.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nMain bot module with Aiogram v3 setup\nHandles bot initialization, router registration, and polling\n\"\"\"\n\nimport asyncio\nimport logging\nfrom aiogram import Bot, Dispatcher\nfrom aiogram.client.default import DefaultBotProperties\nfrom aiogram.enums import ParseMode\nfrom aiogram.fsm.storage.memory import MemoryStorage\n\nfrom config import BOT_TOKEN\nfrom handlers import start, admin, broadcast, user_settings, announcements\nfrom services.broadcast_service import BroadcastService\n\nlogger = logging.getLogger(__name__)\n\n# Global variables for dependency injection\nbot_instance = None\nsession_maker = None\nbroadcast_service = None\n\nasync def main(async_session):\n    \"\"\"Main bot function\"\"\"\n    global bot_instance, session_maker, broadcast_service\n    \n    try:\n        # Validate bot token\n        if not BOT_TOKEN:\n            raise ValueError(\"BOT_TOKEN is not set in environment variables\")\n        \n        # Initialize bot and dispatcher\n        bot_instance = Bot(\n            token=BOT_TOKEN,\n            default=DefaultBotProperties(parse_mode=ParseMode.HTML)\n        )\n        \n        # Test bot token\n        bot_info = await bot_instance.get_me()\n        logger.info(f\"Bot initialized: @{bot_info.username} ({bot_info.first_name})\")\n        \n        # Set session maker for handlers\n        session_maker = async_session\n        \n        # Initialize dispatcher with memory storage\n        storage = MemoryStorage()\n        dp = Dispatcher(storage=storage)\n        \n        # Initialize broadcast service\n        broadcast_service = BroadcastService(bot_instance, async_session)\n        \n        # Register routers\n        dp.include_routers(\n            start.router,\n            user_settings.router,\n            admin.router,\n            broadcast.router,\n            announcements.router\n        )\n        \n        # Set session maker and services for handlers\n        for router in [start.router, user_settings.router, admin.router, \n                      broadcast.router, announcements.router]:\n            router.message.middleware.register(SessionMiddleware(async_session))\n            router.callback_query.middleware.register(SessionMiddleware(async_session))\n        \n        # Start broadcast service worker\n        asyncio.create_task(broadcast_service.worker())\n        logger.info(\"Broadcast service worker started\")\n        \n        # Start polling\n        logger.info(\"Starting bot polling...\")\n        await dp.start_polling(bot_instance)\n        \n    except Exception as e:\n        logger.error(f\"Bot startup failed: {e}\")\n        raise\n    finally:\n        if bot_instance:\n            await bot_instance.session.close()\n\nclass SessionMiddleware:\n    \"\"\"Middleware to inject database session into handlers\"\"\"\n    \n    def __init__(self, session_maker):\n        self.session_maker = session_maker\n    \n    async def __call__(self, handler, event, data):\n        data['session_maker'] = self.session_maker\n        data['broadcast_service'] = broadcast_service\n        return await handler(event, data)\n\ndef get_bot():\n    \"\"\"Get bot instance for external use\"\"\"\n    return bot_instance\n\ndef get_session_maker():\n    \"\"\"Get session maker for external use\"\"\"\n    return session_maker\n\ndef get_broadcast_service():\n    \"\"\"Get broadcast service for external use\"\"\"\n    return broadcast_service\n","size_bytes":3344},"backup_server_files/config.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nConfiguration module for the LangSense Bot\nLoads environment variables and provides configuration constants\n\"\"\"\n\nimport os\nfrom dotenv import load_dotenv\n\n# Load environment variables from .env file\nload_dotenv()\n\n# Bot Configuration\nBOT_TOKEN = os.getenv(\"BOT_TOKEN\")\nif not BOT_TOKEN:\n    raise ValueError(\"BOT_TOKEN must be set in environment variables\")\n\n# Admin Configuration\nADMIN_USER_IDS_STR = os.getenv(\"ADMIN_USER_IDS\", \"\")\nADMIN_USER_IDS = [int(uid.strip()) for uid in ADMIN_USER_IDS_STR.split(\",\") if uid.strip().isdigit()]\n\nif not ADMIN_USER_IDS:\n    raise ValueError(\"ADMIN_USER_IDS must be set with at least one valid user ID\")\n\n# Database Configuration\nDATABASE_URL = os.getenv(\"DATABASE_URL\", \"sqlite+aiosqlite:///./langsense.db\")\n\n# Broadcast Configuration\nBROADCAST_RATE_LIMIT = int(os.getenv(\"BROADCAST_RATE_LIMIT\", \"30\"))  # messages per second\nBROADCAST_CHUNK_SIZE = int(os.getenv(\"BROADCAST_CHUNK_SIZE\", \"100\"))  # users per batch\nBROADCAST_RETRY_ATTEMPTS = int(os.getenv(\"BROADCAST_RETRY_ATTEMPTS\", \"3\"))\nBROADCAST_RETRY_DELAY = int(os.getenv(\"BROADCAST_RETRY_DELAY\", \"5\"))  # seconds\n\n# Localization Configuration\nDEFAULT_LANGUAGE = os.getenv(\"DEFAULT_LANGUAGE\", \"ar\")\nDEFAULT_COUNTRY = os.getenv(\"DEFAULT_COUNTRY\", \"SA\")\nSUPPORTED_LANGUAGES = [\"ar\", \"en\"]\n\n# Customer ID Configuration\nCUSTOMER_ID_PREFIX = os.getenv(\"CUSTOMER_ID_PREFIX\", \"C\")\nCUSTOMER_ID_YEAR_FORMAT = os.getenv(\"CUSTOMER_ID_YEAR_FORMAT\", \"2025\")\n\n# File Upload Configuration\nMAX_FILE_SIZE = int(os.getenv(\"MAX_FILE_SIZE\", \"20\")) * 1024 * 1024  # 20MB default\nALLOWED_IMAGE_TYPES = [\"image/jpeg\", \"image/png\", \"image/gif\", \"image/webp\"]\n\n# Pagination Configuration\nUSERS_PER_PAGE = int(os.getenv(\"USERS_PER_PAGE\", \"10\"))\nANNOUNCEMENTS_PER_PAGE = int(os.getenv(\"ANNOUNCEMENTS_PER_PAGE\", \"5\"))\n\n# Logging Configuration\nLOG_LEVEL = os.getenv(\"LOG_LEVEL\", \"INFO\")\nLOG_FILE = os.getenv(\"LOG_FILE\", \"bot.log\")\n\n# Rate Limiting Configuration\nUSER_RATE_LIMIT = int(os.getenv(\"USER_RATE_LIMIT\", \"5\"))  # requests per minute\nADMIN_RATE_LIMIT = int(os.getenv(\"ADMIN_RATE_LIMIT\", \"30\"))  # requests per minute\n\n# Validation\ndef validate_config():\n    \"\"\"Validate configuration settings\"\"\"\n    errors = []\n    \n    if not BOT_TOKEN or len(BOT_TOKEN) < 40:\n        errors.append(\"Invalid BOT_TOKEN format\")\n    \n    if not ADMIN_USER_IDS:\n        errors.append(\"No valid admin user IDs configured\")\n    \n    if BROADCAST_RATE_LIMIT > 30:\n        errors.append(\"BROADCAST_RATE_LIMIT cannot exceed 30 messages/second (Telegram limit)\")\n    \n    if errors:\n        raise ValueError(\"Configuration errors: \" + \"; \".join(errors))\n\n# Validate configuration on import\nvalidate_config()\n","size_bytes":2685},"backup_server_files/main.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nMain entry point for the LangSense Telegram Bot\nHandles database initialization and starts the bot\n\"\"\"\n\nimport asyncio\nimport logging\nimport sys\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker\nfrom sqlalchemy.pool import StaticPool\n\nfrom config import DATABASE_URL\nfrom models import Base\nimport bot\n\n# Configure logging\nlogging.basicConfig(\n    level=logging.INFO,\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',\n    handlers=[\n        logging.FileHandler('bot.log'),\n        logging.StreamHandler(sys.stdout)\n    ]\n)\nlogger = logging.getLogger(__name__)\n\nasync def init_database():\n    \"\"\"Initialize database and create tables\"\"\"\n    try:\n        # Convert PostgreSQL URL to asyncpg if needed\n        db_url = DATABASE_URL\n        if db_url.startswith(\"postgresql://\"):\n            db_url = db_url.replace(\"postgresql://\", \"postgresql+asyncpg://\")\n        \n        # Create async engine\n        if \"sqlite\" in db_url:\n            # SQLite specific configuration\n            engine = create_async_engine(\n                db_url,\n                poolclass=StaticPool,\n                connect_args={\"check_same_thread\": False},\n                echo=False\n            )\n        else:\n            # PostgreSQL configuration\n            engine = create_async_engine(db_url, echo=False)\n        \n        # Create tables\n        async with engine.begin() as conn:\n            await conn.run_sync(Base.metadata.create_all)\n        \n        logger.info(\"Database initialized successfully\")\n        return engine\n        \n    except Exception as e:\n        logger.error(f\"Database initialization failed: {e}\")\n        raise\n\nasync def main():\n    \"\"\"Main application entry point\"\"\"\n    try:\n        logger.info(\"Starting LangSense Bot...\")\n        \n        # Initialize database\n        engine = await init_database()\n        \n        # Create session maker\n        async_session = async_sessionmaker(engine, expire_on_commit=False)\n        \n        # Start the bot\n        await bot.main(async_session)\n        \n    except KeyboardInterrupt:\n        logger.info(\"Bot stopped by user\")\n    except Exception as e:\n        logger.error(f\"Fatal error: {e}\")\n        sys.exit(1)\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n","size_bytes":2328},"backup_server_files/models.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nSQLAlchemy models for the LangSense Bot\nDefines database schema for users, languages, countries, announcements, and messaging\n\"\"\"\n\nfrom datetime import datetime, timezone\nfrom enum import Enum as PyEnum\nfrom typing import Optional\n\nfrom sqlalchemy import (\n    Boolean, Column, DateTime, Enum, ForeignKey, Integer, String, Text, \n    UniqueConstraint, Index, BigInteger\n)\nfrom sqlalchemy.ext.asyncio import AsyncAttrs\nfrom sqlalchemy.ext.declarative import declarative_base\nfrom sqlalchemy.orm import relationship, Mapped, mapped_column\n\nBase = declarative_base(cls=AsyncAttrs)\n\nclass OutboxType(PyEnum):\n    \"\"\"Types of outbox messages\"\"\"\n    DEPOSIT = \"deposit\"\n    WITHDRAWAL = \"withdrawal\" \n    COMPLAINT = \"complaint\"\n    SUPPORT = \"support\"\n    BROADCAST = \"broadcast\"\n    ANNOUNCEMENT = \"announcement\"\n\nclass OutboxStatus(PyEnum):\n    \"\"\"Status of outbox messages\"\"\"\n    PENDING = \"pending\"\n    APPROVED = \"approved\"\n    REJECTED = \"rejected\"\n    PROCESSING = \"processing\"\n    COMPLETED = \"completed\"\n    FAILED = \"failed\"\n\nclass DeliveryStatus(PyEnum):\n    \"\"\"Status of message delivery\"\"\"\n    PENDING = \"pending\"\n    SENT = \"sent\"\n    DELIVERED = \"delivered\"\n    FAILED = \"failed\"\n    BLOCKED = \"blocked\"\n\nclass User(Base):\n    \"\"\"User model for storing Telegram user information\"\"\"\n    __tablename__ = 'users'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    telegram_id: Mapped[int] = mapped_column(BigInteger, unique=True, nullable=False, index=True)\n    username: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)\n    first_name: Mapped[str] = mapped_column(String(255), nullable=False)\n    last_name: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)\n    phone_number: Mapped[Optional[str]] = mapped_column(String(20), nullable=True)\n    customer_code: Mapped[Optional[str]] = mapped_column(String(50), unique=True, nullable=True, index=True)\n    \n    # Preferences\n    language_code: Mapped[str] = mapped_column(String(5), nullable=False, default='ar')\n    country_code: Mapped[str] = mapped_column(String(5), nullable=False, default='SA')\n    notifications_enabled: Mapped[bool] = mapped_column(Boolean, default=True)\n    \n    # Status\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    is_banned: Mapped[bool] = mapped_column(Boolean, default=False)\n    is_admin: Mapped[bool] = mapped_column(Boolean, default=False)\n    \n    # Timestamps\n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    last_activity: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    \n    # Relationships\n    outbox_messages = relationship(\"Outbox\", back_populates=\"user\", cascade=\"all, delete-orphan\")\n    announcement_deliveries = relationship(\"AnnouncementDelivery\", back_populates=\"user\", cascade=\"all, delete-orphan\")\n    \n    def __repr__(self):\n        return f\"<User(id={self.id}, telegram_id={self.telegram_id}, username={self.username})>\"\n\nclass Language(Base):\n    \"\"\"Language model for multi-language support\"\"\"\n    __tablename__ = 'languages'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    code: Mapped[str] = mapped_column(String(5), unique=True, nullable=False, index=True)\n    name: Mapped[str] = mapped_column(String(100), nullable=False)\n    native_name: Mapped[str] = mapped_column(String(100), nullable=False)\n    rtl: Mapped[bool] = mapped_column(Boolean, default=False)\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    \n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    \n    def __repr__(self):\n        return f\"<Language(code={self.code}, name={self.name})>\"\n\nclass Country(Base):\n    \"\"\"Country model for regional settings\"\"\"\n    __tablename__ = 'countries'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    code: Mapped[str] = mapped_column(String(5), unique=True, nullable=False, index=True)\n    name: Mapped[str] = mapped_column(String(100), nullable=False)\n    native_name: Mapped[str] = mapped_column(String(100), nullable=False)\n    phone_prefix: Mapped[str] = mapped_column(String(10), nullable=False)\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    \n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    \n    def __repr__(self):\n        return f\"<Country(code={self.code}, name={self.name})>\"\n\nclass Announcement(Base):\n    \"\"\"Announcement model for system announcements\"\"\"\n    __tablename__ = 'announcements'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    title_ar: Mapped[str] = mapped_column(String(255), nullable=False)\n    title_en: Mapped[str] = mapped_column(String(255), nullable=False)\n    content_ar: Mapped[str] = mapped_column(Text, nullable=False)\n    content_en: Mapped[str] = mapped_column(Text, nullable=False)\n    image_url: Mapped[Optional[str]] = mapped_column(String(500), nullable=True)\n    \n    # Display settings\n    display_duration: Mapped[int] = mapped_column(Integer, default=0)  # 0 = permanent\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    priority: Mapped[int] = mapped_column(Integer, default=0)\n    \n    # Filtering\n    target_language: Mapped[Optional[str]] = mapped_column(String(5), nullable=True)\n    target_country: Mapped[Optional[str]] = mapped_column(String(5), nullable=True)\n    \n    # Timestamps\n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    scheduled_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    expires_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    \n    # Relationships\n    deliveries = relationship(\"AnnouncementDelivery\", back_populates=\"announcement\", cascade=\"all, delete-orphan\")\n    \n    def __repr__(self):\n        return f\"<Announcement(id={self.id}, title_ar={self.title_ar[:50]})>\"\n\nclass AnnouncementDelivery(Base):\n    \"\"\"Track announcement delivery to users\"\"\"\n    __tablename__ = 'announcement_deliveries'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    announcement_id: Mapped[int] = mapped_column(Integer, ForeignKey('announcements.id'), nullable=False)\n    user_id: Mapped[int] = mapped_column(Integer, ForeignKey('users.id'), nullable=False)\n    \n    status: Mapped[DeliveryStatus] = mapped_column(Enum(DeliveryStatus), default=DeliveryStatus.PENDING)\n    delivered_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    read_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    error_message: Mapped[Optional[str]] = mapped_column(Text, nullable=True)\n    \n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    \n    # Relationships\n    announcement = relationship(\"Announcement\", back_populates=\"deliveries\")\n    user = relationship(\"User\", back_populates=\"announcement_deliveries\")\n    \n    # Unique constraint\n    __table_args__ = (UniqueConstraint('announcement_id', 'user_id', name='uq_announcement_user'),)\n    \n    def __repr__(self):\n        return f\"<AnnouncementDelivery(announcement_id={self.announcement_id}, user_id={self.user_id}, status={self.status})>\"\n\nclass Outbox(Base):\n    \"\"\"Outbox for user requests and system messages\"\"\"\n    __tablename__ = 'outbox'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    user_id: Mapped[int] = mapped_column(Integer, ForeignKey('users.id'), nullable=False)\n    type: Mapped[OutboxType] = mapped_column(Enum(OutboxType), nullable=False)\n    status: Mapped[OutboxStatus] = mapped_column(Enum(OutboxStatus), default=OutboxStatus.PENDING)\n    \n    # Content\n    subject: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)\n    content: Mapped[str] = mapped_column(Text, nullable=False)\n    attachment_url: Mapped[Optional[str]] = mapped_column(String(500), nullable=True)\n    \n    # Processing\n    processed_by: Mapped[Optional[int]] = mapped_column(BigInteger, nullable=True)  # Admin telegram_id\n    processed_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    admin_comment: Mapped[Optional[str]] = mapped_column(Text, nullable=True)\n    \n    # Timestamps\n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    updated_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))\n    \n    # Relationships\n    user = relationship(\"User\", back_populates=\"outbox_messages\")\n    recipients = relationship(\"OutboxRecipient\", back_populates=\"outbox\", cascade=\"all, delete-orphan\")\n    \n    # Indexes\n    __table_args__ = (\n        Index('idx_outbox_type_status', 'type', 'status'),\n        Index('idx_outbox_created', 'created_at'),\n    )\n    \n    def __repr__(self):\n        return f\"<Outbox(id={self.id}, type={self.type}, status={self.status})>\"\n\nclass OutboxRecipient(Base):\n    \"\"\"Track individual message recipients for broadcasts\"\"\"\n    __tablename__ = 'outbox_recipients'\n    \n    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)\n    outbox_id: Mapped[int] = mapped_column(Integer, ForeignKey('outbox.id'), nullable=False)\n    user_id: Mapped[int] = mapped_column(Integer, ForeignKey('users.id'), nullable=False)\n    \n    status: Mapped[DeliveryStatus] = mapped_column(Enum(DeliveryStatus), default=DeliveryStatus.PENDING)\n    attempts: Mapped[int] = mapped_column(Integer, default=0)\n    last_attempt: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    delivered_at: Mapped[Optional[datetime]] = mapped_column(DateTime(timezone=True), nullable=True)\n    error_message: Mapped[Optional[str]] = mapped_column(Text, nullable=True)\n    \n    created_at: Mapped[datetime] = mapped_column(DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))\n    \n    # Relationships\n    outbox = relationship(\"Outbox\", back_populates=\"recipients\")\n    \n    # Unique constraint\n    __table_args__ = (UniqueConstraint('outbox_id', 'user_id', name='uq_outbox_user'),)\n    \n    def __repr__(self):\n        return f\"<OutboxRecipient(outbox_id={self.outbox_id}, user_id={self.user_id}, status={self.status})>\"\n","size_bytes":11331},"handlers/admin.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nAdmin handler for administrative functions\nHandles admin panel, user management, language/country management\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone\nfrom aiogram import Router, F\nfrom aiogram.filters import Command\nfrom aiogram.types import Message, CallbackQuery\nfrom aiogram.fsm.context import FSMContext\nfrom aiogram.fsm.state import State, StatesGroup\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select, func, desc\n\nfrom models import User, Language, Country, Outbox, OutboxType, OutboxStatus\nfrom services.i18n import get_text, get_user_language\nfrom utils.auth import admin_required\nfrom utils.keyboards import (\n    get_admin_panel_keyboard, get_admin_users_keyboard,\n    get_admin_languages_keyboard, get_admin_countries_keyboard,\n    get_user_management_keyboard, get_pagination_keyboard\n)\nfrom config import USERS_PER_PAGE\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\nclass AdminStates(StatesGroup):\n    managing_user = State()\n    adding_language = State()\n    adding_country = State()\n    viewing_outbox = State()\n\n@router.message(Command(\"admin\"))\n@admin_required\nasync def show_admin_panel(message: Message, session_maker):\n    \"\"\"Show admin panel\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get statistics\n            total_users = await session.scalar(select(func.count(User.id)))\n            active_users = await session.scalar(\n                select(func.count(User.id)).where(User.is_active == True)\n            )\n            pending_requests = await session.scalar(\n                select(func.count(Outbox.id)).where(Outbox.status == OutboxStatus.PENDING)\n            )\n            \n            admin_text = get_text(\"admin_panel\", \"ar\").format(\n                total_users=total_users,\n                active_users=active_users,\n                pending_requests=pending_requests\n            )\n            \n            await message.answer(\n                admin_text,\n                reply_markup=get_admin_panel_keyboard(\"ar\")\n            )\n            \n        except Exception as e:\n            logger.error(f\"Error showing admin panel: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"admin_users\")\n@admin_required\nasync def show_users_list(callback: CallbackQuery, session_maker):\n    \"\"\"Show users list with pagination\"\"\"\n    await show_users_page(callback, session_maker, 0)\n\n@router.callback_query(F.data.startswith(\"admin_users_page_\"))\n@admin_required\nasync def show_users_page(callback: CallbackQuery, session_maker, page: int = None):\n    \"\"\"Show specific page of users\"\"\"\n    async with session_maker() as session:\n        try:\n            if page is None:\n                page = int(callback.data.split(\"_\")[-1])\n            \n            offset = page * USERS_PER_PAGE\n            \n            # Get users with pagination\n            result = await session.execute(\n                select(User)\n                .order_by(desc(User.created_at))\n                .offset(offset)\n                .limit(USERS_PER_PAGE)\n            )\n            users = result.scalars().all()\n            \n            # Get total count for pagination\n            total_users = await session.scalar(select(func.count(User.id)))\n            total_pages = (total_users + USERS_PER_PAGE - 1) // USERS_PER_PAGE\n            \n            if not users:\n                await callback.message.edit_text(\n                    get_text(\"no_users_found\", \"ar\")\n                )\n                await callback.answer()\n                return\n            \n            # Format users list\n            users_text = get_text(\"users_list_header\", \"ar\").format(\n                page=page + 1,\n                total_pages=total_pages,\n                total_users=total_users\n            )\n            \n            for user in users:\n                status = \"ğŸŸ¢\" if user.is_active else \"ğŸ”´\"\n                banned = \"ğŸš«\" if user.is_banned else \"\"\n                admin_mark = \"ğŸ‘‘\" if user.is_admin else \"\"\n                \n                users_text += f\"\\n\\n{status} {admin_mark} {banned}\\n\"\n                users_text += f\"ID: {user.telegram_id}\\n\"\n                users_text += f\"Name: {user.first_name}\"\n                if user.last_name:\n                    users_text += f\" {user.last_name}\"\n                if user.username:\n                    users_text += f\" (@{user.username})\"\n                users_text += f\"\\nCustomer: {user.customer_code or 'N/A'}\"\n                users_text += f\"\\nLang: {user.language_code} | Country: {user.country_code}\"\n                users_text += f\"\\nJoined: {user.created_at.strftime('%Y-%m-%d')}\"\n            \n            keyboard = get_pagination_keyboard(\"admin_users\", page, total_pages, \"ar\")\n            \n            await callback.message.edit_text(\n                users_text,\n                reply_markup=keyboard\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing users page: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"admin_languages\")\n@admin_required\nasync def show_languages_management(callback: CallbackQuery, session_maker):\n    \"\"\"Show languages management\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get all languages\n            result = await session.execute(\n                select(Language).order_by(Language.name)\n            )\n            languages = result.scalars().all()\n            \n            if not languages:\n                await callback.message.edit_text(\n                    get_text(\"no_languages_found\", \"ar\"),\n                    reply_markup=get_admin_languages_keyboard([], \"ar\")\n                )\n                await callback.answer()\n                return\n            \n            # Format languages list\n            languages_text = get_text(\"languages_list\", \"ar\")\n            \n            for lang in languages:\n                status = \"âœ…\" if lang.is_active else \"âŒ\"\n                rtl_mark = \"ğŸ”„\" if lang.rtl else \"\"\n                \n                languages_text += f\"\\n\\n{status} {rtl_mark}\\n\"\n                languages_text += f\"Code: {lang.code}\\n\"\n                languages_text += f\"Name: {lang.name}\\n\"\n                languages_text += f\"Native: {lang.native_name}\\n\"\n                languages_text += f\"RTL: {'Yes' if lang.rtl else 'No'}\\n\"\n                languages_text += f\"Created: {lang.created_at.strftime('%Y-%m-%d')}\"\n            \n            await callback.message.edit_text(\n                languages_text,\n                reply_markup=get_admin_languages_keyboard(languages, \"ar\")\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing languages: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"admin_countries\")\n@admin_required\nasync def show_countries_management(callback: CallbackQuery, session_maker):\n    \"\"\"Show countries management\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get all countries\n            result = await session.execute(\n                select(Country).order_by(Country.name)\n            )\n            countries = result.scalars().all()\n            \n            if not countries:\n                await callback.message.edit_text(\n                    get_text(\"no_countries_found\", \"ar\"),\n                    reply_markup=get_admin_countries_keyboard([], \"ar\")\n                )\n                await callback.answer()\n                return\n            \n            # Format countries list\n            countries_text = get_text(\"countries_list\", \"ar\")\n            \n            for country in countries:\n                status = \"âœ…\" if country.is_active else \"âŒ\"\n                \n                countries_text += f\"\\n\\n{status}\\n\"\n                countries_text += f\"Code: {country.code}\\n\"\n                countries_text += f\"Name: {country.name}\\n\"\n                countries_text += f\"Native: {country.native_name}\\n\"\n                countries_text += f\"Phone: {country.phone_prefix}\\n\"\n                countries_text += f\"Created: {country.created_at.strftime('%Y-%m-%d')}\"\n            \n            await callback.message.edit_text(\n                countries_text,\n                reply_markup=get_admin_countries_keyboard(countries, \"ar\")\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing countries: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"admin_outbox\")\n@admin_required\nasync def show_outbox_management(callback: CallbackQuery, session_maker):\n    \"\"\"Show outbox/requests management\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get pending requests\n            result = await session.execute(\n                select(Outbox)\n                .where(Outbox.status == OutboxStatus.PENDING)\n                .order_by(desc(Outbox.created_at))\n                .limit(10)\n            )\n            requests = result.scalars().all()\n            \n            if not requests:\n                await callback.message.edit_text(\n                    get_text(\"no_pending_requests\", \"ar\")\n                )\n                await callback.answer()\n                return\n            \n            # Format requests list\n            requests_text = get_text(\"pending_requests_header\", \"ar\")\n            \n            for req in requests:\n                type_emoji = {\n                    OutboxType.DEPOSIT: \"ğŸ’°\",\n                    OutboxType.WITHDRAWAL: \"ğŸ’¸\", \n                    OutboxType.COMPLAINT: \"ğŸ“¨\",\n                    OutboxType.SUPPORT: \"ğŸ†˜\"\n                }.get(req.type, \"ğŸ“„\")\n                \n                requests_text += f\"\\n\\n{type_emoji} ID: {req.id}\\n\"\n                requests_text += f\"Type: {req.type.value.title()}\\n\"\n                requests_text += f\"User ID: {req.user_id}\\n\"\n                if req.subject:\n                    requests_text += f\"Subject: {req.subject}\\n\"\n                requests_text += f\"Content: {req.content[:100]}...\\n\" if len(req.content) > 100 else f\"Content: {req.content}\\n\"\n                requests_text += f\"Created: {req.created_at.strftime('%Y-%m-%d %H:%M')}\"\n            \n            await callback.message.edit_text(requests_text)\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing outbox: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data.startswith(\"toggle_lang_\"))\n@admin_required\nasync def toggle_language_status(callback: CallbackQuery, session_maker):\n    \"\"\"Toggle language active status\"\"\"\n    async with session_maker() as session:\n        try:\n            lang_id = int(callback.data.split(\"_\")[-1])\n            \n            # Get language\n            result = await session.execute(\n                select(Language).where(Language.id == lang_id)\n            )\n            language = result.scalar_one_or_none()\n            \n            if not language:\n                await callback.answer(get_text(\"language_not_found\", \"ar\"))\n                return\n            \n            # Toggle status\n            language.is_active = not language.is_active\n            language.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            status = \"activated\" if language.is_active else \"deactivated\"\n            await callback.answer(f\"Language {language.name} {status}\")\n            \n            # Refresh the languages list\n            await show_languages_management(callback, session_maker)\n            \n        except Exception as e:\n            logger.error(f\"Error toggling language: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data.startswith(\"toggle_country_\"))\n@admin_required\nasync def toggle_country_status(callback: CallbackQuery, session_maker):\n    \"\"\"Toggle country active status\"\"\"\n    async with session_maker() as session:\n        try:\n            country_id = int(callback.data.split(\"_\")[-1])\n            \n            # Get country\n            result = await session.execute(\n                select(Country).where(Country.id == country_id)\n            )\n            country = result.scalar_one_or_none()\n            \n            if not country:\n                await callback.answer(get_text(\"country_not_found\", \"ar\"))\n                return\n            \n            # Toggle status\n            country.is_active = not country.is_active\n            country.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            status = \"activated\" if country.is_active else \"deactivated\"\n            await callback.answer(f\"Country {country.name} {status}\")\n            \n            # Refresh the countries list\n            await show_countries_management(callback, session_maker)\n            \n        except Exception as e:\n            logger.error(f\"Error toggling country: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"back_to_admin\")\n@admin_required\nasync def back_to_admin_panel(callback: CallbackQuery, session_maker):\n    \"\"\"Go back to admin panel\"\"\"\n    await show_admin_panel(callback.message, session_maker)\n    await callback.answer()\n","size_bytes":13605},"handlers/announcements.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nAnnouncements handler for system announcements\nHandles announcement creation, scheduling, and delivery\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone, timedelta\nfrom aiogram import Router, F\nfrom aiogram.types import Message, CallbackQuery\nfrom aiogram.fsm.context import FSMContext\nfrom aiogram.fsm.state import State, StatesGroup\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select, func\n\nfrom models import Announcement, AnnouncementDelivery, User\nfrom services.i18n import get_text\nfrom utils.auth import admin_required\nfrom utils.keyboards import (\n    get_announcement_menu_keyboard, get_announcement_targeting_keyboard,\n    get_announcement_duration_keyboard, get_announcement_confirmation_keyboard\n)\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\nclass AnnouncementStates(StatesGroup):\n    entering_title_ar = State()\n    entering_title_en = State()\n    entering_content_ar = State()\n    entering_content_en = State()\n    adding_image = State()\n    selecting_target = State()\n    setting_duration = State()\n    confirming = State()\n\n@router.message(F.text == \"/announce_new\")\n@admin_required\nasync def start_announcement_creation(message: Message, state: FSMContext):\n    \"\"\"Start announcement creation process\"\"\"\n    await message.answer(\n        get_text(\"announcement_enter_title_ar\", \"ar\")\n    )\n    await state.set_state(AnnouncementStates.entering_title_ar)\n\n@router.message(AnnouncementStates.entering_title_ar)\n@admin_required\nasync def receive_title_arabic(message: Message, state: FSMContext):\n    \"\"\"Receive Arabic title\"\"\"\n    title_ar = message.text.strip()\n    \n    if not title_ar:\n        await message.answer(get_text(\"title_required\", \"ar\"))\n        return\n    \n    await state.update_data(title_ar=title_ar)\n    await message.answer(get_text(\"announcement_enter_title_en\", \"ar\"))\n    await state.set_state(AnnouncementStates.entering_title_en)\n\n@router.message(AnnouncementStates.entering_title_en)\n@admin_required\nasync def receive_title_english(message: Message, state: FSMContext):\n    \"\"\"Receive English title\"\"\"\n    title_en = message.text.strip()\n    \n    if not title_en:\n        await message.answer(get_text(\"title_required\", \"ar\"))\n        return\n    \n    await state.update_data(title_en=title_en)\n    await message.answer(get_text(\"announcement_enter_content_ar\", \"ar\"))\n    await state.set_state(AnnouncementStates.entering_content_ar)\n\n@router.message(AnnouncementStates.entering_content_ar)\n@admin_required\nasync def receive_content_arabic(message: Message, state: FSMContext):\n    \"\"\"Receive Arabic content\"\"\"\n    content_ar = message.text.strip()\n    \n    if not content_ar:\n        await message.answer(get_text(\"content_required\", \"ar\"))\n        return\n    \n    await state.update_data(content_ar=content_ar)\n    await message.answer(get_text(\"announcement_enter_content_en\", \"ar\"))\n    await state.set_state(AnnouncementStates.entering_content_en)\n\n@router.message(AnnouncementStates.entering_content_en)\n@admin_required\nasync def receive_content_english(message: Message, state: FSMContext):\n    \"\"\"Receive English content\"\"\"\n    content_en = message.text.strip()\n    \n    if not content_en:\n        await message.answer(get_text(\"content_required\", \"ar\"))\n        return\n    \n    await state.update_data(content_en=content_en)\n    \n    # Ask for optional image\n    await message.answer(\n        get_text(\"announcement_add_image_optional\", \"ar\"),\n        reply_markup=get_announcement_menu_keyboard(\"ar\")\n    )\n    await state.set_state(AnnouncementStates.adding_image)\n\n@router.callback_query(AnnouncementStates.adding_image, F.data == \"skip_image\")\n@admin_required\nasync def skip_image(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Skip image and proceed to targeting\"\"\"\n    await callback.message.edit_text(\n        get_text(\"announcement_select_target\", \"ar\"),\n        reply_markup=get_announcement_targeting_keyboard(\"ar\")\n    )\n    await state.set_state(AnnouncementStates.selecting_target)\n    await callback.answer()\n\n@router.message(AnnouncementStates.adding_image, F.photo)\n@admin_required\nasync def receive_announcement_image(message: Message, state: FSMContext):\n    \"\"\"Receive announcement image\"\"\"\n    try:\n        # Get the largest photo\n        photo = message.photo[-1]\n        file_id = photo.file_id\n        \n        await state.update_data(image_file_id=file_id)\n        \n        await message.answer(\n            get_text(\"image_added_successfully\", \"ar\"),\n            reply_markup=get_announcement_targeting_keyboard(\"ar\")\n        )\n        await state.set_state(AnnouncementStates.selecting_target)\n        \n    except Exception as e:\n        logger.error(f\"Error receiving image: {e}\")\n        await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(AnnouncementStates.selecting_target, F.data == \"announce_all\")\n@admin_required\nasync def target_all_users(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Target all users for announcement\"\"\"\n    async with session_maker() as session:\n        try:\n            total_users = await session.scalar(\n                select(func.count(User.id)).where(User.is_active == True)\n            )\n            \n            await state.update_data(target_type=\"all\", target_value=None)\n            \n            await callback.message.edit_text(\n                get_text(\"announcement_set_duration\", \"ar\").format(\n                    target=f\"All users ({total_users})\"\n                ),\n                reply_markup=get_announcement_duration_keyboard(\"ar\")\n            )\n            await state.set_state(AnnouncementStates.setting_duration)\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error targeting all users: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(AnnouncementStates.selecting_target, F.data == \"announce_by_language\")\n@admin_required\nasync def target_by_language(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Target by language selection (simplified - you can expand this)\"\"\"\n    await state.update_data(target_type=\"language\", target_value=\"ar\")  # Default to Arabic\n    \n    await callback.message.edit_text(\n        get_text(\"announcement_set_duration\", \"ar\").format(\n            target=\"Arabic speakers\"\n        ),\n        reply_markup=get_announcement_duration_keyboard(\"ar\")\n    )\n    await state.set_state(AnnouncementStates.setting_duration)\n    await callback.answer()\n\n@router.callback_query(AnnouncementStates.setting_duration, F.data.startswith(\"duration_\"))\n@admin_required\nasync def set_announcement_duration(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Set announcement duration\"\"\"\n    duration_str = callback.data.split(\"_\")[1]\n    \n    # Convert duration to hours\n    duration_mapping = {\n        \"1h\": 1,\n        \"6h\": 6,\n        \"24h\": 24,\n        \"7d\": 168,  # 7 days in hours\n        \"permanent\": 0  # 0 means permanent\n    }\n    \n    duration_hours = duration_mapping.get(duration_str, 0)\n    await state.update_data(duration_hours=duration_hours)\n    \n    # Show confirmation\n    await show_announcement_confirmation(callback, state)\n\nasync def show_announcement_confirmation(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Show announcement confirmation\"\"\"\n    try:\n        data = await state.get_data()\n        \n        duration_text = \"\"\n        if data[\"duration_hours\"] == 0:\n            duration_text = \"Permanent\"\n        else:\n            duration_text = f\"{data['duration_hours']} hours\"\n        \n        target_text = \"\"\n        if data[\"target_type\"] == \"all\":\n            target_text = \"All active users\"\n        elif data[\"target_type\"] == \"language\":\n            target_text = f\"Language: {data.get('target_value', 'N/A')}\"\n        \n        confirmation_text = get_text(\"announcement_confirmation\", \"ar\").format(\n            title_ar=data[\"title_ar\"],\n            title_en=data[\"title_en\"],\n            content_ar=data[\"content_ar\"][:100] + \"...\" if len(data[\"content_ar\"]) > 100 else data[\"content_ar\"],\n            content_en=data[\"content_en\"][:100] + \"...\" if len(data[\"content_en\"]) > 100 else data[\"content_en\"],\n            target=target_text,\n            duration=duration_text,\n            has_image=\"Yes\" if data.get(\"image_file_id\") else \"No\"\n        )\n        \n        await callback.message.edit_text(\n            confirmation_text,\n            reply_markup=get_announcement_confirmation_keyboard(\"ar\")\n        )\n        await state.set_state(AnnouncementStates.confirming)\n        await callback.answer()\n        \n    except Exception as e:\n        logger.error(f\"Error showing confirmation: {e}\")\n        await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(AnnouncementStates.confirming, F.data == \"confirm_announcement\")\n@admin_required\nasync def confirm_announcement(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Confirm and create announcement\"\"\"\n    async with session_maker() as session:\n        try:\n            data = await state.get_data()\n            \n            # Calculate expiration time\n            expires_at = None\n            if data[\"duration_hours\"] > 0:\n                expires_at = datetime.now(timezone.utc) + timedelta(hours=data[\"duration_hours\"])\n            \n            # Create announcement\n            announcement = Announcement(\n                title_ar=data[\"title_ar\"],\n                title_en=data[\"title_en\"],\n                content_ar=data[\"content_ar\"],\n                content_en=data[\"content_en\"],\n                image_url=data.get(\"image_file_id\"),  # Store file_id as URL for simplicity\n                display_duration=data[\"duration_hours\"],\n                target_language=data.get(\"target_value\") if data[\"target_type\"] == \"language\" else None,\n                expires_at=expires_at,\n                scheduled_at=datetime.now(timezone.utc)\n            )\n            \n            session.add(announcement)\n            await session.flush()  # Get the ID\n            \n            # Create delivery records for target users\n            if data[\"target_type\"] == \"all\":\n                # Get all active users\n                result = await session.execute(\n                    select(User.id).where(User.is_active == True)\n                )\n                user_ids = [row[0] for row in result.fetchall()]\n            elif data[\"target_type\"] == \"language\":\n                # Get users by language\n                result = await session.execute(\n                    select(User.id).where(\n                        User.is_active == True,\n                        User.language_code == data[\"target_value\"]\n                    )\n                )\n                user_ids = [row[0] for row in result.fetchall()]\n            else:\n                user_ids = []\n            \n            # Create delivery records\n            for user_id in user_ids:\n                delivery = AnnouncementDelivery(\n                    announcement_id=announcement.id,\n                    user_id=user_id\n                )\n                session.add(delivery)\n            \n            await session.commit()\n            \n            await callback.message.edit_text(\n                get_text(\"announcement_created\", \"ar\").format(\n                    announcement_id=announcement.id,\n                    target_count=len(user_ids)\n                )\n            )\n            \n            await state.clear()\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error creating announcement: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(AnnouncementStates.confirming, F.data == \"cancel_announcement\")\n@admin_required\nasync def cancel_announcement(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Cancel announcement creation\"\"\"\n    await callback.message.edit_text(\n        get_text(\"announcement_cancelled\", \"ar\")\n    )\n    await state.clear()\n    await callback.answer()\n","size_bytes":12080},"handlers/broadcast.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBroadcast handler for mass messaging\nHandles broadcast creation, targeting, and delivery management\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone\nfrom aiogram import Router, F\nfrom aiogram.types import Message, CallbackQuery, InputMediaPhoto\nfrom aiogram.fsm.context import FSMContext\nfrom aiogram.fsm.state import State, StatesGroup\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select, func\n\nfrom models import User, Outbox, OutboxType, OutboxStatus, Language, Country\nfrom services.i18n import get_text\nfrom utils.auth import admin_required\nfrom utils.keyboards import (\n    get_broadcast_targeting_keyboard, get_broadcast_confirmation_keyboard,\n    get_language_filter_keyboard, get_country_filter_keyboard\n)\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\nclass BroadcastStates(StatesGroup):\n    selecting_target = State()\n    entering_message = State()\n    adding_media = State()\n    confirming = State()\n\n@router.message(F.text == \"/broadcast\")\n@admin_required\nasync def start_broadcast(message: Message, state: FSMContext, session_maker):\n    \"\"\"Start broadcast creation process\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get statistics for targeting options\n            total_users = await session.scalar(\n                select(func.count(User.id)).where(User.is_active == True)\n            )\n            \n            # Get language distribution\n            lang_result = await session.execute(\n                select(User.language_code, func.count(User.id))\n                .where(User.is_active == True)\n                .group_by(User.language_code)\n            )\n            lang_stats = dict(lang_result.fetchall())\n            \n            # Get country distribution\n            country_result = await session.execute(\n                select(User.country_code, func.count(User.id))\n                .where(User.is_active == True)\n                .group_by(User.country_code)\n            )\n            country_stats = dict(country_result.fetchall())\n            \n            # Format targeting options\n            stats_text = get_text(\"broadcast_targeting_stats\", \"ar\").format(\n                total_users=total_users,\n                lang_stats=\", \".join([f\"{k}: {v}\" for k, v in lang_stats.items()]),\n                country_stats=\", \".join([f\"{k}: {v}\" for k, v in country_stats.items()])\n            )\n            \n            await message.answer(\n                stats_text,\n                reply_markup=get_broadcast_targeting_keyboard(\"ar\")\n            )\n            \n            await state.set_state(BroadcastStates.selecting_target)\n            await state.update_data(\n                total_users=total_users,\n                lang_stats=lang_stats,\n                country_stats=country_stats\n            )\n            \n        except Exception as e:\n            logger.error(f\"Error starting broadcast: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.selecting_target, F.data == \"broadcast_all\")\n@admin_required\nasync def select_broadcast_all(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Select broadcast to all users\"\"\"\n    await state.update_data(target_type=\"all\")\n    await callback.message.edit_text(\n        get_text(\"broadcast_enter_message\", \"ar\")\n    )\n    await state.set_state(BroadcastStates.entering_message)\n    await callback.answer()\n\n@router.callback_query(BroadcastStates.selecting_target, F.data == \"broadcast_by_language\")\n@admin_required\nasync def select_broadcast_by_language(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Select broadcast by language\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get available languages with user counts\n            result = await session.execute(\n                select(Language.code, Language.native_name, func.count(User.id))\n                .join(User, User.language_code == Language.code)\n                .where(Language.is_active == True, User.is_active == True)\n                .group_by(Language.code, Language.native_name)\n            )\n            languages = result.fetchall()\n            \n            if not languages:\n                await callback.answer(get_text(\"no_languages_with_users\", \"ar\"))\n                return\n            \n            await callback.message.edit_text(\n                get_text(\"select_target_language\", \"ar\"),\n                reply_markup=get_language_filter_keyboard(languages, \"ar\")\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing language selection: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.selecting_target, F.data == \"broadcast_by_country\")\n@admin_required\nasync def select_broadcast_by_country(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Select broadcast by country\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get available countries with user counts\n            result = await session.execute(\n                select(Country.code, Country.native_name, func.count(User.id))\n                .join(User, User.country_code == Country.code)\n                .where(Country.is_active == True, User.is_active == True)\n                .group_by(Country.code, Country.native_name)\n            )\n            countries = result.fetchall()\n            \n            if not countries:\n                await callback.answer(get_text(\"no_countries_with_users\", \"ar\"))\n                return\n            \n            await callback.message.edit_text(\n                get_text(\"select_target_country\", \"ar\"),\n                reply_markup=get_country_filter_keyboard(countries, \"ar\")\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing country selection: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.selecting_target, F.data.startswith(\"lang_filter_\"))\n@admin_required\nasync def select_language_filter(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Select specific language for broadcast\"\"\"\n    language_code = callback.data.split(\"_\")[-1]\n    await state.update_data(target_type=\"language\", target_value=language_code)\n    \n    await callback.message.edit_text(\n        get_text(\"broadcast_enter_message\", \"ar\").format(\n            target=f\"Language: {language_code.upper()}\"\n        )\n    )\n    await state.set_state(BroadcastStates.entering_message)\n    await callback.answer()\n\n@router.callback_query(BroadcastStates.selecting_target, F.data.startswith(\"country_filter_\"))\n@admin_required\nasync def select_country_filter(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Select specific country for broadcast\"\"\"\n    country_code = callback.data.split(\"_\")[-1]\n    await state.update_data(target_type=\"country\", target_value=country_code)\n    \n    await callback.message.edit_text(\n        get_text(\"broadcast_enter_message\", \"ar\").format(\n            target=f\"Country: {country_code.upper()}\"\n        )\n    )\n    await state.set_state(BroadcastStates.entering_message)\n    await callback.answer()\n\n@router.message(BroadcastStates.entering_message)\n@admin_required\nasync def receive_broadcast_message(message: Message, state: FSMContext):\n    \"\"\"Receive broadcast message text\"\"\"\n    try:\n        broadcast_text = message.text or message.caption or \"\"\n        \n        if not broadcast_text.strip():\n            await message.answer(get_text(\"broadcast_message_required\", \"ar\"))\n            return\n        \n        # Store message data\n        await state.update_data(\n            message_text=broadcast_text,\n            message_entities=message.entities,\n            message_type=\"text\"\n        )\n        \n        # Check if message has media\n        if message.photo or message.video or message.document:\n            if message.photo:\n                file_id = message.photo[-1].file_id\n                await state.update_data(message_type=\"photo\", file_id=file_id)\n            elif message.video:\n                await state.update_data(message_type=\"video\", file_id=message.video.file_id)\n            elif message.document:\n                await state.update_data(message_type=\"document\", file_id=message.document.file_id)\n        \n        # Show confirmation\n        await show_broadcast_confirmation(message, state)\n        \n    except Exception as e:\n        logger.error(f\"Error receiving broadcast message: {e}\")\n        await message.answer(get_text(\"error_occurred\", \"ar\"))\n\nasync def show_broadcast_confirmation(message: Message, state: FSMContext):\n    \"\"\"Show broadcast confirmation with preview\"\"\"\n    try:\n        data = await state.get_data()\n        \n        # Calculate target audience\n        target_info = \"\"\n        if data[\"target_type\"] == \"all\":\n            target_info = f\"All active users ({data.get('total_users', '?')} users)\"\n        elif data[\"target_type\"] == \"language\":\n            lang_code = data[\"target_value\"]\n            user_count = data.get(\"lang_stats\", {}).get(lang_code, \"?\")\n            target_info = f\"Language: {lang_code.upper()} ({user_count} users)\"\n        elif data[\"target_type\"] == \"country\":\n            country_code = data[\"target_value\"]\n            user_count = data.get(\"country_stats\", {}).get(country_code, \"?\")\n            target_info = f\"Country: {country_code.upper()} ({user_count} users)\"\n        \n        confirmation_text = get_text(\"broadcast_confirmation\", \"ar\").format(\n            target=target_info,\n            message_preview=data[\"message_text\"][:200] + \"...\" if len(data[\"message_text\"]) > 200 else data[\"message_text\"]\n        )\n        \n        await message.answer(\n            confirmation_text,\n            reply_markup=get_broadcast_confirmation_keyboard(\"ar\")\n        )\n        \n        await state.set_state(BroadcastStates.confirming)\n        \n    except Exception as e:\n        logger.error(f\"Error showing confirmation: {e}\")\n        await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.confirming, F.data == \"confirm_broadcast\")\n@admin_required\nasync def confirm_broadcast(callback: CallbackQuery, state: FSMContext, session_maker, broadcast_service):\n    \"\"\"Confirm and start broadcast\"\"\"\n    async with session_maker() as session:\n        try:\n            data = await state.get_data()\n            \n            # Create outbox entry for broadcast\n            outbox = Outbox(\n                user_id=1,  # System user for broadcasts\n                type=OutboxType.BROADCAST,\n                status=OutboxStatus.PROCESSING,\n                subject=f\"Broadcast to {data['target_type']}\",\n                content=data[\"message_text\"]\n            )\n            session.add(outbox)\n            await session.flush()\n            \n            # Queue broadcast for delivery\n            await broadcast_service.queue_broadcast(\n                outbox_id=outbox.id,\n                target_type=data[\"target_type\"],\n                target_value=data.get(\"target_value\"),\n                message_text=data[\"message_text\"],\n                message_type=data.get(\"message_type\", \"text\"),\n                file_id=data.get(\"file_id\"),\n                message_entities=data.get(\"message_entities\")\n            )\n            \n            await session.commit()\n            \n            await callback.message.edit_text(\n                get_text(\"broadcast_queued\", \"ar\").format(\n                    broadcast_id=outbox.id\n                )\n            )\n            \n            await state.clear()\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error confirming broadcast: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.confirming, F.data == \"cancel_broadcast\")\n@admin_required\nasync def cancel_broadcast(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Cancel broadcast\"\"\"\n    await callback.message.edit_text(\n        get_text(\"broadcast_cancelled\", \"ar\")\n    )\n    await state.clear()\n    await callback.answer()\n","size_bytes":12292},"handlers/start.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nStart handler for user registration, phone verification, and main menu\nHandles /start command, phone number collection, and customer code generation\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone\nfrom aiogram import Router, F\nfrom aiogram.filters import Command, CommandStart\nfrom aiogram.types import Message, CallbackQuery, Contact\nfrom aiogram.fsm.context import FSMContext\nfrom aiogram.fsm.state import State, StatesGroup\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select\n\nfrom models import User\nfrom services.i18n import get_text, get_user_language\nfrom services.customer_id import generate_customer_code\nfrom utils.keyboards import (\n    get_main_menu_keyboard, get_phone_share_keyboard, \n    get_contact_confirmation_keyboard\n)\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\nclass RegistrationStates(StatesGroup):\n    waiting_for_phone = State()\n    confirming_phone = State()\n\n@router.message(CommandStart())\nasync def start_command(message: Message, state: FSMContext, session_maker):\n    \"\"\"Handle /start command and user registration\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get or create user\n            user = await get_or_create_user(session, message.from_user)\n            await session.commit()\n            \n            # Get user's language for responses\n            lang = get_user_language(user.language_code)\n            \n            if not user.phone_number:\n                # First time user - request phone number\n                await message.answer(\n                    get_text(\"welcome_new_user\", lang).format(\n                        first_name=user.first_name\n                    ),\n                    reply_markup=get_phone_share_keyboard(lang)\n                )\n                await state.set_state(RegistrationStates.waiting_for_phone)\n            else:\n                # Returning user - show main menu\n                await show_main_menu(message, user, session)\n                \n        except Exception as e:\n            logger.error(f\"Error in start command: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(RegistrationStates.waiting_for_phone, F.contact)\nasync def handle_phone_contact(message: Message, state: FSMContext, session_maker):\n    \"\"\"Handle phone number shared via contact\"\"\"\n    async with session_maker() as session:\n        try:\n            contact: Contact = message.contact\n            \n            # Verify it's the user's own contact\n            if contact.user_id != message.from_user.id:\n                user = await get_user_by_telegram_id(session, message.from_user.id)\n                lang = get_user_language(user.language_code if user else \"ar\")\n                await message.answer(get_text(\"phone_must_be_yours\", lang))\n                return\n            \n            # Update user with phone number\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if user:\n                user.phone_number = contact.phone_number\n                user.updated_at = datetime.now(timezone.utc)\n                \n                # Generate customer code if not exists\n                if not user.customer_code:\n                    user.customer_code = await generate_customer_code(session)\n                \n                await session.commit()\n                \n                lang = get_user_language(user.language_code)\n                \n                # Show confirmation\n                await message.answer(\n                    get_text(\"phone_registered_success\", lang).format(\n                        phone=contact.phone_number,\n                        customer_code=user.customer_code\n                    ),\n                    reply_markup=get_contact_confirmation_keyboard(lang)\n                )\n                \n                await state.set_state(RegistrationStates.confirming_phone)\n            \n        except Exception as e:\n            logger.error(f\"Error handling phone contact: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(RegistrationStates.confirming_phone, F.data == \"confirm_phone\")\nasync def confirm_phone_registration(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Confirm phone registration and show main menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if user:\n                await callback.answer()\n                await callback.message.delete()\n                await show_main_menu(callback.message, user, session)\n                await state.clear()\n            \n        except Exception as e:\n            logger.error(f\"Error confirming phone: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(F.text.in_([\"ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹\", \"ğŸ’° Deposit\"]))\nasync def handle_deposit(message: Message, session_maker):\n    \"\"\"Handle deposit request\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            await message.answer(get_text(\"deposit_instructions\", lang))\n            \n        except Exception as e:\n            logger.error(f\"Error handling deposit: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(F.text.in_([\"ğŸ’¸ Ø³Ø­Ø¨\", \"ğŸ’¸ Withdraw\"]))\nasync def handle_withdraw(message: Message, session_maker):\n    \"\"\"Handle withdrawal request\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            await message.answer(get_text(\"withdraw_instructions\", lang))\n            \n        except Exception as e:\n            logger.error(f\"Error handling withdraw: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(F.text.in_([\"ğŸ“¨ Ø´ÙƒØ§ÙˆÙ‰\", \"ğŸ“¨ Complaints\"]))\nasync def handle_complaints(message: Message, session_maker):\n    \"\"\"Handle complaints submission\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            await message.answer(get_text(\"complaints_instructions\", lang))\n            \n        except Exception as e:\n            logger.error(f\"Error handling complaints: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(F.text.in_([\"ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ\", \"ğŸ‘¤ My Account\"]))\nasync def handle_my_account(message: Message, session_maker):\n    \"\"\"Show user account information\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            \n            # Format account information\n            account_info = get_text(\"account_info\", lang).format(\n                first_name=user.first_name,\n                last_name=user.last_name or \"\",\n                username=f\"@{user.username}\" if user.username else get_text(\"not_set\", lang),\n                phone=user.phone_number or get_text(\"not_set\", lang),\n                customer_code=user.customer_code,\n                language=user.language_code.upper(),\n                country=user.country_code.upper(),\n                notifications=get_text(\"enabled\", lang) if user.notifications_enabled else get_text(\"disabled\", lang)\n            )\n            \n            await message.answer(account_info)\n            \n        except Exception as e:\n            logger.error(f\"Error showing account: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\nasync def get_or_create_user(session: AsyncSession, telegram_user) -> User:\n    \"\"\"Get existing user or create new one\"\"\"\n    # Try to get existing user\n    result = await session.execute(\n        select(User).where(User.telegram_id == telegram_user.id)\n    )\n    user = result.scalar_one_or_none()\n    \n    if user:\n        # Update user information\n        user.username = telegram_user.username\n        user.first_name = telegram_user.first_name\n        user.last_name = telegram_user.last_name\n        user.last_activity = datetime.now(timezone.utc)\n        user.updated_at = datetime.now(timezone.utc)\n    else:\n        # Create new user\n        user = User(\n            telegram_id=telegram_user.id,\n            username=telegram_user.username,\n            first_name=telegram_user.first_name,\n            last_name=telegram_user.last_name,\n            language_code=telegram_user.language_code or \"ar\",\n            last_activity=datetime.now(timezone.utc)\n        )\n        session.add(user)\n    \n    return user\n\nasync def get_user_by_telegram_id(session: AsyncSession, telegram_id: int) -> User:\n    \"\"\"Get user by telegram ID\"\"\"\n    result = await session.execute(\n        select(User).where(User.telegram_id == telegram_id)\n    )\n    return result.scalar_one_or_none()\n\nasync def show_main_menu(message: Message, user: User, session: AsyncSession):\n    \"\"\"Show main menu to user\"\"\"\n    lang = get_user_language(user.language_code)\n    \n    welcome_back_text = get_text(\"welcome_back\", lang).format(\n        first_name=user.first_name,\n        customer_code=user.customer_code\n    )\n    \n    await message.answer(\n        welcome_back_text,\n        reply_markup=get_main_menu_keyboard(lang)\n    )\n","size_bytes":9884},"handlers/user_settings.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nUser settings handler for language and country selection\nHandles user preference changes and localization updates\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone\nfrom aiogram import Router, F\nfrom aiogram.types import Message, CallbackQuery\nfrom aiogram.fsm.context import FSMContext\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select\n\nfrom models import User, Language, Country\nfrom services.i18n import get_text, get_user_language, load_translations\nfrom utils.keyboards import (\n    get_language_selection_keyboard, get_country_selection_keyboard,\n    get_settings_keyboard, get_main_menu_keyboard\n)\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\n@router.message(F.text.in_([\"ğŸŒ Ø§Ù„Ù„ØºØ©\", \"ğŸŒ Language\", \"âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\", \"âš™ï¸ Settings\"]))\nasync def show_settings_menu(message: Message, session_maker):\n    \"\"\"Show settings menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            \n            await message.answer(\n                get_text(\"settings_menu\", lang),\n                reply_markup=get_settings_keyboard(lang)\n            )\n            \n        except Exception as e:\n            logger.error(f\"Error showing settings menu: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"change_language\")\nasync def show_language_selection(callback: CallbackQuery, session_maker):\n    \"\"\"Show language selection menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Get available languages\n            result = await session.execute(\n                select(Language).where(Language.is_active == True).order_by(Language.name)\n            )\n            languages = result.scalars().all()\n            \n            lang = get_user_language(user.language_code)\n            \n            await callback.message.edit_text(\n                get_text(\"select_language\", lang),\n                reply_markup=get_language_selection_keyboard(languages, user.language_code, lang)\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing language selection: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data.startswith(\"lang_\"))\nasync def change_language(callback: CallbackQuery, session_maker):\n    \"\"\"Change user language\"\"\"\n    async with session_maker() as session:\n        try:\n            language_code = callback.data.split(\"_\")[1]\n            \n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Verify language exists and is active\n            result = await session.execute(\n                select(Language).where(\n                    Language.code == language_code,\n                    Language.is_active == True\n                )\n            )\n            language = result.scalar_one_or_none()\n            \n            if not language:\n                await callback.answer(get_text(\"language_not_available\", \"ar\"))\n                return\n            \n            # Update user language\n            old_lang = user.language_code\n            user.language_code = language_code\n            user.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            # Get new language text\n            new_lang = get_user_language(language_code)\n            \n            await callback.message.edit_text(\n                get_text(\"language_changed\", new_lang).format(\n                    language_name=language.native_name\n                )\n            )\n            \n            # Show updated main menu\n            await callback.message.answer(\n                get_text(\"main_menu_updated\", new_lang),\n                reply_markup=get_main_menu_keyboard(new_lang)\n            )\n            \n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error changing language: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"change_country\")\nasync def show_country_selection(callback: CallbackQuery, session_maker):\n    \"\"\"Show country selection menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Get available countries\n            result = await session.execute(\n                select(Country).where(Country.is_active == True).order_by(Country.name)\n            )\n            countries = result.scalars().all()\n            \n            lang = get_user_language(user.language_code)\n            \n            await callback.message.edit_text(\n                get_text(\"select_country\", lang),\n                reply_markup=get_country_selection_keyboard(countries, user.country_code, lang)\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing country selection: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data.startswith(\"country_\"))\nasync def change_country(callback: CallbackQuery, session_maker):\n    \"\"\"Change user country\"\"\"\n    async with session_maker() as session:\n        try:\n            country_code = callback.data.split(\"_\")[1]\n            \n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Verify country exists and is active\n            result = await session.execute(\n                select(Country).where(\n                    Country.code == country_code,\n                    Country.is_active == True\n                )\n            )\n            country = result.scalar_one_or_none()\n            \n            if not country:\n                lang = get_user_language(user.language_code)\n                await callback.answer(get_text(\"country_not_available\", lang))\n                return\n            \n            # Update user country\n            user.country_code = country_code\n            user.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            lang = get_user_language(user.language_code)\n            \n            country_name = country.native_name if lang == \"ar\" else country.name\n            \n            await callback.message.edit_text(\n                get_text(\"country_changed\", lang).format(\n                    country_name=country_name\n                )\n            )\n            \n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error changing country: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"toggle_notifications\")\nasync def toggle_notifications(callback: CallbackQuery, session_maker):\n    \"\"\"Toggle user notifications\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Toggle notifications\n            user.notifications_enabled = not user.notifications_enabled\n            user.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            lang = get_user_language(user.language_code)\n            \n            status = get_text(\"enabled\", lang) if user.notifications_enabled else get_text(\"disabled\", lang)\n            \n            await callback.message.edit_text(\n                get_text(\"notifications_toggled\", lang).format(status=status)\n            )\n            \n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error toggling notifications: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"back_to_settings\")\nasync def back_to_settings(callback: CallbackQuery, session_maker):\n    \"\"\"Go back to settings menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            lang = get_user_language(user.language_code)\n            \n            await callback.message.edit_text(\n                get_text(\"settings_menu\", lang),\n                reply_markup=get_settings_keyboard(lang)\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error going back to settings: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\nasync def get_user_by_telegram_id(session: AsyncSession, telegram_id: int) -> User:\n    \"\"\"Get user by telegram ID\"\"\"\n    result = await session.execute(\n        select(User).where(User.telegram_id == telegram_id)\n    )\n    return result.scalar_one_or_none()\n","size_bytes":9720},"services/broadcast_service.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBroadcast service for handling mass messaging\nManages broadcast queues, rate limiting, and delivery tracking\n\"\"\"\n\nimport asyncio\nimport logging\nfrom datetime import datetime, timezone\nfrom typing import Optional, List, Dict, Any\nfrom aiogram import Bot\nfrom aiogram.exceptions import TelegramBadRequest, TelegramForbiddenError\nfrom aiogram.types import InputMediaPhoto, InputMediaVideo, InputMediaDocument\nfrom sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker\nfrom sqlalchemy import select, and_\n\nfrom models import (\n    User, Outbox, OutboxRecipient, OutboxStatus, \n    DeliveryStatus, OutboxType\n)\nfrom config import (\n    BROADCAST_RATE_LIMIT, BROADCAST_CHUNK_SIZE, \n    BROADCAST_RETRY_ATTEMPTS, BROADCAST_RETRY_DELAY\n)\n\nlogger = logging.getLogger(__name__)\n\nclass BroadcastService:\n    \"\"\"Service for handling broadcast operations\"\"\"\n    \n    def __init__(self, bot: Bot, session_maker: async_sessionmaker):\n        self.bot = bot\n        self.session_maker = session_maker\n        self.broadcast_queue = asyncio.Queue()\n        self.is_running = False\n        \n    async def queue_broadcast(self, outbox_id: int, target_type: str, \n                            target_value: Optional[str], message_text: str,\n                            message_type: str = \"text\", file_id: Optional[str] = None,\n                            message_entities: Optional[List] = None):\n        \"\"\"Queue a broadcast for delivery\"\"\"\n        broadcast_data = {\n            \"outbox_id\": outbox_id,\n            \"target_type\": target_type,\n            \"target_value\": target_value,\n            \"message_text\": message_text,\n            \"message_type\": message_type,\n            \"file_id\": file_id,\n            \"message_entities\": message_entities\n        }\n        \n        await self.broadcast_queue.put(broadcast_data)\n        logger.info(f\"Queued broadcast {outbox_id} for delivery\")\n    \n    async def worker(self):\n        \"\"\"Background worker for processing broadcast queue\"\"\"\n        self.is_running = True\n        logger.info(\"Broadcast service worker started\")\n        \n        while self.is_running:\n            try:\n                # Get broadcast from queue with timeout\n                try:\n                    broadcast = await asyncio.wait_for(\n                        self.broadcast_queue.get(), timeout=5.0\n                    )\n                except asyncio.TimeoutError:\n                    continue\n                \n                await self.process_broadcast(broadcast)\n                \n            except Exception as e:\n                logger.error(f\"Error in broadcast worker: {e}\")\n                await asyncio.sleep(1)\n    \n    async def process_broadcast(self, broadcast: Dict[str, Any]):\n        \"\"\"Process a single broadcast\"\"\"\n        outbox_id = broadcast[\"outbox_id\"]\n        \n        try:\n            async with self.session_maker() as session:\n                # Get target users\n                users = await self.get_target_users(\n                    session, broadcast[\"target_type\"], broadcast.get(\"target_value\")\n                )\n                \n                if not users:\n                    logger.warning(f\"No target users found for broadcast {outbox_id}\")\n                    await self.update_broadcast_status(session, outbox_id, OutboxStatus.COMPLETED)\n                    return\n                \n                # Create recipient records\n                await self.create_recipient_records(session, outbox_id, users)\n                await session.commit()\n                \n                logger.info(f\"Starting delivery for broadcast {outbox_id} to {len(users)} users\")\n                \n                # Process in chunks\n                for chunk in self.chunk_list(users, BROADCAST_CHUNK_SIZE):\n                    await self.send_to_chunk(session, outbox_id, chunk, broadcast)\n                    \n                    # Rate limiting\n                    sleep_time = len(chunk) / BROADCAST_RATE_LIMIT\n                    await asyncio.sleep(sleep_time)\n                \n                # Update broadcast status\n                await self.update_broadcast_status(session, outbox_id, OutboxStatus.COMPLETED)\n                logger.info(f\"Completed broadcast {outbox_id}\")\n                \n        except Exception as e:\n            logger.error(f\"Error processing broadcast {outbox_id}: {e}\")\n            async with self.session_maker() as session:\n                await self.update_broadcast_status(session, outbox_id, OutboxStatus.FAILED)\n    \n    async def get_target_users(self, session: AsyncSession, target_type: str, \n                             target_value: Optional[str]) -> List[User]:\n        \"\"\"Get target users based on targeting criteria\"\"\"\n        base_query = select(User).where(\n            and_(User.is_active == True, User.is_banned == False)\n        )\n        \n        if target_type == \"all\":\n            result = await session.execute(base_query)\n        elif target_type == \"language\":\n            result = await session.execute(\n                base_query.where(User.language_code == target_value)\n            )\n        elif target_type == \"country\":\n            result = await session.execute(\n                base_query.where(User.country_code == target_value)\n            )\n        else:\n            logger.warning(f\"Unknown target type: {target_type}\")\n            return []\n        \n        return list(result.scalars().all())\n    \n    async def create_recipient_records(self, session: AsyncSession, \n                                     outbox_id: int, users: List[User]):\n        \"\"\"Create recipient tracking records\"\"\"\n        for user in users:\n            recipient = OutboxRecipient(\n                outbox_id=outbox_id,\n                user_id=user.id,\n                status=DeliveryStatus.PENDING\n            )\n            session.add(recipient)\n    \n    async def send_to_chunk(self, session: AsyncSession, outbox_id: int, \n                          users: List[User], broadcast: Dict[str, Any]):\n        \"\"\"Send broadcast to a chunk of users\"\"\"\n        for user in users:\n            try:\n                success = await self.send_to_user(user, broadcast)\n                \n                # Update recipient status\n                await self.update_recipient_status(\n                    session, outbox_id, user.id,\n                    DeliveryStatus.SENT if success else DeliveryStatus.FAILED\n                )\n                \n            except Exception as e:\n                logger.error(f\"Error sending to user {user.telegram_id}: {e}\")\n                await self.update_recipient_status(\n                    session, outbox_id, user.id, DeliveryStatus.FAILED, str(e)\n                )\n        \n        await session.commit()\n    \n    async def send_to_user(self, user: User, broadcast: Dict[str, Any]) -> bool:\n        \"\"\"Send broadcast message to a single user\"\"\"\n        try:\n            message_text = broadcast[\"message_text\"]\n            message_type = broadcast.get(\"message_type\", \"text\")\n            file_id = broadcast.get(\"file_id\")\n            \n            if message_type == \"text\":\n                await self.bot.send_message(\n                    chat_id=user.telegram_id,\n                    text=message_text,\n                    entities=broadcast.get(\"message_entities\")\n                )\n            elif message_type == \"photo\" and file_id:\n                await self.bot.send_photo(\n                    chat_id=user.telegram_id,\n                    photo=file_id,\n                    caption=message_text,\n                    caption_entities=broadcast.get(\"message_entities\")\n                )\n            elif message_type == \"video\" and file_id:\n                await self.bot.send_video(\n                    chat_id=user.telegram_id,\n                    video=file_id,\n                    caption=message_text,\n                    caption_entities=broadcast.get(\"message_entities\")\n                )\n            elif message_type == \"document\" and file_id:\n                await self.bot.send_document(\n                    chat_id=user.telegram_id,\n                    document=file_id,\n                    caption=message_text,\n                    caption_entities=broadcast.get(\"message_entities\")\n                )\n            \n            return True\n            \n        except TelegramForbiddenError:\n            # User blocked the bot\n            logger.info(f\"User {user.telegram_id} blocked the bot\")\n            return False\n        except TelegramBadRequest as e:\n            # Invalid user or other API error\n            logger.warning(f\"Bad request for user {user.telegram_id}: {e}\")\n            return False\n        except Exception as e:\n            logger.error(f\"Unexpected error sending to user {user.telegram_id}: {e}\")\n            return False\n    \n    async def update_broadcast_status(self, session: AsyncSession, \n                                    outbox_id: int, status: OutboxStatus):\n        \"\"\"Update broadcast status\"\"\"\n        result = await session.execute(\n            select(Outbox).where(Outbox.id == outbox_id)\n        )\n        outbox = result.scalar_one_or_none()\n        \n        if outbox:\n            outbox.status = status\n            outbox.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n    \n    async def update_recipient_status(self, session: AsyncSession, outbox_id: int,\n                                    user_id: int, status: DeliveryStatus,\n                                    error_message: Optional[str] = None):\n        \"\"\"Update recipient delivery status\"\"\"\n        result = await session.execute(\n            select(OutboxRecipient).where(\n                and_(\n                    OutboxRecipient.outbox_id == outbox_id,\n                    OutboxRecipient.user_id == user_id\n                )\n            )\n        )\n        recipient = result.scalar_one_or_none()\n        \n        if recipient:\n            recipient.status = status\n            recipient.last_attempt = datetime.now(timezone.utc)\n            recipient.attempts += 1\n            \n            if status == DeliveryStatus.SENT:\n                recipient.delivered_at = datetime.now(timezone.utc)\n            elif error_message:\n                recipient.error_message = error_message\n    \n    @staticmethod\n    def chunk_list(lst: List, chunk_size: int) -> List[List]:\n        \"\"\"Split list into chunks\"\"\"\n        return [lst[i:i + chunk_size] for i in range(0, len(lst), chunk_size)]\n    \n    async def stop(self):\n        \"\"\"Stop the broadcast service\"\"\"\n        self.is_running = False\n        logger.info(\"Broadcast service stopping...\")\n","size_bytes":10646},"services/customer_id.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nCustomer ID generation service\nGenerates unique customer codes for new users\n\"\"\"\n\nimport logging\nfrom datetime import datetime\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select, func\nfrom models import User\nfrom config import CUSTOMER_ID_PREFIX, CUSTOMER_ID_YEAR_FORMAT\n\nlogger = logging.getLogger(__name__)\n\nasync def generate_customer_code(session: AsyncSession) -> str:\n    \"\"\"Generate unique customer code\"\"\"\n    try:\n        # Get current year\n        current_year = datetime.now().year\n        year_str = CUSTOMER_ID_YEAR_FORMAT or str(current_year)\n        \n        # Get the highest existing number for this year\n        pattern = f\"{CUSTOMER_ID_PREFIX}-{year_str}-%\"\n        \n        result = await session.execute(\n            select(func.max(User.customer_code))\n            .where(User.customer_code.like(pattern))\n        )\n        \n        max_code = result.scalar_one_or_none()\n        \n        if max_code:\n            try:\n                # Extract the number part and increment\n                parts = max_code.split('-')\n                if len(parts) >= 3:\n                    last_number = int(parts[-1])\n                    next_number = last_number + 1\n                else:\n                    next_number = 1\n            except (ValueError, IndexError):\n                next_number = 1\n        else:\n            next_number = 1\n        \n        # Format with leading zeros (6 digits)\n        customer_code = f\"{CUSTOMER_ID_PREFIX}-{year_str}-{next_number:06d}\"\n        \n        # Verify uniqueness (double-check)\n        existing = await session.execute(\n            select(User).where(User.customer_code == customer_code)\n        )\n        \n        if existing.scalar_one_or_none():\n            # If somehow exists, try with incremented number\n            next_number += 1\n            customer_code = f\"{CUSTOMER_ID_PREFIX}-{year_str}-{next_number:06d}\"\n        \n        logger.info(f\"Generated customer code: {customer_code}\")\n        return customer_code\n        \n    except Exception as e:\n        logger.error(f\"Error generating customer code: {e}\")\n        # Fallback: use timestamp-based code\n        timestamp = int(datetime.now().timestamp())\n        fallback_code = f\"{CUSTOMER_ID_PREFIX}-{year_str}-T{timestamp}\"\n        logger.warning(f\"Using fallback customer code: {fallback_code}\")\n        return fallback_code\n\nasync def is_customer_code_unique(session: AsyncSession, customer_code: str) -> bool:\n    \"\"\"Check if customer code is unique\"\"\"\n    try:\n        result = await session.execute(\n            select(User).where(User.customer_code == customer_code)\n        )\n        return result.scalar_one_or_none() is None\n    except Exception as e:\n        logger.error(f\"Error checking customer code uniqueness: {e}\")\n        return False\n\nasync def get_user_by_customer_code(session: AsyncSession, customer_code: str) -> User:\n    \"\"\"Get user by customer code\"\"\"\n    try:\n        result = await session.execute(\n            select(User).where(User.customer_code == customer_code)\n        )\n        return result.scalar_one_or_none()\n    except Exception as e:\n        logger.error(f\"Error getting user by customer code: {e}\")\n        return None\n","size_bytes":3239},"services/i18n.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nInternationalization service for multi-language support\nLoads and manages translation files for Arabic and English\n\"\"\"\n\nimport json\nimport logging\nfrom pathlib import Path\nfrom typing import Dict, Any\n\nlogger = logging.getLogger(__name__)\n\n# Global translations storage\ntranslations: Dict[str, Dict[str, str]] = {}\n\ndef load_translations():\n    \"\"\"Load translation files\"\"\"\n    global translations\n    \n    translations_dir = Path(\"translations\")\n    \n    try:\n        # Load Arabic translations\n        ar_file = translations_dir / \"ar.json\"\n        if ar_file.exists():\n            with open(ar_file, 'r', encoding='utf-8') as f:\n                translations['ar'] = json.load(f)\n        else:\n            logger.warning(\"Arabic translations file not found\")\n            translations['ar'] = {}\n        \n        # Load English translations\n        en_file = translations_dir / \"en.json\"\n        if en_file.exists():\n            with open(en_file, 'r', encoding='utf-8') as f:\n                translations['en'] = json.load(f)\n        else:\n            logger.warning(\"English translations file not found\")\n            translations['en'] = {}\n        \n        logger.info(f\"Loaded translations for {len(translations)} languages\")\n        \n    except Exception as e:\n        logger.error(f\"Error loading translations: {e}\")\n        # Initialize with empty dictionaries to prevent crashes\n        translations = {'ar': {}, 'en': {}}\n\ndef get_text(key: str, language: str = \"ar\", **kwargs) -> str:\n    \"\"\"Get translated text by key and language\"\"\"\n    if not translations:\n        load_translations()\n    \n    # Get translation for the language or fall back to Arabic\n    lang_dict = translations.get(language, {})\n    \n    # Get the text or fall back to Arabic, then to the key itself\n    text = lang_dict.get(key)\n    if text is None and language != \"ar\":\n        text = translations.get(\"ar\", {}).get(key)\n    if text is None:\n        text = f\"[{key}]\"  # Fallback to show missing translation\n    \n    # Format with provided arguments\n    try:\n        return text.format(**kwargs)\n    except (KeyError, ValueError) as e:\n        logger.warning(f\"Error formatting text '{key}' for language '{language}': {e}\")\n        return text\n\ndef get_user_language(language_code: str = None) -> str:\n    \"\"\"Get user's language code with fallback\"\"\"\n    if language_code and language_code in translations:\n        return language_code\n    return \"ar\"  # Default to Arabic\n\ndef get_available_languages() -> list:\n    \"\"\"Get list of available languages\"\"\"\n    if not translations:\n        load_translations()\n    return list(translations.keys())\n\ndef is_rtl_language(language_code: str) -> bool:\n    \"\"\"Check if language is right-to-left\"\"\"\n    rtl_languages = ['ar', 'he', 'fa', 'ur']\n    return language_code in rtl_languages\n\n# Load translations on module import\nload_translations()\n","size_bytes":2898},"utils/auth.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nAuthentication utilities for admin verification\nHandles admin permission checks and decorators\n\"\"\"\n\nimport logging\nfrom functools import wraps\nfrom typing import Callable, Any\nfrom aiogram.types import Message, CallbackQuery\n\nfrom config import ADMIN_USER_IDS\nfrom services.i18n import get_text\n\nlogger = logging.getLogger(__name__)\n\ndef is_admin(user_id: int) -> bool:\n    \"\"\"Check if user is an admin\"\"\"\n    return user_id in ADMIN_USER_IDS\n\ndef admin_required(func: Callable) -> Callable:\n    \"\"\"Decorator to require admin privileges\"\"\"\n    @wraps(func)\n    async def wrapper(*args, **kwargs):\n        # Extract user from message or callback\n        user_id = None\n        message_obj = None\n        \n        for arg in args:\n            if isinstance(arg, Message):\n                user_id = arg.from_user.id\n                message_obj = arg\n                break\n            elif isinstance(arg, CallbackQuery):\n                user_id = arg.from_user.id\n                message_obj = arg.message if hasattr(arg, 'message') else arg\n                break\n        \n        if not user_id:\n            logger.warning(\"Could not extract user ID from arguments\")\n            return\n        \n        if not is_admin(user_id):\n            logger.warning(f\"Unauthorized admin access attempt by user {user_id}\")\n            \n            # Send unauthorized message\n            error_text = get_text(\"unauthorized_access\", \"ar\")\n            \n            if isinstance(message_obj, Message):\n                await message_obj.answer(error_text)\n            elif hasattr(message_obj, 'answer'):\n                await message_obj.answer(error_text)\n            elif hasattr(message_obj, 'message') and hasattr(message_obj.message, 'answer'):\n                await message_obj.message.answer(error_text)\n            \n            return\n        \n        # User is admin, proceed with function\n        return await func(*args, **kwargs)\n    \n    return wrapper\n\nasync def check_admin_permissions(user_id: int, required_level: str = \"basic\") -> bool:\n    \"\"\"Check admin permissions with different levels\"\"\"\n    if not is_admin(user_id):\n        return False\n    \n    # For now, all admins have the same level\n    # You can extend this to have different admin levels\n    return True\n\ndef get_admin_level(user_id: int) -> str:\n    \"\"\"Get admin level for user\"\"\"\n    if not is_admin(user_id):\n        return \"none\"\n    \n    # For now, all admins are \"super_admin\"\n    # You can extend this based on your needs\n    return \"super_admin\"\n\nasync def log_admin_action(user_id: int, action: str, details: str = \"\"):\n    \"\"\"Log admin actions for audit trail\"\"\"\n    logger.info(f\"Admin action - User: {user_id}, Action: {action}, Details: {details}\")\n    \n    # You can extend this to save to database for audit trail\n    # Example:\n    # async with session_maker() as session:\n    #     audit_log = AdminAuditLog(\n    #         admin_user_id=user_id,\n    #         action=action,\n    #         details=details,\n    #         timestamp=datetime.now(timezone.utc)\n    #     )\n    #     session.add(audit_log)\n    #     await session.commit()\n\nclass AdminContext:\n    \"\"\"Context manager for admin operations\"\"\"\n    \n    def __init__(self, user_id: int, action: str):\n        self.user_id = user_id\n        self.action = action\n        self.start_time = None\n    \n    async def __aenter__(self):\n        if not is_admin(self.user_id):\n            raise PermissionError(f\"User {self.user_id} is not an admin\")\n        \n        await log_admin_action(self.user_id, f\"Started: {self.action}\")\n        return self\n    \n    async def __aexit__(self, exc_type, exc_val, exc_tb):\n        if exc_type:\n            await log_admin_action(\n                self.user_id, \n                f\"Failed: {self.action}\",\n                f\"Error: {exc_val}\"\n            )\n        else:\n            await log_admin_action(self.user_id, f\"Completed: {self.action}\")\n\n# Example usage of AdminContext:\n# async with AdminContext(user_id, \"broadcast_creation\"):\n#     # Perform admin operation\n#     pass\n","size_bytes":4083},"utils/keyboards.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nKeyboard utilities for creating inline and reply keyboards\nHandles all keyboard layouts for different bot functions\n\"\"\"\n\nfrom typing import List, Optional\nfrom aiogram.types import (\n    ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, \n    InlineKeyboardButton\n)\nfrom aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder\n\nfrom services.i18n import get_text\n\ndef get_main_menu_keyboard(language: str = \"ar\") -> ReplyKeyboardMarkup:\n    \"\"\"Create main menu reply keyboard\"\"\"\n    builder = ReplyKeyboardBuilder()\n    \n    # Main action buttons - 2 per row\n    builder.row(\n        KeyboardButton(text=get_text(\"deposit\", language)),\n        KeyboardButton(text=get_text(\"withdraw\", language))\n    )\n    \n    builder.row(\n        KeyboardButton(text=get_text(\"complaints\", language)),\n        KeyboardButton(text=get_text(\"support\", language))\n    )\n    \n    builder.row(\n        KeyboardButton(text=get_text(\"manager\", language)),\n        KeyboardButton(text=get_text(\"plans\", language))\n    )\n    \n    builder.row(\n        KeyboardButton(text=get_text(\"sales\", language)),\n        KeyboardButton(text=get_text(\"settings\", language))\n    )\n    \n    # Bottom navigation buttons\n    builder.row(\n        KeyboardButton(text=get_text(\"back\", language)),\n        KeyboardButton(text=get_text(\"forward\", language)),\n        KeyboardButton(text=get_text(\"my_account\", language))\n    )\n    \n    return builder.as_markup(resize_keyboard=True, one_time_keyboard=False)\n\ndef get_phone_share_keyboard(language: str = \"ar\") -> ReplyKeyboardMarkup:\n    \"\"\"Create phone sharing keyboard\"\"\"\n    builder = ReplyKeyboardBuilder()\n    \n    builder.row(\n        KeyboardButton(\n            text=get_text(\"share_phone\", language),\n            request_contact=True\n        )\n    )\n    \n    return builder.as_markup(resize_keyboard=True, one_time_keyboard=True)\n\ndef get_contact_confirmation_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create contact confirmation keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"confirm\", language),\n            callback_data=\"confirm_phone\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_settings_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create settings menu keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"change_language\", language),\n            callback_data=\"change_language\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"change_country\", language),\n            callback_data=\"change_country\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"toggle_notifications\", language),\n            callback_data=\"toggle_notifications\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_language_selection_keyboard(languages, current_language: str, \n                                  ui_language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create language selection keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    for lang in languages:\n        # Add checkmark for current language\n        text = lang.native_name\n        if lang.code == current_language:\n            text = f\"âœ… {text}\"\n        \n        builder.row(\n            InlineKeyboardButton(\n                text=text,\n                callback_data=f\"lang_{lang.code}\"\n            )\n        )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", ui_language),\n            callback_data=\"back_to_settings\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_country_selection_keyboard(countries, current_country: str,\n                                 ui_language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create country selection keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    for country in countries:\n        # Add checkmark for current country\n        text = country.native_name\n        if country.code == current_country:\n            text = f\"âœ… {text}\"\n        \n        builder.row(\n            InlineKeyboardButton(\n                text=text,\n                callback_data=f\"country_{country.code}\"\n            )\n        )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", ui_language),\n            callback_data=\"back_to_settings\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_admin_panel_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create admin panel keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"admin_users\", language),\n            callback_data=\"admin_users\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"admin_languages\", language),\n            callback_data=\"admin_languages\"\n        ),\n        InlineKeyboardButton(\n            text=get_text(\"admin_countries\", language),\n            callback_data=\"admin_countries\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"admin_broadcast\", language),\n            callback_data=\"admin_broadcast\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"admin_outbox\", language),\n            callback_data=\"admin_outbox\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_admin_users_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create admin users management keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"search_users\", language),\n            callback_data=\"search_users\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"user_statistics\", language),\n            callback_data=\"user_statistics\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"back_to_admin\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_admin_languages_keyboard(languages, language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create admin languages management keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    # Show toggle buttons for each language\n    for lang in languages[:5]:  # Limit to 5 to avoid too long keyboards\n        status_text = \"âœ…\" if lang.is_active else \"âŒ\"\n        builder.row(\n            InlineKeyboardButton(\n                text=f\"{status_text} {lang.native_name}\",\n                callback_data=f\"toggle_lang_{lang.id}\"\n            )\n        )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"add_language\", language),\n            callback_data=\"add_language\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"back_to_admin\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_admin_countries_keyboard(countries, language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create admin countries management keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    # Show toggle buttons for each country\n    for country in countries[:5]:  # Limit to 5 to avoid too long keyboards\n        status_text = \"âœ…\" if country.is_active else \"âŒ\"\n        builder.row(\n            InlineKeyboardButton(\n                text=f\"{status_text} {country.native_name}\",\n                callback_data=f\"toggle_country_{country.id}\"\n            )\n        )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"add_country\", language),\n            callback_data=\"add_country\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"back_to_admin\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_user_management_keyboard(user_id: int, language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create user management keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"ban_user\", language),\n            callback_data=f\"ban_user_{user_id}\"\n        ),\n        InlineKeyboardButton(\n            text=get_text(\"unban_user\", language),\n            callback_data=f\"unban_user_{user_id}\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"promote_admin\", language),\n            callback_data=f\"promote_admin_{user_id}\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"admin_users\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_pagination_keyboard(base_callback: str, current_page: int, \n                          total_pages: int, language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create pagination keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    buttons = []\n    \n    # Previous button\n    if current_page > 0:\n        buttons.append(\n            InlineKeyboardButton(\n                text=\"â—€ï¸\",\n                callback_data=f\"{base_callback}_page_{current_page - 1}\"\n            )\n        )\n    \n    # Current page indicator\n    buttons.append(\n        InlineKeyboardButton(\n            text=f\"{current_page + 1}/{total_pages}\",\n            callback_data=\"noop\"\n        )\n    )\n    \n    # Next button\n    if current_page < total_pages - 1:\n        buttons.append(\n            InlineKeyboardButton(\n                text=\"â–¶ï¸\",\n                callback_data=f\"{base_callback}_page_{current_page + 1}\"\n            )\n        )\n    \n    builder.row(*buttons)\n    \n    # Back button\n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"back_to_admin\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_broadcast_targeting_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create broadcast targeting keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"broadcast_all\", language),\n            callback_data=\"broadcast_all\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"broadcast_by_language\", language),\n            callback_data=\"broadcast_by_language\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"broadcast_by_country\", language),\n            callback_data=\"broadcast_by_country\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_broadcast_confirmation_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create broadcast confirmation keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"confirm_broadcast\", language),\n            callback_data=\"confirm_broadcast\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"cancel_broadcast\", language),\n            callback_data=\"cancel_broadcast\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_language_filter_keyboard(languages, ui_language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create language filter keyboard for broadcasts\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    for lang_code, lang_name, user_count in languages:\n        builder.row(\n            InlineKeyboardButton(\n                text=f\"{lang_name} ({user_count})\",\n                callback_data=f\"lang_filter_{lang_code}\"\n            )\n        )\n    \n    return builder.as_markup()\n\ndef get_country_filter_keyboard(countries, ui_language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create country filter keyboard for broadcasts\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    for country_code, country_name, user_count in countries:\n        builder.row(\n            InlineKeyboardButton(\n                text=f\"{country_name} ({user_count})\",\n                callback_data=f\"country_filter_{country_code}\"\n            )\n        )\n    \n    return builder.as_markup()\n\ndef get_announcement_menu_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create announcement menu keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"skip_image\", language),\n            callback_data=\"skip_image\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_announcement_targeting_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create announcement targeting keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"announce_all\", language),\n            callback_data=\"announce_all\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"announce_by_language\", language),\n            callback_data=\"announce_by_language\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_announcement_duration_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create announcement duration keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"duration_1h\", language),\n            callback_data=\"duration_1h\"\n        ),\n        InlineKeyboardButton(\n            text=get_text(\"duration_6h\", language),\n            callback_data=\"duration_6h\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"duration_24h\", language),\n            callback_data=\"duration_24h\"\n        ),\n        InlineKeyboardButton(\n            text=get_text(\"duration_7d\", language),\n            callback_data=\"duration_7d\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"duration_permanent\", language),\n            callback_data=\"duration_permanent\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_announcement_confirmation_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create announcement confirmation keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"confirm_announcement\", language),\n            callback_data=\"confirm_announcement\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"cancel_announcement\", language),\n            callback_data=\"cancel_announcement\"\n        )\n    )\n    \n    return builder.as_markup()\n","size_bytes":14747},"backup_server_files/handlers/admin.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nAdmin handler for administrative functions\nHandles admin panel, user management, language/country management\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone\nfrom aiogram import Router, F\nfrom aiogram.filters import Command\nfrom aiogram.types import Message, CallbackQuery\nfrom aiogram.fsm.context import FSMContext\nfrom aiogram.fsm.state import State, StatesGroup\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select, func, desc\n\nfrom models import User, Language, Country, Outbox, OutboxType, OutboxStatus\nfrom services.i18n import get_text, get_user_language\nfrom utils.auth import admin_required\nfrom utils.keyboards import (\n    get_admin_panel_keyboard, get_admin_users_keyboard,\n    get_admin_languages_keyboard, get_admin_countries_keyboard,\n    get_user_management_keyboard, get_pagination_keyboard\n)\nfrom config import USERS_PER_PAGE\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\nclass AdminStates(StatesGroup):\n    managing_user = State()\n    adding_language = State()\n    adding_country = State()\n    viewing_outbox = State()\n\n@router.message(Command(\"admin\"))\n@admin_required\nasync def show_admin_panel(message: Message, session_maker):\n    \"\"\"Show admin panel\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get statistics\n            total_users = await session.scalar(select(func.count(User.id)))\n            active_users = await session.scalar(\n                select(func.count(User.id)).where(User.is_active == True)\n            )\n            pending_requests = await session.scalar(\n                select(func.count(Outbox.id)).where(Outbox.status == OutboxStatus.PENDING)\n            )\n            \n            admin_text = get_text(\"admin_panel\", \"ar\").format(\n                total_users=total_users,\n                active_users=active_users,\n                pending_requests=pending_requests\n            )\n            \n            await message.answer(\n                admin_text,\n                reply_markup=get_admin_panel_keyboard(\"ar\")\n            )\n            \n        except Exception as e:\n            logger.error(f\"Error showing admin panel: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"admin_users\")\n@admin_required\nasync def show_users_list(callback: CallbackQuery, session_maker):\n    \"\"\"Show users list with pagination\"\"\"\n    await show_users_page(callback, session_maker, 0)\n\n@router.callback_query(F.data.startswith(\"admin_users_page_\"))\n@admin_required\nasync def show_users_page(callback: CallbackQuery, session_maker, page: int = None):\n    \"\"\"Show specific page of users\"\"\"\n    async with session_maker() as session:\n        try:\n            if page is None:\n                page = int(callback.data.split(\"_\")[-1])\n            \n            offset = page * USERS_PER_PAGE\n            \n            # Get users with pagination\n            result = await session.execute(\n                select(User)\n                .order_by(desc(User.created_at))\n                .offset(offset)\n                .limit(USERS_PER_PAGE)\n            )\n            users = result.scalars().all()\n            \n            # Get total count for pagination\n            total_users = await session.scalar(select(func.count(User.id)))\n            total_pages = (total_users + USERS_PER_PAGE - 1) // USERS_PER_PAGE\n            \n            if not users:\n                await callback.message.edit_text(\n                    get_text(\"no_users_found\", \"ar\")\n                )\n                await callback.answer()\n                return\n            \n            # Format users list\n            users_text = get_text(\"users_list_header\", \"ar\").format(\n                page=page + 1,\n                total_pages=total_pages,\n                total_users=total_users\n            )\n            \n            for user in users:\n                status = \"ğŸŸ¢\" if user.is_active else \"ğŸ”´\"\n                banned = \"ğŸš«\" if user.is_banned else \"\"\n                admin_mark = \"ğŸ‘‘\" if user.is_admin else \"\"\n                \n                users_text += f\"\\n\\n{status} {admin_mark} {banned}\\n\"\n                users_text += f\"ID: {user.telegram_id}\\n\"\n                users_text += f\"Name: {user.first_name}\"\n                if user.last_name:\n                    users_text += f\" {user.last_name}\"\n                if user.username:\n                    users_text += f\" (@{user.username})\"\n                users_text += f\"\\nCustomer: {user.customer_code or 'N/A'}\"\n                users_text += f\"\\nLang: {user.language_code} | Country: {user.country_code}\"\n                users_text += f\"\\nJoined: {user.created_at.strftime('%Y-%m-%d')}\"\n            \n            keyboard = get_pagination_keyboard(\"admin_users\", page, total_pages, \"ar\")\n            \n            await callback.message.edit_text(\n                users_text,\n                reply_markup=keyboard\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing users page: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"admin_languages\")\n@admin_required\nasync def show_languages_management(callback: CallbackQuery, session_maker):\n    \"\"\"Show languages management\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get all languages\n            result = await session.execute(\n                select(Language).order_by(Language.name)\n            )\n            languages = result.scalars().all()\n            \n            if not languages:\n                await callback.message.edit_text(\n                    get_text(\"no_languages_found\", \"ar\"),\n                    reply_markup=get_admin_languages_keyboard([], \"ar\")\n                )\n                await callback.answer()\n                return\n            \n            # Format languages list\n            languages_text = get_text(\"languages_list\", \"ar\")\n            \n            for lang in languages:\n                status = \"âœ…\" if lang.is_active else \"âŒ\"\n                rtl_mark = \"ğŸ”„\" if lang.rtl else \"\"\n                \n                languages_text += f\"\\n\\n{status} {rtl_mark}\\n\"\n                languages_text += f\"Code: {lang.code}\\n\"\n                languages_text += f\"Name: {lang.name}\\n\"\n                languages_text += f\"Native: {lang.native_name}\\n\"\n                languages_text += f\"RTL: {'Yes' if lang.rtl else 'No'}\\n\"\n                languages_text += f\"Created: {lang.created_at.strftime('%Y-%m-%d')}\"\n            \n            await callback.message.edit_text(\n                languages_text,\n                reply_markup=get_admin_languages_keyboard(languages, \"ar\")\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing languages: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"admin_countries\")\n@admin_required\nasync def show_countries_management(callback: CallbackQuery, session_maker):\n    \"\"\"Show countries management\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get all countries\n            result = await session.execute(\n                select(Country).order_by(Country.name)\n            )\n            countries = result.scalars().all()\n            \n            if not countries:\n                await callback.message.edit_text(\n                    get_text(\"no_countries_found\", \"ar\"),\n                    reply_markup=get_admin_countries_keyboard([], \"ar\")\n                )\n                await callback.answer()\n                return\n            \n            # Format countries list\n            countries_text = get_text(\"countries_list\", \"ar\")\n            \n            for country in countries:\n                status = \"âœ…\" if country.is_active else \"âŒ\"\n                \n                countries_text += f\"\\n\\n{status}\\n\"\n                countries_text += f\"Code: {country.code}\\n\"\n                countries_text += f\"Name: {country.name}\\n\"\n                countries_text += f\"Native: {country.native_name}\\n\"\n                countries_text += f\"Phone: {country.phone_prefix}\\n\"\n                countries_text += f\"Created: {country.created_at.strftime('%Y-%m-%d')}\"\n            \n            await callback.message.edit_text(\n                countries_text,\n                reply_markup=get_admin_countries_keyboard(countries, \"ar\")\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing countries: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"admin_outbox\")\n@admin_required\nasync def show_outbox_management(callback: CallbackQuery, session_maker):\n    \"\"\"Show outbox/requests management\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get pending requests\n            result = await session.execute(\n                select(Outbox)\n                .where(Outbox.status == OutboxStatus.PENDING)\n                .order_by(desc(Outbox.created_at))\n                .limit(10)\n            )\n            requests = result.scalars().all()\n            \n            if not requests:\n                await callback.message.edit_text(\n                    get_text(\"no_pending_requests\", \"ar\")\n                )\n                await callback.answer()\n                return\n            \n            # Format requests list\n            requests_text = get_text(\"pending_requests_header\", \"ar\")\n            \n            for req in requests:\n                type_emoji = {\n                    OutboxType.DEPOSIT: \"ğŸ’°\",\n                    OutboxType.WITHDRAWAL: \"ğŸ’¸\", \n                    OutboxType.COMPLAINT: \"ğŸ“¨\",\n                    OutboxType.SUPPORT: \"ğŸ†˜\"\n                }.get(req.type, \"ğŸ“„\")\n                \n                requests_text += f\"\\n\\n{type_emoji} ID: {req.id}\\n\"\n                requests_text += f\"Type: {req.type.value.title()}\\n\"\n                requests_text += f\"User ID: {req.user_id}\\n\"\n                if req.subject:\n                    requests_text += f\"Subject: {req.subject}\\n\"\n                requests_text += f\"Content: {req.content[:100]}...\\n\" if len(req.content) > 100 else f\"Content: {req.content}\\n\"\n                requests_text += f\"Created: {req.created_at.strftime('%Y-%m-%d %H:%M')}\"\n            \n            await callback.message.edit_text(requests_text)\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing outbox: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data.startswith(\"toggle_lang_\"))\n@admin_required\nasync def toggle_language_status(callback: CallbackQuery, session_maker):\n    \"\"\"Toggle language active status\"\"\"\n    async with session_maker() as session:\n        try:\n            lang_id = int(callback.data.split(\"_\")[-1])\n            \n            # Get language\n            result = await session.execute(\n                select(Language).where(Language.id == lang_id)\n            )\n            language = result.scalar_one_or_none()\n            \n            if not language:\n                await callback.answer(get_text(\"language_not_found\", \"ar\"))\n                return\n            \n            # Toggle status\n            language.is_active = not language.is_active\n            language.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            status = \"activated\" if language.is_active else \"deactivated\"\n            await callback.answer(f\"Language {language.name} {status}\")\n            \n            # Refresh the languages list\n            await show_languages_management(callback, session_maker)\n            \n        except Exception as e:\n            logger.error(f\"Error toggling language: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data.startswith(\"toggle_country_\"))\n@admin_required\nasync def toggle_country_status(callback: CallbackQuery, session_maker):\n    \"\"\"Toggle country active status\"\"\"\n    async with session_maker() as session:\n        try:\n            country_id = int(callback.data.split(\"_\")[-1])\n            \n            # Get country\n            result = await session.execute(\n                select(Country).where(Country.id == country_id)\n            )\n            country = result.scalar_one_or_none()\n            \n            if not country:\n                await callback.answer(get_text(\"country_not_found\", \"ar\"))\n                return\n            \n            # Toggle status\n            country.is_active = not country.is_active\n            country.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            status = \"activated\" if country.is_active else \"deactivated\"\n            await callback.answer(f\"Country {country.name} {status}\")\n            \n            # Refresh the countries list\n            await show_countries_management(callback, session_maker)\n            \n        except Exception as e:\n            logger.error(f\"Error toggling country: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"back_to_admin\")\n@admin_required\nasync def back_to_admin_panel(callback: CallbackQuery, session_maker):\n    \"\"\"Go back to admin panel\"\"\"\n    await show_admin_panel(callback.message, session_maker)\n    await callback.answer()\n","size_bytes":13605},"backup_server_files/handlers/announcements.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nAnnouncements handler for system announcements\nHandles announcement creation, scheduling, and delivery\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone, timedelta\nfrom aiogram import Router, F\nfrom aiogram.types import Message, CallbackQuery\nfrom aiogram.fsm.context import FSMContext\nfrom aiogram.fsm.state import State, StatesGroup\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select, func\n\nfrom models import Announcement, AnnouncementDelivery, User\nfrom services.i18n import get_text\nfrom utils.auth import admin_required\nfrom utils.keyboards import (\n    get_announcement_menu_keyboard, get_announcement_targeting_keyboard,\n    get_announcement_duration_keyboard, get_announcement_confirmation_keyboard\n)\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\nclass AnnouncementStates(StatesGroup):\n    entering_title_ar = State()\n    entering_title_en = State()\n    entering_content_ar = State()\n    entering_content_en = State()\n    adding_image = State()\n    selecting_target = State()\n    setting_duration = State()\n    confirming = State()\n\n@router.message(F.text == \"/announce_new\")\n@admin_required\nasync def start_announcement_creation(message: Message, state: FSMContext):\n    \"\"\"Start announcement creation process\"\"\"\n    await message.answer(\n        get_text(\"announcement_enter_title_ar\", \"ar\")\n    )\n    await state.set_state(AnnouncementStates.entering_title_ar)\n\n@router.message(AnnouncementStates.entering_title_ar)\n@admin_required\nasync def receive_title_arabic(message: Message, state: FSMContext):\n    \"\"\"Receive Arabic title\"\"\"\n    title_ar = message.text.strip()\n    \n    if not title_ar:\n        await message.answer(get_text(\"title_required\", \"ar\"))\n        return\n    \n    await state.update_data(title_ar=title_ar)\n    await message.answer(get_text(\"announcement_enter_title_en\", \"ar\"))\n    await state.set_state(AnnouncementStates.entering_title_en)\n\n@router.message(AnnouncementStates.entering_title_en)\n@admin_required\nasync def receive_title_english(message: Message, state: FSMContext):\n    \"\"\"Receive English title\"\"\"\n    title_en = message.text.strip()\n    \n    if not title_en:\n        await message.answer(get_text(\"title_required\", \"ar\"))\n        return\n    \n    await state.update_data(title_en=title_en)\n    await message.answer(get_text(\"announcement_enter_content_ar\", \"ar\"))\n    await state.set_state(AnnouncementStates.entering_content_ar)\n\n@router.message(AnnouncementStates.entering_content_ar)\n@admin_required\nasync def receive_content_arabic(message: Message, state: FSMContext):\n    \"\"\"Receive Arabic content\"\"\"\n    content_ar = message.text.strip()\n    \n    if not content_ar:\n        await message.answer(get_text(\"content_required\", \"ar\"))\n        return\n    \n    await state.update_data(content_ar=content_ar)\n    await message.answer(get_text(\"announcement_enter_content_en\", \"ar\"))\n    await state.set_state(AnnouncementStates.entering_content_en)\n\n@router.message(AnnouncementStates.entering_content_en)\n@admin_required\nasync def receive_content_english(message: Message, state: FSMContext):\n    \"\"\"Receive English content\"\"\"\n    content_en = message.text.strip()\n    \n    if not content_en:\n        await message.answer(get_text(\"content_required\", \"ar\"))\n        return\n    \n    await state.update_data(content_en=content_en)\n    \n    # Ask for optional image\n    await message.answer(\n        get_text(\"announcement_add_image_optional\", \"ar\"),\n        reply_markup=get_announcement_menu_keyboard(\"ar\")\n    )\n    await state.set_state(AnnouncementStates.adding_image)\n\n@router.callback_query(AnnouncementStates.adding_image, F.data == \"skip_image\")\n@admin_required\nasync def skip_image(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Skip image and proceed to targeting\"\"\"\n    await callback.message.edit_text(\n        get_text(\"announcement_select_target\", \"ar\"),\n        reply_markup=get_announcement_targeting_keyboard(\"ar\")\n    )\n    await state.set_state(AnnouncementStates.selecting_target)\n    await callback.answer()\n\n@router.message(AnnouncementStates.adding_image, F.photo)\n@admin_required\nasync def receive_announcement_image(message: Message, state: FSMContext):\n    \"\"\"Receive announcement image\"\"\"\n    try:\n        # Get the largest photo\n        photo = message.photo[-1]\n        file_id = photo.file_id\n        \n        await state.update_data(image_file_id=file_id)\n        \n        await message.answer(\n            get_text(\"image_added_successfully\", \"ar\"),\n            reply_markup=get_announcement_targeting_keyboard(\"ar\")\n        )\n        await state.set_state(AnnouncementStates.selecting_target)\n        \n    except Exception as e:\n        logger.error(f\"Error receiving image: {e}\")\n        await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(AnnouncementStates.selecting_target, F.data == \"announce_all\")\n@admin_required\nasync def target_all_users(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Target all users for announcement\"\"\"\n    async with session_maker() as session:\n        try:\n            total_users = await session.scalar(\n                select(func.count(User.id)).where(User.is_active == True)\n            )\n            \n            await state.update_data(target_type=\"all\", target_value=None)\n            \n            await callback.message.edit_text(\n                get_text(\"announcement_set_duration\", \"ar\").format(\n                    target=f\"All users ({total_users})\"\n                ),\n                reply_markup=get_announcement_duration_keyboard(\"ar\")\n            )\n            await state.set_state(AnnouncementStates.setting_duration)\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error targeting all users: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(AnnouncementStates.selecting_target, F.data == \"announce_by_language\")\n@admin_required\nasync def target_by_language(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Target by language selection (simplified - you can expand this)\"\"\"\n    await state.update_data(target_type=\"language\", target_value=\"ar\")  # Default to Arabic\n    \n    await callback.message.edit_text(\n        get_text(\"announcement_set_duration\", \"ar\").format(\n            target=\"Arabic speakers\"\n        ),\n        reply_markup=get_announcement_duration_keyboard(\"ar\")\n    )\n    await state.set_state(AnnouncementStates.setting_duration)\n    await callback.answer()\n\n@router.callback_query(AnnouncementStates.setting_duration, F.data.startswith(\"duration_\"))\n@admin_required\nasync def set_announcement_duration(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Set announcement duration\"\"\"\n    duration_str = callback.data.split(\"_\")[1]\n    \n    # Convert duration to hours\n    duration_mapping = {\n        \"1h\": 1,\n        \"6h\": 6,\n        \"24h\": 24,\n        \"7d\": 168,  # 7 days in hours\n        \"permanent\": 0  # 0 means permanent\n    }\n    \n    duration_hours = duration_mapping.get(duration_str, 0)\n    await state.update_data(duration_hours=duration_hours)\n    \n    # Show confirmation\n    await show_announcement_confirmation(callback, state)\n\nasync def show_announcement_confirmation(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Show announcement confirmation\"\"\"\n    try:\n        data = await state.get_data()\n        \n        duration_text = \"\"\n        if data[\"duration_hours\"] == 0:\n            duration_text = \"Permanent\"\n        else:\n            duration_text = f\"{data['duration_hours']} hours\"\n        \n        target_text = \"\"\n        if data[\"target_type\"] == \"all\":\n            target_text = \"All active users\"\n        elif data[\"target_type\"] == \"language\":\n            target_text = f\"Language: {data.get('target_value', 'N/A')}\"\n        \n        confirmation_text = get_text(\"announcement_confirmation\", \"ar\").format(\n            title_ar=data[\"title_ar\"],\n            title_en=data[\"title_en\"],\n            content_ar=data[\"content_ar\"][:100] + \"...\" if len(data[\"content_ar\"]) > 100 else data[\"content_ar\"],\n            content_en=data[\"content_en\"][:100] + \"...\" if len(data[\"content_en\"]) > 100 else data[\"content_en\"],\n            target=target_text,\n            duration=duration_text,\n            has_image=\"Yes\" if data.get(\"image_file_id\") else \"No\"\n        )\n        \n        await callback.message.edit_text(\n            confirmation_text,\n            reply_markup=get_announcement_confirmation_keyboard(\"ar\")\n        )\n        await state.set_state(AnnouncementStates.confirming)\n        await callback.answer()\n        \n    except Exception as e:\n        logger.error(f\"Error showing confirmation: {e}\")\n        await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(AnnouncementStates.confirming, F.data == \"confirm_announcement\")\n@admin_required\nasync def confirm_announcement(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Confirm and create announcement\"\"\"\n    async with session_maker() as session:\n        try:\n            data = await state.get_data()\n            \n            # Calculate expiration time\n            expires_at = None\n            if data[\"duration_hours\"] > 0:\n                expires_at = datetime.now(timezone.utc) + timedelta(hours=data[\"duration_hours\"])\n            \n            # Create announcement\n            announcement = Announcement(\n                title_ar=data[\"title_ar\"],\n                title_en=data[\"title_en\"],\n                content_ar=data[\"content_ar\"],\n                content_en=data[\"content_en\"],\n                image_url=data.get(\"image_file_id\"),  # Store file_id as URL for simplicity\n                display_duration=data[\"duration_hours\"],\n                target_language=data.get(\"target_value\") if data[\"target_type\"] == \"language\" else None,\n                expires_at=expires_at,\n                scheduled_at=datetime.now(timezone.utc)\n            )\n            \n            session.add(announcement)\n            await session.flush()  # Get the ID\n            \n            # Create delivery records for target users\n            if data[\"target_type\"] == \"all\":\n                # Get all active users\n                result = await session.execute(\n                    select(User.id).where(User.is_active == True)\n                )\n                user_ids = [row[0] for row in result.fetchall()]\n            elif data[\"target_type\"] == \"language\":\n                # Get users by language\n                result = await session.execute(\n                    select(User.id).where(\n                        User.is_active == True,\n                        User.language_code == data[\"target_value\"]\n                    )\n                )\n                user_ids = [row[0] for row in result.fetchall()]\n            else:\n                user_ids = []\n            \n            # Create delivery records\n            for user_id in user_ids:\n                delivery = AnnouncementDelivery(\n                    announcement_id=announcement.id,\n                    user_id=user_id\n                )\n                session.add(delivery)\n            \n            await session.commit()\n            \n            await callback.message.edit_text(\n                get_text(\"announcement_created\", \"ar\").format(\n                    announcement_id=announcement.id,\n                    target_count=len(user_ids)\n                )\n            )\n            \n            await state.clear()\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error creating announcement: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(AnnouncementStates.confirming, F.data == \"cancel_announcement\")\n@admin_required\nasync def cancel_announcement(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Cancel announcement creation\"\"\"\n    await callback.message.edit_text(\n        get_text(\"announcement_cancelled\", \"ar\")\n    )\n    await state.clear()\n    await callback.answer()\n","size_bytes":12080},"backup_server_files/handlers/broadcast.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBroadcast handler for mass messaging\nHandles broadcast creation, targeting, and delivery management\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone\nfrom aiogram import Router, F\nfrom aiogram.types import Message, CallbackQuery, InputMediaPhoto\nfrom aiogram.fsm.context import FSMContext\nfrom aiogram.fsm.state import State, StatesGroup\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select, func\n\nfrom models import User, Outbox, OutboxType, OutboxStatus, Language, Country\nfrom services.i18n import get_text\nfrom utils.auth import admin_required\nfrom utils.keyboards import (\n    get_broadcast_targeting_keyboard, get_broadcast_confirmation_keyboard,\n    get_language_filter_keyboard, get_country_filter_keyboard\n)\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\nclass BroadcastStates(StatesGroup):\n    selecting_target = State()\n    entering_message = State()\n    adding_media = State()\n    confirming = State()\n\n@router.message(F.text == \"/broadcast\")\n@admin_required\nasync def start_broadcast(message: Message, state: FSMContext, session_maker):\n    \"\"\"Start broadcast creation process\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get statistics for targeting options\n            total_users = await session.scalar(\n                select(func.count(User.id)).where(User.is_active == True)\n            )\n            \n            # Get language distribution\n            lang_result = await session.execute(\n                select(User.language_code, func.count(User.id))\n                .where(User.is_active == True)\n                .group_by(User.language_code)\n            )\n            lang_stats = dict(lang_result.fetchall())\n            \n            # Get country distribution\n            country_result = await session.execute(\n                select(User.country_code, func.count(User.id))\n                .where(User.is_active == True)\n                .group_by(User.country_code)\n            )\n            country_stats = dict(country_result.fetchall())\n            \n            # Format targeting options\n            stats_text = get_text(\"broadcast_targeting_stats\", \"ar\").format(\n                total_users=total_users,\n                lang_stats=\", \".join([f\"{k}: {v}\" for k, v in lang_stats.items()]),\n                country_stats=\", \".join([f\"{k}: {v}\" for k, v in country_stats.items()])\n            )\n            \n            await message.answer(\n                stats_text,\n                reply_markup=get_broadcast_targeting_keyboard(\"ar\")\n            )\n            \n            await state.set_state(BroadcastStates.selecting_target)\n            await state.update_data(\n                total_users=total_users,\n                lang_stats=lang_stats,\n                country_stats=country_stats\n            )\n            \n        except Exception as e:\n            logger.error(f\"Error starting broadcast: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.selecting_target, F.data == \"broadcast_all\")\n@admin_required\nasync def select_broadcast_all(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Select broadcast to all users\"\"\"\n    await state.update_data(target_type=\"all\")\n    await callback.message.edit_text(\n        get_text(\"broadcast_enter_message\", \"ar\")\n    )\n    await state.set_state(BroadcastStates.entering_message)\n    await callback.answer()\n\n@router.callback_query(BroadcastStates.selecting_target, F.data == \"broadcast_by_language\")\n@admin_required\nasync def select_broadcast_by_language(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Select broadcast by language\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get available languages with user counts\n            result = await session.execute(\n                select(Language.code, Language.native_name, func.count(User.id))\n                .join(User, User.language_code == Language.code)\n                .where(Language.is_active == True, User.is_active == True)\n                .group_by(Language.code, Language.native_name)\n            )\n            languages = result.fetchall()\n            \n            if not languages:\n                await callback.answer(get_text(\"no_languages_with_users\", \"ar\"))\n                return\n            \n            await callback.message.edit_text(\n                get_text(\"select_target_language\", \"ar\"),\n                reply_markup=get_language_filter_keyboard(languages, \"ar\")\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing language selection: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.selecting_target, F.data == \"broadcast_by_country\")\n@admin_required\nasync def select_broadcast_by_country(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Select broadcast by country\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get available countries with user counts\n            result = await session.execute(\n                select(Country.code, Country.native_name, func.count(User.id))\n                .join(User, User.country_code == Country.code)\n                .where(Country.is_active == True, User.is_active == True)\n                .group_by(Country.code, Country.native_name)\n            )\n            countries = result.fetchall()\n            \n            if not countries:\n                await callback.answer(get_text(\"no_countries_with_users\", \"ar\"))\n                return\n            \n            await callback.message.edit_text(\n                get_text(\"select_target_country\", \"ar\"),\n                reply_markup=get_country_filter_keyboard(countries, \"ar\")\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing country selection: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.selecting_target, F.data.startswith(\"lang_filter_\"))\n@admin_required\nasync def select_language_filter(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Select specific language for broadcast\"\"\"\n    language_code = callback.data.split(\"_\")[-1]\n    await state.update_data(target_type=\"language\", target_value=language_code)\n    \n    await callback.message.edit_text(\n        get_text(\"broadcast_enter_message\", \"ar\").format(\n            target=f\"Language: {language_code.upper()}\"\n        )\n    )\n    await state.set_state(BroadcastStates.entering_message)\n    await callback.answer()\n\n@router.callback_query(BroadcastStates.selecting_target, F.data.startswith(\"country_filter_\"))\n@admin_required\nasync def select_country_filter(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Select specific country for broadcast\"\"\"\n    country_code = callback.data.split(\"_\")[-1]\n    await state.update_data(target_type=\"country\", target_value=country_code)\n    \n    await callback.message.edit_text(\n        get_text(\"broadcast_enter_message\", \"ar\").format(\n            target=f\"Country: {country_code.upper()}\"\n        )\n    )\n    await state.set_state(BroadcastStates.entering_message)\n    await callback.answer()\n\n@router.message(BroadcastStates.entering_message)\n@admin_required\nasync def receive_broadcast_message(message: Message, state: FSMContext):\n    \"\"\"Receive broadcast message text\"\"\"\n    try:\n        broadcast_text = message.text or message.caption or \"\"\n        \n        if not broadcast_text.strip():\n            await message.answer(get_text(\"broadcast_message_required\", \"ar\"))\n            return\n        \n        # Store message data\n        await state.update_data(\n            message_text=broadcast_text,\n            message_entities=message.entities,\n            message_type=\"text\"\n        )\n        \n        # Check if message has media\n        if message.photo or message.video or message.document:\n            if message.photo:\n                file_id = message.photo[-1].file_id\n                await state.update_data(message_type=\"photo\", file_id=file_id)\n            elif message.video:\n                await state.update_data(message_type=\"video\", file_id=message.video.file_id)\n            elif message.document:\n                await state.update_data(message_type=\"document\", file_id=message.document.file_id)\n        \n        # Show confirmation\n        await show_broadcast_confirmation(message, state)\n        \n    except Exception as e:\n        logger.error(f\"Error receiving broadcast message: {e}\")\n        await message.answer(get_text(\"error_occurred\", \"ar\"))\n\nasync def show_broadcast_confirmation(message: Message, state: FSMContext):\n    \"\"\"Show broadcast confirmation with preview\"\"\"\n    try:\n        data = await state.get_data()\n        \n        # Calculate target audience\n        target_info = \"\"\n        if data[\"target_type\"] == \"all\":\n            target_info = f\"All active users ({data.get('total_users', '?')} users)\"\n        elif data[\"target_type\"] == \"language\":\n            lang_code = data[\"target_value\"]\n            user_count = data.get(\"lang_stats\", {}).get(lang_code, \"?\")\n            target_info = f\"Language: {lang_code.upper()} ({user_count} users)\"\n        elif data[\"target_type\"] == \"country\":\n            country_code = data[\"target_value\"]\n            user_count = data.get(\"country_stats\", {}).get(country_code, \"?\")\n            target_info = f\"Country: {country_code.upper()} ({user_count} users)\"\n        \n        confirmation_text = get_text(\"broadcast_confirmation\", \"ar\").format(\n            target=target_info,\n            message_preview=data[\"message_text\"][:200] + \"...\" if len(data[\"message_text\"]) > 200 else data[\"message_text\"]\n        )\n        \n        await message.answer(\n            confirmation_text,\n            reply_markup=get_broadcast_confirmation_keyboard(\"ar\")\n        )\n        \n        await state.set_state(BroadcastStates.confirming)\n        \n    except Exception as e:\n        logger.error(f\"Error showing confirmation: {e}\")\n        await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.confirming, F.data == \"confirm_broadcast\")\n@admin_required\nasync def confirm_broadcast(callback: CallbackQuery, state: FSMContext, session_maker, broadcast_service):\n    \"\"\"Confirm and start broadcast\"\"\"\n    async with session_maker() as session:\n        try:\n            data = await state.get_data()\n            \n            # Create outbox entry for broadcast\n            outbox = Outbox(\n                user_id=1,  # System user for broadcasts\n                type=OutboxType.BROADCAST,\n                status=OutboxStatus.PROCESSING,\n                subject=f\"Broadcast to {data['target_type']}\",\n                content=data[\"message_text\"]\n            )\n            session.add(outbox)\n            await session.flush()\n            \n            # Queue broadcast for delivery\n            await broadcast_service.queue_broadcast(\n                outbox_id=outbox.id,\n                target_type=data[\"target_type\"],\n                target_value=data.get(\"target_value\"),\n                message_text=data[\"message_text\"],\n                message_type=data.get(\"message_type\", \"text\"),\n                file_id=data.get(\"file_id\"),\n                message_entities=data.get(\"message_entities\")\n            )\n            \n            await session.commit()\n            \n            await callback.message.edit_text(\n                get_text(\"broadcast_queued\", \"ar\").format(\n                    broadcast_id=outbox.id\n                )\n            )\n            \n            await state.clear()\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error confirming broadcast: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(BroadcastStates.confirming, F.data == \"cancel_broadcast\")\n@admin_required\nasync def cancel_broadcast(callback: CallbackQuery, state: FSMContext):\n    \"\"\"Cancel broadcast\"\"\"\n    await callback.message.edit_text(\n        get_text(\"broadcast_cancelled\", \"ar\")\n    )\n    await state.clear()\n    await callback.answer()\n","size_bytes":12292},"backup_server_files/handlers/start.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nStart handler for user registration, phone verification, and main menu\nHandles /start command, phone number collection, and customer code generation\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone\nfrom aiogram import Router, F\nfrom aiogram.filters import Command, CommandStart\nfrom aiogram.types import Message, CallbackQuery, Contact\nfrom aiogram.fsm.context import FSMContext\nfrom aiogram.fsm.state import State, StatesGroup\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select\n\nfrom models import User\nfrom services.i18n import get_text, get_user_language\nfrom services.customer_id import generate_customer_code\nfrom utils.keyboards import (\n    get_main_menu_keyboard, get_phone_share_keyboard, \n    get_contact_confirmation_keyboard\n)\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\nclass RegistrationStates(StatesGroup):\n    waiting_for_phone = State()\n    confirming_phone = State()\n\n@router.message(CommandStart())\nasync def start_command(message: Message, state: FSMContext, session_maker):\n    \"\"\"Handle /start command and user registration\"\"\"\n    async with session_maker() as session:\n        try:\n            # Get or create user\n            user = await get_or_create_user(session, message.from_user)\n            await session.commit()\n            \n            # Get user's language for responses\n            lang = get_user_language(user.language_code)\n            \n            if not user.phone_number:\n                # First time user - request phone number\n                await message.answer(\n                    get_text(\"welcome_new_user\", lang).format(\n                        first_name=user.first_name\n                    ),\n                    reply_markup=get_phone_share_keyboard(lang)\n                )\n                await state.set_state(RegistrationStates.waiting_for_phone)\n            else:\n                # Returning user - show main menu\n                await show_main_menu(message, user, session)\n                \n        except Exception as e:\n            logger.error(f\"Error in start command: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(RegistrationStates.waiting_for_phone, F.contact)\nasync def handle_phone_contact(message: Message, state: FSMContext, session_maker):\n    \"\"\"Handle phone number shared via contact\"\"\"\n    async with session_maker() as session:\n        try:\n            contact: Contact = message.contact\n            \n            # Verify it's the user's own contact\n            if contact.user_id != message.from_user.id:\n                user = await get_user_by_telegram_id(session, message.from_user.id)\n                lang = get_user_language(user.language_code if user else \"ar\")\n                await message.answer(get_text(\"phone_must_be_yours\", lang))\n                return\n            \n            # Update user with phone number\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if user:\n                user.phone_number = contact.phone_number\n                user.updated_at = datetime.now(timezone.utc)\n                \n                # Generate customer code if not exists\n                if not user.customer_code:\n                    user.customer_code = await generate_customer_code(session)\n                \n                await session.commit()\n                \n                lang = get_user_language(user.language_code)\n                \n                # Show confirmation\n                await message.answer(\n                    get_text(\"phone_registered_success\", lang).format(\n                        phone=contact.phone_number,\n                        customer_code=user.customer_code\n                    ),\n                    reply_markup=get_contact_confirmation_keyboard(lang)\n                )\n                \n                await state.set_state(RegistrationStates.confirming_phone)\n            \n        except Exception as e:\n            logger.error(f\"Error handling phone contact: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(RegistrationStates.confirming_phone, F.data == \"confirm_phone\")\nasync def confirm_phone_registration(callback: CallbackQuery, state: FSMContext, session_maker):\n    \"\"\"Confirm phone registration and show main menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if user:\n                await callback.answer()\n                await callback.message.delete()\n                await show_main_menu(callback.message, user, session)\n                await state.clear()\n            \n        except Exception as e:\n            logger.error(f\"Error confirming phone: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(F.text.in_([\"ğŸ’° Ø¥ÙŠØ¯Ø§Ø¹\", \"ğŸ’° Deposit\"]))\nasync def handle_deposit(message: Message, session_maker):\n    \"\"\"Handle deposit request\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            await message.answer(get_text(\"deposit_instructions\", lang))\n            \n        except Exception as e:\n            logger.error(f\"Error handling deposit: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(F.text.in_([\"ğŸ’¸ Ø³Ø­Ø¨\", \"ğŸ’¸ Withdraw\"]))\nasync def handle_withdraw(message: Message, session_maker):\n    \"\"\"Handle withdrawal request\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            await message.answer(get_text(\"withdraw_instructions\", lang))\n            \n        except Exception as e:\n            logger.error(f\"Error handling withdraw: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(F.text.in_([\"ğŸ“¨ Ø´ÙƒØ§ÙˆÙ‰\", \"ğŸ“¨ Complaints\"]))\nasync def handle_complaints(message: Message, session_maker):\n    \"\"\"Handle complaints submission\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            await message.answer(get_text(\"complaints_instructions\", lang))\n            \n        except Exception as e:\n            logger.error(f\"Error handling complaints: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.message(F.text.in_([\"ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ\", \"ğŸ‘¤ My Account\"]))\nasync def handle_my_account(message: Message, session_maker):\n    \"\"\"Show user account information\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            \n            # Format account information\n            account_info = get_text(\"account_info\", lang).format(\n                first_name=user.first_name,\n                last_name=user.last_name or \"\",\n                username=f\"@{user.username}\" if user.username else get_text(\"not_set\", lang),\n                phone=user.phone_number or get_text(\"not_set\", lang),\n                customer_code=user.customer_code,\n                language=user.language_code.upper(),\n                country=user.country_code.upper(),\n                notifications=get_text(\"enabled\", lang) if user.notifications_enabled else get_text(\"disabled\", lang)\n            )\n            \n            await message.answer(account_info)\n            \n        except Exception as e:\n            logger.error(f\"Error showing account: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\nasync def get_or_create_user(session: AsyncSession, telegram_user) -> User:\n    \"\"\"Get existing user or create new one\"\"\"\n    # Try to get existing user\n    result = await session.execute(\n        select(User).where(User.telegram_id == telegram_user.id)\n    )\n    user = result.scalar_one_or_none()\n    \n    if user:\n        # Update user information\n        user.username = telegram_user.username\n        user.first_name = telegram_user.first_name\n        user.last_name = telegram_user.last_name\n        user.last_activity = datetime.now(timezone.utc)\n        user.updated_at = datetime.now(timezone.utc)\n    else:\n        # Create new user\n        user = User(\n            telegram_id=telegram_user.id,\n            username=telegram_user.username,\n            first_name=telegram_user.first_name,\n            last_name=telegram_user.last_name,\n            language_code=telegram_user.language_code or \"ar\",\n            last_activity=datetime.now(timezone.utc)\n        )\n        session.add(user)\n    \n    return user\n\nasync def get_user_by_telegram_id(session: AsyncSession, telegram_id: int) -> User:\n    \"\"\"Get user by telegram ID\"\"\"\n    result = await session.execute(\n        select(User).where(User.telegram_id == telegram_id)\n    )\n    return result.scalar_one_or_none()\n\nasync def show_main_menu(message: Message, user: User, session: AsyncSession):\n    \"\"\"Show main menu to user\"\"\"\n    lang = get_user_language(user.language_code)\n    \n    welcome_back_text = get_text(\"welcome_back\", lang).format(\n        first_name=user.first_name,\n        customer_code=user.customer_code\n    )\n    \n    await message.answer(\n        welcome_back_text,\n        reply_markup=get_main_menu_keyboard(lang)\n    )\n","size_bytes":9884},"backup_server_files/handlers/user_settings.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nUser settings handler for language and country selection\nHandles user preference changes and localization updates\n\"\"\"\n\nimport logging\nfrom datetime import datetime, timezone\nfrom aiogram import Router, F\nfrom aiogram.types import Message, CallbackQuery\nfrom aiogram.fsm.context import FSMContext\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select\n\nfrom models import User, Language, Country\nfrom services.i18n import get_text, get_user_language, load_translations\nfrom utils.keyboards import (\n    get_language_selection_keyboard, get_country_selection_keyboard,\n    get_settings_keyboard, get_main_menu_keyboard\n)\n\nlogger = logging.getLogger(__name__)\nrouter = Router()\n\n@router.message(F.text.in_([\"ğŸŒ Ø§Ù„Ù„ØºØ©\", \"ğŸŒ Language\", \"âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª\", \"âš™ï¸ Settings\"]))\nasync def show_settings_menu(message: Message, session_maker):\n    \"\"\"Show settings menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, message.from_user.id)\n            if not user:\n                return\n            \n            lang = get_user_language(user.language_code)\n            \n            await message.answer(\n                get_text(\"settings_menu\", lang),\n                reply_markup=get_settings_keyboard(lang)\n            )\n            \n        except Exception as e:\n            logger.error(f\"Error showing settings menu: {e}\")\n            await message.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"change_language\")\nasync def show_language_selection(callback: CallbackQuery, session_maker):\n    \"\"\"Show language selection menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Get available languages\n            result = await session.execute(\n                select(Language).where(Language.is_active == True).order_by(Language.name)\n            )\n            languages = result.scalars().all()\n            \n            lang = get_user_language(user.language_code)\n            \n            await callback.message.edit_text(\n                get_text(\"select_language\", lang),\n                reply_markup=get_language_selection_keyboard(languages, user.language_code, lang)\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing language selection: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data.startswith(\"lang_\"))\nasync def change_language(callback: CallbackQuery, session_maker):\n    \"\"\"Change user language\"\"\"\n    async with session_maker() as session:\n        try:\n            language_code = callback.data.split(\"_\")[1]\n            \n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Verify language exists and is active\n            result = await session.execute(\n                select(Language).where(\n                    Language.code == language_code,\n                    Language.is_active == True\n                )\n            )\n            language = result.scalar_one_or_none()\n            \n            if not language:\n                await callback.answer(get_text(\"language_not_available\", \"ar\"))\n                return\n            \n            # Update user language\n            old_lang = user.language_code\n            user.language_code = language_code\n            user.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            # Get new language text\n            new_lang = get_user_language(language_code)\n            \n            await callback.message.edit_text(\n                get_text(\"language_changed\", new_lang).format(\n                    language_name=language.native_name\n                )\n            )\n            \n            # Show updated main menu\n            await callback.message.answer(\n                get_text(\"main_menu_updated\", new_lang),\n                reply_markup=get_main_menu_keyboard(new_lang)\n            )\n            \n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error changing language: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"change_country\")\nasync def show_country_selection(callback: CallbackQuery, session_maker):\n    \"\"\"Show country selection menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Get available countries\n            result = await session.execute(\n                select(Country).where(Country.is_active == True).order_by(Country.name)\n            )\n            countries = result.scalars().all()\n            \n            lang = get_user_language(user.language_code)\n            \n            await callback.message.edit_text(\n                get_text(\"select_country\", lang),\n                reply_markup=get_country_selection_keyboard(countries, user.country_code, lang)\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error showing country selection: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data.startswith(\"country_\"))\nasync def change_country(callback: CallbackQuery, session_maker):\n    \"\"\"Change user country\"\"\"\n    async with session_maker() as session:\n        try:\n            country_code = callback.data.split(\"_\")[1]\n            \n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Verify country exists and is active\n            result = await session.execute(\n                select(Country).where(\n                    Country.code == country_code,\n                    Country.is_active == True\n                )\n            )\n            country = result.scalar_one_or_none()\n            \n            if not country:\n                lang = get_user_language(user.language_code)\n                await callback.answer(get_text(\"country_not_available\", lang))\n                return\n            \n            # Update user country\n            user.country_code = country_code\n            user.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            lang = get_user_language(user.language_code)\n            \n            country_name = country.native_name if lang == \"ar\" else country.name\n            \n            await callback.message.edit_text(\n                get_text(\"country_changed\", lang).format(\n                    country_name=country_name\n                )\n            )\n            \n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error changing country: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"toggle_notifications\")\nasync def toggle_notifications(callback: CallbackQuery, session_maker):\n    \"\"\"Toggle user notifications\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            # Toggle notifications\n            user.notifications_enabled = not user.notifications_enabled\n            user.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n            \n            lang = get_user_language(user.language_code)\n            \n            status = get_text(\"enabled\", lang) if user.notifications_enabled else get_text(\"disabled\", lang)\n            \n            await callback.message.edit_text(\n                get_text(\"notifications_toggled\", lang).format(status=status)\n            )\n            \n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error toggling notifications: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\n@router.callback_query(F.data == \"back_to_settings\")\nasync def back_to_settings(callback: CallbackQuery, session_maker):\n    \"\"\"Go back to settings menu\"\"\"\n    async with session_maker() as session:\n        try:\n            user = await get_user_by_telegram_id(session, callback.from_user.id)\n            if not user:\n                await callback.answer()\n                return\n            \n            lang = get_user_language(user.language_code)\n            \n            await callback.message.edit_text(\n                get_text(\"settings_menu\", lang),\n                reply_markup=get_settings_keyboard(lang)\n            )\n            await callback.answer()\n            \n        except Exception as e:\n            logger.error(f\"Error going back to settings: {e}\")\n            await callback.answer(get_text(\"error_occurred\", \"ar\"))\n\nasync def get_user_by_telegram_id(session: AsyncSession, telegram_id: int) -> User:\n    \"\"\"Get user by telegram ID\"\"\"\n    result = await session.execute(\n        select(User).where(User.telegram_id == telegram_id)\n    )\n    return result.scalar_one_or_none()\n","size_bytes":9720},"backup_server_files/services/broadcast_service.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nBroadcast service for handling mass messaging\nManages broadcast queues, rate limiting, and delivery tracking\n\"\"\"\n\nimport asyncio\nimport logging\nfrom datetime import datetime, timezone\nfrom typing import Optional, List, Dict, Any\nfrom aiogram import Bot\nfrom aiogram.exceptions import TelegramBadRequest, TelegramForbiddenError\nfrom aiogram.types import InputMediaPhoto, InputMediaVideo, InputMediaDocument\nfrom sqlalchemy.ext.asyncio import AsyncSession, async_sessionmaker\nfrom sqlalchemy import select, and_\n\nfrom models import (\n    User, Outbox, OutboxRecipient, OutboxStatus, \n    DeliveryStatus, OutboxType\n)\nfrom config import (\n    BROADCAST_RATE_LIMIT, BROADCAST_CHUNK_SIZE, \n    BROADCAST_RETRY_ATTEMPTS, BROADCAST_RETRY_DELAY\n)\n\nlogger = logging.getLogger(__name__)\n\nclass BroadcastService:\n    \"\"\"Service for handling broadcast operations\"\"\"\n    \n    def __init__(self, bot: Bot, session_maker: async_sessionmaker):\n        self.bot = bot\n        self.session_maker = session_maker\n        self.broadcast_queue = asyncio.Queue()\n        self.is_running = False\n        \n    async def queue_broadcast(self, outbox_id: int, target_type: str, \n                            target_value: Optional[str], message_text: str,\n                            message_type: str = \"text\", file_id: Optional[str] = None,\n                            message_entities: Optional[List] = None):\n        \"\"\"Queue a broadcast for delivery\"\"\"\n        broadcast_data = {\n            \"outbox_id\": outbox_id,\n            \"target_type\": target_type,\n            \"target_value\": target_value,\n            \"message_text\": message_text,\n            \"message_type\": message_type,\n            \"file_id\": file_id,\n            \"message_entities\": message_entities\n        }\n        \n        await self.broadcast_queue.put(broadcast_data)\n        logger.info(f\"Queued broadcast {outbox_id} for delivery\")\n    \n    async def worker(self):\n        \"\"\"Background worker for processing broadcast queue\"\"\"\n        self.is_running = True\n        logger.info(\"Broadcast service worker started\")\n        \n        while self.is_running:\n            try:\n                # Get broadcast from queue with timeout\n                try:\n                    broadcast = await asyncio.wait_for(\n                        self.broadcast_queue.get(), timeout=5.0\n                    )\n                except asyncio.TimeoutError:\n                    continue\n                \n                await self.process_broadcast(broadcast)\n                \n            except Exception as e:\n                logger.error(f\"Error in broadcast worker: {e}\")\n                await asyncio.sleep(1)\n    \n    async def process_broadcast(self, broadcast: Dict[str, Any]):\n        \"\"\"Process a single broadcast\"\"\"\n        outbox_id = broadcast[\"outbox_id\"]\n        \n        try:\n            async with self.session_maker() as session:\n                # Get target users\n                users = await self.get_target_users(\n                    session, broadcast[\"target_type\"], broadcast.get(\"target_value\")\n                )\n                \n                if not users:\n                    logger.warning(f\"No target users found for broadcast {outbox_id}\")\n                    await self.update_broadcast_status(session, outbox_id, OutboxStatus.COMPLETED)\n                    return\n                \n                # Create recipient records\n                await self.create_recipient_records(session, outbox_id, users)\n                await session.commit()\n                \n                logger.info(f\"Starting delivery for broadcast {outbox_id} to {len(users)} users\")\n                \n                # Process in chunks\n                for chunk in self.chunk_list(users, BROADCAST_CHUNK_SIZE):\n                    await self.send_to_chunk(session, outbox_id, chunk, broadcast)\n                    \n                    # Rate limiting\n                    sleep_time = len(chunk) / BROADCAST_RATE_LIMIT\n                    await asyncio.sleep(sleep_time)\n                \n                # Update broadcast status\n                await self.update_broadcast_status(session, outbox_id, OutboxStatus.COMPLETED)\n                logger.info(f\"Completed broadcast {outbox_id}\")\n                \n        except Exception as e:\n            logger.error(f\"Error processing broadcast {outbox_id}: {e}\")\n            async with self.session_maker() as session:\n                await self.update_broadcast_status(session, outbox_id, OutboxStatus.FAILED)\n    \n    async def get_target_users(self, session: AsyncSession, target_type: str, \n                             target_value: Optional[str]) -> List[User]:\n        \"\"\"Get target users based on targeting criteria\"\"\"\n        base_query = select(User).where(\n            and_(User.is_active == True, User.is_banned == False)\n        )\n        \n        if target_type == \"all\":\n            result = await session.execute(base_query)\n        elif target_type == \"language\":\n            result = await session.execute(\n                base_query.where(User.language_code == target_value)\n            )\n        elif target_type == \"country\":\n            result = await session.execute(\n                base_query.where(User.country_code == target_value)\n            )\n        else:\n            logger.warning(f\"Unknown target type: {target_type}\")\n            return []\n        \n        return list(result.scalars().all())\n    \n    async def create_recipient_records(self, session: AsyncSession, \n                                     outbox_id: int, users: List[User]):\n        \"\"\"Create recipient tracking records\"\"\"\n        for user in users:\n            recipient = OutboxRecipient(\n                outbox_id=outbox_id,\n                user_id=user.id,\n                status=DeliveryStatus.PENDING\n            )\n            session.add(recipient)\n    \n    async def send_to_chunk(self, session: AsyncSession, outbox_id: int, \n                          users: List[User], broadcast: Dict[str, Any]):\n        \"\"\"Send broadcast to a chunk of users\"\"\"\n        for user in users:\n            try:\n                success = await self.send_to_user(user, broadcast)\n                \n                # Update recipient status\n                await self.update_recipient_status(\n                    session, outbox_id, user.id,\n                    DeliveryStatus.SENT if success else DeliveryStatus.FAILED\n                )\n                \n            except Exception as e:\n                logger.error(f\"Error sending to user {user.telegram_id}: {e}\")\n                await self.update_recipient_status(\n                    session, outbox_id, user.id, DeliveryStatus.FAILED, str(e)\n                )\n        \n        await session.commit()\n    \n    async def send_to_user(self, user: User, broadcast: Dict[str, Any]) -> bool:\n        \"\"\"Send broadcast message to a single user\"\"\"\n        try:\n            message_text = broadcast[\"message_text\"]\n            message_type = broadcast.get(\"message_type\", \"text\")\n            file_id = broadcast.get(\"file_id\")\n            \n            if message_type == \"text\":\n                await self.bot.send_message(\n                    chat_id=user.telegram_id,\n                    text=message_text,\n                    entities=broadcast.get(\"message_entities\")\n                )\n            elif message_type == \"photo\" and file_id:\n                await self.bot.send_photo(\n                    chat_id=user.telegram_id,\n                    photo=file_id,\n                    caption=message_text,\n                    caption_entities=broadcast.get(\"message_entities\")\n                )\n            elif message_type == \"video\" and file_id:\n                await self.bot.send_video(\n                    chat_id=user.telegram_id,\n                    video=file_id,\n                    caption=message_text,\n                    caption_entities=broadcast.get(\"message_entities\")\n                )\n            elif message_type == \"document\" and file_id:\n                await self.bot.send_document(\n                    chat_id=user.telegram_id,\n                    document=file_id,\n                    caption=message_text,\n                    caption_entities=broadcast.get(\"message_entities\")\n                )\n            \n            return True\n            \n        except TelegramForbiddenError:\n            # User blocked the bot\n            logger.info(f\"User {user.telegram_id} blocked the bot\")\n            return False\n        except TelegramBadRequest as e:\n            # Invalid user or other API error\n            logger.warning(f\"Bad request for user {user.telegram_id}: {e}\")\n            return False\n        except Exception as e:\n            logger.error(f\"Unexpected error sending to user {user.telegram_id}: {e}\")\n            return False\n    \n    async def update_broadcast_status(self, session: AsyncSession, \n                                    outbox_id: int, status: OutboxStatus):\n        \"\"\"Update broadcast status\"\"\"\n        result = await session.execute(\n            select(Outbox).where(Outbox.id == outbox_id)\n        )\n        outbox = result.scalar_one_or_none()\n        \n        if outbox:\n            outbox.status = status\n            outbox.updated_at = datetime.now(timezone.utc)\n            await session.commit()\n    \n    async def update_recipient_status(self, session: AsyncSession, outbox_id: int,\n                                    user_id: int, status: DeliveryStatus,\n                                    error_message: Optional[str] = None):\n        \"\"\"Update recipient delivery status\"\"\"\n        result = await session.execute(\n            select(OutboxRecipient).where(\n                and_(\n                    OutboxRecipient.outbox_id == outbox_id,\n                    OutboxRecipient.user_id == user_id\n                )\n            )\n        )\n        recipient = result.scalar_one_or_none()\n        \n        if recipient:\n            recipient.status = status\n            recipient.last_attempt = datetime.now(timezone.utc)\n            recipient.attempts += 1\n            \n            if status == DeliveryStatus.SENT:\n                recipient.delivered_at = datetime.now(timezone.utc)\n            elif error_message:\n                recipient.error_message = error_message\n    \n    @staticmethod\n    def chunk_list(lst: List, chunk_size: int) -> List[List]:\n        \"\"\"Split list into chunks\"\"\"\n        return [lst[i:i + chunk_size] for i in range(0, len(lst), chunk_size)]\n    \n    async def stop(self):\n        \"\"\"Stop the broadcast service\"\"\"\n        self.is_running = False\n        logger.info(\"Broadcast service stopping...\")\n","size_bytes":10646},"backup_server_files/services/customer_id.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nCustomer ID generation service\nGenerates unique customer codes for new users\n\"\"\"\n\nimport logging\nfrom datetime import datetime\nfrom sqlalchemy.ext.asyncio import AsyncSession\nfrom sqlalchemy import select, func\nfrom models import User\nfrom config import CUSTOMER_ID_PREFIX, CUSTOMER_ID_YEAR_FORMAT\n\nlogger = logging.getLogger(__name__)\n\nasync def generate_customer_code(session: AsyncSession) -> str:\n    \"\"\"Generate unique customer code\"\"\"\n    try:\n        # Get current year\n        current_year = datetime.now().year\n        year_str = CUSTOMER_ID_YEAR_FORMAT or str(current_year)\n        \n        # Get the highest existing number for this year\n        pattern = f\"{CUSTOMER_ID_PREFIX}-{year_str}-%\"\n        \n        result = await session.execute(\n            select(func.max(User.customer_code))\n            .where(User.customer_code.like(pattern))\n        )\n        \n        max_code = result.scalar_one_or_none()\n        \n        if max_code:\n            try:\n                # Extract the number part and increment\n                parts = max_code.split('-')\n                if len(parts) >= 3:\n                    last_number = int(parts[-1])\n                    next_number = last_number + 1\n                else:\n                    next_number = 1\n            except (ValueError, IndexError):\n                next_number = 1\n        else:\n            next_number = 1\n        \n        # Format with leading zeros (6 digits)\n        customer_code = f\"{CUSTOMER_ID_PREFIX}-{year_str}-{next_number:06d}\"\n        \n        # Verify uniqueness (double-check)\n        existing = await session.execute(\n            select(User).where(User.customer_code == customer_code)\n        )\n        \n        if existing.scalar_one_or_none():\n            # If somehow exists, try with incremented number\n            next_number += 1\n            customer_code = f\"{CUSTOMER_ID_PREFIX}-{year_str}-{next_number:06d}\"\n        \n        logger.info(f\"Generated customer code: {customer_code}\")\n        return customer_code\n        \n    except Exception as e:\n        logger.error(f\"Error generating customer code: {e}\")\n        # Fallback: use timestamp-based code\n        timestamp = int(datetime.now().timestamp())\n        fallback_code = f\"{CUSTOMER_ID_PREFIX}-{year_str}-T{timestamp}\"\n        logger.warning(f\"Using fallback customer code: {fallback_code}\")\n        return fallback_code\n\nasync def is_customer_code_unique(session: AsyncSession, customer_code: str) -> bool:\n    \"\"\"Check if customer code is unique\"\"\"\n    try:\n        result = await session.execute(\n            select(User).where(User.customer_code == customer_code)\n        )\n        return result.scalar_one_or_none() is None\n    except Exception as e:\n        logger.error(f\"Error checking customer code uniqueness: {e}\")\n        return False\n\nasync def get_user_by_customer_code(session: AsyncSession, customer_code: str) -> User:\n    \"\"\"Get user by customer code\"\"\"\n    try:\n        result = await session.execute(\n            select(User).where(User.customer_code == customer_code)\n        )\n        return result.scalar_one_or_none()\n    except Exception as e:\n        logger.error(f\"Error getting user by customer code: {e}\")\n        return None\n","size_bytes":3239},"backup_server_files/services/i18n.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nInternationalization service for multi-language support\nLoads and manages translation files for Arabic and English\n\"\"\"\n\nimport json\nimport logging\nfrom pathlib import Path\nfrom typing import Dict, Any\n\nlogger = logging.getLogger(__name__)\n\n# Global translations storage\ntranslations: Dict[str, Dict[str, str]] = {}\n\ndef load_translations():\n    \"\"\"Load translation files\"\"\"\n    global translations\n    \n    translations_dir = Path(\"translations\")\n    \n    try:\n        # Load Arabic translations\n        ar_file = translations_dir / \"ar.json\"\n        if ar_file.exists():\n            with open(ar_file, 'r', encoding='utf-8') as f:\n                translations['ar'] = json.load(f)\n        else:\n            logger.warning(\"Arabic translations file not found\")\n            translations['ar'] = {}\n        \n        # Load English translations\n        en_file = translations_dir / \"en.json\"\n        if en_file.exists():\n            with open(en_file, 'r', encoding='utf-8') as f:\n                translations['en'] = json.load(f)\n        else:\n            logger.warning(\"English translations file not found\")\n            translations['en'] = {}\n        \n        logger.info(f\"Loaded translations for {len(translations)} languages\")\n        \n    except Exception as e:\n        logger.error(f\"Error loading translations: {e}\")\n        # Initialize with empty dictionaries to prevent crashes\n        translations = {'ar': {}, 'en': {}}\n\ndef get_text(key: str, language: str = \"ar\", **kwargs) -> str:\n    \"\"\"Get translated text by key and language\"\"\"\n    if not translations:\n        load_translations()\n    \n    # Get translation for the language or fall back to Arabic\n    lang_dict = translations.get(language, {})\n    \n    # Get the text or fall back to Arabic, then to the key itself\n    text = lang_dict.get(key)\n    if text is None and language != \"ar\":\n        text = translations.get(\"ar\", {}).get(key)\n    if text is None:\n        text = f\"[{key}]\"  # Fallback to show missing translation\n    \n    # Format with provided arguments\n    try:\n        return text.format(**kwargs)\n    except (KeyError, ValueError) as e:\n        logger.warning(f\"Error formatting text '{key}' for language '{language}': {e}\")\n        return text\n\ndef get_user_language(language_code: str = None) -> str:\n    \"\"\"Get user's language code with fallback\"\"\"\n    if language_code and language_code in translations:\n        return language_code\n    return \"ar\"  # Default to Arabic\n\ndef get_available_languages() -> list:\n    \"\"\"Get list of available languages\"\"\"\n    if not translations:\n        load_translations()\n    return list(translations.keys())\n\ndef is_rtl_language(language_code: str) -> bool:\n    \"\"\"Check if language is right-to-left\"\"\"\n    rtl_languages = ['ar', 'he', 'fa', 'ur']\n    return language_code in rtl_languages\n\n# Load translations on module import\nload_translations()\n","size_bytes":2898},"backup_server_files/utils/auth.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nAuthentication utilities for admin verification\nHandles admin permission checks and decorators\n\"\"\"\n\nimport logging\nfrom functools import wraps\nfrom typing import Callable, Any\nfrom aiogram.types import Message, CallbackQuery\n\nfrom config import ADMIN_USER_IDS\nfrom services.i18n import get_text\n\nlogger = logging.getLogger(__name__)\n\ndef is_admin(user_id: int) -> bool:\n    \"\"\"Check if user is an admin\"\"\"\n    return user_id in ADMIN_USER_IDS\n\ndef admin_required(func: Callable) -> Callable:\n    \"\"\"Decorator to require admin privileges\"\"\"\n    @wraps(func)\n    async def wrapper(*args, **kwargs):\n        # Extract user from message or callback\n        user_id = None\n        message_obj = None\n        \n        for arg in args:\n            if isinstance(arg, Message):\n                user_id = arg.from_user.id\n                message_obj = arg\n                break\n            elif isinstance(arg, CallbackQuery):\n                user_id = arg.from_user.id\n                message_obj = arg.message if hasattr(arg, 'message') else arg\n                break\n        \n        if not user_id:\n            logger.warning(\"Could not extract user ID from arguments\")\n            return\n        \n        if not is_admin(user_id):\n            logger.warning(f\"Unauthorized admin access attempt by user {user_id}\")\n            \n            # Send unauthorized message\n            error_text = get_text(\"unauthorized_access\", \"ar\")\n            \n            if isinstance(message_obj, Message):\n                await message_obj.answer(error_text)\n            elif hasattr(message_obj, 'answer'):\n                await message_obj.answer(error_text)\n            elif hasattr(message_obj, 'message') and hasattr(message_obj.message, 'answer'):\n                await message_obj.message.answer(error_text)\n            \n            return\n        \n        # User is admin, proceed with function\n        return await func(*args, **kwargs)\n    \n    return wrapper\n\nasync def check_admin_permissions(user_id: int, required_level: str = \"basic\") -> bool:\n    \"\"\"Check admin permissions with different levels\"\"\"\n    if not is_admin(user_id):\n        return False\n    \n    # For now, all admins have the same level\n    # You can extend this to have different admin levels\n    return True\n\ndef get_admin_level(user_id: int) -> str:\n    \"\"\"Get admin level for user\"\"\"\n    if not is_admin(user_id):\n        return \"none\"\n    \n    # For now, all admins are \"super_admin\"\n    # You can extend this based on your needs\n    return \"super_admin\"\n\nasync def log_admin_action(user_id: int, action: str, details: str = \"\"):\n    \"\"\"Log admin actions for audit trail\"\"\"\n    logger.info(f\"Admin action - User: {user_id}, Action: {action}, Details: {details}\")\n    \n    # You can extend this to save to database for audit trail\n    # Example:\n    # async with session_maker() as session:\n    #     audit_log = AdminAuditLog(\n    #         admin_user_id=user_id,\n    #         action=action,\n    #         details=details,\n    #         timestamp=datetime.now(timezone.utc)\n    #     )\n    #     session.add(audit_log)\n    #     await session.commit()\n\nclass AdminContext:\n    \"\"\"Context manager for admin operations\"\"\"\n    \n    def __init__(self, user_id: int, action: str):\n        self.user_id = user_id\n        self.action = action\n        self.start_time = None\n    \n    async def __aenter__(self):\n        if not is_admin(self.user_id):\n            raise PermissionError(f\"User {self.user_id} is not an admin\")\n        \n        await log_admin_action(self.user_id, f\"Started: {self.action}\")\n        return self\n    \n    async def __aexit__(self, exc_type, exc_val, exc_tb):\n        if exc_type:\n            await log_admin_action(\n                self.user_id, \n                f\"Failed: {self.action}\",\n                f\"Error: {exc_val}\"\n            )\n        else:\n            await log_admin_action(self.user_id, f\"Completed: {self.action}\")\n\n# Example usage of AdminContext:\n# async with AdminContext(user_id, \"broadcast_creation\"):\n#     # Perform admin operation\n#     pass\n","size_bytes":4083},"backup_server_files/utils/keyboards.py":{"content":"#!/usr/bin/env python3\n\"\"\"\nKeyboard utilities for creating inline and reply keyboards\nHandles all keyboard layouts for different bot functions\n\"\"\"\n\nfrom typing import List, Optional\nfrom aiogram.types import (\n    ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, \n    InlineKeyboardButton\n)\nfrom aiogram.utils.keyboard import ReplyKeyboardBuilder, InlineKeyboardBuilder\n\nfrom services.i18n import get_text\n\ndef get_main_menu_keyboard(language: str = \"ar\") -> ReplyKeyboardMarkup:\n    \"\"\"Create main menu reply keyboard\"\"\"\n    builder = ReplyKeyboardBuilder()\n    \n    # Main action buttons - 2 per row\n    builder.row(\n        KeyboardButton(text=get_text(\"deposit\", language)),\n        KeyboardButton(text=get_text(\"withdraw\", language))\n    )\n    \n    builder.row(\n        KeyboardButton(text=get_text(\"complaints\", language)),\n        KeyboardButton(text=get_text(\"support\", language))\n    )\n    \n    builder.row(\n        KeyboardButton(text=get_text(\"manager\", language)),\n        KeyboardButton(text=get_text(\"plans\", language))\n    )\n    \n    builder.row(\n        KeyboardButton(text=get_text(\"sales\", language)),\n        KeyboardButton(text=get_text(\"settings\", language))\n    )\n    \n    # Bottom navigation buttons\n    builder.row(\n        KeyboardButton(text=get_text(\"back\", language)),\n        KeyboardButton(text=get_text(\"forward\", language)),\n        KeyboardButton(text=get_text(\"my_account\", language))\n    )\n    \n    return builder.as_markup(resize_keyboard=True, one_time_keyboard=False)\n\ndef get_phone_share_keyboard(language: str = \"ar\") -> ReplyKeyboardMarkup:\n    \"\"\"Create phone sharing keyboard\"\"\"\n    builder = ReplyKeyboardBuilder()\n    \n    builder.row(\n        KeyboardButton(\n            text=get_text(\"share_phone\", language),\n            request_contact=True\n        )\n    )\n    \n    return builder.as_markup(resize_keyboard=True, one_time_keyboard=True)\n\ndef get_contact_confirmation_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create contact confirmation keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"confirm\", language),\n            callback_data=\"confirm_phone\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_settings_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create settings menu keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"change_language\", language),\n            callback_data=\"change_language\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"change_country\", language),\n            callback_data=\"change_country\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"toggle_notifications\", language),\n            callback_data=\"toggle_notifications\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_language_selection_keyboard(languages, current_language: str, \n                                  ui_language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create language selection keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    for lang in languages:\n        # Add checkmark for current language\n        text = lang.native_name\n        if lang.code == current_language:\n            text = f\"âœ… {text}\"\n        \n        builder.row(\n            InlineKeyboardButton(\n                text=text,\n                callback_data=f\"lang_{lang.code}\"\n            )\n        )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", ui_language),\n            callback_data=\"back_to_settings\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_country_selection_keyboard(countries, current_country: str,\n                                 ui_language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create country selection keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    for country in countries:\n        # Add checkmark for current country\n        text = country.native_name\n        if country.code == current_country:\n            text = f\"âœ… {text}\"\n        \n        builder.row(\n            InlineKeyboardButton(\n                text=text,\n                callback_data=f\"country_{country.code}\"\n            )\n        )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", ui_language),\n            callback_data=\"back_to_settings\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_admin_panel_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create admin panel keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"admin_users\", language),\n            callback_data=\"admin_users\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"admin_languages\", language),\n            callback_data=\"admin_languages\"\n        ),\n        InlineKeyboardButton(\n            text=get_text(\"admin_countries\", language),\n            callback_data=\"admin_countries\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"admin_broadcast\", language),\n            callback_data=\"admin_broadcast\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"admin_outbox\", language),\n            callback_data=\"admin_outbox\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_admin_users_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create admin users management keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"search_users\", language),\n            callback_data=\"search_users\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"user_statistics\", language),\n            callback_data=\"user_statistics\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"back_to_admin\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_admin_languages_keyboard(languages, language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create admin languages management keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    # Show toggle buttons for each language\n    for lang in languages[:5]:  # Limit to 5 to avoid too long keyboards\n        status_text = \"âœ…\" if lang.is_active else \"âŒ\"\n        builder.row(\n            InlineKeyboardButton(\n                text=f\"{status_text} {lang.native_name}\",\n                callback_data=f\"toggle_lang_{lang.id}\"\n            )\n        )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"add_language\", language),\n            callback_data=\"add_language\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"back_to_admin\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_admin_countries_keyboard(countries, language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create admin countries management keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    # Show toggle buttons for each country\n    for country in countries[:5]:  # Limit to 5 to avoid too long keyboards\n        status_text = \"âœ…\" if country.is_active else \"âŒ\"\n        builder.row(\n            InlineKeyboardButton(\n                text=f\"{status_text} {country.native_name}\",\n                callback_data=f\"toggle_country_{country.id}\"\n            )\n        )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"add_country\", language),\n            callback_data=\"add_country\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"back_to_admin\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_user_management_keyboard(user_id: int, language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create user management keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"ban_user\", language),\n            callback_data=f\"ban_user_{user_id}\"\n        ),\n        InlineKeyboardButton(\n            text=get_text(\"unban_user\", language),\n            callback_data=f\"unban_user_{user_id}\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"promote_admin\", language),\n            callback_data=f\"promote_admin_{user_id}\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"admin_users\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_pagination_keyboard(base_callback: str, current_page: int, \n                          total_pages: int, language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create pagination keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    buttons = []\n    \n    # Previous button\n    if current_page > 0:\n        buttons.append(\n            InlineKeyboardButton(\n                text=\"â—€ï¸\",\n                callback_data=f\"{base_callback}_page_{current_page - 1}\"\n            )\n        )\n    \n    # Current page indicator\n    buttons.append(\n        InlineKeyboardButton(\n            text=f\"{current_page + 1}/{total_pages}\",\n            callback_data=\"noop\"\n        )\n    )\n    \n    # Next button\n    if current_page < total_pages - 1:\n        buttons.append(\n            InlineKeyboardButton(\n                text=\"â–¶ï¸\",\n                callback_data=f\"{base_callback}_page_{current_page + 1}\"\n            )\n        )\n    \n    builder.row(*buttons)\n    \n    # Back button\n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"back\", language),\n            callback_data=\"back_to_admin\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_broadcast_targeting_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create broadcast targeting keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"broadcast_all\", language),\n            callback_data=\"broadcast_all\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"broadcast_by_language\", language),\n            callback_data=\"broadcast_by_language\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"broadcast_by_country\", language),\n            callback_data=\"broadcast_by_country\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_broadcast_confirmation_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create broadcast confirmation keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"confirm_broadcast\", language),\n            callback_data=\"confirm_broadcast\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"cancel_broadcast\", language),\n            callback_data=\"cancel_broadcast\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_language_filter_keyboard(languages, ui_language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create language filter keyboard for broadcasts\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    for lang_code, lang_name, user_count in languages:\n        builder.row(\n            InlineKeyboardButton(\n                text=f\"{lang_name} ({user_count})\",\n                callback_data=f\"lang_filter_{lang_code}\"\n            )\n        )\n    \n    return builder.as_markup()\n\ndef get_country_filter_keyboard(countries, ui_language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create country filter keyboard for broadcasts\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    for country_code, country_name, user_count in countries:\n        builder.row(\n            InlineKeyboardButton(\n                text=f\"{country_name} ({user_count})\",\n                callback_data=f\"country_filter_{country_code}\"\n            )\n        )\n    \n    return builder.as_markup()\n\ndef get_announcement_menu_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create announcement menu keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"skip_image\", language),\n            callback_data=\"skip_image\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_announcement_targeting_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create announcement targeting keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"announce_all\", language),\n            callback_data=\"announce_all\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"announce_by_language\", language),\n            callback_data=\"announce_by_language\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_announcement_duration_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create announcement duration keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"duration_1h\", language),\n            callback_data=\"duration_1h\"\n        ),\n        InlineKeyboardButton(\n            text=get_text(\"duration_6h\", language),\n            callback_data=\"duration_6h\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"duration_24h\", language),\n            callback_data=\"duration_24h\"\n        ),\n        InlineKeyboardButton(\n            text=get_text(\"duration_7d\", language),\n            callback_data=\"duration_7d\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"duration_permanent\", language),\n            callback_data=\"duration_permanent\"\n        )\n    )\n    \n    return builder.as_markup()\n\ndef get_announcement_confirmation_keyboard(language: str = \"ar\") -> InlineKeyboardMarkup:\n    \"\"\"Create announcement confirmation keyboard\"\"\"\n    builder = InlineKeyboardBuilder()\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"confirm_announcement\", language),\n            callback_data=\"confirm_announcement\"\n        )\n    )\n    \n    builder.row(\n        InlineKeyboardButton(\n            text=get_text(\"cancel_announcement\", language),\n            callback_data=\"cancel_announcement\"\n        )\n    )\n    \n    return builder.as_markup()\n","size_bytes":14747}},"version":1}